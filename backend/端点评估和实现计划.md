# 端点评估和实现计划

## 概述

根据前后端对齐检查报告，当前有 **50个缺失端点** 和 **292个额外端点**。本文档评估缺失端点的重要性，并制定实现计划。

## 已修复的问题

### 路由前缀重复问题
- ✅ **STRM路由**：`app/api/strm.py` 中的 `prefix="/api/strm"` 已改为 `prefix="/strm"`
- ✅ **Upload路由**：`app/api/upload.py` 中的 `prefix="/api/upload"` 已改为 `prefix="/upload"`

**原因**：主应用在 `main.py` 中已经为 `api_router` 添加了 `/api` 前缀，所以各个路由模块不应该再包含 `/api` 前缀。

## 缺失端点分类

### 高优先级（核心功能，必须实现）

#### 1. 认证管理
- ✅ `POST /api/auth/logout` - **已实现**

#### 2. 下载管理（别名端点）
- ❌ `GET /api/downloads/{download_id}` - 需要添加别名端点（当前只有 `{task_id}`）
- ❌ `POST /api/downloads/{download_id}/pause` - 需要添加别名端点
- ❌ `POST /api/downloads/{download_id}/resume` - 需要添加别名端点

**说明**：FastAPI路由参数名不影响URL匹配，`/{task_id}` 和 `/{download_id}` 在URL层面是一样的，但前端可能期望使用 `download_id`。可以通过文档说明或添加别名端点解决。

#### 3. STRM管理
- ❌ `POST /api/strm/emit` - **已实现，但路径可能不匹配**
- ❌ `POST /api/strm/incremental-sync` - **已实现，但路径可能不匹配**
- ❌ `POST /api/strm/full-sync` - **已实现，但路径可能不匹配**
- ❌ `GET /api/strm/network-info` - **已实现，但路径可能不匹配**
- ❌ `GET /api/strm/stream/{storage_type}/{token}` - **已实现，但路径可能不匹配**
- ❌ `GET /api/strm/subtitle/{storage_type}/{token}` - **已实现，但路径可能不匹配**
- ❌ `POST /api/strm/sync/start` - **已实现，但路径可能不匹配**
- ❌ `POST /api/strm/sync/stop` - **已实现，但路径可能不匹配**
- ❌ `GET /api/strm/sync/tasks` - **已实现，但路径可能不匹配**
- ❌ `GET /api/strm/sync/tasks/{task_id}` - **已实现，但路径可能不匹配**
- ❌ `POST /api/strm/sync/tasks/{task_id}/stop` - **已实现，但路径可能不匹配**
- ❌ `GET /api/strm/sync/history` - **已实现，但路径可能不匹配**

**说明**：这些端点已实现，但由于路由前缀问题（已修复），重新运行对齐检查应该能匹配。

#### 4. 存储管理
- ❌ `GET /api/storage/status` - **已实现**
- ❌ `GET /api/storage/config` - **已实现**
- ❌ `PUT /api/storage/config` - **已实现**

**说明**：这些端点已实现，可能需要重新运行对齐检查。

#### 5. 媒体库管理
- ❌ `GET /api/library/servers` - **已实现（别名端点）**
- ❌ `POST /api/library/{server}/refresh` - **已实现（别名端点）**

**说明**：这些端点已实现，但参数名可能不匹配（`server` vs `server_id`）。

### 中优先级（重要功能，建议实现）

#### 6. 媒体管理
- ❌ `GET /api/media` - 媒体列表
- ❌ `GET /api/media/{media_id}` - 媒体详情
- ❌ `POST /api/media` - 创建媒体记录
- ❌ `PUT /api/media/{media_id}` - 更新媒体记录
- ❌ `DELETE /api/media/{media_id}` - 删除媒体记录

**说明**：`app/api/media.py` 目前只有搜索功能，需要添加CRUD端点。

#### 7. 仪表盘统计
- ❌ `GET /api/dashboard/stats/system` - 系统统计
- ❌ `GET /api/dashboard/stats/media` - 媒体统计

**说明**：`app/api/dashboard.py` 目前只有综合仪表盘端点，需要添加单独的统计端点。

#### 8. 系统设置
- ❌ `GET /api/system/settings/{key}` - 获取单个设置项
- ❌ `PUT /api/system/settings/{key}` - 更新单个设置项

**说明**：`app/api/system_settings.py` 可能已有这些端点，需要检查。

#### 9. 音乐管理
- ❌ `GET /api/music/tracks/{track_id}` - 音乐曲目详情

**说明**：`app/api/music.py` 目前只有搜索和榜单功能，需要添加曲目详情端点。

#### 10. 豆瓣API
- ❌ `GET /api/douban/detail/{douban_id}` - 豆瓣详情
- ❌ `GET /api/douban/rating/{douban_id}` - 豆瓣评分

**说明**：`app/api/douban.py` 可能已有这些端点，需要检查。

#### 11. RSSHub
- ❌ `GET /api/rsshub/sources/{id}/preview` - RSSHub源预览

**说明**：`app/api/rsshub.py` 可能已有这个端点，需要检查。

#### 12. 站点域名管理
- ❌ `POST /api/sites/{site_id}/domains/check-all` - 检查所有域名
- ❌ `POST /api/sites/{site_id}/domains/set-active` - 设置活动域名

**说明**：`app/api/site_domain.py` 可能已有这些端点，需要检查。

### 低优先级（可选功能，可延后实现）

#### 13. 下载器管理
- ❌ `GET /api/dl/instances` - 下载器实例列表
- ❌ `POST /api/dl/{did}/test` - 测试下载器连接
- ❌ `GET /api/dl/{did}/stats` - 下载器统计

**说明**：这些端点可能需要新的API模块或扩展现有的下载管理模块。

#### 14. 规则集管理
- ❌ `GET /api/ruleset` - 获取规则集
- ❌ `PUT /api/ruleset` - 更新规则集

**说明**：这些端点可能需要新的API模块。

#### 15. 刮削器配置
- ❌ `GET /api/scraper/config` - 获取刮削器配置
- ❌ `PUT /api/scraper/config` - 更新刮削器配置
- ❌ `POST /api/scraper/test` - 测试刮削器

**说明**：这些端点可能需要新的API模块或扩展现有的媒体识别模块。

#### 16. 网关签名
- ❌ `POST /api/gateway/sign` - 网关签名

**说明**：这个端点可能与STRM网关相关，需要检查是否已实现。

#### 17. 密钥管理
- ❌ `GET /api/secrets/status` - 密钥状态

**说明**：这个端点可能与 `app/core/secret_manager.py` 相关，需要检查是否已实现。

#### 18. 插件管理
- ❌ `GET /api/plugins/registry` - 插件注册表
- ❌ `POST /api/plugins/{pid}/install` - 安装插件

**说明**：`app/api/plugins.py` 可能已有这些端点，需要检查。

## 实现计划

### 阶段1：修复路径匹配问题（立即执行）
1. ✅ 修复STRM路由前缀
2. ✅ 修复Upload路由前缀
3. 检查其他路由模块是否有类似问题
4. 重新运行对齐检查

### 阶段2：实现高优先级端点（1-2天）
1. 添加下载管理别名端点（如果需要）
2. 验证STRM端点路径匹配
3. 验证存储管理端点路径匹配
4. 修复媒体库管理端点参数名

### 阶段3：实现中优先级端点（3-5天）
1. 实现媒体管理CRUD端点
2. 实现仪表盘统计端点
3. 检查并实现系统设置单个键端点
4. 实现音乐曲目详情端点
5. 检查并实现豆瓣详情和评分端点
6. 检查并实现RSSHub源预览端点
7. 检查并实现站点域名管理端点

### 阶段4：实现低优先级端点（按需）
1. 根据实际需求决定是否实现下载器管理端点
2. 根据实际需求决定是否实现规则集管理端点
3. 根据实际需求决定是否实现刮削器配置端点
4. 检查并实现网关签名端点
5. 检查并实现密钥状态端点
6. 检查并实现插件管理端点

## 额外端点评估

当前有 **292个额外端点**，这些端点可能是：
1. VabHub特有的功能端点（不在前端期望列表中）
2. 内部管理端点
3. 已废弃但未移除的端点

**建议**：
- 保留VabHub特有的功能端点
- 标记内部管理端点（使用不同的路径前缀，如 `/api/internal/...`）
- 移除已废弃的端点

## 下一步行动

1. **立即执行**：修复路由前缀问题并重新运行对齐检查
2. **短期**：实现高优先级和中优先级的缺失端点
3. **长期**：评估额外端点的必要性，优化API结构

