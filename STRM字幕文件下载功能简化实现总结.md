# STRMå­—å¹•æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ç®€åŒ–å®ç°æ€»ç»“

**å®ç°æ—¶é—´**: 2025-01-XX  
**åŠŸèƒ½**: å­—å¹•æ–‡ä»¶ä¸‹è½½åœ°å€è·å–åŠŸèƒ½ç®€åŒ–

---

## ğŸ“‹ ä¸€ã€ç”¨æˆ·éœ€æ±‚åˆ†æ

### ç”¨æˆ·åé¦ˆ

ç”¨æˆ·è®¤ä¸ºå­—å¹•æ–‡ä»¶ä¸‹è½½åœ°å€è·å–åŠŸèƒ½ä¸åº”è¯¥é‚£ä¹ˆå¤æ‚ï¼Œæå‡ºäº†æ›´ç®€å•çš„å®ç°æ€è·¯ï¼š

1. **ç”¨æˆ·å¼€å¯"ä¸‹è½½ç«™ç‚¹å­—å¹•"å¼€å…³**ï¼ˆç±»ä¼¼MoviePilotçš„è®¾ç½®ï¼‰
2. **å¦‚æœæœ‰ä¸‹è½½åˆ°ç‹¬ç«‹å­—å¹•æ–‡ä»¶ï¼Œåœ¨ä¸Šä¼ ç½‘ç›˜æ—¶å’Œè§†é¢‘æ–‡ä»¶ä¸€èµ·é‡å‘½åä¸Šä¼ åˆ†ç±»**
3. **ç”ŸæˆSTRMæ–‡ä»¶æ—¶ï¼Œå°†å­—å¹•æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°å¯¹åº”æ–‡ä»¶å¤¹**
4. **å­—å¹•æ–‡ä»¶æœ¬èº«ä¸å¤§ï¼Œè€Œä¸”å¤§éƒ¨åˆ†è§†é¢‘æ–‡ä»¶å†…ç½®å­—å¹•ä¹Ÿä¸éœ€è¦ä¸‹è½½**

### æ ¸å¿ƒæ€è·¯

- âœ… **å­—å¹•æ–‡ä»¶ä¸è§†é¢‘æ–‡ä»¶ä¸€èµ·å¤„ç†** - ä¸Šä¼ ã€é‡å‘½åã€åˆ†ç±»éƒ½ä¸€èµ·
- âœ… **STRMç”Ÿæˆæ—¶ç›´æ¥ä¸‹è½½** - ä¸éœ€è¦ç”ŸæˆURLï¼Œç›´æ¥ä»ç½‘ç›˜ä¸‹è½½åˆ°æœ¬åœ°
- âœ… **ç®€å•å®ç”¨** - å­—å¹•æ–‡ä»¶å°ï¼Œç›´æ¥ä¸‹è½½å³å¯

---

## ğŸ“‹ äºŒã€å®ç°æ–¹æ¡ˆ

### 2.1 åŸæœ‰å®ç°ï¼ˆå¤æ‚ï¼‰

**é—®é¢˜**:
- è¯•å›¾ç”Ÿæˆå­—å¹•æ–‡ä»¶URL
- éœ€è¦å¤æ‚çš„pick_codeæå–é€»è¾‘
- è¿”å›å ä½ç¬¦ï¼ŒåŠŸèƒ½ä¸å®Œæ•´

**ä»£ç **:
```python
async def _generate_subtitle_url(...) -> str:
    # TODO: ä»subtitle_fileæå–pick_code
    # è¿”å›å ä½ç¬¦
    return f"# Subtitle file: {subtitle_file}\n# TODO: å®ç°å­—å¹•æ–‡ä»¶ä¸‹è½½åœ°å€è·å–"
```

### 2.2 æ–°å®ç°ï¼ˆç®€åŒ–ï¼‰

**æ–¹æ¡ˆ**:
1. ä»`subtitle_files`å‚æ•°ä¸­æå–pick_code
2. ä½¿ç”¨115 APIè·å–ä¸‹è½½åœ°å€
3. ç›´æ¥ä¸‹è½½å­—å¹•æ–‡ä»¶åˆ°æœ¬åœ°STRMç›®å½•
4. ä¸éœ€è¦ç”ŸæˆURLæ–‡ä»¶ï¼Œç›´æ¥ä¿å­˜æ–‡ä»¶å†…å®¹

**ä»£ç **:
```python
async def _generate_subtitle_files(...) -> List[str]:
    """
    ç”Ÿæˆå­—å¹•æ–‡ä»¶åˆ°STRMç›®å½•
    
    å­—å¹•æ–‡ä»¶å¤„ç†é€»è¾‘ï¼š
    1. å­—å¹•æ–‡ä»¶å·²ç»åœ¨ç½‘ç›˜ä¸­ï¼ˆå’Œè§†é¢‘æ–‡ä»¶ä¸€èµ·ä¸Šä¼ ã€é‡å‘½åã€åˆ†ç±»ï¼‰
    2. ç›´æ¥ä»ç½‘ç›˜ä¸‹è½½å­—å¹•æ–‡ä»¶åˆ°æœ¬åœ°STRMç›®å½•
    3. å­—å¹•æ–‡ä»¶é€šå¸¸å¾ˆå°ï¼Œç›´æ¥ä¸‹è½½å³å¯
    """
    # 1. æå–pick_code
    pick_code = self._extract_pick_code_from_path(subtitle_file)
    
    # 2. è·å–ä¸‹è½½åœ°å€
    result = await cloud_115_api.get_download_url(pick_code=pick_code)
    
    # 3. ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°
    async with httpx.AsyncClient() as client:
        response = await client.get(download_url)
        with open(local_path, 'wb') as f:
            f.write(response.content)
```

---

## ğŸ“‹ ä¸‰ã€å®ç°ç»†èŠ‚

### 3.1 pick_codeæå–

**æ”¯æŒæ ¼å¼**:
- ç›´æ¥æ˜¯pick_code: `"cg16zx93h3xy6ddf1"`
- åŒ…å«pick_codeçš„è·¯å¾„: `"/path/to/file.pick_code.srt"`
- 115ç½‘ç›˜è·¯å¾„æ ¼å¼: é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æå–15ä½å­—æ¯æ•°å­—

**å®ç°**:
```python
def _extract_pick_code_from_path(self, path: str) -> Optional[str]:
    # å¦‚æœè·¯å¾„çœ‹èµ·æ¥å°±æ˜¯pick_codeï¼ˆ15ä½å­—æ¯æ•°å­—ï¼‰
    if len(path) == 15 and path.isalnum():
        return path
    
    # å°è¯•ä»è·¯å¾„ä¸­æå–pick_codeï¼ˆ15ä½å­—æ¯æ•°å­—ï¼‰
    match = re.search(r'([a-z0-9]{15})', path, re.IGNORECASE)
    if match:
        return match.group(1)
    
    return None
```

### 3.2 å­—å¹•æ–‡ä»¶ä¸‹è½½

**æµç¨‹**:
1. è·å–115 APIå®¢æˆ·ç«¯
2. è°ƒç”¨`get_download_url`è·å–ä¸‹è½½åœ°å€
3. ä½¿ç”¨`httpx`ä¸‹è½½æ–‡ä»¶å†…å®¹
4. ä¿å­˜åˆ°æœ¬åœ°STRMç›®å½•

**å®ç°**:
```python
async def _download_subtitle_from_cloud(
    self,
    cloud_115_api: Any,
    pick_code: str,
    local_path: Path
) -> bool:
    # 1. è·å–ä¸‹è½½åœ°å€
    result = await cloud_115_api.get_download_url(pick_code=pick_code)
    
    # 2. ä¸‹è½½æ–‡ä»¶
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(download_url)
        response.raise_for_status()
        
        # 3. ä¿å­˜åˆ°æœ¬åœ°
        local_path.parent.mkdir(parents=True, exist_ok=True)
        with open(local_path, 'wb') as f:
            f.write(response.content)
    
    return True
```

---

## ğŸ“‹ å››ã€å·¥ä½œæµç¨‹

### 4.1 å®Œæ•´æµç¨‹

```
1. ä¸‹è½½é˜¶æ®µ
   â”œâ”€â”€ ç”¨æˆ·å¼€å¯"ä¸‹è½½ç«™ç‚¹å­—å¹•"å¼€å…³
   â”œâ”€â”€ ä»ç«™ç‚¹ä¸‹è½½å­—å¹•æ–‡ä»¶åˆ°æœ¬åœ°ä¸‹è½½ç›®å½•
   â””â”€â”€ å­—å¹•æ–‡ä»¶å’Œè§†é¢‘æ–‡ä»¶åœ¨åŒä¸€ç›®å½•

2. ä¸Šä¼ é˜¶æ®µ
   â”œâ”€â”€ å­—å¹•æ–‡ä»¶å’Œè§†é¢‘æ–‡ä»¶ä¸€èµ·ä¸Šä¼ åˆ°ç½‘ç›˜
   â”œâ”€â”€ å­—å¹•æ–‡ä»¶å’Œè§†é¢‘æ–‡ä»¶ä¸€èµ·é‡å‘½å
   â””â”€â”€ å­—å¹•æ–‡ä»¶å’Œè§†é¢‘æ–‡ä»¶ä¸€èµ·åˆ†ç±»

3. STRMç”Ÿæˆé˜¶æ®µ
   â”œâ”€â”€ æ£€æµ‹åˆ°ç½‘ç›˜ä¸­æœ‰å­—å¹•æ–‡ä»¶ï¼ˆé€šè¿‡subtitle_fileså‚æ•°ï¼‰
   â”œâ”€â”€ æå–å­—å¹•æ–‡ä»¶çš„pick_code
   â”œâ”€â”€ ä»ç½‘ç›˜ä¸‹è½½å­—å¹•æ–‡ä»¶åˆ°æœ¬åœ°STRMç›®å½•
   â””â”€â”€ å­—å¹•æ–‡ä»¶ä¿å­˜åœ¨STRMæ–‡ä»¶åŒç›®å½•
```

### 4.2 è°ƒç”¨ç¤ºä¾‹

```python
# ç”ŸæˆSTRMæ–‡ä»¶æ—¶
result = await generator.generate_strm_file(
    media_info=media_info,
    cloud_file_id=video_pick_code,
    cloud_storage='115',
    cloud_path=cloud_path,
    subtitle_files=['cg16zx93h3xy6ddf1', 'cg16zx93h3xy6ddf2'],  # pick_codeåˆ—è¡¨
    cloud_115_api=cloud_115_api
)

# ç»“æœ
{
    'strm_path': '/path/to/video.strm',
    'subtitle_paths': [
        '/path/to/video.zh.srt',
        '/path/to/video.en.srt'
    ],
    'nfo_path': '/path/to/video.nfo'
}
```

---

## ğŸ“‹ äº”ã€ä¼˜åŠ¿

### 5.1 ç®€åŒ–å®ç°

- âœ… **ä¸éœ€è¦ç”ŸæˆURLæ–‡ä»¶** - ç›´æ¥ä¸‹è½½æ–‡ä»¶å†…å®¹
- âœ… **é€»è¾‘æ¸…æ™°** - ä¸‹è½½ã€ä¿å­˜ï¼Œä¸¤æ­¥å®Œæˆ
- âœ… **ä»£ç ç®€æ´** - ç§»é™¤äº†å¤æ‚çš„URLç”Ÿæˆé€»è¾‘

### 5.2 ç¬¦åˆç”¨æˆ·éœ€æ±‚

- âœ… **ä¸è§†é¢‘æ–‡ä»¶ä¸€èµ·å¤„ç†** - ä¸Šä¼ ã€é‡å‘½åã€åˆ†ç±»éƒ½ä¸€èµ·
- âœ… **STRMç”Ÿæˆæ—¶ä¸‹è½½** - ç®€å•ç›´æ¥
- âœ… **æ–‡ä»¶å°ï¼Œä¸‹è½½å¿«** - å­—å¹•æ–‡ä»¶é€šå¸¸åªæœ‰å‡ KBåˆ°å‡ åKB

### 5.3 é”™è¯¯å¤„ç†

- âœ… **pick_codeæå–å¤±è´¥** - è®°å½•è­¦å‘Šï¼Œè·³è¿‡è¯¥å­—å¹•æ–‡ä»¶
- âœ… **ä¸‹è½½å¤±è´¥** - è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†å…¶ä»–å­—å¹•æ–‡ä»¶
- âœ… **ç½‘ç»œè¶…æ—¶** - è®¾ç½®30ç§’è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…

---

## ğŸ“‹ å…­ã€æ³¨æ„äº‹é¡¹

### 6.1 subtitle_fileså‚æ•°æ ¼å¼

**å½“å‰å®ç°æ”¯æŒ**:
- pick_codeå­—ç¬¦ä¸²: `"cg16zx93h3xy6ddf1"`
- åŒ…å«pick_codeçš„è·¯å¾„: `"/path/to/file.cg16zx93h3xy6ddf1.srt"`

**å»ºè®®**:
- åœ¨è°ƒç”¨`generate_strm_file`æ—¶ï¼Œç›´æ¥ä¼ é€’pick_codeåˆ—è¡¨
- å¦‚æœä¼ é€’è·¯å¾„ï¼Œç¡®ä¿è·¯å¾„ä¸­åŒ…å«pick_code

### 6.2 å­—å¹•æ–‡ä»¶å‘½å

**å½“å‰å®ç°**:
- ä½¿ç”¨åŸå§‹æ–‡ä»¶å: `Path(subtitle_file).name`

**å»ºè®®**:
- å¦‚æœå­—å¹•æ–‡ä»¶åœ¨ç½‘ç›˜ä¸­å·²ç»é‡å‘½åï¼Œæ–‡ä»¶ååº”è¯¥å·²ç»åŒ¹é…è§†é¢‘æ–‡ä»¶
- å¦‚æœéœ€è¦è¿›ä¸€æ­¥å¤„ç†ï¼Œå¯ä»¥åœ¨ä¸‹è½½åé‡å‘½å

### 6.3 å­—å¹•æ–‡ä»¶æŸ¥æ‰¾

**å½“å‰å®ç°**:
- ä¾èµ–`subtitle_files`å‚æ•°ä¼ é€’

**å»ºè®®**:
- åœ¨STRMåŒæ­¥æ—¶ï¼Œè‡ªåŠ¨æŸ¥æ‰¾å…³è”çš„å­—å¹•æ–‡ä»¶
- å¯ä»¥é€šè¿‡æ–‡ä»¶ååŒ¹é…æˆ–æ•°æ®åº“å…³è”æŸ¥æ‰¾

---

## ğŸ“‹ ä¸ƒã€åç»­ä¼˜åŒ–å»ºè®®

### 7.1 è‡ªåŠ¨æŸ¥æ‰¾å­—å¹•æ–‡ä»¶

**å½“å‰**: éœ€è¦æ‰‹åŠ¨ä¼ é€’`subtitle_files`å‚æ•°

**ä¼˜åŒ–**: åœ¨STRMåŒæ­¥æ—¶ï¼Œè‡ªåŠ¨æŸ¥æ‰¾ç½‘ç›˜ä¸­ä¸è§†é¢‘æ–‡ä»¶å…³è”çš„å­—å¹•æ–‡ä»¶

```python
# åœ¨STRMSyncManagerä¸­
async def _find_subtitle_files(self, video_pick_code: str) -> List[str]:
    """æŸ¥æ‰¾ä¸è§†é¢‘æ–‡ä»¶å…³è”çš„å­—å¹•æ–‡ä»¶"""
    # 1. è·å–è§†é¢‘æ–‡ä»¶ä¿¡æ¯
    video_info = await cloud_115_api.get_file_info(file_id=video_pick_code)
    
    # 2. æŸ¥æ‰¾åŒç›®å½•ä¸‹çš„å­—å¹•æ–‡ä»¶
    subtitle_files = await cloud_115_api.list_files(
        parent_id=video_info.parent_id,
        file_type='subtitle'  # éœ€è¦APIæ”¯æŒ
    )
    
    # 3. åŒ¹é…æ–‡ä»¶å
    matched_subtitles = []
    for subtitle in subtitle_files:
        if self._is_subtitle_for_video(subtitle, video_info):
            matched_subtitles.append(subtitle.pick_code)
    
    return matched_subtitles
```

### 7.2 å­—å¹•æ–‡ä»¶é‡å‘½å

**å½“å‰**: ä½¿ç”¨åŸå§‹æ–‡ä»¶å

**ä¼˜åŒ–**: ä¸‹è½½åæ ¹æ®è§†é¢‘æ–‡ä»¶åé‡å‘½åå­—å¹•æ–‡ä»¶

```python
# åœ¨_generate_subtitle_filesä¸­
subtitle_name = self._generate_subtitle_name(
    video_name=local_path.stem,
    subtitle_file=subtitle_file,
    language=extracted_language
)
```

### 7.3 æ‰¹é‡ä¸‹è½½ä¼˜åŒ–

**å½“å‰**: é€ä¸ªä¸‹è½½å­—å¹•æ–‡ä»¶

**ä¼˜åŒ–**: å¹¶å‘ä¸‹è½½å¤šä¸ªå­—å¹•æ–‡ä»¶

```python
# ä½¿ç”¨asyncio.gatherå¹¶å‘ä¸‹è½½
tasks = [
    self._download_subtitle_from_cloud(cloud_115_api, pick_code, local_path)
    for pick_code, local_path in subtitle_tasks
]
results = await asyncio.gather(*tasks, return_exceptions=True)
```

---

## ğŸ“‹ å…«ã€æµ‹è¯•å»ºè®®

### 8.1 å•å…ƒæµ‹è¯•

1. **pick_codeæå–æµ‹è¯•**
   - æµ‹è¯•ç›´æ¥pick_codeæ ¼å¼
   - æµ‹è¯•åŒ…å«pick_codeçš„è·¯å¾„æ ¼å¼
   - æµ‹è¯•æ— æ•ˆè·¯å¾„æ ¼å¼

2. **ä¸‹è½½æµ‹è¯•**
   - æµ‹è¯•æ­£å¸¸ä¸‹è½½
   - æµ‹è¯•ä¸‹è½½å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ã€APIé”™è¯¯ï¼‰
   - æµ‹è¯•è¶…æ—¶å¤„ç†

### 8.2 é›†æˆæµ‹è¯•

1. **å®Œæ•´æµç¨‹æµ‹è¯•**
   - æµ‹è¯•ä»ç½‘ç›˜ä¸‹è½½å­—å¹•æ–‡ä»¶åˆ°æœ¬åœ°STRMç›®å½•
   - æµ‹è¯•å­—å¹•æ–‡ä»¶ä¸STRMæ–‡ä»¶åœ¨åŒä¸€ç›®å½•
   - æµ‹è¯•å¤šä¸ªå­—å¹•æ–‡ä»¶ä¸‹è½½

2. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - æµ‹è¯•pick_codeæå–å¤±è´¥
   - æµ‹è¯•ä¸‹è½½å¤±è´¥
   - æµ‹è¯•ç½‘ç»œè¶…æ—¶

---

## ğŸ“‹ ä¹ã€æ€»ç»“

### 9.1 å®ç°å®Œæˆ

- âœ… **ç®€åŒ–äº†å­—å¹•æ–‡ä»¶ä¸‹è½½é€»è¾‘** - ç›´æ¥ä»ç½‘ç›˜ä¸‹è½½åˆ°æœ¬åœ°
- âœ… **ç§»é™¤äº†å¤æ‚çš„URLç”Ÿæˆ** - ä¸å†éœ€è¦ç”ŸæˆURLæ–‡ä»¶
- âœ… **ç¬¦åˆç”¨æˆ·éœ€æ±‚** - ç®€å•ã€å®ç”¨ã€é«˜æ•ˆ

### 9.2 ä»£ç å˜æ›´

**æ–‡ä»¶**: `backend/app/modules/strm/generator.py`

**å˜æ›´**:
- é‡å†™äº†`_generate_subtitle_files`æ–¹æ³•
- ç§»é™¤äº†`_generate_subtitle_url`æ–¹æ³•
- æ–°å¢äº†`_extract_pick_code_from_path`æ–¹æ³•
- æ–°å¢äº†`_download_subtitle_from_cloud`æ–¹æ³•

### 9.3 ä¸‹ä¸€æ­¥

1. **æµ‹è¯•åŠŸèƒ½** - ç¡®ä¿å­—å¹•æ–‡ä»¶ä¸‹è½½æ­£å¸¸å·¥ä½œ
2. **ä¼˜åŒ–é”™è¯¯å¤„ç†** - å®Œå–„é”™è¯¯æç¤ºå’Œå¤„ç†
3. **è‡ªåŠ¨æŸ¥æ‰¾å­—å¹•æ–‡ä»¶** - åœ¨STRMåŒæ­¥æ—¶è‡ªåŠ¨æŸ¥æ‰¾å…³è”å­—å¹•æ–‡ä»¶

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

