# å¤šé€šçŸ¥æ¸ é“å’Œç´¢å¼•å™¨è§£æå™¨å®ç°æ€»ç»“

**å®ç°æ—¶é—´**: 2025-01-XX  
**åŠŸèƒ½**: å¤šé€šçŸ¥æ¸ é“ï¼ˆTelegramã€WeChatï¼‰å’Œç´¢å¼•å™¨è§£æå™¨æ‰©å±•ï¼ˆGazelleã€Nexus PHPã€Unit3Dï¼‰

---

## ğŸ“‹ ä¸€ã€å¤šé€šçŸ¥æ¸ é“å®ç°

### 1.1 å®ç°å†…å®¹

#### âœ… Telegramé€šçŸ¥æ¸ é“

**æ–‡ä»¶**: `backend/app/modules/notification/channels/telegram.py`

**åŠŸèƒ½**:
- âœ… æ”¯æŒTelegram Bot APIå‘é€æ¶ˆæ¯
- âœ… æ”¯æŒMarkdownã€MarkdownV2ã€HTMLã€çº¯æ–‡æœ¬æ ¼å¼
- âœ… è‡ªåŠ¨è½¬ä¹‰MarkdownV2ç‰¹æ®Šå­—ç¬¦
- âœ… æ”¯æŒè‡ªå®šä¹‰API URLï¼ˆç”¨äºä»£ç†ï¼‰
- âœ… æ”¯æŒé“¾æ¥å’Œemoji
- âœ… é…ç½®éªŒè¯å’Œè¿æ¥æµ‹è¯•

**é…ç½®å‚æ•°**:
```python
{
    "bot_token": "YOUR_BOT_TOKEN",
    "chat_id": "YOUR_CHAT_ID",
    "parse_mode": "Markdown",  # Markdown, MarkdownV2, HTML, None
    "api_url": "https://api.telegram.org"  # å¯é€‰ï¼Œç”¨äºä»£ç†
}
```

#### âœ… WeChaté€šçŸ¥æ¸ é“

**æ–‡ä»¶**: `backend/app/modules/notification/channels/wechat.py`

**åŠŸèƒ½**:
- âœ… æ”¯æŒä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhookæ–¹å¼ï¼ˆæ¨èï¼‰
- âœ… æ”¯æŒä¼ä¸šå¾®ä¿¡APIæ–¹å¼ï¼ˆcorpidã€app_secretã€app_idï¼‰
- âœ… è‡ªåŠ¨Tokenç®¡ç†å’Œåˆ·æ–°
- âœ… æ”¯æŒé“¾æ¥å’Œemoji
- âœ… é…ç½®éªŒè¯å’Œè¿æ¥æµ‹è¯•

**é…ç½®å‚æ•°ï¼ˆWebhookæ–¹å¼ï¼‰**:
```python
{
    "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
}
```

**é…ç½®å‚æ•°ï¼ˆAPIæ–¹å¼ï¼‰**:
```python
{
    "corpid": "YOUR_CORPID",
    "app_secret": "YOUR_APP_SECRET",
    "app_id": "YOUR_APP_ID",
    "api_url": "https://qyapi.weixin.qq.com"  # å¯é€‰ï¼Œç”¨äºä»£ç†
}
```

### 1.2 æ¶æ„è®¾è®¡

```
NotificationChannelManager
â”œâ”€â”€ channel_instances (Dict[str, NotificationChannelBase])
â”‚   â”œâ”€â”€ TelegramChannel
â”‚   â””â”€â”€ WeChatChannel
â””â”€â”€ channel_handlers (å…¼å®¹æ—§æ–¹æ³•)
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒæ–°æ—§ä¸¤ç§æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… æ¸ é“é…ç½®å¯åŠ¨æ€æ›´æ–°
- âœ… ç»Ÿä¸€çš„æ¥å£å’Œé”™è¯¯å¤„ç†

### 1.3 ä½¿ç”¨æ–¹å¼

#### æ–¹å¼1: é€šè¿‡NotificationChannelManagerï¼ˆæ¨èï¼‰

```python
from app.modules.notification.channels import NotificationChannelManager

# åˆå§‹åŒ–ç®¡ç†å™¨ï¼ˆå¸¦é…ç½®ï¼‰
channel_configs = {
    "telegram": {
        "bot_token": "YOUR_BOT_TOKEN",
        "chat_id": "YOUR_CHAT_ID"
    },
    "wechat": {
        "webhook_url": "YOUR_WEBHOOK_URL"
    }
}
manager = NotificationChannelManager(channel_configs)

# å‘é€é€šçŸ¥
results = await manager.send(
    title="æµ‹è¯•é€šçŸ¥",
    message="è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
    notification_type="info",
    channels=["telegram", "wechat"]
)
```

#### æ–¹å¼2: ç›´æ¥ä½¿ç”¨æ¸ é“ç±»

```python
from app.modules.notification.channels.telegram import TelegramChannel

channel = TelegramChannel({
    "bot_token": "YOUR_BOT_TOKEN",
    "chat_id": "YOUR_CHAT_ID"
})

result = await channel.send(
    title="æµ‹è¯•é€šçŸ¥",
    message="è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
    notification_type="info"
)
```

### 1.4 å¾…å®ç°åŠŸèƒ½

- â³ é€šçŸ¥æ¸ é“é…ç½®APIï¼ˆç”¨äºå‰ç«¯é…ç½®ï¼‰
- â³ é€šçŸ¥æ¸ é“é…ç½®æ•°æ®åº“å­˜å‚¨
- â³ å‰ç«¯é€šçŸ¥æ¸ é“é…ç½®ç•Œé¢
- â³ æ›´å¤šé€šçŸ¥æ¸ é“ï¼ˆSlackã€WebPushç­‰ï¼‰

---

## ğŸ“‹ äºŒã€ç´¢å¼•å™¨è§£æå™¨æ‰©å±•å®ç°

### 2.1 å®ç°å†…å®¹

#### âœ… è§£æå™¨åŸºç¡€ç±»

**æ–‡ä»¶**: `backend/app/modules/search/parsers/base.py`

**åŠŸèƒ½**:
- âœ… å®šä¹‰è§£æå™¨æ¥å£ï¼ˆ`parse_search_results`ã€`parse_torrent_detail`ï¼‰
- âœ… æä¾›é€šç”¨å·¥å…·æ–¹æ³•ï¼ˆ`extract_info_hash`ã€`parse_size`ã€`parse_date`ï¼‰
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

#### âœ… Gazelleæ¡†æ¶è§£æå™¨

**æ–‡ä»¶**: `backend/app/modules/search/parsers/gazelle.py`

**åŠŸèƒ½**:
- âœ… è§£æGazelleæ¡†æ¶çš„æœç´¢ç»“æœé¡µé¢
- âœ… è§£æGazelleæ¡†æ¶çš„ç§å­è¯¦æƒ…é¡µé¢
- âœ… æ”¯æŒå¤šç§Gazelleå˜ä½“ï¼ˆPTPã€BTNç­‰ï¼‰

**æ”¯æŒçš„ç«™ç‚¹**:
- PassThePopcorn (PTP)
- BroadcastTheNet (BTN)
- å…¶ä»–ä½¿ç”¨Gazelleæ¡†æ¶çš„PTç«™ç‚¹

#### âœ… Nexus PHPæ¡†æ¶è§£æå™¨

**æ–‡ä»¶**: `backend/app/modules/search/parsers/nexus_php.py`

**åŠŸèƒ½**:
- âœ… è§£æNexus PHPæ¡†æ¶çš„æœç´¢ç»“æœé¡µé¢
- âœ… è§£æNexus PHPæ¡†æ¶çš„ç§å­è¯¦æƒ…é¡µé¢
- âœ… æ”¯æŒå¤šç§Nexus PHPå˜ä½“

**æ”¯æŒçš„ç«™ç‚¹**:
- å¤§å¤šæ•°ä½¿ç”¨Nexus PHPæ¡†æ¶çš„PTç«™ç‚¹

#### âœ… Unit3Dæ¡†æ¶è§£æå™¨

**æ–‡ä»¶**: `backend/app/modules/search/parsers/unit3d.py`

**åŠŸèƒ½**:
- âœ… è§£æUnit3Dæ¡†æ¶çš„æœç´¢ç»“æœé¡µé¢
- âœ… è§£æUnit3Dæ¡†æ¶çš„ç§å­è¯¦æƒ…é¡µé¢
- âœ… æ”¯æŒç°ä»£åŒ–çš„Unit3Då¸ƒå±€

**æ”¯æŒçš„ç«™ç‚¹**:
- ä½¿ç”¨Unit3Dæ¡†æ¶çš„PTç«™ç‚¹

### 2.2 æ¶æ„è®¾è®¡

```
ParserBase (åŸºç±»)
â”œâ”€â”€ GazelleParser
â”œâ”€â”€ NexusPHPParser
â””â”€â”€ Unit3DParser

PrivateIndexer
â””â”€â”€ parser: ParserBase (å¯é€‰)
```

**ç‰¹ç‚¹**:
- âœ… è§£æå™¨å¯æ’æ‹”ï¼ˆå¯é€‰ï¼‰
- âœ… è‡ªåŠ¨æ£€æµ‹è§£æå™¨ç±»å‹
- âœ… ç»Ÿä¸€çš„è§£æç»“æœæ ¼å¼

### 2.3 é›†æˆæ–¹å¼

#### æ–¹å¼1: è‡ªåŠ¨æ£€æµ‹ï¼ˆæ¨èï¼‰

```python
from app.modules.search.indexers.private_indexer import PrivateIndexer
from app.modules.search.indexers.base import IndexerConfig

config = IndexerConfig(
    name="MyPT",
    base_url="https://mypt.example.com",
    cookie="YOUR_COOKIE",
    parser_type="gazelle"  # å¯é€‰ï¼šgazelle, nexus_php, unit3d
)

indexer = PrivateIndexer(config)
# è§£æå™¨ä¼šè‡ªåŠ¨æ ¹æ®parser_typeåˆ›å»º
```

#### æ–¹å¼2: æ‰‹åŠ¨æŒ‡å®šè§£æå™¨

```python
from app.modules.search.indexers.private_indexer import PrivateIndexer
from app.modules.search.indexers.base import IndexerConfig
from app.modules.search.parsers.gazelle import GazelleParser

config = IndexerConfig(
    name="MyPT",
    base_url="https://mypt.example.com",
    cookie="YOUR_COOKIE"
)

parser = GazelleParser("MyPT", config.base_url)
indexer = PrivateIndexer(config, parser=parser)
```

### 2.4 è§£æç»“æœæ ¼å¼

æ‰€æœ‰è§£æå™¨è¿”å›ç»Ÿä¸€çš„ç»“æœæ ¼å¼ï¼š

**æœç´¢ç»“æœ**:
```python
{
    "title": "Movie Name 2023 1080p x265 BluRay",
    "magnet_link": "magnet:?xt=urn:btih:...",
    "torrent_url": "https://site.com/torrents/12345",
    "size_gb": 10.5,
    "seeders": 100,
    "leechers": 20,
    "upload_date": "2023-01-01T00:00:00",
    "info_hash": "abc123...",
    "site": "MyPT"
}
```

**ç§å­è¯¦æƒ…**:
```python
{
    "title": "Movie Name 2023 1080p x265 BluRay",
    "description": "Full description...",
    "magnet_link": "magnet:?xt=urn:btih:...",
    "torrent_url": "https://site.com/download/12345",
    "size_gb": 10.5,
    "seeders": 100,
    "leechers": 20,
    "upload_date": "2023-01-01T00:00:00",
    "uploader": "UploaderName",
    "category": "Movies"
}
```

### 2.5 å¾…å®ç°åŠŸèƒ½

- â³ æ›´å¤šè§£æå™¨ï¼ˆDiscuzã€IPT Projectã€TorrentLeechç­‰ï¼‰
- â³ è§£æå™¨é…ç½®æ•°æ®åº“å­˜å‚¨
- â³ è§£æå™¨è‡ªåŠ¨é€‰æ‹©ä¼˜åŒ–
- â³ è§£æå™¨æ€§èƒ½ç›‘æ§

---

## ğŸ“‹ ä¸‰ã€æ–‡ä»¶ç»“æ„

```
backend/app/modules/
â”œâ”€â”€ notification/
â”‚   â”œâ”€â”€ channels/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py              # é€šçŸ¥æ¸ é“åŸºç±»
â”‚   â”‚   â”œâ”€â”€ telegram.py          # Telegramæ¸ é“
â”‚   â”‚   â””â”€â”€ wechat.py            # WeChatæ¸ é“
â”‚   â”œâ”€â”€ channels.py              # é€šçŸ¥æ¸ é“ç®¡ç†å™¨ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â””â”€â”€ service.py               # é€šçŸ¥æœåŠ¡
â”‚
â””â”€â”€ search/
    â”œâ”€â”€ parsers/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ base.py              # è§£æå™¨åŸºç±»
    â”‚   â”œâ”€â”€ gazelle.py           # Gazelleè§£æå™¨
    â”‚   â”œâ”€â”€ nexus_php.py         # Nexus PHPè§£æå™¨
    â”‚   â””â”€â”€ unit3d.py            # Unit3Dè§£æå™¨
    â””â”€â”€ indexers/
        â”œâ”€â”€ base.py              # ç´¢å¼•å™¨åŸºç±»
        â”œâ”€â”€ private_indexer.py   # ç§æœ‰ç´¢å¼•å™¨ï¼ˆå·²æ›´æ–°ï¼‰
        â””â”€â”€ public_indexer.py    # å…¬å¼€ç´¢å¼•å™¨
```

---

## ğŸ“‹ å››ã€ä¾èµ–åº“

### é€šçŸ¥æ¸ é“

**Telegram**:
- `httpx` - HTTPå®¢æˆ·ç«¯ï¼ˆå·²å­˜åœ¨ï¼‰

**WeChat**:
- `httpx` - HTTPå®¢æˆ·ç«¯ï¼ˆå·²å­˜åœ¨ï¼‰

### è§£æå™¨

**æ‰€æœ‰è§£æå™¨**:
- `lxml` - HTMLè§£æï¼ˆéœ€è¦æ·»åŠ åˆ°requirements.txtï¼‰
- `beautifulsoup4` - HTMLè§£æï¼ˆå¯é€‰ï¼Œå·²å­˜åœ¨ï¼‰

---

## ğŸ“‹ äº”ã€é…ç½®å»ºè®®

### 5.1 requirements.txt

éœ€è¦æ·»åŠ ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰:
```txt
lxml>=4.9.0  # HTMLè§£æ
```

### 5.2 ç¯å¢ƒå˜é‡

é€šçŸ¥æ¸ é“é…ç½®å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è®¾ç½®ï¼š

```bash
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

# WeChat (Webhookæ–¹å¼)
WECHAT_WEBHOOK_URL=your_webhook_url

# WeChat (APIæ–¹å¼)
WECHAT_CORPID=your_corpid
WECHAT_APP_SECRET=your_app_secret
WECHAT_APP_ID=your_app_id
```

---

## ğŸ“‹ å…­ã€æµ‹è¯•å»ºè®®

### 6.1 é€šçŸ¥æ¸ é“æµ‹è¯•

```python
# æµ‹è¯•Telegram
from app.modules.notification.channels.telegram import TelegramChannel

channel = TelegramChannel({
    "bot_token": "YOUR_BOT_TOKEN",
    "chat_id": "YOUR_CHAT_ID"
})

result = await channel.test_connection()
print(result)

# æµ‹è¯•WeChat
from app.modules.notification.channels.wechat import WeChatChannel

channel = WeChatChannel({
    "webhook_url": "YOUR_WEBHOOK_URL"
})

result = await channel.test_connection()
print(result)
```

### 6.2 è§£æå™¨æµ‹è¯•

```python
# æµ‹è¯•Gazelleè§£æå™¨
from app.modules.search.parsers.gazelle import GazelleParser

parser = GazelleParser("TestSite", "https://example.com")
html = "<html>...</html>"  # å®é™…çš„æœç´¢ç»“æœHTML

results = parser.parse_search_results(html)
print(results)
```

---

## ğŸ“‹ ä¸ƒã€åç»­å¼€å‘è®¡åˆ’

### 7.1 é€šçŸ¥æ¸ é“

1. **é€šçŸ¥æ¸ é“é…ç½®API** (é«˜ä¼˜å…ˆçº§)
   - åˆ›å»º `backend/app/api/notification_channels.py`
   - æä¾›æ¸ é“é…ç½®çš„CRUDæ“ä½œ
   - æ”¯æŒæµ‹è¯•è¿æ¥åŠŸèƒ½

2. **é€šçŸ¥æ¸ é“é…ç½®æ•°æ®åº“å­˜å‚¨** (ä¸­ä¼˜å…ˆçº§)
   - åˆ›å»º `NotificationChannelConfig` æ¨¡å‹
   - æ”¯æŒå¤šç”¨æˆ·é…ç½®

3. **å‰ç«¯é…ç½®ç•Œé¢** (ä¸­ä¼˜å…ˆçº§)
   - åœ¨è®¾ç½®é¡µé¢æ·»åŠ é€šçŸ¥æ¸ é“é…ç½®
   - æ”¯æŒæµ‹è¯•é€šçŸ¥åŠŸèƒ½

4. **æ›´å¤šé€šçŸ¥æ¸ é“** (ä½ä¼˜å…ˆçº§)
   - Slack
   - WebPush
   - VoceChat

### 7.2 è§£æå™¨

1. **æ›´å¤šè§£æå™¨** (ä¸­ä¼˜å…ˆçº§)
   - Discuzè®ºå›è§£æå™¨
   - IPT Projectè§£æå™¨
   - TorrentLeechè§£æå™¨

2. **è§£æå™¨é…ç½®ä¼˜åŒ–** (ä¸­ä¼˜å…ˆçº§)
   - è§£æå™¨é…ç½®æ•°æ®åº“å­˜å‚¨
   - è§£æå™¨è‡ªåŠ¨é€‰æ‹©ä¼˜åŒ–

3. **è§£æå™¨æ€§èƒ½ç›‘æ§** (ä½ä¼˜å…ˆçº§)
   - è§£ææˆåŠŸç‡ç»Ÿè®¡
   - è§£æé€Ÿåº¦ç›‘æ§

---

## ğŸ“‹ å…«ã€æ€»ç»“

### âœ… å·²å®Œæˆ

1. âœ… Telegramé€šçŸ¥æ¸ é“ï¼ˆå®Œæ•´å®ç°ï¼‰
2. âœ… WeChaté€šçŸ¥æ¸ é“ï¼ˆå®Œæ•´å®ç°ï¼‰
3. âœ… NotificationChannelManageræ›´æ–°ï¼ˆæ”¯æŒæ–°æ¸ é“ï¼‰
4. âœ… è§£æå™¨åŸºç¡€ç±»ï¼ˆå®Œæ•´å®ç°ï¼‰
5. âœ… Gazelleè§£æå™¨ï¼ˆå®Œæ•´å®ç°ï¼‰
6. âœ… Nexus PHPè§£æå™¨ï¼ˆå®Œæ•´å®ç°ï¼‰
7. âœ… Unit3Dè§£æå™¨ï¼ˆå®Œæ•´å®ç°ï¼‰
8. âœ… è§£æå™¨é›†æˆåˆ°ç´¢å¼•å™¨ï¼ˆå·²å®Œæˆï¼‰

### â³ å¾…å®Œæˆ

1. â³ é€šçŸ¥æ¸ é“é…ç½®API
2. â³ é€šçŸ¥æ¸ é“é…ç½®æ•°æ®åº“å­˜å‚¨
3. â³ å‰ç«¯é€šçŸ¥æ¸ é“é…ç½®ç•Œé¢
4. â³ æ›´å¤šè§£æå™¨å®ç°
5. â³ è§£æå™¨é…ç½®ä¼˜åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-XX

