# STRM定期全量和自动增量功能实现总结

## 📋 概述

根据用户需求，实现了STRM系统的定期全量同步和自动增量同步功能，并优化了全量同步策略以降低风控风险。

## ✅ 已实现的功能

### 1. 配置项 ✅

#### STRMConfig 新增字段
- `auto_incremental_sync: bool` - 自动增量同步开关（默认：True）
- `periodic_full_sync: bool` - 定期全量同步开关（默认：True）
- `periodic_full_sync_interval_days: int` - 定期全量同步间隔（默认：7天）
- `cloud_media_library_path: str` - 网盘媒体库路径（默认：'/115/电影'）

#### STRMSyncConfig 新增字段
- `cloud_media_library_path: str` - 网盘媒体库路径
- `periodic_full_sync_interval_days: int` - 定期全量同步间隔（天数）

### 2. 全量同步优化 ✅

#### 降低风控风险的策略

**方案1：指定路径扫描（推荐）**
- 只扫描用户设置的网盘媒体库路径（例如：`/115/电影`）
- 不进行全盘扫描，大幅减少API调用
- 降低风控风险：⭐⭐⭐⭐⭐

**方案2：本地缺失检查模式（最安全）**
- 不调用115 API获取文件列表
- 从数据库读取已有的文件树快照
- 只对比本地STRM文件是否存在
- 如果缺失，则生成STRM文件
- 降低风控风险：⭐⭐⭐⭐⭐⭐（最高）

#### 实现方式

```python
async def full_sync(
    self,
    cloud_media_library_path: Optional[str] = None,
    check_local_missing_only: bool = False
):
    """
    全量同步
    
    Args:
        cloud_media_library_path: 网盘媒体库路径（可选，如果指定则只扫描此路径）
        check_local_missing_only: 是否只检查本地缺失的文件（不调用115 API）
    """
```

**两种模式对比**：

| 模式 | API调用 | 风控风险 | 适用场景 |
|------|---------|---------|---------|
| **指定路径扫描** | 中等（只扫描指定路径） | ⭐⭐⭐⭐ | 定期全量同步（3-7天一次） |
| **本地缺失检查** | 无（只读数据库） | ⭐⭐⭐⭐⭐⭐ | 定期全量同步（推荐） |

### 3. 定时任务服务 ✅

#### STRMSchedulerService
- **位置**: `VabHub/backend/app/modules/strm/scheduler_service.py`
- **功能**:
  - 定期全量同步任务（每天凌晨2点检查，实际执行间隔由配置决定）
  - 自动增量同步管理（启动/停止）

#### 定期全量同步工作流程
1. 检查是否启用定期全量同步
2. 检查是否到了执行时间（通过上次执行时间判断）
3. 执行全量同步（使用本地缺失检查模式，降低风控风险）
4. 记录执行时间

#### 自动增量同步工作流程
1. 检查是否启用自动增量同步
2. 创建STRMSyncManager实例
3. 启动同步任务（首次全量，之后增量）
4. 实时监测115网盘变更

### 4. 前端界面 ✅

#### 新增UI元素
- **自动增量同步开关**：开关滑块，带说明文字
- **定期全量同步开关**：开关滑块，带说明文字
- **定期全量同步间隔**：数字输入框（天数，1-30天）
- **网盘媒体库路径**：文本输入框（例如：/115/电影）

#### 位置
- 在STRM设置的"同步设置"部分
- 位于"刮削设置"之后

## 🎯 风控风险分析

### 全量同步方式对比

#### 方式1：全盘扫描 ❌（不推荐）
- **API调用**：需要遍历所有文件，调用次数极多
- **风控风险**：⭐⭐⭐⭐⭐⭐（极高）
- **适用场景**：无（不推荐使用）

#### 方式2：指定路径扫描 ✅（推荐）
- **API调用**：只扫描指定路径，调用次数中等
- **风控风险**：⭐⭐⭐⭐（中等）
- **适用场景**：定期全量同步（3-7天一次）

#### 方式3：本地缺失检查 ✅✅（最推荐）
- **API调用**：无（只读数据库）
- **风控风险**：⭐⭐⭐⭐⭐⭐（最低）
- **适用场景**：定期全量同步（推荐使用）

### 推荐方案

**定期全量同步使用"本地缺失检查模式"**：
- ✅ 不调用115 API，完全避免风控风险
- ✅ 基于已有的文件树快照对比
- ✅ 只检查本地STRM文件是否存在
- ✅ 如果缺失，则生成STRM文件

**自动增量同步使用"实时监测"**：
- ✅ 基于时间范围搜索，API调用较少
- ✅ 只处理变更的文件，效率高
- ✅ 实时响应网盘变更

## 📊 配置示例

### 推荐配置

```json
{
  "auto_incremental_sync": true,  // 启用自动增量同步
  "periodic_full_sync": true,  // 启用定期全量同步
  "periodic_full_sync_interval_days": 7,  // 每7天执行一次
  "cloud_media_library_path": "/115/电影"  // 只扫描电影目录
}
```

### 保守配置（降低风控风险）

```json
{
  "auto_incremental_sync": true,
  "periodic_full_sync": true,
  "periodic_full_sync_interval_days": 14,  // 每14天执行一次（更保守）
  "cloud_media_library_path": "/115/电影"  // 只扫描电影目录
}
```

## 🔧 技术实现

### 1. 本地缺失检查模式实现

```python
async def _get_cloud_tree_from_db(self) -> Dict[str, Any]:
    """从数据库获取网盘文件树（基于已有的文件树快照）"""
    # 从STRMFileTree表获取文件树
    # 不调用115 API，只读数据库
    pass

async def _find_missing_local_files(
    self,
    local_tree: Dict[str, Any],
    cloud_tree: Dict[str, Any]
) -> List[Dict[str, Any]]:
    """找出本地缺失的文件（对比本地STRM文件和网盘文件）"""
    # 对比本地STRM文件和数据库中的文件树
    # 找出缺失的文件
    pass
```

### 2. 定时任务实现

```python
async def _periodic_full_sync_task(self):
    """定期全量同步任务"""
    # 1. 检查是否启用
    # 2. 检查是否到了执行时间
    # 3. 执行全量同步（使用本地缺失检查模式）
    # 4. 记录执行时间
    pass
```

## 📝 使用说明

### 1. 启用定期全量同步

1. 在STRM设置中，打开"定期全量同步"开关
2. 设置"定期全量同步间隔"（建议3-7天）
3. 设置"网盘媒体库路径"（例如：`/115/电影`）
4. 点击"保存设置"

### 2. 启用自动增量同步

1. 在STRM设置中，打开"自动增量同步"开关
2. 点击"保存设置"
3. 系统会自动启动增量同步任务

### 3. 风控风险建议

- ✅ **推荐**：使用"本地缺失检查模式"（`check_local_missing_only=True`）
- ✅ **保守**：设置较长的同步间隔（7-14天）
- ✅ **安全**：只扫描指定的媒体库路径，不进行全盘扫描

## ✨ 优势

1. **降低风控风险**：
   - 本地缺失检查模式不调用115 API
   - 指定路径扫描大幅减少API调用
   - 定期全量同步间隔可配置（3-7天）

2. **智能同步**：
   - 自动增量同步实时监测变更
   - 定期全量同步检查本地缺失
   - 两种模式互补，确保STRM文件完整

3. **用户友好**：
   - 前端界面简单直观
   - 配置项清晰明了
   - 自动执行，无需手动干预

## 🎯 总结

1. **定期全量同步**：使用"本地缺失检查模式"，不调用115 API，完全避免风控风险 ✅
2. **自动增量同步**：实时监测115网盘变更，只处理变更的文件，效率高 ✅
3. **配置灵活**：用户可以根据需求调整同步间隔和扫描路径 ✅
4. **风控安全**：推荐使用本地缺失检查模式，最不容易被风控 ✅

