# åª’ä½“è¯†åˆ«å†å²è®°å½•åŠŸèƒ½è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

VabHubç°åœ¨å®ç°äº†**å®Œæ•´çš„åª’ä½“è¯†åˆ«å†å²è®°å½•åŠŸèƒ½**ï¼Œå¯ä»¥è‡ªåŠ¨ä¿å­˜æ¯æ¬¡è¯†åˆ«ç»“æœï¼Œå¹¶æä¾›æŸ¥è¯¢ã€ç»Ÿè®¡å’Œæ¸…ç†åŠŸèƒ½ã€‚

**å®Œæˆæ—¶é—´**: 2025-11-08  
**çŠ¶æ€**: âœ… åª’ä½“è¯†åˆ«å†å²è®°å½•åŠŸèƒ½å·²å®ç°

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨ä¿å­˜è¯†åˆ«å†å²
- æ¯æ¬¡è¯†åˆ«è‡ªåŠ¨ä¿å­˜ç»“æœ
- ä¿å­˜æ–‡ä»¶è·¯å¾„ã€æ–‡ä»¶åã€æ–‡ä»¶å¤§å°
- ä¿å­˜è¯†åˆ«ç»“æœï¼ˆæ ‡é¢˜ã€å¹´ä»½ã€å­£æ•°ã€é›†æ•°ç­‰ï¼‰
- ä¿å­˜è¯†åˆ«æ¥æºå’Œç½®ä¿¡åº¦
- ä¿å­˜åŸå§‹è¯†åˆ«ç»“æœï¼ˆJSONæ ¼å¼ï¼‰

### 2. å†å²è®°å½•æŸ¥è¯¢
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- æ”¯æŒå¤šæ¡ä»¶è¿‡æ»¤ï¼š
  - æ–‡ä»¶è·¯å¾„ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
  - æ ‡é¢˜ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
  - åª’ä½“ç±»å‹ï¼ˆmovie, tv, unknownï¼‰
  - æˆåŠŸçŠ¶æ€ï¼ˆtrue, falseï¼‰
  - æ—¥æœŸèŒƒå›´ï¼ˆå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸï¼‰
- æŒ‰è¯†åˆ«æ—¶é—´å€’åºæ’åˆ—

### 3. ç»Ÿè®¡ä¿¡æ¯
- æ€»è®°å½•æ•°
- æˆåŠŸ/å¤±è´¥è®°å½•æ•°
- æˆåŠŸç‡
- æŒ‰åª’ä½“ç±»å‹ç»Ÿè®¡
- æŒ‰è¯†åˆ«æ¥æºç»Ÿè®¡
- å¹³å‡ç½®ä¿¡åº¦

### 4. å†å²è®°å½•ç®¡ç†
- åˆ é™¤å•æ¡è®°å½•
- æ¸…ç†å†å²è®°å½•ï¼ˆä¿ç•™æœ€è¿‘Nå¤©ï¼‰
- æ¸…ç†æ‰€æœ‰å†å²è®°å½•

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ•°æ®æ¨¡å‹

```python
class IdentificationHistory(Base):
    """åª’ä½“è¯†åˆ«å†å²è®°å½•æ¨¡å‹"""
    id: int
    file_path: str  # æ–‡ä»¶è·¯å¾„
    file_name: str  # åŸå§‹æ–‡ä»¶å
    file_size: int  # æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    title: str  # è¯†åˆ«å‡ºçš„æ ‡é¢˜
    year: int  # å¹´ä»½
    season: int  # å­£æ•°ï¼ˆç”µè§†å‰§ï¼‰
    episode: int  # é›†æ•°ï¼ˆç”µè§†å‰§ï¼‰
    media_type: str  # åª’ä½“ç±»å‹
    confidence: float  # è¯†åˆ«ç½®ä¿¡åº¦
    source: str  # è¯†åˆ«æ¥æº
    success: str  # æ˜¯å¦æˆåŠŸ
    error: str  # é”™è¯¯ä¿¡æ¯
    raw_result: JSON  # åŸå§‹è¯†åˆ«ç»“æœ
    identified_at: datetime  # è¯†åˆ«æ—¶é—´
```

### è‡ªåŠ¨ä¿å­˜æœºåˆ¶

è¯†åˆ«æœåŠ¡åœ¨æ¯æ¬¡è¯†åˆ«å®Œæˆåè‡ªåŠ¨ä¿å­˜å†å²è®°å½•ï¼š

```python
# è¯†åˆ«å®Œæˆåè‡ªåŠ¨ä¿å­˜
await self._save_history(
    file_path=file_path,
    file_name=file_name,
    file_size=file_size,
    result=identification_result
)
```

---

## ğŸ“Š APIç«¯ç‚¹

### 1. è·å–è¯†åˆ«å†å²è®°å½•åˆ—è¡¨
```bash
GET /api/v1/media-identification/history?limit=50&offset=0&title=xxx&media_type=movie
```

**æŸ¥è¯¢å‚æ•°**:
- `limit`: è¿”å›è®°å½•æ•°ï¼ˆé»˜è®¤50ï¼‰
- `offset`: åç§»é‡ï¼ˆé»˜è®¤0ï¼‰
- `file_path`: æ–‡ä»¶è·¯å¾„è¿‡æ»¤ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
- `title`: æ ‡é¢˜è¿‡æ»¤ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
- `media_type`: åª’ä½“ç±»å‹è¿‡æ»¤ï¼ˆmovie, tv, unknownï¼‰
- `success`: æˆåŠŸçŠ¶æ€è¿‡æ»¤ï¼ˆtrue, falseï¼‰
- `start_date`: å¼€å§‹æ—¥æœŸï¼ˆISOæ ¼å¼ï¼‰
- `end_date`: ç»“æŸæ—¥æœŸï¼ˆISOæ ¼å¼ï¼‰

**å“åº”**:
```json
{
  "total": 100,
  "limit": 50,
  "offset": 0,
  "results": [
    {
      "id": 1,
      "file_path": "/path/to/file.mkv",
      "file_name": "file.mkv",
      "file_size": 1024000,
      "title": "Movie Title",
      "year": 2023,
      "media_type": "movie",
      "confidence": 0.95,
      "source": "filename_parser",
      "success": true,
      "identified_at": "2025-11-08T10:00:00Z"
    }
  ]
}
```

### 2. è·å–å•ä¸ªè¯†åˆ«å†å²è®°å½•
```bash
GET /api/v1/media-identification/history/{history_id}
```

### 3. åˆ é™¤è¯†åˆ«å†å²è®°å½•
```bash
DELETE /api/v1/media-identification/history/{history_id}
```

### 4. æ¸…ç†è¯†åˆ«å†å²è®°å½•
```bash
DELETE /api/v1/media-identification/history?days=30
```

**æŸ¥è¯¢å‚æ•°**:
- `days`: ä¿ç•™æœ€è¿‘Nå¤©çš„è®°å½•ï¼Œå¦‚æœä¸ºç©ºåˆ™æ¸…ç†æ‰€æœ‰è®°å½•

### 5. è·å–è¯†åˆ«å†å²ç»Ÿè®¡ä¿¡æ¯
```bash
GET /api/v1/media-identification/history/statistics
```

**å“åº”**:
```json
{
  "total": 1000,
  "success_count": 950,
  "failed_count": 50,
  "success_rate": 95.0,
  "type_stats": {
    "movie": 600,
    "tv": 350,
    "unknown": 50
  },
  "source_stats": {
    "filename_parser": 800,
    "enhanced_identification": 150
  },
  "avg_confidence": 0.92
}
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### æŸ¥è¯¢æœ€è¿‘çš„è¯†åˆ«è®°å½•
```bash
curl -X GET "http://localhost:8000/api/v1/media-identification/history?limit=10"
```

### æŒ‰æ ‡é¢˜æŸ¥è¯¢
```bash
curl -X GET "http://localhost:8000/api/v1/media-identification/history?title=Movie"
```

### æŒ‰åª’ä½“ç±»å‹æŸ¥è¯¢
```bash
curl -X GET "http://localhost:8000/api/v1/media-identification/history?media_type=movie"
```

### è·å–ç»Ÿè®¡ä¿¡æ¯
```bash
curl -X GET "http://localhost:8000/api/v1/media-identification/history/statistics"
```

### æ¸…ç†30å¤©å‰çš„è®°å½•
```bash
curl -X DELETE "http://localhost:8000/api/v1/media-identification/history?days=30"
```

---

## ğŸ” æ•°æ®åº“è¿ç§»

### è¿è¡Œè¿ç§»è„šæœ¬
```bash
python backend/migrate_add_identification_history.py
```

### è‡ªåŠ¨åˆ›å»º
å¦‚æœä½¿ç”¨`init_db()`åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¡¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆéœ€è¦å¯¼å…¥æ¨¡å‹ï¼‰ã€‚

---

## âœ… æ€»ç»“

### ä¼˜åŠ¿
1. âœ… **è‡ªåŠ¨ä¿å­˜**: æ¯æ¬¡è¯†åˆ«è‡ªåŠ¨ä¿å­˜å†å²
2. âœ… **çµæ´»æŸ¥è¯¢**: æ”¯æŒå¤šæ¡ä»¶è¿‡æ»¤å’Œåˆ†é¡µ
3. âœ… **ç»Ÿè®¡åˆ†æ**: æä¾›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
4. âœ… **å†å²ç®¡ç†**: æ”¯æŒåˆ é™¤å’Œæ¸…ç†å†å²è®°å½•
5. âœ… **æ•°æ®å®Œæ•´**: ä¿å­˜å®Œæ•´çš„è¯†åˆ«ç»“æœå’ŒåŸå§‹æ•°æ®

### åº”ç”¨åœºæ™¯
1. **è¯†åˆ«è®°å½•è¿½è¸ª**: æŸ¥çœ‹å†å²è¯†åˆ«è®°å½•
2. **è¯†åˆ«æ•ˆæœåˆ†æ**: é€šè¿‡ç»Ÿè®¡ä¿¡æ¯åˆ†æè¯†åˆ«æ•ˆæœ
3. **é—®é¢˜æ’æŸ¥**: é€šè¿‡å†å²è®°å½•æ’æŸ¥è¯†åˆ«é—®é¢˜
4. **æ•°æ®æ¸…ç†**: å®šæœŸæ¸…ç†æ—§çš„å†å²è®°å½•

---

**æœ€åæ›´æ–°**: 2025-11-08  
**çŠ¶æ€**: âœ… åª’ä½“è¯†åˆ«å†å²è®°å½•åŠŸèƒ½å·²å®ç°

