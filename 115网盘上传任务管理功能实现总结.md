# 115ç½‘ç›˜ä¸Šä¼ ä»»åŠ¡ç®¡ç†åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

åŸºäºç”¨æˆ·éœ€æ±‚ï¼Œå®ç°äº†å®Œæ•´çš„115ç½‘ç›˜ä¸Šä¼ ä»»åŠ¡ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ä»»åŠ¡é˜Ÿåˆ—ã€çŠ¶æ€è·Ÿè¸ªã€é‡è¯•æœºåˆ¶ã€å¹¶å‘æ§åˆ¶ã€è¿›åº¦æŒä¹…åŒ–ã€é€Ÿåº¦é™åˆ¶å’Œä¸Šä¼ éªŒè¯ç­‰åŠŸèƒ½ã€‚

## âœ… å·²å®ç°åŠŸèƒ½

### 1. æ•°æ®åº“æ¨¡å‹ (`app/models/upload.py`)

#### UploadTaskï¼ˆä¸Šä¼ ä»»åŠ¡æ¨¡å‹ï¼‰

**æ ¸å¿ƒå­—æ®µ**ï¼š
- æ–‡ä»¶ä¿¡æ¯ï¼š`file_path`, `file_name`, `file_size`, `file_sha1`, `file_pre_sha1`
- ç›®æ ‡ä¿¡æ¯ï¼š`target_parent_id`, `target_path`
- ä¸Šä¼ ä¿¡æ¯ï¼š`upload_method`, `pick_code`, `bucket`, `object_key`, `upload_id`
- çŠ¶æ€ä¿¡æ¯ï¼š`status`, `progress`, `uploaded_bytes`, `total_bytes`
- åˆ†ç‰‡ä¿¡æ¯ï¼š`part_size`, `total_parts`, `completed_parts`, `parts_info`
- é‡è¯•ä¿¡æ¯ï¼š`retry_count`, `max_retries`, `last_error`, `error_history`
- éªŒè¯ä¿¡æ¯ï¼š`etag`, `verification_status`, `verification_result`
- é€Ÿåº¦é™åˆ¶ï¼š`speed_limit`, `current_speed`
- æ—¶é—´æˆ³ï¼š`created_at`, `updated_at`, `started_at`, `completed_at`

**çŠ¶æ€æšä¸¾** (`UploadTaskStatus`)ï¼š
- `PENDING`: ç­‰å¾…ä¸­
- `QUEUED`: å·²æ’é˜Ÿ
- `INITIALIZING`: åˆå§‹åŒ–ä¸­
- `CALCULATING_HASH`: è®¡ç®—å“ˆå¸Œä¸­
- `UPLOADING`: ä¸Šä¼ ä¸­
- `VERIFYING`: éªŒè¯ä¸­
- `COMPLETED`: å·²å®Œæˆ
- `FAILED`: å¤±è´¥
- `CANCELLED`: å·²å–æ¶ˆ
- `PAUSED`: å·²æš‚åœ
- `RESUMING`: æ¢å¤ä¸­

#### UploadProgressï¼ˆä¸Šä¼ è¿›åº¦è®°å½•ï¼‰

**æ ¸å¿ƒå­—æ®µ**ï¼š
- è¿›åº¦ä¿¡æ¯ï¼š`uploaded_bytes`, `total_bytes`, `progress`
- åˆ†ç‰‡è¿›åº¦ï¼š`completed_parts`, `total_parts`, `parts_info`
- é€Ÿåº¦ä¿¡æ¯ï¼š`current_speed`, `average_speed`
- æ—¶é—´ä¿¡æ¯ï¼š`elapsed_time`, `estimated_remaining`
- æ—¶é—´æˆ³ï¼š`recorded_at`

### 2. ä¸Šä¼ ä»»åŠ¡ç®¡ç†å™¨ (`app/modules/upload/task_manager.py`)

#### æ ¸å¿ƒåŠŸèƒ½

**ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†**ï¼š
- ä½¿ç”¨ `asyncio.Queue` å®ç°ä»»åŠ¡é˜Ÿåˆ—
- æ”¯æŒä»»åŠ¡æ·»åŠ ã€å–æ¶ˆã€æš‚åœã€æ¢å¤
- è‡ªåŠ¨ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶å¤„ç†

**å¹¶å‘æ§åˆ¶**ï¼š
- ä½¿ç”¨ `asyncio.Semaphore` é™åˆ¶æœ€å¤§å¹¶å‘æ•°ï¼ˆé»˜è®¤3ï¼‰
- æ”¯æŒåŠ¨æ€è°ƒæ•´å¹¶å‘æ•°

**çŠ¶æ€è·Ÿè¸ª**ï¼š
- å®æ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€
- è®°å½•ä»»åŠ¡è¿›åº¦ã€å·²ä¸Šä¼ å­—èŠ‚æ•°ã€åˆ†ç‰‡ä¿¡æ¯ç­‰

**é‡è¯•æœºåˆ¶**ï¼š
- æ”¯æŒè‡ªåŠ¨é‡è¯•ï¼ˆé»˜è®¤æœ€å¤§3æ¬¡ï¼‰
- è®°å½•é”™è¯¯å†å²å’Œé‡è¯•æ¬¡æ•°
- å¯é…ç½®é‡è¯•å»¶è¿Ÿï¼ˆé»˜è®¤5ç§’ï¼‰

**è¿›åº¦æŒä¹…åŒ–**ï¼š
- å®æ—¶ä¿å­˜ä¸Šä¼ è¿›åº¦åˆ°æ•°æ®åº“
- æ”¯æŒä»è¿›åº¦è®°å½•æ¢å¤æ–­ç‚¹ç»­ä¼ 
- è®°å½•é€Ÿåº¦ä¿¡æ¯å’Œæ—¶é—´ä¼°ç®—

**ä»»åŠ¡ç®¡ç†API**ï¼š
- `add_task()`: æ·»åŠ ä¸Šä¼ ä»»åŠ¡
- `get_task()`: è·å–ä»»åŠ¡ä¿¡æ¯
- `list_tasks()`: åˆ—å‡ºä»»åŠ¡ï¼ˆæ”¯æŒçŠ¶æ€å’Œç”¨æˆ·è¿‡æ»¤ï¼‰
- `cancel_task()`: å–æ¶ˆä»»åŠ¡
- `pause_task()`: æš‚åœä»»åŠ¡
- `resume_task()`: æ¢å¤ä»»åŠ¡

### 3. é€Ÿåº¦é™åˆ¶å™¨ (`app/modules/upload/speed_limiter.py`)

#### æ ¸å¿ƒåŠŸèƒ½

**é€Ÿåº¦é™åˆ¶**ï¼š
- æ”¯æŒè®¾ç½®ä¸Šä¼ é€Ÿåº¦é™åˆ¶ï¼ˆå­—èŠ‚/ç§’ï¼‰
- è‡ªåŠ¨è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´
- å®æ—¶ç›‘æ§å½“å‰ä¸Šä¼ é€Ÿåº¦

**åŠ¨æ€åˆ†ç‰‡å¤§å°è°ƒæ•´**ï¼š
- æ ¹æ®é€Ÿåº¦é™åˆ¶å’Œæ–‡ä»¶å¤§å°è®¡ç®—æœ€ä¼˜åˆ†ç‰‡å¤§å°
- ç›®æ ‡ï¼šæ¯ä¸ªåˆ†ç‰‡ä¸Šä¼ æ—¶é—´çº¦10ç§’
- é™åˆ¶åœ¨æœ€å°ï¼ˆ5MBï¼‰å’Œæœ€å¤§ï¼ˆ100MBï¼‰ä¹‹é—´

**ä¸»è¦æ–¹æ³•**ï¼š
- `start()`: å¼€å§‹è®¡æ—¶
- `wait_if_needed()`: å¦‚æœéœ€è¦ï¼Œç­‰å¾…ä»¥é™åˆ¶é€Ÿåº¦
- `get_current_speed()`: è·å–å½“å‰é€Ÿåº¦
- `reset()`: é‡ç½®è®¡æ•°å™¨
- `calculate_optimal_part_size()`: è®¡ç®—æœ€ä¼˜åˆ†ç‰‡å¤§å°

### 4. ä¸Šä¼ éªŒè¯

**éªŒè¯åŠŸèƒ½**ï¼š
- ä¸Šä¼ å®Œæˆåè‡ªåŠ¨éªŒè¯ETag
- è®°å½•éªŒè¯çŠ¶æ€å’Œç»“æœ
- æ”¯æŒæ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥

## ğŸš§ å¾…å®Œå–„åŠŸèƒ½

### 1. é€Ÿåº¦é™åˆ¶é›†æˆ

éœ€è¦å°† `SpeedLimiter` é›†æˆåˆ° `Cloud115OSS` å’Œ `Cloud115UploadManager` ä¸­ï¼š

```python
# åœ¨ Cloud115OSS._multipart_upload ä¸­
speed_limiter = SpeedLimiter(speed_limit)
speed_limiter.start()

# åœ¨ä¸Šä¼ æ¯ä¸ªåˆ†ç‰‡å‰
await speed_limiter.wait_if_needed(len(chunk))
```

### 2. åŠ¨æ€åˆ†ç‰‡å¤§å°

éœ€è¦åœ¨ `Cloud115OSS` ä¸­ä½¿ç”¨ `calculate_optimal_part_size` æ›¿ä»£å›ºå®šçš„10MBåˆ†ç‰‡ï¼š

```python
# æ ¹æ®é€Ÿåº¦é™åˆ¶è®¡ç®—æœ€ä¼˜åˆ†ç‰‡å¤§å°
part_size = calculate_optimal_part_size(
    file_size=file_size,
    speed_limit=speed_limit,
    default_part_size=10 * 1024 * 1024
)
```

### 3. æ–­ç‚¹ç»­ä¼ æ¢å¤

éœ€è¦åœ¨ `UploadTaskManager._do_upload` ä¸­å®ç°ä»è¿›åº¦è®°å½•æ¢å¤æ–­ç‚¹ç»­ä¼ ï¼š

```python
# æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„åˆ†ç‰‡
if task.parts_info and task.completed_parts < task.total_parts:
    # æ¢å¤åˆ†ç‰‡ä¸Šä¼ 
    await self._resume_multipart_upload(task)
```

### 4. ä¸Šä¼ éªŒè¯å¢å¼º

éœ€è¦å®ç°æ›´å®Œæ•´çš„éªŒè¯åŠŸèƒ½ï¼š

```python
# è®¡ç®—æœ¬åœ°æ–‡ä»¶ETag
local_etag = calculate_file_etag(file_path)

# å¯¹æ¯”ä¸Šä¼ åçš„ETag
if local_etag != remote_etag:
    # éªŒè¯å¤±è´¥ï¼Œè®°å½•é”™è¯¯
    pass
```

### 5. APIç«¯ç‚¹

éœ€è¦åˆ›å»ºREST APIç«¯ç‚¹ï¼š

- `POST /api/upload/tasks`: æ·»åŠ ä¸Šä¼ ä»»åŠ¡
- `GET /api/upload/tasks`: åˆ—å‡ºä»»åŠ¡
- `GET /api/upload/tasks/{task_id}`: è·å–ä»»åŠ¡è¯¦æƒ…
- `POST /api/upload/tasks/{task_id}/cancel`: å–æ¶ˆä»»åŠ¡
- `POST /api/upload/tasks/{task_id}/pause`: æš‚åœä»»åŠ¡
- `POST /api/upload/tasks/{task_id}/resume`: æ¢å¤ä»»åŠ¡
- `GET /api/upload/tasks/{task_id}/progress`: è·å–è¿›åº¦å†å²

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from app.core.cloud_storage.providers.cloud_115_api import Cloud115API
from app.modules.upload.task_manager import UploadTaskManager

# åˆå§‹åŒ–APIå®¢æˆ·ç«¯
api = Cloud115API(access_token="your_access_token")

# åˆå§‹åŒ–ä»»åŠ¡ç®¡ç†å™¨
task_manager = UploadTaskManager(
    api_client=api,
    max_concurrent=3,
    max_retries=3,
    retry_delay=5.0
)

# å¯åŠ¨ä»»åŠ¡ç®¡ç†å™¨
await task_manager.start()

# æ·»åŠ ä¸Šä¼ ä»»åŠ¡
task_id = await task_manager.add_task(
    file_path="/path/to/file.mkv",
    target_parent_id="0",
    file_name="file.mkv",
    speed_limit=10 * 1024 * 1024  # 10MB/s
)

# è·å–ä»»åŠ¡ä¿¡æ¯
task_info = await task_manager.get_task(task_id)

# åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
tasks = await task_manager.list_tasks(status="uploading")

# æš‚åœä»»åŠ¡
await task_manager.pause_task(task_id)

# æ¢å¤ä»»åŠ¡
await task_manager.resume_task(task_id)

# å–æ¶ˆä»»åŠ¡
await task_manager.cancel_task(task_id)

# åœæ­¢ä»»åŠ¡ç®¡ç†å™¨
await task_manager.stop()
```

## ğŸ¯ æŠ€æœ¯å®ç°

### 1. å¼‚æ­¥å¤„ç†

- ä½¿ç”¨ `asyncio.Queue` å®ç°ä»»åŠ¡é˜Ÿåˆ—
- ä½¿ç”¨ `asyncio.Semaphore` æ§åˆ¶å¹¶å‘
- ä½¿ç”¨ `asyncio.Task` ç®¡ç†ä»»åŠ¡æ‰§è¡Œ

### 2. æ•°æ®åº“æŒä¹…åŒ–

- ä½¿ç”¨ SQLAlchemy å¼‚æ­¥ORM
- å®æ—¶ä¿å­˜ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
- æ”¯æŒä»æ•°æ®åº“æ¢å¤ä»»åŠ¡

### 3. é”™è¯¯å¤„ç†

- å®Œå–„çš„å¼‚å¸¸æ•è·å’Œè®°å½•
- é”™è¯¯å†å²è®°å½•
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

### 4. æ€§èƒ½ä¼˜åŒ–

- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- æ‰¹é‡æ“ä½œæ”¯æŒ
- è¿›åº¦è®°å½•å®šæœŸæ¸…ç†ï¼ˆå¾…å®ç°ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“åˆå§‹åŒ–**: éœ€è¦åœ¨ `init_db()` ä¸­å¯¼å…¥ `UploadTask` å’Œ `UploadProgress` æ¨¡å‹
2. **ä»»åŠ¡ç®¡ç†å™¨ç”Ÿå‘½å‘¨æœŸ**: éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶å¯åŠ¨ï¼Œå…³é—­æ—¶åœæ­¢
3. **è¿›åº¦è®°å½•æ¸…ç†**: å»ºè®®å®šæœŸæ¸…ç†æ—§çš„è¿›åº¦è®°å½•ï¼Œé¿å…æ•°æ®åº“è†¨èƒ€
4. **å¹¶å‘æ•°é…ç½®**: æ ¹æ®æœåŠ¡å™¨æ€§èƒ½å’Œç½‘ç»œå¸¦å®½è°ƒæ•´ `max_concurrent`
5. **é€Ÿåº¦é™åˆ¶**: é€Ÿåº¦é™åˆ¶ä¼šå½±å“ä¸Šä¼ æ•ˆç‡ï¼Œå»ºè®®æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [115ç½‘ç›˜OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ€»ç»“](./115ç½‘ç›˜OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ€»ç»“.md)
- [115ç½‘ç›˜æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§](./115ç½‘ç›˜æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§.md)
- [115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£é›†æˆå®Œæˆæ€»ç»“](./115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£é›†æˆå®Œæˆæ€»ç»“.md)

## âœ… æ€»ç»“

å·²æˆåŠŸå®ç°115ç½‘ç›˜ä¸Šä¼ ä»»åŠ¡ç®¡ç†çš„åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… æ•°æ®åº“æ¨¡å‹ï¼ˆä»»åŠ¡å’Œè¿›åº¦è®°å½•ï¼‰
2. âœ… ä»»åŠ¡ç®¡ç†å™¨ï¼ˆé˜Ÿåˆ—ã€å¹¶å‘ã€é‡è¯•ï¼‰
3. âœ… é€Ÿåº¦é™åˆ¶å™¨ï¼ˆé™é€Ÿã€åŠ¨æ€åˆ†ç‰‡ï¼‰
4. âœ… è¿›åº¦æŒä¹…åŒ–ï¼ˆä¿å­˜ã€æ¢å¤ï¼‰
5. âœ… ä¸Šä¼ éªŒè¯ï¼ˆETagéªŒè¯ï¼‰

ä¸‹ä¸€æ­¥éœ€è¦ï¼š
1. é›†æˆé€Ÿåº¦é™åˆ¶åˆ°OSSä¸Šä¼ 
2. å®ç°æ–­ç‚¹ç»­ä¼ æ¢å¤
3. å¢å¼ºä¸Šä¼ éªŒè¯
4. åˆ›å»ºREST APIç«¯ç‚¹
5. å®ç°è¿›åº¦è®°å½•æ¸…ç†

