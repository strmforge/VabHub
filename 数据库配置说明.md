# 数据库配置说明

## 📊 数据库配置

### 当前配置

**默认数据库**: SQLite（开发环境）

**配置文件**: `backend/app/core/config.py`

**配置项**:
```python
DATABASE_URL: str = os.getenv(
    "DATABASE_URL",
    "sqlite:///./vabhub.db"  # 开发环境使用SQLite
)
```

### 数据库类型

#### 1. SQLite（开发环境推荐）✅

**优点**:
- 无需安装和配置数据库服务
- 文件数据库，易于备份和迁移
- 适合开发和测试环境

**配置**:
```python
DATABASE_URL = "sqlite:///./vabhub.db"
```

**数据库文件位置**:
- `backend/vabhub.db`

#### 2. PostgreSQL（生产环境推荐）

**优点**:
- 性能更好
- 支持并发连接
- 适合生产环境

**配置**:
```python
DATABASE_URL = "postgresql://用户名:密码@主机:端口/数据库名"
# 示例: postgresql://vabhub:vabhub@localhost:5432/vabhub
```

**环境变量**:
```bash
# 设置环境变量
set DATABASE_URL=postgresql://vabhub:vabhub@localhost:5432/vabhub
```

---

## 🔄 切换数据库

### 从PostgreSQL切换到SQLite

**步骤**:
1. **修改配置文件**:
   ```python
   # backend/app/core/config.py
   DATABASE_URL: str = os.getenv(
       "DATABASE_URL",
       "sqlite:///./vabhub.db"  # 修改为SQLite
   )
   ```

2. **重启服务**:
   ```bash
   # 终止当前进程
   taskkill /PID <PID> /F
   
   # 重新启动
   python backend/scripts/start.py
   ```

3. **初始化数据库**:
   ```bash
   python backend/scripts/init_db.py
   ```

### 从SQLite切换到PostgreSQL

**步骤**:
1. **确保PostgreSQL服务运行**:
   ```bash
   # 检查服务状态
   sc query postgresql-x64-*
   
   # 启动服务
   net start postgresql-x64-14
   ```

2. **创建数据库**:
   ```sql
   -- 使用psql创建数据库
   CREATE DATABASE vabhub;
   CREATE USER vabhub WITH PASSWORD 'vabhub';
   GRANT ALL PRIVILEGES ON DATABASE vabhub TO vabhub;
   ```

3. **修改配置文件**:
   ```python
   # backend/app/core/config.py
   DATABASE_URL: str = os.getenv(
       "DATABASE_URL",
       "postgresql://vabhub:vabhub@localhost:5432/vabhub"
   )
   ```

4. **设置环境变量**（可选）:
   ```bash
   set DATABASE_URL=postgresql://vabhub:vabhub@localhost:5432/vabhub
   ```

5. **重启服务**:
   ```bash
   python backend/scripts/start.py
   ```

---

## 🚀 初始化数据库

### SQLite数据库初始化

**自动初始化**:
- 服务启动时会自动创建数据库文件
- 首次运行时会自动创建所有表

**手动初始化**:
```bash
python backend/scripts/init_db.py
```

### PostgreSQL数据库初始化

**创建数据库**:
```sql
CREATE DATABASE vabhub;
CREATE USER vabhub WITH PASSWORD 'vabhub';
GRANT ALL PRIVILEGES ON DATABASE vabhub TO vabhub;
```

**初始化表结构**:
```bash
python backend/scripts/init_db.py
```

---

## 📝 环境变量配置

### 使用环境变量

**设置环境变量**:
```bash
# Windows
set DATABASE_URL=sqlite:///./vabhub.db

# Linux/Mac
export DATABASE_URL=sqlite:///./vabhub.db
```

**创建.env文件**（推荐）:
```bash
# .env
DATABASE_URL=sqlite:///./vabhub.db
```

---

## 🔍 数据库连接测试

### 测试SQLite连接

```python
from app.core.database import AsyncSessionLocal
from sqlalchemy import text
import asyncio

async def test():
    async with AsyncSessionLocal() as session:
        result = await session.execute(text("SELECT 1"))
        print(result.scalar())

asyncio.run(test())
```

### 测试PostgreSQL连接

```python
from app.core.database import AsyncSessionLocal
from sqlalchemy import text
import asyncio

async def test():
    async with AsyncSessionLocal() as session:
        result = await session.execute(text("SELECT 1"))
        print(result.scalar())

asyncio.run(test())
```

---

## 📊 数据库迁移

### 从SQLite迁移到PostgreSQL

**步骤**:
1. **备份SQLite数据库**:
   ```bash
   copy backend\vabhub.db backend\vabhub.db.backup
   ```

2. **导出数据**（如果需要）:
   ```bash
   # 使用SQLite导出工具
   sqlite3 backend\vabhub.db .dump > backup.sql
   ```

3. **切换到PostgreSQL**:
   - 修改配置文件
   - 初始化数据库
   - 导入数据（如果需要）

### 从PostgreSQL迁移到SQLite

**步骤**:
1. **导出PostgreSQL数据**:
   ```bash
   pg_dump -U vabhub -d vabhub > backup.sql
   ```

2. **切换到SQLite**:
   - 修改配置文件
   - 初始化数据库
   - 导入数据（需要转换SQL格式）

---

## 🎯 推荐配置

### 开发环境

**推荐**: SQLite
- 无需安装数据库服务
- 易于设置和使用
- 适合开发和测试

### 生产环境

**推荐**: PostgreSQL
- 性能更好
- 支持并发连接
- 适合生产环境

---

## 🐛 常见问题

### Q1: SQLite数据库文件在哪里？

**A**: `backend/vabhub.db`

### Q2: 如何备份SQLite数据库？

**A**: 直接复制数据库文件:
```bash
copy backend\vabhub.db backend\vabhub.db.backup
```

### Q3: PostgreSQL连接失败怎么办？

**A**: 
1. 检查PostgreSQL服务是否运行
2. 检查数据库配置是否正确
3. 检查用户权限
4. 切换到SQLite（开发环境）

### Q4: 如何切换数据库？

**A**: 
1. 修改 `backend/app/core/config.py` 中的 `DATABASE_URL`
2. 重启服务
3. 初始化数据库

---

**创建时间**: 2025-01-XX  
**最后更新**: 2025-01-XX  
**状态**: 当前使用SQLite（开发环境）

