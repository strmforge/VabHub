# æµ‹è¯•éªŒè¯é—®é¢˜ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025-01-XX  
**çŠ¶æ€**: âœ… é—®é¢˜å·²ä¿®å¤

---

## ğŸ“‹ ä¸€ã€å‘ç°çš„é—®é¢˜

### âŒ 1. ä»£ç ç¼©è¿›é”™è¯¯

**æ–‡ä»¶**: `backend/app/modules/media_identification/service.py`  
**ä½ç½®**: ç¬¬170-172è¡Œ  
**é”™è¯¯**: `elif` è¯­å¥åç¼ºå°‘ç¼©è¿›å—

**ä¿®å¤**: âœ… å°† `elif` æ”¹ä¸º `if`ï¼ˆå› ä¸ºå‰é¢å·²ç»æœ‰ `if` åˆ¤æ–­ï¼‰

---

### âŒ 2. QueryExpanderæ–¹æ³•ç¼ºå¤±

**æ–‡ä»¶**: `backend/app/modules/search/service.py`  
**ä½ç½®**: ç¬¬103è¡Œ  
**é”™è¯¯**: `QueryExpander` å¯¹è±¡æ²¡æœ‰ `expand` æ–¹æ³•

**ä¿®å¤**: âœ… å®ç°ç®€åŒ–çš„æŸ¥è¯¢æ‰©å±•é€»è¾‘ï¼ˆç§»é™¤å¹´ä»½ã€æ·»åŠ åç¼€ï¼‰

---

### âŒ 3. æ•°æ®åº“æ¨¡å‹å…³ç³»é”™è¯¯

**æ–‡ä»¶**: `backend/app/models/rsshub_source.py`ï¼ˆæ¨æµ‹ï¼‰  
**é”™è¯¯**: `RSSHubSource.user_subscriptions` å…³ç³»é…ç½®æœ‰é—®é¢˜

**çŠ¶æ€**: âš ï¸ **éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥**ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼‰

---

## ğŸ“‹ äºŒã€ä¿®å¤å†…å®¹

### âœ… 1. ä¿®å¤ä»£ç ç¼©è¿›é”™è¯¯

**ä¿®æ”¹å‰**:
```python
elif not tmdb_result or not tmdb_result.get("success"):
    douban_result = await self._search_douban(title, year, media_type)
    if douban_result and douban_result.get("success"):
        identification_result = {
```

**ä¿®æ”¹å**:
```python
if not tmdb_result or not tmdb_result.get("success"):
    douban_result = await self._search_douban(title, year, media_type)
    if douban_result and douban_result.get("success"):
        identification_result = {
```

---

### âœ… 2. ä¿®å¤QueryExpanderè°ƒç”¨

**ä¿®æ”¹å‰**:
```python
if enable_query_expansion:
    expanded_queries = await self.query_expander.expand(query, media_type, year)
else:
    expanded_queries = [query]
```

**ä¿®æ”¹å**:
```python
if enable_query_expansion:
    # æŸ¥è¯¢æ‰©å±•ï¼šç§»é™¤å¹´ä»½ã€æ·»åŠ åç¼€ç­‰ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…å¯ä»¥æ›´å¤æ‚ï¼‰
    expanded_queries = [query]
    # å¦‚æœåŒ…å«å¹´ä»½ï¼Œå°è¯•ç§»é™¤å¹´ä»½
    import re
    year_match = re.search(r'\((\d{4})\)', query)
    if year_match:
        expanded_queries.append(re.sub(r'\s*\(\d{4}\)', '', query))
    # æ·»åŠ å¸¸è§åç¼€
    if media_type == "tv":
        expanded_queries.append(f"{query} ç¬¬ä¸€å­£")
        expanded_queries.append(f"{query} S01")
else:
    expanded_queries = [query]
```

---

## ğŸ“‹ ä¸‰ã€æµ‹è¯•ç»“æœ

### âœ… æµ‹è¯•é€šè¿‡

1. âœ… **HMACç­¾ååŠŸèƒ½æµ‹è¯•** - é€šè¿‡
2. âœ… **ChartRowæ¨¡å‹é›†æˆæµ‹è¯•** - é€šè¿‡

### âš ï¸ æµ‹è¯•å¤±è´¥ï¼ˆå·²ä¿®å¤ï¼‰

1. âš ï¸ **è±†ç“£å›é€€æœºåˆ¶æµ‹è¯•** - ä»£ç ç¼©è¿›é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰
2. âš ï¸ **SSEæœç´¢åŠŸèƒ½æµ‹è¯•** - QueryExpanderæ–¹æ³•ç¼ºå¤±ï¼ˆå·²ä¿®å¤ï¼‰

### âš ï¸ éœ€è¦è¿›ä¸€æ­¥å¤„ç†

1. âš ï¸ **é€Ÿåº¦é™åˆ¶åŠŸèƒ½æµ‹è¯•** - æ•°æ®åº“æ¨¡å‹å…³ç³»é”™è¯¯ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
2. âš ï¸ **å‰åç«¯å¯¹é½æ£€æŸ¥** - åç«¯æœåŠ¡å¯åŠ¨è¶…æ—¶ï¼ˆéœ€è¦ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ï¼‰

---

## ğŸ“‹ å››ã€åç»­è¡ŒåŠ¨

### 4.1 é‡æ–°è¿è¡Œæµ‹è¯•

**æ‰§è¡Œå‘½ä»¤**:
```bash
cd VabHub/backend
python scripts/run_all_tests.py
```

**é¢„æœŸç»“æœ**:
- æ‰€æœ‰æµ‹è¯•é€šè¿‡
- åŠŸèƒ½éªŒè¯å®Œæˆ

---

### 4.2 ä¿®å¤æ•°æ®åº“æ¨¡å‹å…³ç³»

**éœ€è¦æ£€æŸ¥**:
- `RSSHubSource` æ¨¡å‹å®šä¹‰
- `user_subscriptions` å…³ç³»é…ç½®
- å¤–é”®çº¦æŸ

**ä¼˜å…ˆçº§**: ä¸­ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼‰

---

### 4.3 ç­‰å¾…åç«¯æœåŠ¡å®Œå…¨å¯åŠ¨

**å»ºè®®**:
- ç­‰å¾…åç«¯æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆçº¦30ç§’ï¼‰
- ç„¶åè¿è¡Œå‰åç«¯å¯¹é½æ£€æŸ¥

---

## ğŸ“‹ äº”ã€æ€»ç»“

### âœ… å·²ä¿®å¤

- **ä»£ç ç¼©è¿›é”™è¯¯**: âœ… ä¿®å¤
- **QueryExpanderè°ƒç”¨**: âœ… ä¿®å¤

### âš ï¸ å¾…å¤„ç†

- **æ•°æ®åº“æ¨¡å‹å…³ç³»**: âš ï¸ éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥
- **åç«¯æœåŠ¡å¯åŠ¨**: âš ï¸ éœ€è¦ç­‰å¾…å®Œå…¨å¯åŠ¨

### ğŸ“Š æµ‹è¯•çŠ¶æ€

- **æµ‹è¯•è„šæœ¬**: âœ… å·²åˆ›å»º
- **ä»£ç ä¿®å¤**: âœ… å·²å®Œæˆ
- **åŠŸèƒ½éªŒè¯**: â³ å¾…é‡æ–°è¿è¡Œæµ‹è¯•

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**çŠ¶æ€**: âœ… ä¸»è¦é—®é¢˜å·²ä¿®å¤ï¼Œå¯ä»¥é‡æ–°è¿è¡Œæµ‹è¯•

