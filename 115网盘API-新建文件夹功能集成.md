# 115网盘API-新建文件夹功能集成

## ✅ 已完成的工作

### 1. 新建文件夹API集成

在115网盘API客户端中添加了新建文件夹功能：

#### `create_folder` - 创建文件夹
- **Path**: `POST 域名+/open/folder/add`
- **Method**: `POST`
- **Headers**: `Authorization: Bearer access_token`
- **Body (form-data)**:
  - `pid`: 父目录ID（必须）
  - `file_name`: 文件夹名称（必须，限制255个字符）
- **Returns**: 创建的文件夹信息（file_name、file_id）

#### `create_folder_by_path` - 根据路径创建文件夹
- 先获取父目录信息（通过路径）
- 然后调用`create_folder`创建文件夹
- 支持通过路径创建文件夹，更便于使用

## 🎯 使用示例

### 1. 通过父目录ID创建文件夹

```python
from app.core.cloud_storage.providers.cloud_115_api import Cloud115API

# 初始化API客户端
api = Cloud115API(access_token="your_access_token")

# 创建文件夹
folder_info = await api.create_folder(
    parent_id="3073323042143855813",  # 父目录ID
    folder_name="新建文件夹名称"  # 文件夹名称（限制255个字符）
)

# 返回: {
#     "file_name": "新建文件夹名称",
#     "file_id": "新建的文件夹ID"
# }
```

### 2. 根据路径创建文件夹

```python
# 根据路径创建文件夹
folder_info = await api.create_folder_by_path(
    parent_path="/电影",  # 父目录路径
    folder_name="2025年电影"  # 文件夹名称
)

# 返回: {
#     "file_name": "2025年电影",
#     "file_id": "新建的文件夹ID"
# }
```

## 📊 API字段说明

### 请求参数

- `pid`: 父目录ID
  - 类型: `string`
  - 必须: 是
  - 说明: 新建文件夹所在的父目录ID（根目录的ID需要查询或使用特定值）

- `file_name`: 文件夹名称
  - 类型: `string`
  - 必须: 是
  - 说明: 新建文件夹名称，限制255个字符

### 返回数据

- `state`: 接口状态
  - 类型: `boolean`
  - 说明: `true`表示正常，`false`表示异常

- `message`: 异常信息
  - 类型: `string`
  - 说明: 错误信息

- `code`: 异常码
  - 类型: `number`
  - 说明: 错误代码

- `data`: 返回数据
  - 类型: `object`
  - 字段:
    - `file_name`: 新建的文件夹名称
    - `file_id`: 新建的文件夹ID

## 🔧 集成到STRM系统

### 1. 文件上传时的文件夹创建

在文件上传到115网盘时，如果目标目录不存在，可以自动创建：

```python
# 在文件上传管理器中
async def upload_file_to_cloud(
    self,
    file_path: str,
    cloud_path: str,
    cloud_115_api: Cloud115API
):
    """上传文件到115网盘"""
    # 解析云存储路径
    path_parts = cloud_path.strip('/').split('/')
    current_path = ''
    
    # 逐级创建目录
    for part in path_parts[:-1]:  # 除了最后一部分（文件名）
        current_path = f"{current_path}/{part}" if current_path else f"/{part}"
        
        # 检查目录是否存在
        dir_info = await cloud_115_api.get_file_info(path=current_path)
        
        if not dir_info:
            # 目录不存在，创建目录
            parent_path = '/'.join(current_path.split('/')[:-1]) or '/'
            folder_name = part
            
            folder_info = await cloud_115_api.create_folder_by_path(
                parent_path=parent_path,
                folder_name=folder_name
            )
            
            if not folder_info:
                logger.error(f"创建目录失败: {current_path}")
                return False
    
    # 继续上传文件...
```

### 2. 文件组织时的文件夹创建

在文件按类型组织到115网盘时，可以自动创建分类文件夹：

```python
# 在文件组织管理器中
async def organize_files_by_type(
    self,
    files: List[str],
    cloud_115_api: Cloud115API,
    base_path: str = "/电影"
):
    """按类型组织文件"""
    # 创建分类文件夹
    categories = ["电影", "电视剧", "动漫", "其他"]
    
    for category in categories:
        category_path = f"{base_path}/{category}"
        
        # 检查目录是否存在
        dir_info = await cloud_115_api.get_file_info(path=category_path)
        
        if not dir_info:
            # 创建分类文件夹
            folder_info = await cloud_115_api.create_folder_by_path(
                parent_path=base_path,
                folder_name=category
            )
            
            if folder_info:
                logger.info(f"创建分类文件夹: {category_path}")
            else:
                logger.error(f"创建分类文件夹失败: {category_path}")
```

## 🚧 注意事项

### 1. 根目录ID

- 根目录的ID需要查询或使用特定值
- 可以通过`get_file_info(path="/")`获取根目录信息
- 或者使用已知的根目录ID（通常为0或特定值）

### 2. 文件夹名称限制

- 文件夹名称限制255个字符
- 需要处理特殊字符
- 需要处理重名问题

### 3. 错误处理

- 处理文件夹已存在的情况
- 处理父目录不存在的情况
- 处理权限不足的情况
- 处理网络错误

### 4. 路径格式

- 支持`/`和`>`两种分隔符
- 路径需要以分隔符开头
- 路径中的目录层级用分隔符分隔

## 🎉 总结

已完成115网盘"新建文件夹"API的集成，包括：

1. ✅ `create_folder` - 通过父目录ID创建文件夹
2. ✅ `create_folder_by_path` - 根据路径创建文件夹
3. ✅ 错误处理和日志记录
4. ✅ 集成到STRM系统的使用示例

**新建文件夹功能已成功集成到115网盘API客户端中！**

下一步可以：
1. 在文件上传管理器中集成文件夹自动创建功能
2. 在文件组织管理器中集成分类文件夹创建功能
3. 处理文件夹重名和冲突问题
4. 优化错误处理和用户体验

