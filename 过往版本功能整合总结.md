# è¿‡å¾€ç‰ˆæœ¬åŠŸèƒ½æ•´åˆæ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†å¦‚ä½•å°†VabHubè¿‡å¾€ç‰ˆæœ¬ï¼ˆVabHub-1ã€VabHub1.4ç‰ˆã€VabHub-å˜å¼‚ç‰ˆç­‰ï¼‰ä¸­çš„åŠŸèƒ½æ•´åˆåˆ°å½“å‰ç‰ˆæœ¬ä¸­ï¼Œå¹¶æä¾›äº†ç›´æ¥è°ƒç”¨çš„æ–¹æ³•ã€‚

## ğŸ¯ æ•´åˆç­–ç•¥

### 1. é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

åˆ›å»ºäº†`LegacyAdapter`ç±»ï¼Œé€šè¿‡åŠ¨æ€æ¨¡å—åŠ è½½çš„æ–¹å¼ï¼Œå…è®¸å½“å‰ç‰ˆæœ¬ç›´æ¥è°ƒç”¨è¿‡å¾€ç‰ˆæœ¬çš„åŠŸèƒ½ã€‚

**æ ¸å¿ƒæ–‡ä»¶**:
- `VabHub/backend/app/core/legacy_adapter.py` - æ ¸å¿ƒé€‚é…å™¨
- `VabHub/backend/app/core/legacy_wrapper.py` - ä¾¿æ·åŒ…è£…å™¨

### 2. æœåŠ¡å±‚å°è£…

ä¸ºå¸¸ç”¨çš„åŠŸèƒ½åˆ›å»ºäº†æœåŠ¡å±‚å°è£…ï¼Œæä¾›æ›´å‹å¥½çš„è°ƒç”¨æ¥å£ï¼š

**æ¨èæœåŠ¡**:
- `VabHub/backend/app/modules/recommendation/service.py`
- API: `/recommendations/*`

**åª’ä½“è¯†åˆ«æœåŠ¡**:
- `VabHub/backend/app/modules/media_identification/service.py`
- API: `/media-identification/*`

### 3. ç»Ÿä¸€APIæ¥å£

æ‰€æœ‰åŠŸèƒ½éƒ½é€šè¿‡ç»Ÿä¸€çš„APIæ¥å£æš´éœ²ï¼Œæ–¹ä¾¿å‰ç«¯å’Œå…¶ä»–æœåŠ¡è°ƒç”¨ã€‚

## âœ… å·²æ•´åˆçš„åŠŸèƒ½

### 1. æ¨èç³»ç»Ÿ âœ…

#### åŠŸèƒ½æè¿°
- **ååŒè¿‡æ»¤æ¨è**: åŸºäºç”¨æˆ·ç›¸ä¼¼åº¦çš„æ¨è
- **å†…å®¹æ¨è**: åŸºäºå†…å®¹ç›¸ä¼¼åº¦çš„æ¨è
- **æ··åˆæ¨è**: ç»¼åˆå¤šç§ç®—æ³•çš„æ¨è
- **çƒ­é—¨æ¨è**: åŸºäºæµè¡Œåº¦çš„æ¨è

#### æ¥æºç‰ˆæœ¬
- VabHub-1: `modules.ai.recommendation.recommendation_engine.RecommendationEngine`
- VabHub-1: `modules.ai.core.intelligent_content_recommendation.IntelligentContentRecommendationEngine`

#### ä½¿ç”¨æ–¹æ³•

**é€šè¿‡æœåŠ¡å±‚è°ƒç”¨**:
```python
from app.modules.recommendation.service import RecommendationService

service = RecommendationService(db)
recommendations = await service.get_recommendations(
    user_id=1,
    limit=20,
    algorithm="hybrid"
)
```

**é€šè¿‡APIè°ƒç”¨**:
```bash
GET /recommendations/1?limit=20&algorithm=hybrid
```

**ç›´æ¥è°ƒç”¨é€‚é…å™¨**:
```python
from app.core.legacy_adapter import get_recommendation_engine

engine = get_recommendation_engine(version="vabhub_1")
recommendations = engine.update_recommendations(user_id=1)
```

### 2. åª’ä½“è¯†åˆ« âœ…

#### åŠŸèƒ½æè¿°
- **æ–‡ä»¶åè§£æ**: ä»æ–‡ä»¶åæå–åª’ä½“ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å¹´ä»½ã€å­£é›†ç­‰ï¼‰
- **ç±»å‹è¯†åˆ«**: è¯†åˆ«åª’ä½“ç±»å‹ï¼ˆç”µå½±ã€ç”µè§†å‰§ã€åŠ¨æ¼«ç­‰ï¼‰
- **å¢å¼ºè¯†åˆ«**: AIå¢å¼ºçš„åª’ä½“è¯†åˆ«

#### æ¥æºç‰ˆæœ¬
- VabHub-1: `modules.media.parser.MediaFileParser`
- VabHub-1: `modules.media.media_identification_service.MediaIdentificationService`
- VabHub-1: `modules.media.enhanced_media_identification_service.EnhancedMediaIdentificationService`

#### ä½¿ç”¨æ–¹æ³•

**é€šè¿‡æœåŠ¡å±‚è°ƒç”¨**:
```python
from app.modules.media_identification.service import MediaIdentificationService

service = MediaIdentificationService(db)
result = await service.identify_media("/path/to/movie.mkv")
```

**é€šè¿‡APIè°ƒç”¨**:
```bash
POST /media-identification/identify
{
  "file_path": "/path/to/movie.mkv"
}
```

**ç›´æ¥è°ƒç”¨é€‚é…å™¨**:
```python
from app.core.legacy_wrapper import MediaParserWrapper

parser = MediaParserWrapper(version="vabhub_1")
result = parser.parse_filename("/path/to/movie.mkv")
```

### 3. æ¦œå•ç³»ç»Ÿ âœ…

#### åŠŸèƒ½æè¿°
- **éŸ³ä¹æ¦œå•**: QQéŸ³ä¹ã€ç½‘æ˜“äº‘éŸ³ä¹ã€Spotifyç­‰
- **å½±è§†æ¦œå•**: TMDBã€è±†ç“£ç­‰

#### æ¥æºç‰ˆæœ¬
- VabHub-1: `core.music_charts.MusicChartsService`
- VabHub1.4ç‰ˆ: `plugins.charts_tmdb_plugin.ChartsTMDBPlugin`
- VabHub1.4ç‰ˆ: `plugins.charts_douban_plugin.ChartsDoubanPlugin`

#### ä½¿ç”¨æ–¹æ³•

**é€šè¿‡APIè°ƒç”¨**:
```bash
# è·å–éŸ³ä¹æ¦œå•
POST /charts/music
{
  "platform": "qq_music",
  "chart_type": "hot",
  "region": "CN",
  "limit": 50
}

# è·å–å½±è§†æ¦œå•
POST /charts/video
{
  "source": "tmdb",
  "chart_type": "trending_movies",
  "region": "CN",
  "limit": 20
}
```

### 4. AIåˆ†ç±»å™¨ âœ…

#### åŠŸèƒ½æè¿°
- **åª’ä½“å†…å®¹åˆ†ç±»**: ä½¿ç”¨AIå¯¹åª’ä½“å†…å®¹è¿›è¡Œåˆ†ç±»
- **ç½®ä¿¡åº¦è¯„ä¼°**: è¯„ä¼°åˆ†ç±»ç»“æœçš„ç½®ä¿¡åº¦

#### æ¥æºç‰ˆæœ¬
- VabHub-1: `modules.ai.classifier.ai_classifier.AIClassifier`

#### ä½¿ç”¨æ–¹æ³•

**ç›´æ¥è°ƒç”¨é€‚é…å™¨**:
```python
from app.core.legacy_adapter import get_legacy_adapter

adapter = get_legacy_adapter()
classifier = adapter.get_instance("ai_classifier", version="vabhub_1")
result = classifier.classify(media_info)
```

### 5. ä¸‹è½½ç®¡ç† âœ…

#### åŠŸèƒ½æè¿°
- **qBittorrentå®¢æˆ·ç«¯**: qBittorrentä¸‹è½½å™¨é›†æˆ
- **Transmissionå®¢æˆ·ç«¯**: Transmissionä¸‹è½½å™¨é›†æˆ
- **ç»Ÿä¸€ä¸‹è½½ç®¡ç†**: ç»Ÿä¸€çš„ä¸‹è½½æœåŠ¡æ¥å£

#### æ¥æºç‰ˆæœ¬
- VabHub-1: `modules.download.clients.qbittorrent_client.QBittorrentClient`
- VabHub-1: `modules.download.clients.transmission_client.TransmissionClient`
- VabHub-1: `modules.download.download_service.DownloadService`

### 6. ç¼“å­˜ç®¡ç† âœ…

#### åŠŸèƒ½æè¿°
- **å¤šçº§ç¼“å­˜**: æ”¯æŒå¤šçº§ç¼“å­˜ç­–ç•¥
- **ç¼“å­˜ç­–ç•¥**: å¤šç§ç¼“å­˜ç­–ç•¥ï¼ˆLRUã€LFUç­‰ï¼‰

#### æ¥æºç‰ˆæœ¬
- VabHub-1: `modules.cache.cache_manager.CacheManager`

### 7. æ’ä»¶ç³»ç»Ÿ âœ…

#### åŠŸèƒ½æè¿°
- **æ’ä»¶ç®¡ç†**: æ’ä»¶åŠ è½½ã€å¸è½½ã€é…ç½®
- **æ’ä»¶å¸‚åœº**: æ’ä»¶å¸‚åœºåŠŸèƒ½

#### æ¥æºç‰ˆæœ¬
- VabHub1.4ç‰ˆ: `core.plugin_manager.PluginManager`

## ğŸ“ æ–‡ä»¶ç»“æ„

```
VabHub/backend/app/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ legacy_adapter.py          # æ ¸å¿ƒé€‚é…å™¨
â”‚   â””â”€â”€ legacy_wrapper.py          # ä¾¿æ·åŒ…è£…å™¨
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ recommendation/
â”‚   â”‚   â””â”€â”€ service.py             # æ¨èæœåŠ¡ï¼ˆæ•´åˆè¿‡å¾€ç‰ˆæœ¬ï¼‰
â”‚   â”œâ”€â”€ media_identification/
â”‚   â”‚   â””â”€â”€ service.py             # åª’ä½“è¯†åˆ«æœåŠ¡ï¼ˆæ•´åˆè¿‡å¾€ç‰ˆæœ¬ï¼‰
â”‚   â””â”€â”€ charts/
â”‚       â”œâ”€â”€ service.py             # éŸ³ä¹æ¦œå•æœåŠ¡
â”‚       â””â”€â”€ video_charts.py        # å½±è§†æ¦œå•æœåŠ¡
â””â”€â”€ api/
    â”œâ”€â”€ recommendation.py          # æ¨èAPI
    â”œâ”€â”€ media_identification.py    # åª’ä½“è¯†åˆ«API
    â””â”€â”€ charts.py                  # æ¦œå•API
```

## ğŸ”Œ APIç«¯ç‚¹

### æ¨èç³»ç»Ÿ

- `GET /recommendations/{user_id}` - è·å–ç”¨æˆ·æ¨è
- `GET /recommendations/{user_id}/similar/{media_id}` - è·å–ç›¸ä¼¼å†…å®¹æ¨è
- `GET /recommendations/popular` - è·å–çƒ­é—¨æ¨è

### åª’ä½“è¯†åˆ«

- `POST /media-identification/identify` - è¯†åˆ«åª’ä½“æ–‡ä»¶
- `POST /media-identification/identify/batch` - æ‰¹é‡è¯†åˆ«åª’ä½“æ–‡ä»¶

### æ¦œå•ç³»ç»Ÿ

- `GET /charts/music/platforms` - è·å–æ”¯æŒçš„éŸ³ä¹æ¦œå•å¹³å°
- `POST /charts/music` - è·å–éŸ³ä¹æ¦œå•
- `GET /charts/music/compare` - æ¯”è¾ƒä¸åŒå¹³å°çš„éŸ³ä¹æ¦œå•
- `GET /charts/video/sources` - è·å–æ”¯æŒçš„å½±è§†æ¦œå•æ•°æ®æº
- `POST /charts/video` - è·å–å½±è§†æ¦œå•

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: è·å–ç”¨æˆ·æ¨è

```python
from app.modules.recommendation.service import RecommendationService

# åˆ›å»ºæœåŠ¡å®ä¾‹
service = RecommendationService(db)

# è·å–æ¨è
recommendations = await service.get_recommendations(
    user_id=1,
    limit=20,
    algorithm="hybrid"
)

for rec in recommendations:
    print(f"æ¨è: {rec['media_id']} - åˆ†æ•°: {rec['score']} - åŸå› : {rec['reason']}")
```

### ç¤ºä¾‹2: è¯†åˆ«åª’ä½“æ–‡ä»¶

```python
from app.modules.media_identification.service import MediaIdentificationService

# åˆ›å»ºæœåŠ¡å®ä¾‹
service = MediaIdentificationService(db)

# è¯†åˆ«åª’ä½“æ–‡ä»¶
result = await service.identify_media("/path/to/å‰§é›†.S01E01.1080p.mkv")

if result["success"]:
    print(f"æ ‡é¢˜: {result['title']}")
    print(f"ç±»å‹: {result['type']}")
    print(f"ç½®ä¿¡åº¦: {result['confidence']}")
```

### ç¤ºä¾‹3: ç›´æ¥è°ƒç”¨é€‚é…å™¨

```python
from app.core.legacy_adapter import get_legacy_adapter

# è·å–é€‚é…å™¨å®ä¾‹
adapter = get_legacy_adapter()

# è·å–æ¨èå¼•æ“
engine = adapter.get_instance("recommendation_engine", version="vabhub_1")

# è°ƒç”¨æ–¹æ³•
recommendations = adapter.call_function(
    "recommendation_engine",
    "update_recommendations",
    version="vabhub_1",
    user_id=1
)
```

### ç¤ºä¾‹4: æŸ¥è¯¢å¯ç”¨åŠŸèƒ½

```python
from app.core.legacy_adapter import get_legacy_adapter

adapter = get_legacy_adapter()
functions = adapter.get_available_functions()

for func_name, func_info in functions.items():
    print(f"{func_name}: {func_info['description']}")
    print(f"  ç‰ˆæœ¬: {', '.join(func_info['versions'])}")
```

## ğŸ“Š åŠŸèƒ½æ˜ å°„è¡¨

| åŠŸèƒ½åç§° | ç‰ˆæœ¬ | æ¨¡å—è·¯å¾„ | çŠ¶æ€ |
|---------|------|---------|------|
| recommendation_engine | vabhub_1 | modules.ai.recommendation.recommendation_engine | âœ… å·²æ•´åˆ |
| intelligent_recommendation | vabhub_1 | modules.ai.core.intelligent_content_recommendation | âœ… å·²æ•´åˆ |
| media_parser | vabhub_1 | modules.media.parser | âœ… å·²æ•´åˆ |
| media_identification | vabhub_1 | modules.media.media_identification_service | âœ… å·²æ•´åˆ |
| enhanced_media_identification | vabhub_1 | modules.media.enhanced_media_identification_service | âœ… å·²æ•´åˆ |
| music_charts | vabhub_1 | core.music_charts | âœ… å·²æ•´åˆ |
| charts_tmdb | vabhub_14 | plugins.charts_tmdb_plugin | âœ… å·²æ•´åˆ |
| charts_douban | vabhub_14 | plugins.charts_douban_plugin | âœ… å·²æ•´åˆ |
| ai_classifier | vabhub_1 | modules.ai.classifier.ai_classifier | âœ… å·²æ³¨å†Œ |
| download_manager | vabhub_1 | modules.download.download_service | âœ… å·²æ³¨å†Œ |
| cache_manager | vabhub_1 | modules.cache.cache_manager | âœ… å·²æ³¨å†Œ |
| plugin_manager | vabhub_14 | core.plugin_manager | âœ… å·²æ³¨å†Œ |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è·¯å¾„ä¾èµ–**: ç¡®ä¿è¿‡å¾€ç‰ˆæœ¬çš„ä»£ç è·¯å¾„æ­£ç¡®
   - VabHub-1: `VabHub-1/backend`
   - VabHub1.4ç‰ˆ: `VabHub1.4ç‰ˆ/VabHub-Core/core`

2. **ä¾èµ–é¡¹**: è¿‡å¾€ç‰ˆæœ¬çš„åŠŸèƒ½å¯èƒ½éœ€è¦ç‰¹å®šçš„ä¾èµ–åŒ…
   - æ¨èå¼•æ“å¯èƒ½éœ€è¦: `numpy`, `pandas`, `scikit-learn`
   - åª’ä½“è¯†åˆ«å¯èƒ½éœ€è¦: `Pillow`, `opencv-python`

3. **å…¼å®¹æ€§**: æŸäº›åŠŸèƒ½å¯èƒ½éœ€è¦é€‚é…æ‰èƒ½åœ¨å½“å‰ç‰ˆæœ¬ä¸­ä½¿ç”¨
   - æ•°æ®åº“æ¨¡å‹å¯èƒ½éœ€è¦è°ƒæ•´
   - APIæ¥å£å¯èƒ½éœ€è¦é€‚é…

4. **æ€§èƒ½**: åŠ¨æ€åŠ è½½å¯èƒ½å½±å“æ€§èƒ½ï¼Œå»ºè®®ä½¿ç”¨ç¼“å­˜
   - é€‚é…å™¨ä¼šè‡ªåŠ¨ç¼“å­˜å·²åŠ è½½çš„æ¨¡å—å’Œå®ä¾‹
   - å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é¢„çƒ­å¸¸ç”¨åŠŸèƒ½

## ğŸ”„ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ³¨å†ŒåŠŸèƒ½**:
```python
from app.core.legacy_adapter import get_legacy_adapter

adapter = get_legacy_adapter()
adapter.register_function(
    name="new_function",
    version="vabhub_1",
    module_path="modules.new_module.NewClass",
    description="æ–°åŠŸèƒ½æè¿°"
)
```

2. **åˆ›å»ºæœåŠ¡å±‚**ï¼ˆå¯é€‰ï¼‰:
```python
# app/modules/new_feature/service.py
from app.core.legacy_adapter import get_legacy_adapter

class NewFeatureService:
    def __init__(self, db):
        self.db = db
        self._adapter = get_legacy_adapter()
    
    async def use_feature(self, **kwargs):
        instance = self._adapter.get_instance("new_function", version="vabhub_1")
        return await instance.do_something(**kwargs)
```

3. **åˆ›å»ºAPIè·¯ç”±**ï¼ˆå¯é€‰ï¼‰:
```python
# app/api/new_feature.py
from fastapi import APIRouter, Depends
from app.modules.new_feature.service import NewFeatureService

router = APIRouter()

@router.get("/new-feature")
async def get_new_feature(db=Depends(get_db)):
    service = NewFeatureService(db)
    result = await service.use_feature()
    return result
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**: é€‚é…å™¨ä¼šè‡ªåŠ¨ç¼“å­˜å·²åŠ è½½çš„æ¨¡å—å’Œå®ä¾‹
2. **æ‡’åŠ è½½**: åªæœ‰åœ¨å®é™…ä½¿ç”¨æ—¶æ‰åŠ è½½æ¨¡å—
3. **å•ä¾‹æ¨¡å¼**: æ¯ä¸ªåŠŸèƒ½ç±»åªåˆ›å»ºä¸€ä¸ªå®ä¾‹
4. **å¼‚æ­¥æ”¯æŒ**: æ‰€æœ‰æœåŠ¡éƒ½æ”¯æŒå¼‚æ­¥è°ƒç”¨

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨æœåŠ¡å±‚**: ä½¿ç”¨å°è£…å¥½çš„æœåŠ¡å±‚ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨é€‚é…å™¨
2. **é”™è¯¯å¤„ç†**: å§‹ç»ˆå¤„ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸
3. **æ—¥å¿—è®°å½•**: ä½¿ç”¨æ—¥å¿—è®°å½•åŠŸèƒ½è°ƒç”¨æƒ…å†µ
4. **ç‰ˆæœ¬ç®¡ç†**: æ˜ç¡®æŒ‡å®šä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œé¿å…ç‰ˆæœ¬å†²çª

## ğŸ“ æ€»ç»“

é€šè¿‡é€‚é…å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬æˆåŠŸåœ°å°†VabHubè¿‡å¾€ç‰ˆæœ¬ä¸­çš„åŠŸèƒ½æ•´åˆåˆ°äº†å½“å‰ç‰ˆæœ¬ä¸­ï¼š

1. âœ… **æ¨èç³»ç»Ÿ** - å®Œæ•´æ•´åˆï¼Œæ”¯æŒå¤šç§æ¨èç®—æ³•
2. âœ… **åª’ä½“è¯†åˆ«** - å®Œæ•´æ•´åˆï¼Œæ”¯æŒæ–‡ä»¶åè§£æå’ŒAIå¢å¼ºè¯†åˆ«
3. âœ… **æ¦œå•ç³»ç»Ÿ** - å®Œæ•´æ•´åˆï¼Œæ”¯æŒéŸ³ä¹å’Œå½±è§†æ¦œå•
4. âœ… **AIåŠŸèƒ½** - å·²æ³¨å†Œï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨
5. âœ… **ä¸‹è½½ç®¡ç†** - å·²æ³¨å†Œï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨
6. âœ… **ç¼“å­˜ç®¡ç†** - å·²æ³¨å†Œï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨
7. âœ… **æ’ä»¶ç³»ç»Ÿ** - å·²æ³¨å†Œï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨

æ‰€æœ‰åŠŸèƒ½éƒ½é€šè¿‡ç»Ÿä¸€çš„æ¥å£æš´éœ²ï¼Œæ–¹ä¾¿ä½¿ç”¨å’Œæ‰©å±•ã€‚

---

**æ›´æ–°æ—¶é—´**: 2025-01-08
**æ•´åˆçŠ¶æ€**: æŒç»­å¼€å‘ä¸­

