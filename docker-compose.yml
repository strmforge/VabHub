# VabHub Docker Compose 配置
# CI-DOCKER-ONE-IMAGE-1 + DEPLOY-UPGRADE-1 实现
# 使用方法: docker compose up -d
#
# 架构: 单一 All-in-One 应用镜像 + PostgreSQL + Redis
# 默认端口: 52180 (避开 8080/7878/8989/9091 等常见下载器端口)

version: '3.8'

services:
  # ============== VabHub 主应用 (All-in-One) ==============
  vabhub:
    image: ghcr.io/strmforge/vabhub:latest
    container_name: vabhub
    environment:
      # 数据库连接
      - DATABASE_URL=postgresql://${DB_USER:-vabhub}:${DB_PASSWORD:-vabhub_password}@db:5432/${DB_NAME:-vabhub}
      # Redis 连接
      - REDIS_URL=redis://redis:6379/0
      # 安全密钥 (生产环境必须修改)
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-this-in-production}
      # 应用配置
      - APP_DEMO_MODE=${APP_DEMO_MODE:-false}
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:52180}
      - VABHUB_PORT=${VABHUB_PORT:-52180}
      - WORKERS=${WORKERS:-4}
      # 容器信息 (用于升级引擎)
      - VABHUB_CONTAINER_NAME=vabhub
      # 时区
      - TZ=Asia/Shanghai
    volumes:
      - vabhub_data:/app/data
      - vabhub_logs:/app/logs
      # Docker Socket - 用于 UI 升级/重启功能
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # 可选: 挂载配置目录
      # - ./config:/config
    ports:
      - "${VABHUB_PORT:-52180}:${VABHUB_PORT:-52180}"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vabhub-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${VABHUB_PORT:-52180}/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============== PostgreSQL 数据库 ==============
  db:
    image: postgres:14-alpine
    container_name: vabhub-db
    environment:
      POSTGRES_DB: ${DB_NAME:-vabhub}
      POSTGRES_USER: ${DB_USER:-vabhub}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-vabhub_password}
    volumes:
      - vabhub_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-vabhub}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - vabhub-internal
    restart: unless-stopped

  # ============== Redis 缓存 ==============
  redis:
    image: redis:7-alpine
    container_name: vabhub-redis
    command: redis-server --appendonly yes
    volumes:
      - vabhub_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - vabhub-internal
    restart: unless-stopped

volumes:
  vabhub_db_data:
    name: vabhub_db_data
  vabhub_redis_data:
    name: vabhub_redis_data
  vabhub_data:
    name: vabhub_data
  vabhub_logs:
    name: vabhub_logs

networks:
  vabhub-internal:
    driver: bridge
