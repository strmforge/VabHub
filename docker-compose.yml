# VabHub Docker Compose 配置
# 简化版 - 类似 MoviePilot 的简洁风格
# 使用方法: docker compose up -d
#
# 安全密钥会自动生成并保存到 /app/data/.vabhub_secrets.json
# 如需自定义密钥，可在 .env 中设置 SECRET_KEY / JWT_SECRET_KEY

services:
  # ============== VabHub 主应用 ==============
  vabhub:
    image: ghcr.io/strmforge/vabhub:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vabhub
    environment:
      # ---------- 基础配置 ----------
      - VABHUB_PORT=${VABHUB_PORT:-52180}
      - TZ=${TZ:-Asia/Shanghai}
      # ---------- 数据库 ----------
      - DATABASE_URL=postgresql://${DB_USER:-vabhub}:${DB_PASSWORD:-vabhub_password}@db:5432/${DB_NAME:-vabhub}
      - REDIS_URL=redis://redis:6379/0
      # ---------- 初始管理员 (首次启动有效) ----------
      - SUPERUSER_NAME=${SUPERUSER_NAME:-admin}
      - SUPERUSER_PASSWORD=${SUPERUSER_PASSWORD:-}
      # ---------- 可选配置 ----------
      # - APP_BASE_URL=http://your-domain.com:52180
      # - TMDB_API_KEY=your-tmdb-key
    volumes:
      - vabhub_data:/app/data        # 数据 + 自动生成的密钥
      - vabhub_logs:/app/logs        # 日志
      - /var/run/docker.sock:/var/run/docker.sock:ro  # UI 升级功能
      # 媒体目录 (按需挂载)
      # - /path/to/media:/media
      # - /path/to/downloads:/downloads
    ports:
      - "${VABHUB_PORT:-52180}:${VABHUB_PORT:-52180}"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vabhub-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${VABHUB_PORT:-52180}/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============== PostgreSQL 数据库 ==============
  db:
    image: postgres:14-alpine
    container_name: vabhub-db
    environment:
      POSTGRES_DB: ${DB_NAME:-vabhub}
      POSTGRES_USER: ${DB_USER:-vabhub}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-vabhub_password}
    volumes:
      - vabhub_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-vabhub}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - vabhub-internal
    restart: unless-stopped

  # ============== Redis 缓存 ==============
  redis:
    image: redis:7-alpine
    container_name: vabhub-redis
    command: redis-server --appendonly yes
    volumes:
      - vabhub_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - vabhub-internal
    restart: unless-stopped

volumes:
  vabhub_db_data:
    name: vabhub_db_data
  vabhub_redis_data:
    name: vabhub_redis_data
  vabhub_data:
    name: vabhub_data
  vabhub_logs:
    name: vabhub_logs

networks:
  vabhub-internal:
    driver: bridge
