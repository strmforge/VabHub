# å­—å¹•ä¸‹è½½å¼€å…³åŠŸèƒ½å®Œæˆæ€»ç»“

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå®ç°äº†å­—å¹•ä¸‹è½½å¼€å…³åŠŸèƒ½ã€‚**é»˜è®¤å…³é—­è‡ªåŠ¨ä¸‹è½½å­—å¹•**ï¼Œå› ä¸ºPTç«™å¤§å¤šæœ‰å†…å«å­—å¹•æˆ–å½±ç‰‡å†…ç½®å­—å¹•ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦æ‰‹åŠ¨å¼€å¯æˆ–å…³é—­ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. é…ç½®ç®¡ç† âœ…

**æ–‡ä»¶**: `backend/app/core/config.py`

- âœ… æ·»åŠ å­—å¹•ä¸‹è½½é…ç½®é¡¹
  - `SUBTITLE_AUTO_DOWNLOAD`: æ˜¯å¦è‡ªåŠ¨ä¸‹è½½å­—å¹•ï¼ˆé»˜è®¤ï¼š`false`ï¼‰
  - `SUBTITLE_DEFAULT_LANGUAGE`: é»˜è®¤å­—å¹•è¯­è¨€ï¼ˆé»˜è®¤ï¼š`zh`ï¼‰

### 2. ç³»ç»Ÿè®¾ç½®é›†æˆ âœ…

**æ–‡ä»¶**: `backend/app/modules/settings/service.py`

- âœ… æ·»åŠ å­—å¹•è®¾ç½®åˆ°é»˜è®¤è®¾ç½®
  - `subtitle_auto_download`: "false"ï¼ˆé»˜è®¤å…³é—­ï¼‰
  - `subtitle_default_language`: "zh"
  - `subtitle_enabled_sources`: "opensubtitles"
- âœ… æ”¯æŒå­—å¹•è®¾ç½®åˆ†ç±»ï¼ˆ`category: "subtitle"`ï¼‰
- âœ… `get_setting`æ–¹æ³•æ”¯æŒé»˜è®¤å€¼å‚æ•°

### 3. å­—å¹•æœåŠ¡å¢å¼º âœ…

**æ–‡ä»¶**: `backend/app/modules/subtitle/service.py`

- âœ… `SubtitleService.__init__`æ”¯æŒ`auto_download`å‚æ•°
- âœ… `download_subtitle`æ–¹æ³•æ”¯æŒ`force_download`å‚æ•°
- âœ… è‡ªåŠ¨æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­çš„è‡ªåŠ¨ä¸‹è½½å¼€å…³
- âœ… å¦‚æœè‡ªåŠ¨ä¸‹è½½å…³é—­ï¼Œè·³è¿‡ä¸‹è½½å¹¶è®°å½•æ—¥å¿—
- âœ… æ”¯æŒå¼ºåˆ¶ä¸‹è½½ï¼ˆå¿½ç•¥è‡ªåŠ¨ä¸‹è½½è®¾ç½®ï¼‰

**å…³é”®é€»è¾‘**:
```python
# æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨ä¸‹è½½ï¼ˆé™¤éå¼ºåˆ¶ä¸‹è½½ï¼‰
if not force_download:
    # ä»ç³»ç»Ÿè®¾ç½®è¯»å–
    if self.auto_download is None:
        settings_service = SettingsService(self.db)
        auto_download_setting = await settings_service.get_setting("subtitle_auto_download", "false")
        self.auto_download = auto_download_setting.lower() == "true"
    
    if not self.auto_download:
        logger.info("å­—å¹•è‡ªåŠ¨ä¸‹è½½å·²å…³é—­ï¼Œè·³è¿‡ä¸‹è½½ï¼ˆæç¤ºï¼šPTç«™å¤§å¤šæœ‰å†…ç½®å­—å¹•ï¼‰")
        return None
```

### 4. å­—å¹•è®¾ç½®API âœ…

**æ–‡ä»¶**: `backend/app/api/subtitle_settings.py`

- âœ… `GET /api/v1/subtitle-settings/` - è·å–å­—å¹•è®¾ç½®
- âœ… `PUT /api/v1/subtitle-settings/` - æ›´æ–°å­—å¹•è®¾ç½®

**å“åº”æ ¼å¼**:
```json
{
    "success": true,
    "message": "è·å–æˆåŠŸ",
    "data": {
        "auto_download": false,
        "default_language": "zh",
        "enabled_sources": ["opensubtitles"]
    }
}
```

### 5. å­—å¹•ä¸‹è½½APIå¢å¼º âœ…

**æ–‡ä»¶**: `backend/app/api/subtitle.py`

- âœ… `POST /api/v1/subtitles/download`æ”¯æŒ`force_download`å‚æ•°
- âœ… é»˜è®¤`force_download=True`ï¼ˆæ‰‹åŠ¨è°ƒç”¨APIæ—¶å¼ºåˆ¶ä¸‹è½½ï¼‰
- âœ… æ”¯æŒé€šè¿‡å‚æ•°æ§åˆ¶æ˜¯å¦å¿½ç•¥è‡ªåŠ¨ä¸‹è½½è®¾ç½®

### 6. åª’ä½“æ•´ç†å·¥ä½œæµé›†æˆ âœ…

**æ–‡ä»¶**: `backend/app/modules/media_renamer/organizer.py`

- âœ… æ•´ç†æ–‡ä»¶æ—¶ï¼Œå¦‚æœç”¨æˆ·æ˜ç¡®è¦æ±‚ä¸‹è½½å­—å¹•ï¼ˆ`download_subtitle=True`ï¼‰ï¼Œåˆ™å¼ºåˆ¶ä¸‹è½½
- âœ… å¦‚æœç”¨æˆ·æœªè¦æ±‚ï¼Œåˆ™éµå¾ªè‡ªåŠ¨ä¸‹è½½è®¾ç½®

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### 1. ä¸‰çº§æ§åˆ¶æœºåˆ¶

1. **ç³»ç»Ÿè®¾ç½®**ï¼ˆå…¨å±€é»˜è®¤ï¼‰ï¼š
   - å­˜å‚¨åœ¨`system_settings`è¡¨ä¸­
   - é”®ï¼š`subtitle_auto_download`
   - é»˜è®¤å€¼ï¼š`"false"`ï¼ˆå…³é—­ï¼‰

2. **ç¯å¢ƒå˜é‡**ï¼ˆé…ç½®é»˜è®¤ï¼‰ï¼š
   - `SUBTITLE_AUTO_DOWNLOAD`ç¯å¢ƒå˜é‡
   - é»˜è®¤å€¼ï¼š`false`

3. **APIå‚æ•°**ï¼ˆå•æ¬¡è°ƒç”¨ï¼‰ï¼š
   - `force_download`å‚æ•°
   - å¯ä»¥å¿½ç•¥è‡ªåŠ¨ä¸‹è½½è®¾ç½®ï¼Œå¼ºåˆ¶ä¸‹è½½

### 2. ä½¿ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šPTç«™èµ„æºï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
- è‡ªåŠ¨ä¸‹è½½ï¼š**å…³é—­**
- åŸå› ï¼šPTç«™èµ„æºå¤§å¤šæœ‰å†…ç½®å­—å¹•
- è¡Œä¸ºï¼šè·³è¿‡å­—å¹•ä¸‹è½½ï¼Œè®°å½•æ—¥å¿—æç¤º

#### åœºæ™¯2ï¼šéœ€è¦å­—å¹•æ—¶
- æ–¹å¼1ï¼šæ‰‹åŠ¨è°ƒç”¨APIä¸‹è½½
  ```bash
  POST /api/v1/subtitles/download?media_file_path=/path/to/movie.mkv&force_download=true
  ```
- æ–¹å¼2ï¼šå¼€å¯è‡ªåŠ¨ä¸‹è½½è®¾ç½®
  ```bash
  PUT /api/v1/subtitle-settings/
  {
      "auto_download": true
  }
  ```

#### åœºæ™¯3ï¼šæ•´ç†æ–‡ä»¶æ—¶
- ç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼š`download_subtitle=True` â†’ å¼ºåˆ¶ä¸‹è½½
- ç”¨æˆ·æœªè¦æ±‚ï¼šéµå¾ªè‡ªåŠ¨ä¸‹è½½è®¾ç½®

## ğŸ¯ APIä½¿ç”¨ç¤ºä¾‹

### è·å–å­—å¹•è®¾ç½®

```bash
GET /api/v1/subtitle-settings/
```

å“åº”ï¼š
```json
{
    "success": true,
    "message": "è·å–æˆåŠŸ",
    "data": {
        "auto_download": false,
        "default_language": "zh",
        "enabled_sources": ["opensubtitles"]
    }
}
```

### æ›´æ–°å­—å¹•è®¾ç½®ï¼ˆå¼€å¯è‡ªåŠ¨ä¸‹è½½ï¼‰

```bash
PUT /api/v1/subtitle-settings/
{
    "auto_download": true,
    "default_language": "zh",
    "enabled_sources": ["opensubtitles", "subhd"]
}
```

### æ‰‹åŠ¨ä¸‹è½½å­—å¹•ï¼ˆå¼ºåˆ¶ä¸‹è½½ï¼‰

```bash
POST /api/v1/subtitles/download?media_file_path=/path/to/movie.mkv&force_download=true
```

### æ•´ç†æ–‡ä»¶æ—¶ä¸‹è½½å­—å¹•

```bash
POST /api/v1/media-renamer/organize
{
    "source_path": "/downloads/movie.mkv",
    "target_base_dir": "/media/library",
    "download_subtitle": true,  # æ˜ç¡®è¦æ±‚ä¸‹è½½å­—å¹•
    "subtitle_language": "zh"
}
```

## ğŸ“ è®¾è®¡è¯´æ˜

### ä¸ºä»€ä¹ˆé»˜è®¤å…³é—­ï¼Ÿ

1. **PTç«™ç‰¹æ€§**ï¼šPTç«™èµ„æºå¤§å¤šåŒ…å«å†…ç½®å­—å¹•æˆ–å†…å«å­—å¹•æ–‡ä»¶
2. **ç”¨æˆ·éœ€æ±‚**ï¼šç”¨æˆ·å¯èƒ½ä¸éœ€è¦é¢å¤–ä¸‹è½½å­—å¹•
3. **èµ„æºèŠ‚çº¦**ï¼šé¿å…ä¸å¿…è¦çš„APIè°ƒç”¨å’Œå­˜å‚¨ç©ºé—´
4. **çµæ´»æ€§**ï¼šç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦æ‰‹åŠ¨å¼€å¯

### æ§åˆ¶å±‚çº§

```
ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨APIï¼ˆforce_download=Trueï¼‰
    â†“ æœ€é«˜ä¼˜å…ˆçº§
ç³»ç»Ÿè®¾ç½®ï¼ˆsubtitle_auto_downloadï¼‰
    â†“ å…¨å±€é»˜è®¤
ç¯å¢ƒå˜é‡ï¼ˆSUBTITLE_AUTO_DOWNLOADï¼‰
    â†“ é…ç½®é»˜è®¤
ä»£ç é»˜è®¤å€¼ï¼ˆFalseï¼‰
```

## ğŸ‰ æ€»ç»“

å­—å¹•ä¸‹è½½å¼€å…³åŠŸèƒ½å·²å®Œæˆï¼Œå®ç°äº†ï¼š

1. âœ… **é»˜è®¤å…³é—­è‡ªåŠ¨ä¸‹è½½**ï¼ˆç¬¦åˆPTç«™ä½¿ç”¨åœºæ™¯ï¼‰
2. âœ… **ä¸‰çº§æ§åˆ¶æœºåˆ¶**ï¼ˆç³»ç»Ÿè®¾ç½®ã€ç¯å¢ƒå˜é‡ã€APIå‚æ•°ï¼‰
3. âœ… **çµæ´»çš„é…ç½®æ–¹å¼**ï¼ˆAPIã€ç³»ç»Ÿè®¾ç½®ï¼‰
4. âœ… **æ¸…æ™°çš„æ—¥å¿—æç¤º**ï¼ˆå‘ŠçŸ¥ç”¨æˆ·ä¸ºä»€ä¹ˆè·³è¿‡ä¸‹è½½ï¼‰
5. âœ… **å¼ºåˆ¶ä¸‹è½½æ”¯æŒ**ï¼ˆæ‰‹åŠ¨è°ƒç”¨æ—¶ä¸å—é™åˆ¶ï¼‰

**ä¸‹ä¸€æ­¥**: ç»§ç»­å¼€å‘åª’ä½“åˆ†ç±»è§„åˆ™å¼•æ“ã€é›†æˆæ›´å¤šå­—å¹•æºã€å¼€å‘å‰ç«¯ç•Œé¢ã€‚

