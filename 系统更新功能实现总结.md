# 系统更新功能实现总结

## 概述

本文档总结了VabHub系统更新功能的实现，包括自动更新、热更新等功能，参考了MoviePilot的实现方式。

## 功能对比

### MoviePilot的更新功能

**配置项**（`app/core/config.py`）：
- `MOVIEPILOT_AUTO_UPDATE: str = 'release'` - 重启自动更新模式（never/release/dev）
- `AUTO_UPDATE_RESOURCE: bool = True` - 自动更新站点资源包

**实现方式**：
- 在系统启动时检查更新模式
- 如果启用自动更新，在重启时执行Git pull/checkout操作
- 支持更新到发行版本（release）或开发版本（dev）

### VabHub的更新功能

**新增功能**：
1. **自动更新** - 系统启动时自动检查并更新（如果启用）
2. **手动更新** - 通过API手动触发更新
3. **热更新** - 无需重启即可重载模块
4. **版本检查** - 检查当前版本和远程版本

## 实现细节

### 1. 后端实现

#### 1.1 更新管理器 (`app/modules/system/update_manager.py`)

**核心类**：`UpdateManager`

**功能**：
- `check_update_available()` - 检查是否有可用更新
- `update_system()` - 执行系统更新
- `hot_reload_modules()` - 热重载模块（无需重启）

**更新模式**：
- `NEVER` - 从不更新
- `RELEASE` - 仅更新到发行版本
- `DEV` - 更新到开发版本（包括release）

**实现逻辑**：
```python
# 1. 检查Git仓库
if not await self._is_git_repo():
    return {"success": False, "message": "当前目录不是Git仓库"}

# 2. 获取远程更新
await self._fetch_remote()

# 3. 检查是否有更新
update_info = await self.check_update_available()

# 4. 执行更新
if self.update_mode == UpdateMode.RELEASE:
    result = await self._update_to_release()
elif self.update_mode == UpdateMode.DEV:
    result = await self._update_to_dev()
```

#### 1.2 API端点 (`app/api/system_update.py`)

**端点列表**：
- `GET /api/system/update/check` - 检查更新
- `POST /api/system/update` - 执行系统更新
- `POST /api/system/hot-reload` - 热重载模块
- `GET /api/system/version` - 获取版本信息

#### 1.3 启动时自动更新 (`backend/main.py`)

**实现逻辑**：
```python
# 在lifespan启动时检查自动更新
async with get_db_session() as db:
    settings_service = SettingsService(db)
    update_mode_value = await settings_service.get_setting("system_auto_update_mode", category="system")
    
    if update_mode_value and update_mode_value != "never":
        update_manager = UpdateManager()
        update_manager.update_mode = UpdateMode(update_mode_value)
        
        # 在后台任务中执行更新（不阻塞启动）
        asyncio.create_task(auto_update_task())
```

**特点**：
- 异步执行，不阻塞系统启动
- 从数据库读取配置
- 更新失败不影响系统启动

### 2. 前端实现

#### 2.1 系统更新页面 (`frontend/src/pages/SystemUpdate.vue`)

**功能模块**：
1. **版本信息卡片** - 显示当前版本、Commit Hash、构建时间
2. **更新检查卡片** - 检查更新、显示更新状态
3. **更新设置卡片** - 配置自动更新模式
4. **更新操作卡片** - 手动更新到发行版/开发版
5. **热重载模块卡片** - 选择模块并执行热重载

**主要功能**：
- 实时检查更新状态
- 支持手动更新和自动更新配置
- 热重载模块选择和执行
- 更新结果提示和错误处理

## 热更新功能

### 支持热更新的模块

1. **分类配置** (`category_helper`) - 重新加载YAML配置
2. **系统设置** (`settings`) - 重新加载设置模块
3. **插件** (`plugins`) - 重新加载插件系统

### 热更新实现

**原理**：
- 使用Python的`importlib.reload()`重新加载模块
- 无需重启系统即可应用更改

**使用场景**：
- 修改分类配置YAML后立即生效
- 更新插件代码后立即生效
- 修改系统设置后立即生效

**限制**：
- 只能重载已加载的模块
- 不能重载核心系统模块（如数据库、路由等）
- 某些模块可能需要完全重启才能生效

## 与MoviePilot的对比

| 特性 | MoviePilot | VabHub |
|------|-----------|--------|
| **自动更新** | ✅ 重启时自动更新 | ✅ 启动时自动更新（后台任务） |
| **更新模式** | release/dev/never | release/dev/never |
| **手动更新** | ❌ | ✅ API端点支持 |
| **热更新** | ❌ | ✅ 支持模块热重载 |
| **版本检查** | ✅ 通过GitHub API | ✅ 通过Git命令 |
| **前端界面** | ✅ 设置页面 | ✅ 独立更新页面 |

## 使用说明

### 1. 配置自动更新

1. 进入"系统更新"页面
2. 在"更新设置"中选择更新模式：
   - **从不更新** - 禁用自动更新
   - **仅更新到发行版** - 仅更新到Git标签版本
   - **更新到开发版** - 更新到main分支最新代码
3. 启用"自动更新"开关

### 2. 手动更新

1. 点击"检查更新"按钮检查是否有新版本
2. 如果有更新，点击"更新到发行版"或"更新到开发版"
3. 更新完成后，系统会提示需要重启

### 3. 热重载模块

1. 在"热重载模块"卡片中选择要重载的模块
2. 点击"执行热重载"按钮
3. 模块会立即重新加载，无需重启系统

## 注意事项

1. **Git仓库要求**：
   - 系统更新功能需要项目是Git仓库
   - 需要配置远程仓库（origin）
   - 需要网络连接以获取远程更新

2. **更新风险**：
   - 更新可能会覆盖本地修改
   - 建议在更新前提交或备份本地更改
   - 更新后可能需要重启系统

3. **热更新限制**：
   - 只能重载已加载的模块
   - 某些模块（如数据库连接、路由等）需要重启才能生效
   - 热更新失败不会影响系统运行

## 未来改进

1. **更新历史记录** - 记录每次更新的详细信息
2. **回滚功能** - 支持回滚到之前的版本
3. **更新预览** - 显示更新内容摘要
4. **增量更新** - 仅下载和更新变更的文件
5. **更新通知** - 通过通知系统推送更新信息

## Docker支持（新增）

### 自动检测部署方式

系统会自动检测当前运行环境：
- **Docker环境**：检查`/.dockerenv`文件、环境变量或cgroup
- **源代码环境**：检查是否存在`.git`目录

### Docker更新流程

1. **检测Docker环境** - 自动识别是否在容器中运行
2. **获取镜像信息** - 从容器或环境变量获取镜像名称
3. **检查镜像更新** - 拉取最新镜像并比较镜像ID
4. **更新镜像** - 执行`docker pull`拉取新镜像
5. **重启容器** - 自动重启容器以使用新镜像

### 配置要求

在Docker部署时，建议设置以下环境变量：
```yaml
environment:
  - CONTAINER_NAME=vabhub-backend  # 容器名称
  - IMAGE_NAME=vabhub/vabhub:latest  # 镜像名称（可选）
  - DOCKER_CONTAINER=true  # 标识Docker环境（可选）
```

### 部署方式对比

| 部署方式 | 检测方法 | 更新方式 | 更新命令 |
|---------|---------|---------|---------|
| **Docker** | `/.dockerenv`、环境变量、cgroup | Docker pull + restart | `docker pull image:tag`<br>`docker restart container` |
| **源代码** | `.git`目录 | Git pull/checkout | `git pull origin main` |

## 总结

VabHub的系统更新功能在MoviePilot的基础上进行了增强：

1. **更灵活的更新方式** - 支持自动更新和手动更新
2. **多部署方式支持** - 自动检测并支持Docker和源代码两种部署方式
3. **热更新支持** - 无需重启即可重载模块
4. **更好的用户体验** - 独立的前端界面和详细的状态提示
5. **更安全的更新** - 异步执行，不阻塞系统启动

这些改进使得VabHub的系统更新功能更加完善和用户友好，适用于各种部署场景。

