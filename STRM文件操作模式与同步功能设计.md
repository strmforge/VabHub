# STRMæ–‡ä»¶æ“ä½œæ¨¡å¼ä¸åŒæ­¥åŠŸèƒ½è®¾è®¡

## ğŸ“‹ è®¾è®¡æ¦‚è¿°

å‚è€ƒMoviePilotçš„æ–‡ä»¶å¤„ç†æ¨¡å¼ï¼Œå®ç°å®Œæ•´çš„æ–‡ä»¶æ“ä½œå’ŒSTRMåŒæ­¥åŠŸèƒ½ã€‚

## ğŸ¯ æ–‡ä»¶æ“ä½œæ¨¡å¼

### 1. æœ¬åœ°åª’ä½“åº“æ¨¡å¼

#### COPYï¼ˆå¤åˆ¶ï¼‰
- **åŠŸèƒ½**ï¼šå¤åˆ¶æ–‡ä»¶åˆ°åª’ä½“åº“
- **ç‰¹ç‚¹**ï¼šä¿ç•™æºæ–‡ä»¶ï¼Œå¯ä»¥ç»§ç»­åšç§
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ä¿ç•™æºæ–‡ä»¶åšç§çš„æƒ…å†µ

#### MOVEï¼ˆç§»åŠ¨ï¼‰
- **åŠŸèƒ½**ï¼šç§»åŠ¨æ–‡ä»¶åˆ°åª’ä½“åº“
- **ç‰¹ç‚¹**ï¼šåˆ é™¤æºæ–‡ä»¶ï¼Œé‡Šæ”¾ç©ºé—´
- **é€‚ç”¨åœºæ™¯**ï¼šä¸éœ€è¦ä¿ç•™æºæ–‡ä»¶çš„æƒ…å†µ

#### SYMLINKï¼ˆè½¯è¿æ¥ï¼‰
- **åŠŸèƒ½**ï¼šåˆ›å»ºè½¯è¿æ¥æŒ‡å‘æºæ–‡ä»¶
- **ç‰¹ç‚¹**ï¼šä¸å ç”¨é¢å¤–ç©ºé—´ï¼Œæºæ–‡ä»¶åˆ é™¤åè¿æ¥å¤±æ•ˆ
- **é€‚ç”¨åœºæ™¯**ï¼šèŠ‚çœç©ºé—´ï¼Œä½†éœ€è¦ä¿è¯æºæ–‡ä»¶ä¸åˆ é™¤

#### HARDLINKï¼ˆç¡¬é“¾æ¥ï¼‰
- **åŠŸèƒ½**ï¼šåˆ›å»ºç¡¬é“¾æ¥æŒ‡å‘æºæ–‡ä»¶
- **ç‰¹ç‚¹**ï¼šä¸å ç”¨é¢å¤–ç©ºé—´ï¼Œæºæ–‡ä»¶åˆ é™¤åä»å¯è®¿é—®
- **é€‚ç”¨åœºæ™¯**ï¼šèŠ‚çœç©ºé—´ï¼Œä¸”éœ€è¦ä¿è¯æ–‡ä»¶å¯è®¿é—®

### 2. ç½‘ç›˜åª’ä½“åº“æ¨¡å¼

#### CLOUD_COPYï¼ˆç½‘ç›˜å¤åˆ¶ï¼‰
- **åŠŸèƒ½**ï¼šä¸Šä¼ æ–‡ä»¶åˆ°ç½‘ç›˜ï¼Œä¿ç•™æœ¬åœ°æ–‡ä»¶
- **ç‰¹ç‚¹**ï¼šæœ¬åœ°æ–‡ä»¶ä¿ç•™ï¼Œå¯ä»¥ç»§ç»­åšç§
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ä¿ç•™æœ¬åœ°æ–‡ä»¶åšç§çš„æƒ…å†µ

#### CLOUD_MOVEï¼ˆç½‘ç›˜ç§»åŠ¨ï¼‰
- **åŠŸèƒ½**ï¼šä¸Šä¼ æ–‡ä»¶åˆ°ç½‘ç›˜ï¼Œåˆ é™¤æœ¬åœ°æ–‡ä»¶
- **ç‰¹ç‚¹**ï¼šæœ¬åœ°æ–‡ä»¶åˆ é™¤ï¼Œé‡Šæ”¾ç©ºé—´
- **é€‚ç”¨åœºæ™¯**ï¼šä¸éœ€è¦ä¿ç•™æœ¬åœ°æ–‡ä»¶çš„æƒ…å†µ

#### CLOUD_STRMï¼ˆç½‘ç›˜STRMç”Ÿæˆï¼‰
- **åŠŸèƒ½**ï¼šä¸Šä¼ æ–‡ä»¶åˆ°ç½‘ç›˜ï¼Œç”ŸæˆSTRMæ–‡ä»¶åˆ°æœ¬åœ°åª’ä½“åº“
- **ç‰¹ç‚¹**ï¼šæœ¬åœ°åªä¿ç•™STRMæ–‡ä»¶ï¼ŒèŠ‚çœç©ºé—´
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦èŠ‚çœæœ¬åœ°ç©ºé—´ï¼Œä¸”éœ€è¦åª’ä½“æœåŠ¡å™¨è®¿é—®çš„æƒ…å†µ

## ğŸ”„ STRMåŒæ­¥åŠŸèƒ½

### 1. è‡ªåŠ¨åŒæ­¥é…ç½®

```python
class STRMSyncConfig:
    # STRMæœ¬åœ°åª’ä½“åº“åœ°å€
    strm_library_path: str
    
    # æ˜¯å¦å¯ç”¨è‡ªåŠ¨åŒæ­¥
    auto_sync: bool = True
    
    # é¦–æ¬¡åŒæ­¥æ¨¡å¼ï¼ˆå…¨é‡/å¢é‡ï¼‰
    first_sync_mode: str = "full"  # full/incremental
    
    # åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰
    sync_interval: int = 300  # 5åˆ†é’Ÿ
    
    # å®æ—¶å¯¹æ¯”ï¼ˆåˆ©ç”¨115ç½‘ç›˜å¼€å‘è€…æƒé™ï¼‰
    realtime_compare: bool = True
    
    # å¯¹æ¯”é—´éš”ï¼ˆç§’ï¼‰
    compare_interval: int = 60  # 1åˆ†é’Ÿ
    
    # ç½‘ç›˜åˆ é™¤è‡ªåŠ¨åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶
    auto_delete_on_cloud_delete: bool = True
```

### 2. åŒæ­¥æµç¨‹

#### é¦–æ¬¡åŒæ­¥ï¼ˆå…¨é‡ï¼‰
```
1. æ‰«æç½‘ç›˜æ–‡ä»¶æ ‘
   â†“
2. æ‰«ææœ¬åœ°STRMæ–‡ä»¶æ ‘
   â†“
3. å¯¹æ¯”å·®å¼‚
   â”œâ”€â”€ æ–°å¢æ–‡ä»¶
   â”œâ”€â”€ æ›´æ–°æ–‡ä»¶
   â””â”€â”€ åˆ é™¤æ–‡ä»¶
   â†“
4. ç”ŸæˆSTRMæ–‡ä»¶ï¼ˆæ–°å¢å’Œæ›´æ–°ï¼‰
   â†“
5. åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶ï¼ˆåˆ é™¤ï¼‰
   â†“
6. è®°å½•åŒæ­¥æ—¶é—´
```

#### å¢é‡åŒæ­¥
```
1. è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´
   â†“
2. æ‰«æç½‘ç›˜å˜æ›´æ–‡ä»¶ï¼ˆåˆ©ç”¨115ç½‘ç›˜å¼€å‘è€…æƒé™APIï¼‰
   â”œâ”€â”€ æ–°å¢æ–‡ä»¶
   â”œâ”€â”€ æ›´æ–°æ–‡ä»¶
   â””â”€â”€ åˆ é™¤æ–‡ä»¶
   â†“
3. ç”Ÿæˆæˆ–æ›´æ–°STRMæ–‡ä»¶
   â†“
4. åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶ï¼ˆå¦‚æœç½‘ç›˜æ–‡ä»¶å·²åˆ é™¤ï¼‰
   â†“
5. æ›´æ–°åŒæ­¥æ—¶é—´
```

#### å®æ—¶å¯¹æ¯”
```
1. åˆ©ç”¨115ç½‘ç›˜å¼€å‘è€…æƒé™APIè·å–æ–‡ä»¶å˜æ›´
   â”œâ”€â”€ æ–‡ä»¶æ–°å¢é€šçŸ¥
   â”œâ”€â”€ æ–‡ä»¶æ›´æ–°é€šçŸ¥
   â””â”€â”€ æ–‡ä»¶åˆ é™¤é€šçŸ¥
   â†“
2. å¤„ç†æ–°å¢å’Œæ›´æ–°çš„æ–‡ä»¶
   â”œâ”€â”€ ç”ŸæˆSTRMæ–‡ä»¶
   â””â”€â”€ æ›´æ–°STRMæ–‡ä»¶
   â†“
3. å¤„ç†åˆ é™¤çš„æ–‡ä»¶
   â””â”€â”€ åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶
   â†“
4. è®°å½•ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
```

### 3. 115ç½‘ç›˜å¼€å‘è€…æƒé™API

#### éœ€è¦çš„APIæ¥å£

1. **æ–‡ä»¶å˜æ›´é€šçŸ¥API**
   - è·å–æ–‡ä»¶æ–°å¢ã€æ›´æ–°ã€åˆ é™¤é€šçŸ¥
   - å®æ—¶æ¨é€æ–‡ä»¶å˜æ›´äº‹ä»¶

2. **æ–‡ä»¶åˆ—è¡¨API**
   - è·å–æ–‡ä»¶åˆ—è¡¨
   - æ”¯æŒå¢é‡æŸ¥è¯¢

3. **æ–‡ä»¶çŠ¶æ€æŸ¥è¯¢API**
   - æŸ¥è¯¢æ–‡ä»¶çŠ¶æ€
   - è·å–æ–‡ä»¶å…ƒæ•°æ®

4. **æ–‡ä»¶æ“ä½œAPI**
   - æ–‡ä»¶ä¸Šä¼ 
   - æ–‡ä»¶ä¸‹è½½
   - æ–‡ä»¶åˆ é™¤

#### å®ç°æ–¹å¼

```python
async def _get_cloud_realtime_changes(self) -> Dict[str, List[str]]:
    """
    è·å–ç½‘ç›˜å®æ—¶æ–‡ä»¶å˜æ›´
    åˆ©ç”¨115ç½‘ç›˜å¼€å‘è€…æƒé™API
    
    å‚è€ƒ115ç½‘ç›˜å¼€å‘è€…æ–‡æ¡£ï¼š
    - æ–‡ä»¶å˜æ›´é€šçŸ¥API
    - æ–‡ä»¶åˆ—è¡¨API
    - æ–‡ä»¶çŠ¶æ€æŸ¥è¯¢API
    """
    # è°ƒç”¨115ç½‘ç›˜API
    # 1. è®¢é˜…æ–‡ä»¶å˜æ›´é€šçŸ¥
    # 2. å¤„ç†æ–‡ä»¶å˜æ›´äº‹ä»¶
    # 3. è¿”å›å˜æ›´æ–‡ä»¶åˆ—è¡¨
    pass
```

## ğŸ—‘ï¸ ç½‘ç›˜åˆ é™¤è‡ªåŠ¨åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶

### 1. åˆ é™¤æ£€æµ‹

```python
async def _realtime_compare(self):
    """å®æ—¶å¯¹æ¯”ç½‘ç›˜å’Œæœ¬åœ°STRMæ–‡ä»¶"""
    # 1. è·å–ç½‘ç›˜æ–‡ä»¶å˜æ›´
    changes = await self._get_cloud_realtime_changes()
    
    # 2. å¤„ç†åˆ é™¤çš„æ–‡ä»¶
    if changes.get('deleted') and self.sync_config.auto_delete_on_cloud_delete:
        await self._delete_local_strm_files(changes['deleted'])
```

### 2. åˆ é™¤æµç¨‹

```
1. æ£€æµ‹åˆ°ç½‘ç›˜æ–‡ä»¶åˆ é™¤
   â†“
2. æŸ¥æ‰¾å¯¹åº”çš„æœ¬åœ°STRMæ–‡ä»¶
   â†“
3. åˆ é™¤STRMæ–‡ä»¶
   â†“
4. åˆ é™¤å…³è”çš„NFOæ–‡ä»¶
   â†“
5. åˆ é™¤å…³è”çš„å­—å¹•æ–‡ä»¶
   â†“
6. æ¸…ç†ç©ºæ–‡ä»¶å¤¹
   â†“
7. è®°å½•åˆ é™¤äº‹ä»¶
```

### 3. åˆ é™¤å®ç°

```python
async def _delete_local_strm_files(self, file_list: List[str]):
    """åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶"""
    for file_path in file_list:
        # 1. æŸ¥æ‰¾å¯¹åº”çš„æœ¬åœ°STRMæ–‡ä»¶
        local_strm_path = await self._find_local_strm_file(file_path)
        
        # 2. åˆ é™¤STRMæ–‡ä»¶
        Path(local_strm_path).unlink()
        
        # 3. åˆ é™¤å…³è”çš„NFOæ–‡ä»¶
        nfo_path = Path(local_strm_path).with_suffix('.nfo')
        if nfo_path.exists():
            nfo_path.unlink()
        
        # 4. åˆ é™¤å…³è”çš„å­—å¹•æ–‡ä»¶
        subtitle_files = await self._find_local_subtitle_files(local_strm_path)
        for subtitle_file in subtitle_files:
            if Path(subtitle_file).exists():
                Path(subtitle_file).unlink()
        
        # 5. æ¸…ç†ç©ºæ–‡ä»¶å¤¹
        await self._cleanup_empty_folders(Path(local_strm_path).parent)
        
        # 6. è®°å½•åˆ é™¤äº‹ä»¶
        await self._record_delete_event(file_path, local_strm_path)
```

## ğŸ“Š é…ç½®ç¤ºä¾‹

### 1. æœ¬åœ°åª’ä½“åº“é…ç½®

```python
config = STRMWorkflowConfig(
    destination=MediaLibraryDestination.LOCAL,
    operation_mode=FileOperationMode.COPY,  # æˆ– MOVE, SYMLINK, HARDLINK
    source_path='/downloads/movie.mkv',
    target_path='/media_library/Movies/movie.mkv',
    keep_seeding=True  # ä¿ç•™åšç§
)
```

### 2. ç½‘ç›˜åª’ä½“åº“é…ç½®ï¼ˆå¤åˆ¶æ¨¡å¼ï¼‰

```python
config = STRMWorkflowConfig(
    destination=MediaLibraryDestination.CLOUD,
    operation_mode=FileOperationMode.CLOUD_COPY,
    cloud_storage='115',
    cloud_target_path='/ç”µå½±/movie.mkv',
    source_path='/downloads/movie.mkv',
    keep_seeding=True  # ä¿ç•™åšç§
)
```

### 3. ç½‘ç›˜åª’ä½“åº“é…ç½®ï¼ˆç§»åŠ¨æ¨¡å¼ï¼‰

```python
config = STRMWorkflowConfig(
    destination=MediaLibraryDestination.CLOUD,
    operation_mode=FileOperationMode.CLOUD_MOVE,
    cloud_storage='115',
    cloud_target_path='/ç”µå½±/movie.mkv',
    source_path='/downloads/movie.mkv',
    delete_source=True  # åˆ é™¤æºæ–‡ä»¶
)
```

### 4. ç½‘ç›˜åª’ä½“åº“é…ç½®ï¼ˆSTRMæ¨¡å¼ï¼‰

```python
config = STRMWorkflowConfig(
    destination=MediaLibraryDestination.CLOUD,
    operation_mode=FileOperationMode.CLOUD_STRM,
    cloud_storage='115',
    cloud_target_path='/ç”µå½±/movie.mkv',
    source_path='/downloads/movie.mkv',
    generate_strm=True,
    strm_sync_config=STRMSyncConfig(
        strm_library_path='/media_library',
        auto_sync=True,
        first_sync_mode='full',
        sync_interval=300,
        realtime_compare=True,
        compare_interval=60,
        auto_delete_on_cloud_delete=True
    )
)
```

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§

1. âœ… **æ–‡ä»¶æ“ä½œæ¨¡å¼**
   - å¤åˆ¶ã€ç§»åŠ¨ã€è½¯è¿æ¥ã€ç¡¬é“¾æ¥
   - ç½‘ç›˜å¤åˆ¶ã€ç½‘ç›˜ç§»åŠ¨

2. âœ… **STRMç”Ÿæˆ**
   - ç½‘ç›˜STRMç”Ÿæˆ
   - STRMæ–‡ä»¶ç”Ÿæˆåˆ°æœ¬åœ°åª’ä½“åº“

3. ğŸš§ **è‡ªåŠ¨åŒæ­¥**
   - å…¨é‡åŒæ­¥
   - å¢é‡åŒæ­¥
   - å®æ—¶å¯¹æ¯”ï¼ˆéœ€è¦115ç½‘ç›˜å¼€å‘è€…æƒé™APIï¼‰

4. ğŸš§ **ç½‘ç›˜åˆ é™¤è‡ªåŠ¨åˆ é™¤æœ¬åœ°STRMæ–‡ä»¶**
   - åˆ é™¤æ£€æµ‹
   - åˆ é™¤å®ç°
   - ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è®°å½•

### ä¸­ä¼˜å…ˆçº§

5. **115ç½‘ç›˜å¼€å‘è€…æƒé™APIé›†æˆ**
   - æ–‡ä»¶å˜æ›´é€šçŸ¥API
   - æ–‡ä»¶åˆ—è¡¨API
   - æ–‡ä»¶çŠ¶æ€æŸ¥è¯¢API

6. **æ–‡ä»¶æ ‘ç®¡ç†**
   - æ–‡ä»¶æ ‘æ‰«æ
   - æ–‡ä»¶æ ‘å¯¹æ¯”
   - æ–‡ä»¶æ ‘æ›´æ–°

### ä½ä¼˜å…ˆçº§

7. **å‰ç«¯ç•Œé¢**
   - æ–‡ä»¶æ“ä½œæ¨¡å¼é€‰æ‹©
   - STRMåŒæ­¥é…ç½®
   - åŒæ­¥çŠ¶æ€æ˜¾ç¤º

## ğŸ“ 115ç½‘ç›˜å¼€å‘è€…æƒé™APIéœ€æ±‚

### éœ€è¦çš„APIæ–‡æ¡£

1. **æ–‡ä»¶å˜æ›´é€šçŸ¥API**
   - å¦‚ä½•è®¢é˜…æ–‡ä»¶å˜æ›´é€šçŸ¥
   - æ–‡ä»¶å˜æ›´äº‹ä»¶æ ¼å¼
   - å®æ—¶æ¨é€æœºåˆ¶

2. **æ–‡ä»¶åˆ—è¡¨API**
   - å¦‚ä½•è·å–æ–‡ä»¶åˆ—è¡¨
   - å¢é‡æŸ¥è¯¢æ–¹å¼
   - æ–‡ä»¶å…ƒæ•°æ®æ ¼å¼

3. **æ–‡ä»¶çŠ¶æ€æŸ¥è¯¢API**
   - å¦‚ä½•æŸ¥è¯¢æ–‡ä»¶çŠ¶æ€
   - æ–‡ä»¶çŠ¶æ€å­—æ®µ
   - æŸ¥è¯¢é¢‘ç‡é™åˆ¶

4. **æ–‡ä»¶æ“ä½œAPI**
   - æ–‡ä»¶ä¸Šä¼ API
   - æ–‡ä»¶ä¸‹è½½API
   - æ–‡ä»¶åˆ é™¤API

### å®ç°å»ºè®®

1. **è”ç³»115ç½‘ç›˜å¼€å‘è€…**
   - ç”³è¯·å¼€å‘è€…æƒé™
   - è·å–APIæ–‡æ¡£
   - è·å–APIå¯†é’¥

2. **å®ç°APIå®¢æˆ·ç«¯**
   - å°è£…115ç½‘ç›˜APIè°ƒç”¨
   - å®ç°æ–‡ä»¶å˜æ›´é€šçŸ¥è®¢é˜…
   - å®ç°å®æ—¶æ–‡ä»¶å¯¹æ¯”

3. **æµ‹è¯•å’Œä¼˜åŒ–**
   - æµ‹è¯•APIè°ƒç”¨é¢‘ç‡
   - ä¼˜åŒ–APIè°ƒç”¨æ–¹å¼
   - é¿å…è§¦å‘é£æ§

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆ

1. âœ… æ–‡ä»¶æ“ä½œæ¨¡å¼å®šä¹‰
2. âœ… æ–‡ä»¶å¤„ç†å™¨å®ç°
3. âœ… STRMåŒæ­¥ç®¡ç†å™¨æ¡†æ¶
4. âœ… é…ç½®æ¨¡å‹è®¾è®¡

### å¾…å®ç°

1. ğŸš§ 115ç½‘ç›˜å¼€å‘è€…æƒé™APIé›†æˆ
2. ğŸš§ å®æ—¶æ–‡ä»¶å¯¹æ¯”å®ç°
3. ğŸš§ æ–‡ä»¶æ ‘ç®¡ç†å™¨å®ç°
4. ğŸš§ å‰ç«¯ç•Œé¢å¼€å‘

### ä¸‹ä¸€æ­¥

1. **è·å–115ç½‘ç›˜å¼€å‘è€…æƒé™APIæ–‡æ¡£**
2. **å®ç°115ç½‘ç›˜APIå®¢æˆ·ç«¯**
3. **å®ç°å®æ—¶æ–‡ä»¶å¯¹æ¯”**
4. **æµ‹è¯•å’Œä¼˜åŒ–**

è¯·æä¾›115ç½‘ç›˜å¼€å‘è€…æƒé™APIæ–‡æ¡£ï¼Œä»¥ä¾¿å®ç°å®æ—¶æ–‡ä»¶å¯¹æ¯”åŠŸèƒ½ã€‚

