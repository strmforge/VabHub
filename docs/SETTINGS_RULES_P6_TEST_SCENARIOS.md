# SETTINGS-RULES-1 P6 测试场景文档

## 项目概述

**项目名称**: SETTINGS-RULES-1：全局 HR 策略 + 分辨率档位 + 三档模式（含 STRM/移动联动）
**测试阶段**: P6 - 测试与文档
**文档版本**: v1.0
**测试目标**: 验证全局规则系统的完整功能和用户体验

---

## 测试环境准备

### 前置条件
1. **后端服务**: VabHub 后端服务正常运行
2. **数据库**: 已执行全局规则表迁移脚本
3. **前端应用**: Vue 3 + Vuetify 前端应用可访问
4. **API接口**: `/api/settings/rules/global` 端点正常响应
5. **测试数据**: 准备不同HR标签、分辨率、质量的测试种子数据

### 测试工具
- 浏览器开发者工具（监控API调用）
- 数据库客户端（验证数据持久化）
- 种子管理客户端（验证下载行为）

---

## 核心测试场景（8个）

### 场景1：默认B档行为回归测试
**测试目标**: 验证默认B档、不改任何选项时，行为与当前系统尽量保持一致

**测试步骤**:
1. 访问 `/settings/global-rules` 页面
2. 确认默认为B档平衡模式
3. 不修改任何选项，点击"保存设置"
4. 执行搜索操作，观察种子筛选结果
5. 执行自动订阅，观察下载行为

**预期结果**:
- HR策略：安全跳过（跳过H&R/HR高风险种子）
- 分辨率：自动选择，最高4K
- 源质量：禁用低质（过滤CAM/TS/TC）
- HDR策略：任意
- 3D策略：禁止3D
- STRM/移动行为：允许所有操作

**验证点**:
- API调用成功：`PUT /api/settings/rules/global`
- 数据库记录正确保存
- 搜索结果与历史行为一致
- 下载任务创建正常

---

### 场景2：A档安全模式测试
**测试目标**: 验证切换到A档后，HR种子明显减少或被跳过，分辨率高于1080p的候选被过滤

**测试步骤**:
1. 在全局规则设置页面，切换到A档保种安全模式
2. 确认C档切换确认对话框不出现（仅切换到C档时出现）
3. 点击"保存设置"
4. 执行搜索操作，包含HR种子和4K种子
5. 观察筛选结果

**预期结果**:
- HR策略：严格跳过（跳过所有HR种子）
- 分辨率策略：最高档位1080p
- 源质量：禁用低质
- HDR策略：仅SDR
- 3D策略：禁止3D
- STRM/移动行为：本地只允许复制/硬链接，网盘禁止移动上传

**验证点**:
- HR种子被过滤掉（H&R/HR/H3/H5/UNKNOWN）
- 4K/2160p种子被过滤，只保留1080p及以下
- UI显示A档模式提示信息
- 数据库配置正确保存

---

### 场景3：C档老司机模式UI测试
**测试目标**: 验证UI显示红色提示，切换时有确认弹窗

**测试步骤**:
1. 在B档或A档模式下，点击C档按钮
2. 验证确认对话框出现
3. 检查对话框内容：
   - 标题："切换到「老司机模式」"
   - 红色警示文本："如使用，系统将禁用『网盘移动上传』或『本地移动保存』，避免导致保种炸雷，请谨慎使用。"
   - 行为说明列表
4. 点击"取消"，验证模式不变
5. 再次点击C档，点击"确认切换"

**预期结果**:
- 确认对话框内容完整准确
- 取消操作保持原模式
- 确认后切换到C档，显示红色error类型警示
- C档模式下HR策略被锁定（显示锁定图标）

**验证点**:
- 对话框样式和内容符合规范
- 取消/确认逻辑正确
- C档红色警示显示正确
- HR策略控件正确禁用

---

### 场景4：C档移动整理联动测试
**测试目标**: 验证下载任务执行时，本地/网盘"移动整理"行为被自动降级为复制/硬链接/仅 STRM

**测试步骤**:
1. 切换到C档老司机模式并保存
2. 创建下载任务，配置为"移动整理"模式
3. 观察任务执行过程
4. 检查文件操作日志
5. 验证源文件是否保留

**预期结果**:
- 本地移动整理自动降级为复制/硬链接
- 网盘移动上传自动降级为复制上传
- STRM生成功能正常
- 源文件不会被删除

**验证点**:
- 文件操作日志显示降级行为
- 源目录文件完整保留
- 目标目录文件正确复制
- 无删除操作执行

---

### 场景5：中文字幕过滤测试
**测试目标**: 验证设置"必须包含中文字幕"后，在有中字/无中字的混合结果中，只有有中字的被选中下载

**测试步骤**:
1. 在全局规则设置中，开启"必须包含中文字幕"
2. 保存设置
3. 执行搜索操作，确保结果包含：
   - 有中文字幕的种子
   - 无中文字幕的种子
   - 简体中文种子
   - 繁体中文种子
4. 观察筛选结果

**预期结果**:
- 只保留包含简体或繁体中文字幕的种子
- 无中文字幕的种子被过滤
- 简体和繁体中文字幕都被接受

**验证点**:
- API返回的筛选结果正确
- UI显示的字幕策略生效
- 搜索日志记录过滤情况

---

### 场景6：源质量过滤测试
**测试目标**: 验证设置"过滤低质源、高质量优先"后，CAM/TS类结果被过滤

**测试步骤**:
1. 设置源质量策略为"只要高质量源"
2. 保存设置
3. 执行搜索，确保结果包含：
   - CAM/TS/TC等低质量源
   - WEB-DL普通质量源
   - REMUX/BLURAY/UHD高质量源
4. 观察筛选结果

**预期结果**:
- CAM/TS/TC等低质量源被过滤
- 普通WEB-DL被过滤
- 只保留REMUX/BLURAY/UHD/高码WEB-DL

**验证点**:
- 质量标签过滤正确生效
- 高质量源定义符合预期
- 过滤日志记录详细

---

### 场景7：HDR/SDR过滤测试
**测试目标**: 验证设置"只下载SDR"后，结果中只保留非HDR资源

**测试步骤**:
1. 设置HDR策略为"仅下载SDR"
2. 保存设置
3. 执行搜索，确保结果包含：
   - HDR版本
   - SDR版本
   - Dolby Vision版本
4. 观察筛选结果

**预期结果**:
- HDR版本被过滤
- Dolby Vision版本被过滤
- 只保留SDR版本

**验证点**:
- HDR标签正确识别和过滤
- SDR版本完整保留
- 工具提示说明准确

---

### 场景8：音轨偏好过滤测试
**测试目标**: 验证设置"避免只有国语配音"后，只有国语的片源被过滤；同一标题如果有"原语+国语双轨"的版本，则优先选择该版本

**测试步骤**:
1. 设置音轨策略为"尽量避开只有国语配音的资源"
2. 保存设置
3. 执行搜索，确保结果包含：
   - 只有国语配音的版本
   - 原声版本
   - 原声+国语双轨版本
4. 观察筛选和排序结果

**预期结果**:
- 只有国语配音的版本被过滤
- 原声+国语双轨版本优先排序
- 原声版本正常保留

**验证点**:
- 音轨标签识别正确
- 过滤逻辑准确执行
- 排序权重符合预期

---

### 场景9：3D资源过滤测试
**测试目标**: 验证开启3D禁用后，3D资源不再进入候选列表

**测试步骤**:
1. 确认3D策略为"禁止3D"（默认状态）
2. 执行搜索，确保结果包含：
   - 3D版本
   - 2D版本
3. 观察筛选结果
4. 切换3D策略为"允许3D"，重新搜索

**预期结果**:
- 禁止3D时，3D版本被过滤
- 允许3D时，3D版本正常显示
- 2D版本始终保留

**验证点**:
- 3D标签正确识别
- 策略切换立即生效
- 工具提示说明准确

---

## 边界测试场景

### 场景10：网络异常处理测试
**测试步骤**:
1. 断开网络连接
2. 尝试保存设置
3. 尝试加载设置
4. 恢复网络，重试操作

**预期结果**:
- 网络异常时显示错误提示
- 操作失败不影响当前设置
- 网络恢复后操作正常

### 场景11：并发操作测试
**测试步骤**:
1. 在多个浏览器标签页打开设置页面
2. 同时修改不同设置并保存
3. 观察数据一致性

**预期结果**:
- 最后保存的设置生效
- 无数据冲突或损坏
- UI状态正确同步

---

## 性能测试场景

### 场景12：大量种子筛选性能测试
**测试步骤**:
1. 准备1000+种子的搜索结果
2. 应用复杂过滤规则
3. 测量筛选响应时间

**预期结果**:
- 筛选响应时间 < 2秒
- UI不出现卡顿
- 内存使用正常

---

## 用户体验测试

### 场景13：工具提示可用性测试
**测试步骤**:
1. 悬停各个?帮助图标
2. 验证提示内容准确性
3. 测试提示显示/隐藏时机

**预期结果**:
- 所有工具提示正常显示
- 内容准确易懂
- 交互流畅自然

### 场景14：重置功能测试
**测试步骤**:
1. 修改多项设置
2. 点击"重置为默认"
3. 点击"重置为当前档默认"
4. 验证重置结果

**预期结果**:
- 默认重置恢复B档默认配置
- 当前档重置保持当前档位，重置其他配置
- 重置确认提示准确

---

## 测试报告模板

### 测试结果记录表

| 场景编号 | 测试项目 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|---------|---------|---------|------|------|
| 1 | B档回归测试 | 行为与历史一致 | | ☐通过 ☐失败 | |
| 2 | A档安全模式 | HR/4K被过滤 | | ☐通过 ☐失败 | |
| 3 | C档UI测试 | 确认对话框正确 | | ☐通过 ☐失败 | |
| 4 | C档联动测试 | 移动降级为复制 | | ☐通过 ☐失败 | |
| 5 | 中文字幕过滤 | 只保留有中字 | | ☐通过 ☐失败 | |
| 6 | 源质量过滤 | 低质源被过滤 | | ☐通过 ☐失败 | |
| 7 | HDR/SDR过滤 | 只保留SDR | | ☐通过 ☐失败 | |
| 8 | 音轨偏好过滤 | 纯国语被过滤 | | ☐通过 ☐失败 | |
| 9 | 3D资源过滤 | 3D被正确过滤 | | ☐通过 ☐失败 | |

### 缺陷记录表

| 缺陷ID | 场景编号 | 缺陷描述 | 严重程度 | 状态 | 解决方案 |
|--------|---------|---------|---------|------|---------|
| | | | 高/中/低 | ☐新建 ☐处理中 ☐已解决 | |

---

## 测试完成标准

### 功能完整性
- ☐ 所有14个测试场景执行完成
- ☐ 核心功能测试通过率 100%
- ☐ 边界测试通过率 100%

### 性能指标
- ☐ 页面加载时间 < 3秒
- ☐ 设置保存响应时间 < 1秒
- ☐ 大量数据筛选响应时间 < 2秒

### 用户体验
- ☐ UI交互流畅无卡顿
- ☐ 错误提示准确友好
- ☐ 工具提示完整准确

### 代码质量
- ☐ 无JavaScript错误
- ☐ API调用无异常
- ☐ 数据操作无损坏

---

## 测试环境清理

### 测试后操作
1. 恢复默认设置配置
2. 清理测试下载任务
3. 清理测试搜索历史
4. 验证系统正常运行

### 数据备份建议
- 测试前备份当前设置
- 记录测试过程中的配置变更
- 保留关键测试截图和日志

---

**文档维护**: 本测试文档应在功能更新后及时维护，确保测试场景的完整性和准确性。

**测试负责人**: ____________  
**测试完成日期**: ____________  
**版本发布批准**: ____________
