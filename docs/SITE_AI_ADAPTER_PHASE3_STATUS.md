# 站点 AI 适配模块 Phase AI-3 完成状态

## 概述

Phase AI-3 的目标是将"悄悄在后台跑"的 AI 适配功能，变成管理员能看得见、能粗略控制调用频率、能安全观察效果的「实验性能力」。

## 完成时间

2025-11-21

## 实现内容

### 任务 A：站点列表与详情中展示 AI 适配状态 ✅

#### A1. 后端补充站点信息中的 AI 字段

**文件：** `backend/app/core/site_ai_adapter/status.py`

**新增模块：**
- `AISiteAdapterStatus`：站点 AI 适配状态数据模型
- `get_ai_adapter_status_for_site()`：获取站点 AI 适配状态的辅助函数

**新增字段（在 `SiteResponse` 中）：**
- `ai_adapter_enabled`：是否全局启用 AI 适配（来自配置）
- `ai_config_present`：此站点是否已有 AI 配置记录
- `ai_config_last_analyzed_at`：上一次 AI 分析完成时间
- `ai_effective_mode`：生效模式（"manual_profile" | "ai_profile" | "none"）

**集成点：**
- `backend/app/api/site.py`：
  - `list_sites()`：在站点列表响应中补充 AI 状态字段
  - `get_site()`：在站点详情响应中补充 AI 状态字段

**特点：**
- 所有新字段都是 Optional，向后兼容
- 即使未配置 AI，也返回明确的 false/null
- 状态查询失败时使用默认值，不影响主流程

#### A2. 前端站点列表增加「AI 适配状态」列

**文件：** `frontend/src/components/site/SiteCard.vue`

**新增内容：**
- 在站点卡片中显示 AI 适配状态图标和标签
- 使用 tooltip 显示详细信息（配置状态、上次分析时间、生效模式）
- 添加"AI配置诊断"按钮（小虫图标），点击打开调试对话框

**显示逻辑：**
- 仅在 `ai_adapter_enabled` 为 true 时显示 AI 状态信息
- 使用不同图标和颜色区分"已配置"和"未配置"
- 显示生效模式标签（手工配置/AI配置/无配置）

### 任务 B：调用频率与安全阈值控制 ✅

#### B1. 增加简单的频率限制逻辑（后端）

**文件：** `backend/app/core/site_ai_adapter/service.py`

**修改函数：** `maybe_auto_analyze_site()`

**新增逻辑：**
- 在自动分析前，检查站点是否在最近 X 分钟内已分析过
- 如果已分析过，跳过本次自动触发，记录 INFO 日志
- 日志包含：site_id、上次分析时间、配置的间隔值、还需等待的时间

**新增配置项：** `backend/app/core/config.py`
- `AI_ADAPTER_MIN_REANALYZE_INTERVAL_MINUTES`：同一站点两次自动分析的最小间隔（分钟）
- 默认值：60 分钟
- 可通过环境变量 `AI_ADAPTER_MIN_REANALYZE_INTERVAL_MINUTES` 配置

**特点：**
- 频率限制只影响自动触发，不影响手动刷新（`POST /api/admin/site-ai-adapter/refresh/{site_id}`）
- 检查失败时记录 DEBUG 日志并继续执行分析（容错处理）

#### B2. 文档更新频率策略

**文件：** `docs/SITE_AI_ADAPTER_PHASE3_STATUS.md`（本文档）

**说明内容：**
- 自动分析触发场景（创建/更新站点）
- 频率限制策略（默认 60 分钟内不重复分析）
- 配置项说明（名称、默认值、修改方式）

### 任务 C：AI 有效配置可视化调试面板 ✅

**文件：** `frontend/src/components/site/SiteAIAdapterDebugDialog.vue`

**新增组件：**
- 对话框形式的调试面板
- 展示站点基本信息
- 展示 AI 配置状态（是否存在、引擎类型、URL、HR 规则等）
- 展示 Local Intel 配置（生效模式、HR 监控、站内信监控）
- 展示 External Indexer 配置（生效模式、基础 URL、框架类型、支持能力）

**集成点：**
- `frontend/src/pages/Sites.vue`：
  - 导入 `SiteAIAdapterDebugDialog` 组件
  - 监听 `SiteCard` 的 `ai-debug` 事件
  - 打开调试对话框

**API 调用：**
- 使用 `GET /api/admin/site-ai-adapter/effective-config/{site_id}` 获取配置数据
- 错误处理：显示 toast 提示和错误信息

**UI 特点：**
- 使用卡片分组展示不同模块的配置
- 使用 Chip 组件显示状态标签
- 响应式布局，支持滚动

### 任务 D：整理文档 & 代码自检 ✅

**自检结果：**
- ✅ 后端导入检查通过
- ✅ Lint 检查无错误
- ✅ 前端组件创建完成

## 使用方式

### 查看站点 AI 适配状态

1. **站点列表页面**
   - 每个站点卡片会显示 AI 适配状态图标
   - 鼠标悬停查看详细信息（配置状态、上次分析时间、生效模式）

2. **AI 配置诊断**
   - 点击站点卡片上的"小虫"图标（AI配置诊断）
   - 打开调试对话框，查看完整的配置信息

### 频率限制说明

**自动触发场景：**
- 创建新站点时
- 更新站点时

**频率限制：**
- 默认：同一站点在 60 分钟内不会重复自动分析
- 如果站点在 60 分钟内已分析过，会跳过本次自动触发
- 日志会记录跳过原因和还需等待的时间

**手动刷新不受限制：**
- 使用 `POST /api/admin/site-ai-adapter/refresh/{site_id}` 手动刷新时，不受频率限制

**调整频率限制：**
```bash
# 在 .env 文件中设置
AI_ADAPTER_MIN_REANALYZE_INTERVAL_MINUTES=120  # 改为 120 分钟
```

## 配置项说明

### AI_ADAPTER_MIN_REANALYZE_INTERVAL_MINUTES

- **类型：** 整数（分钟）
- **默认值：** `60`
- **作用：** 控制同一站点两次自动分析的最小间隔时间
- **建议值：**
  - 开发/测试环境：可设置为较小值（如 10-30 分钟）
  - 生产环境：建议保持默认值或更大（60-120 分钟）
- **注意事项：**
  - 此限制只影响自动触发，不影响手动刷新
  - 设置为 0 可禁用频率限制（不推荐）

## 前端界面说明

### 站点卡片中的 AI 状态显示

**显示位置：** 站点卡片的信息区域

**显示内容：**
- AI 适配图标（✅ 已配置 / ⚪ 未配置）
- 生效模式标签（手工配置/AI配置/无配置）
- Tooltip 详细信息：
  - 配置状态
  - 上次分析时间
  - 生效模式说明

**交互：**
- 点击"小虫"图标打开调试对话框

### 调试对话框

**打开方式：**
- 点击站点卡片上的"小虫"图标

**显示内容：**
1. **站点信息**
   - 站点名称
   - 站点 ID

2. **AI 配置状态**
   - 配置是否存在
   - 引擎类型
   - 搜索 URL
   - 详情 URL
   - HR 规则是否启用

3. **Local Intel 配置**
   - 生效模式（手工/AI/无）
   - HR 监控状态
   - HR 页面路径
   - 站内信监控状态

4. **External Indexer 配置**
   - 生效模式（手工/AI/无）
   - 站点名称
   - 基础 URL
   - 框架类型
   - 支持能力列表

## 向后兼容性

✅ **完全向后兼容**

- 所有新字段都是 Optional，不影响现有 API 消费者
- 前端组件使用条件渲染，不影响没有 AI 配置的站点
- 频率限制只影响自动触发，不影响手动操作
- 所有新功能都通过 `AI_ADAPTER_ENABLED` 开关控制

## 注意事项

1. **实验性功能标识**
   - 所有 UI 中的"AI 适配"字样都标注为"实验性功能"
   - 不要给用户"必须开启"的错觉

2. **频率限制建议**
   - 生产环境建议保持默认值（60 分钟）
   - 频繁修改站点配置时，可能需要手动刷新

3. **调试对话框**
   - 主要用于诊断和观察，不提供编辑功能
   - 如需修改配置，请使用手动刷新 API

4. **日志监控**
   - 建议监控频率限制相关的 INFO 日志
   - 如果频繁出现跳过记录，可能需要调整间隔时间

## 后续扩展方向

1. **前端管理界面增强**
   - 在站点管理页面添加"批量刷新 AI 配置"功能
   - 添加"AI 适配统计"面板（显示已配置站点数量、成功率等）

2. **频率限制优化**
   - 支持按站点类型设置不同的频率限制
   - 支持"强制刷新"选项（忽略频率限制）

3. **配置对比功能**
   - 在调试对话框中显示配置变更历史
   - 支持对比不同版本的配置

---

**文档版本：** 1.0  
**最后更新：** 2025-11-21

