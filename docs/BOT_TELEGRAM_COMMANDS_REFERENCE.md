# Telegram Bot 命令参考手册

BOT-EXT-1 实现

## 基础命令

| 命令 | 说明 | 权限 |
|------|------|------|
| `/start` | 绑定账号 / 打开主菜单 | 所有用户 |
| `/menu` | 打开主菜单 | 已绑定用户 |
| `/help` | 显示帮助信息 | 所有用户 |
| `/ping` | 检查 Bot 状态 | 所有用户 |
| `/settings` | 账号设置 | 已绑定用户 |

## 搜索功能

### /search - 全局搜索

**格式：**
```
/search <关键词>
/search <媒体类型> <关键词>
```

**示例：**
```
/search 三体
/search movie 流浪地球
/search manga 进击的巨人
/search 漫画 海贼王
```

**支持的媒体类型：**
- `movie` / `电影` - 电影
- `tv` / `剧集` / `电视剧` - 剧集
- `novel` / `小说` - 小说
- `manga` / `漫画` - 漫画
- `audiobook` / `有声书` - 有声书
- `music` / `音乐` - 音乐

**返回结果：**
- 按媒体类型分组展示
- 每个结果带操作按钮：
  - 漫画：📌 追更
  - 小说/有声书：📖 阅读
  - 音乐：⬇️ 下载
  - 🌐 网页 (跳转到 Web 详情页)

**纯文本搜索：**
直接发送媒体名称（不以 `/` 开头），Bot 会自动当作搜索处理。

## TG-BOT-2 影视订阅控制 (V2)

### /subs - 查看影视订阅

**格式：**
```
/subs
```

**功能：**
- 显示用户的影视订阅列表（最多10条）
- 包含订阅ID、标题、媒体类型、状态、站点、清晰度、安全策略
- 支持电影和美剧订阅

**示例输出：**
```
📽️ 你的影视订阅（最多显示 10 条）：

#12 电影《沙丘2》 (启用)
- 站点：1, 2, 3
- 清晰度：1080p-2160p
- 安全策略：安全模式（禁止 HR/H3/H5，只下载 Free）
- 上次检查：2025-11-27 02:13

💡 快速操作：
- /sub_check <id>  手动检查指定订阅
- /sub_toggle <id>  启用/停用订阅
- /sub_search 关键字  搜索并创建新订阅
```

### /sub_check - 手动检查订阅

**格式：**
```
/sub_check <订阅ID>
```

**示例：**
```
/sub_check 12
```

**功能：**
- 执行订阅检查（试运行模式，不实际创建下载任务）
- 显示检查结果和安全策略信息
- 包含完整的权限验证

### /sub_toggle - 启用/停用订阅

**格式：**
```
/sub_toggle <订阅ID>
```

**示例：**
```
/sub_toggle 12
```

**功能：**
- 切换订阅状态（active ↔ paused）
- 实时更新数据库
- 用户只能操作自己的订阅

### /sub_search - TMDB搜索并创建订阅

**格式：**
```
/sub_search <关键词>     # TMDB关键词搜索
/sub_search <TMDB_ID>    # 使用TMDB ID直接创建订阅
```

**示例：**
```
/sub_search 沙丘2       # 关键词搜索TMDB
/sub_search 123456      # 直接使用TMDB ID创建
```

**功能：**
- **关键词搜索模式**：调用TMDB API搜索电影/剧集，显示结果列表
- **TMDB ID模式**：直接使用TMDB ID创建订阅（兼容旧行为）
- **智能缓存**：搜索结果缓存10分钟，供/sub_create选择
- **多类型支持**：同时搜索电影和剧集，最多显示5条结果

**搜索结果格式：**
```
 找到 3 个 TMDB 结果：

[1] 电影《Dune: Part Two》 (2024)
    简介：保罗·亚特雷迪斯继续他的传奇旅程...

[2] 电影《Dune》 (1984)
    简介：一个年轻人必须阻止珍贵物质...

[3] 剧集《Dune》 (2000)
    简介：改编自弗兰克·赫伯特的经典小说...

 创建订阅：
/sub_create 1  # 以第 1 条结果创建订阅（安全模式）
 搜索结果缓存 10 分钟，请及时选择
```

**配置要求：**
- 关键词搜索需要配置 `TMDB_API_KEY`
- TMDB ID模式无需API key配置

**错误处理：**
- API key未配置：提示管理员配置
- 搜索无结果：建议使用更精确关键词或TMDB ID
- 网络错误：提供fallback方案

### /sub_create - 创建订阅（智能双模式）

**格式：**
```
/sub_create <索引>      # 使用最近一次搜索结果中的第 N 条
/sub_create <TMDB_ID>   # 直接用 TMDB ID 创建订阅
```

**示例：**
```
/sub_create 1           # 选择搜索结果第 1 条
/sub_create 123456      # 直接使用 TMDB ID 123456
```

**功能：**
- **智能判断**：自动识别用户意图（索引选择 vs TMDB ID）
- **索引模式**：从最近一次搜索结果中选择，使用真实TMDB数据
- **TMDB ID模式**：直接使用TMDB ID创建，获取真实详情信息
- **安全策略**：默认使用安全模式（禁止HR/H3H5，只下载Free资源）

**智能判断逻辑：**
1. 有搜索结果缓存且输入数字在范围内 → 索引模式
2. 否则 → TMDB ID模式
3. 索引超出范围时，提供明确的错误提示和修正建议

**成功创建示例：**
```
✅ 订阅创建成功

订阅ID：#15
目标：电影《Dune: Part Two》 (2024)
TMDB ID：123456
清晰度：2160p,1080p
安全策略：安全模式（只下载 Free 资源）

💡 你可以在 Web → 影视订阅中心 中查看并调整详细规则
```

**错误处理：**
- 索引超出范围：显示有效范围提示
- 缓存过期：提示重新搜索
- TMDB ID无效：提供验证建议

### /dl_search - 快速下载搜索

**格式：**
```
/dl_search <搜索关键词>
```

**示例：**
```
/dl_search 沙丘2
/dl_search Dune Part Two
```

**功能：**
- 🔍 调用多个索引器并发搜索资源
- 🛡️ 应用严格安全策略过滤（禁止HR/H3/H5，优先Free资源）
- 📋 返回安全候选列表供用户选择
- 💾 自动缓存搜索结果（10分钟有效期）
- 📊 显示详细的过滤统计信息

**搜索结果格式：**
```
🔍 搜索资源：沙丘2

共找到 25 条候选，其中：
- 过滤（HR/H3/H5）：8
- 过滤（非 Free）：7
✅ 安全候选：10 条

安全候选列表：

[1] 1337x · Dune Part Two 2024 1080p x265 BluRay
    大小：8.5 GB · 做种：50 / 下载：10 · Free

[2] YTS · Dune Part Two 2023 1080p WEB-DL
    大小：6.2 GB · 做种：120 / 下载：25 · Free

使用方式：
- /dl_create 1   立刻创建第 1 条下载任务

💡 提示：搜索结果缓存 10 分钟内有效，超时后需要重新 /dl_search
```

**安全策略：**
- **HR/H3/H5过滤**：自动排除高HR风险和特殊站点
- **Free优先**：优先显示Free和2x资源，严格模式下只允许Free
- **站点屏蔽**：支持用户自定义屏蔽站点列表
- **质量过滤**：可配置分辨率和编码要求

**错误处理：**
- 搜索无结果：提供搜索建议和替代方案
- 所有候选被过滤：解释安全策略并建议放宽条件
- 网络超时：自动重试和降级处理

### /dl_create - 创建下载任务

**格式：**
```
/dl_create <搜索结果索引>
```

**示例：**
```
/dl_create 1
/dl_create 3
```

**功能：**
- ⬇️ 从最近一次`/dl_search`结果中选择候选
- 🛡️ 创建安全的下载任务（已通过安全策略过滤）
- 🏷️ 自动标记来源为Telegram Bot
- 📊 显示任务创建确认和详细信息
- 🔄 支持模拟模式和真实下载器

**任务创建流程：**
1. 验证用户已绑定账号
2. 检查搜索缓存有效性
3. 验证索引范围
4. 调用DownloadService创建任务
5. 返回确认信息

**成功响应示例：**
```
✅ 下载任务已创建：

站点：1337x
标题：Dune Part Two 2024 1080p x265 BluRay
大小：8.5 GB · Free

你可以在 Web → 下载任务 中查看进度。
```

**错误处理：**
- 无搜索缓存：提示先使用`/dl_search`
- 索引超出范围：显示有效范围提示
- 缓存过期：提示重新搜索
- 下载器未配置：自动切换模拟模式
- 网络错误：提供重试建议

## 错误处理

TG-BOT-2实现了统一的错误处理系统：

- **权限检查**：确保用户只能操作自己的资源
- **参数验证**：提供清晰的用法示例
- **系统错误**：友好的错误提示和重试建议

## 安全策略

所有新创建的订阅默认使用**安全模式**：
- `allow_hr`: False（禁止HR）
- `allow_h3h5`: False（禁止H3/H5）
- `strict_free_only`: True（只下载Free资源）

用户可以在Web端调整这些安全策略设置。

## 订阅管理

### /subscriptions - 查看订阅

**格式：**
```
/subscriptions
/subscriptions manga
/subscriptions music
```

**功能：**
- 列出所有订阅（漫画追更、音乐榜单等）
- 显示订阅状态（启用/暂停）
- 提供操作按钮：暂停/恢复、立即执行、取消订阅

### /notify - 通知偏好

**格式：**
```
/notify
```

**功能：**
- 设置各类通知的开关
- 设置临时静音 (30分钟 / 1小时 / 2小时 / 4小时 / 今晚)
- 开启/关闭全局静音

## 下载任务

### /downloads - 查看下载任务

**格式：**
```
/downloads
/downloads failed
/downloads active
/downloads completed
```

**参数说明：**
- 无参数：显示最近任务
- `failed` / `失败`：只看失败任务
- `active` / `进行中`：正在下载或排队的任务
- `completed` / `完成`：已完成的任务

**操作按钮：**
- 失败任务：🔄 重试、⏭ 跳过
- 进行中任务：⏹ 取消
- 已完成/失败任务：🗑 删除记录

## 阅读中心

### /reading - 进行中的阅读

**格式：**
```
/reading
```

**功能：**
- 显示正在阅读的小说、有声书、漫画
- 显示阅读进度条
- 提供操作按钮：📖 继续、✅ 完成

### /recent - 最近活动

**格式：**
```
/recent
```

**功能：**
- 显示最近的阅读活动记录
- 包含时间戳

## 音乐中心

### /music - 音乐中心入口

**格式：**
```
/music
```

**功能：**
- 显示音乐中心菜单
- 快速跳转到：音乐榜单、我的订阅、最近下载

### /charts - 音乐榜单

**格式：**
```
/charts
```

**功能：**
- 列出可用的音乐榜单
- 显示订阅状态和新曲数量
- 提供操作按钮：订阅/取消订阅

## 音乐订阅管理

**权限：** 仅已绑定用户可用

### /music_subs - 列出音乐订阅

**格式：**
```
/music_subs
```

**功能：**
- 列出当前用户的音乐订阅（最多10条）
- 显示：ID、类型（榜单/关键字）、目标、站点、质量、状态、安全策略摘要
- 提供操作示例提示

**示例输出：**
```
🎵 我的音乐订阅

✅ #12 📊榜单
   目标: 榜单 #5
   站点: orpheus | 质量: lossless
   状态: 激活 | [严格安全] 不下 HR/H3H5，只下 Free/半 Free

⏸ #13 🔍关键字
   目标: 周杰伦
   站点: 全部站点 | 质量: 任意
   状态: 暂停 | [标准模式] 过滤 HR/H3H5，允许非 Free
```

### /music_sub <id> - 查看订阅详情

**格式：**
```
/music_sub 订阅ID
```

**示例：**
```
/music_sub 12
```

**功能：**
- 显示单个订阅的详细信息
- 包含基本信息、安全策略、最近运行统计

### /music_sub_check <id> - 试运行订阅

**格式：**
```
/music_sub_check 订阅ID
```

**示例：**
```
/music_sub_check 12
```

**功能：**
- 执行试运行（dry_run=True）
- 不创建真实下载任务
- 返回搜索候选数量、过滤统计、理论可下载数量
- 无论订阅状态如何都允许执行

**示例输出：**
```
✅ 试运行完成（不会创建真实下载任务）

订阅: #12 [榜单] 榜单 #5
当前状态: ✅ 激活
安全策略: [严格安全] 不下 HR/H3H5，只下 Free/半 Free

本次统计:
- 原始候选: 10
- 过滤: HR=2, H3/H5=1, 非Free=3, 重复=1
- 理论可下载: 3
```

### /music_sub_run <id> - 真实执行订阅

**格式：**
```
/music_sub_run 订阅ID
```

**示例：**
```
/music_sub_run 12
```

**功能：**
- 执行真实运行（dry_run=False）
- 创建真实下载任务
- 仅当订阅状态为 active 时允许执行
- 返回本次创建的任务数和过滤统计

**限制：**
- 订阅必须处于激活状态
- 暂停的订阅需要先用 `/music_sub_toggle` 激活

### /music_sub_toggle <id> - 切换订阅状态

**格式：**
```
/music_sub_toggle 订阅ID
```

**示例：**
```
/music_sub_toggle 12
```

**功能：**
- 切换订阅的激活/暂停状态
- active → paused
- paused → active

**示例输出：**
```
✅ 已切换订阅状态

订阅: #12 [关键字] 周杰伦
新状态: ⏸ 已暂停

📝 说明:
- 激活时: 系统会根据你的设置自动参与音乐订阅执行
- 暂停时: 不会再自动执行，但你仍然可以用 /music_sub_check 12 试运行
```

**安全策略说明：**
- `[严格安全]` - 不下 HR/H3H5，只下 Free/半 Free
- `[标准模式]` - 过滤 HR/H3H5，允许非 Free
- `[风险自担]` - 允许 HR/H3H5，Free 不限制
- `[宽松模式]` - 基本不过滤

**使用建议：**
- 推荐先用 `/music_sub_check` 观察效果，再用 `/music_sub_run` 真正下载
- 通过 `/music_subs` 快速查看所有订阅状态
- 使用 `/music_sub_toggle` 管理订阅的激活状态

## 阅读 / 听书 / 漫画 - Telegram 只读控制台

**权限：** 仅已绑定用户可用  
**特性：** 只读模式，提供三个视角的阅读功能：进行中阅读列表、最近活动时间线、书架收藏

### 进行中视角

#### /reading - 查看进行中阅读/收听/漫画进度

**格式：**
```
/reading
```

**功能：**
- 显示正在进行的阅读/收听/漫画混合列表（最多10条）
- 按最近更新时间排序
- 显示统一状态：进行中/未开始/已完成 + 进度百分比
- 支持类型图标：📖(小说) 🎧(有声书) 🖼(漫画)

**示例输出：**
```
📚 进行中阅读列表（只读模式）：

[1] 📖《三体》 - 进行中 · 75%
[2] 🎧《明朝那些事儿》 - 进行中 · 30%
[3] 🖼《进击的巨人》 - 已完成

👉 查看详情：/reading_detail 1
👉 打开 Web 阅读：/reading_open 1
```

#### /reading_books - 查看进行中小说阅读

**格式：**
```
/reading_books
```

**功能：**
- 显示仅小说的进行中阅读列表（最多10条）
- 包含进度百分比和状态信息

**示例输出：**
```
📖 进行中小说列表（只读模式）：

[1] 📖《三体》 - 进行中 · 75%
[2] 📖《流浪地球》 - 未开始

👉 查看详情：/reading_detail 1
👉 打开 Web 阅读：/reading_open 1
```

### /reading_audio - 查看进行中有声书收听

**格式：**
```
/reading_audio
```

**功能：**
- 显示仅有声书的进行中收听列表（最多10条）
- 显示播放进度和状态

**示例输出：**
```
🎧 进行中有声书列表（只读模式）：

[1] 🎧《明朝那些事儿》 - 进行中 · 30%
[2] 🎧《人类简史》 - 未开始

👉 查看详情：/reading_detail 1
👉 打开 Web 阅读：/reading_open 1
```

### /reading_manga - 查看进行中漫画阅读

**格式：**
```
/reading_manga
```

**功能：**
- 显示仅漫画的进行中阅读列表（最多10条）
- 显示阅读进度和完成状态

**示例输出：**
```
🖼 进行中漫画列表（只读模式）：

[1] 🖼《进击的巨人》 - 已完成
[2] 🖼《海贼王》 - 进行中 · 45%

👉 查看详情：/reading_detail 1
👉 打开 Web 阅读：/reading_open 1
```

### /reading_detail <index> - 查看具体条目详情

**格式：**
```
/reading_detail 1
/reading_detail 3
```

**参数：**
- `index`: 条目序号（1-based，从进行中阅读列表中选择）

**功能：**
- 显示某个阅读项的详细信息
- 包含状态、进度、作者、最近更新时间
- 提供 Web 跳转链接

**示例输出：**
```
[1] 小说《三体》（只读模式）

状态：进行中 · 75%
类型：小说
最近更新：2024-01-15 14:30
作者：刘慈欣
进度：第2卷 第3章

👉 打开 Web 继续阅读：
http://localhost:5173/novel-center/ebook/123
```

### /reading_open <index> - 打开 Web 阅读页面

**格式：**
```
/reading_open 1
/reading_open 3
```

**参数：**
- `index`: 条目序号（1-based，从进行中阅读列表中选择）

**功能：**
- 直接返回 Web 跳转链接
- 便于在移动设备上快速打开阅读页面

**示例输出：**
```
👉 打开 Web 继续阅读：
http://localhost:5173/novel-center/ebook/123
```

### /reading_recent - 查看最近阅读活动时间线

**格式：**
```
/reading_recent
```

**功能：**
- 显示最近的阅读/收听/漫画活动时间线（最多50条）
- 按活动时间倒序排列
- 显示活动类型、具体行为和相对时间
- 支持类型图标：📖(小说) 🎧(有声书) 🖼(漫画)

**示例输出：**
```
🕒 最近阅读活动时间线（只读模式）：

[1] 📖《三体》 · 小说 · 阅读了第 12 章 · 刚刚
[2] 🎧《许三观卖血记》 · 有声书 · 收听了 22 分钟 · 1小时前
[3] 🖼《咒术回战》 · 漫画 · 阅读了第 28 话 · 昨天 23:17

👉 打开 Web 链接：/reading_recent_open 1
```

### /reading_recent_open <index> - 打开最近活动对应的 Web 页面

**格式：**
```
/reading_recent_open 1
/reading_recent_open 3
```

**参数：**
- `index`: 条目序号（1-based，从最近活动时间线中选择）

**功能：**
- 打开最近活动中的某一条对应的 Web 页面
- 直接返回 Web 跳转链接
- 显示活动详情和链接

**示例输出：**
```
已为你打开：
📖《三体》 · 阅读了第 12 章

Web 链接：
http://localhost:5173/novel-center/ebook/123
```

### 书架视角

#### /shelf - 查看我的书架混合列表

**格式：**
```
/shelf
```

**功能：**
- 显示收藏的小说/有声书/漫画混合列表（最多20条）
- 按收藏时间倒序排列
- 显示阅读状态、进度百分比和最近阅读位置
- 支持类型图标：📖(小说) 🎧(有声书) 🖼(漫画)

**示例输出：**
```
📚 我的书架（只读模式）

[1] 📖《三体》 - 阅读中 · 75% · 第 12 章
[2] 🎧《许三观卖血记》 - 已完成 · 100%
[3] 🖼《咒术回战》 - 阅读中 · 43% · 第 28 话

👉 查看详情：/shelf_detail 1
👉 打开 Web 页面：/shelf_open 1
```

#### /shelf_books - 查看我收藏的小说

**格式：**
```
/shelf_books
```

**功能：**
- 显示仅收藏的小说列表（最多20条）
- 包含阅读状态和进度信息

**示例输出：**
```
📚 我的书架 - 小说（只读模式）

[1] 📖《三体》 - 阅读中 · 75% · 第 12 章
[2] 📖《明朝那些事儿》 - 未开始

👉 查看详情：/shelf_detail 1
👉 打开 Web 页面：/shelf_open 1
```

#### /shelf_audio - 查看我收藏的有声书

**格式：**
```
/shelf_audio
```

**功能：**
- 显示仅收藏的有声书列表（最多20条）
- 包含收听状态和进度信息

#### /shelf_manga - 查看我收藏的漫画

**格式：**
```
/shelf_manga
```

**功能：**
- 显示仅收藏的漫画列表（最多20条）
- 包含阅读状态和进度信息

#### /shelf_detail <index> - 查看书架条目详情

**格式：**
```
/shelf_detail 1
/shelf_detail 3
```

**参数：**
- `index`: 条目序号（1-based，从书架列表中选择）

**功能：**
- 显示书架中某一条的详细信息
- 包含标题、类型、来源、状态、最近阅读位置、最近阅读时间
- 提供 Web 跳转链接

**示例输出：**
```
📚 书架条目详情（只读模式）

小说《三体》

类型：小说
来源：小说中心
状态：阅读中 · 75%
最近阅读位置：第 12 章
最近阅读时间：2025-11-27 19:32

👉 打开 Web 页面：
https://example.com/novel-center/ebook/123
```

#### /shelf_open <index> - 打开书架条目对应的 Web 页面

**格式：**
```
/shelf_open 1
/shelf_open 3
```

**参数：**
- `index`: 条目序号（1-based，从书架列表中选择）

**功能：**
- 直接返回书架条目的 Web 跳转链接
- 便于在移动设备上快速打开对应页面

**示例输出：**
```
👉 打开 Web 页面：
https://example.com/novel-center/ebook/123
```

## 使用说明

### 三个视角的区别

**进行中阅读列表视角**（`/reading*` 命令）：
- 显示当前正在进行的阅读项目
- 适合查看"我现在在读什么"
- 按最近更新时间排序

**最近活动时间线视角**（`/reading_recent*` 命令）：
- 显示所有阅读活动记录，包括已完成的项目
- 适合查看"我最近读了什么"
- 按活动发生时间倒序排列

**书架收藏视角**（`/shelf*` 命令）：
- 显示收藏的小说/有声书/漫画，无论是否已开始阅读
- 适合查看"我拥有什么收藏"
- 按收藏时间倒序排列
- **注意：书架视角为只读模式，不会修改收藏状态**

### 交互视角（写操作）

#### /reading_done <index> - 标记进行中的阅读为已完成

**格式：**
```
/reading_done <编号>
```

**功能：**
- 标记进行中列表中的某条为已完成状态
- 设置进度为100%，更新最后阅读时间
- 支持：小说、有声书、漫画三种类型
- **注意：此操作会修改你的阅读状态，请谨慎使用**

**示例：**
```
/reading_done 1
```

**示例输出：**
```
✅ 已标记为已完成（会影响你的阅读进度）

小说《三体》
类型：小说
当前状态：已完成 · 100%

如需继续查看进行中列表，可发送：
/reading
```

#### /reading_fav <index> - 将进行中的条目加入书架收藏

**格式：**
```
/reading_fav <编号>
```

**功能：**
- 从进行中列表中将某条加入收藏书架
- 如果已在收藏中，则幂等返回
- 支持：小说、有声书、漫画三种类型
- **注意：此操作会修改你的收藏状态**

**示例：**
```
/reading_fav 1
```

**示例输出：**
```
⭐ 已加入书架收藏（会修改你的收藏状态）

小说《三体》已添加到你的书架。

你可以通过 /shelf 查看。
```

#### /shelf_unfav <index> - 取消书架收藏

**格式：**
```
/shelf_unfav <编号>
```

**功能：**
- 从书架视角中取消某条收藏
- 返回是否实际删除了收藏
- 支持幂等操作（重复取消不会报错）
- **注意：此操作会修改你的收藏状态**

**示例：**
```
/shelf_unfav 1
```

**示例输出：**
```
✅ 已取消收藏（会修改你的收藏状态）

小说《三体》已从你的书架中移除。
```

**注意事项：**
- 交互视角命令会修改数据库中的阅读状态/收藏状态
- 所有修改都可以在 Web 端进行调整
- 命令执行后会自动缓存失效，确保数据一致性
- 未绑定用户无法执行这些命令

### 缓存机制

1. **阅读列表缓存**：进行中阅读列表会缓存10分钟，期间使用 `/reading_detail` 和 `/reading_open` 无需重新查询数据库
2. **活动时间线缓存**：最近活动列表也会缓存10分钟，支持 `/reading_recent_open` 快速访问
3. **书架列表缓存**：书架列表会缓存10分钟，支持 `/shelf_detail` 和 `/shelf_open` 快速访问，按类型分别缓存
3. **索引访问**：所有序号都是1-based，从对应的列表中选择
4. **过期处理**：如果缓存过期或索引超出范围，会提示重新发送对应的列表命令获取最新数据

### 只读模式说明

所有阅读命令均为只读操作，不会修改任何阅读状态或进度。如需修改阅读进度、标记完成等操作，请使用 Web 端进行。

### 错误处理

- **未绑定用户**：提示先绑定账号
- **无阅读记录**：显示友好的空状态提示
- **索引无效**：提示重新获取最新列表
- **缓存过期**：自动提示重新查询

## 管理员命令

**权限：** 仅管理员可用

### /admin - 管理员菜单可用

### /admin - 管理员命令入口

**格式：**
```
/admin
/admin <子命令>
```

**子命令列表：**

| 子命令 | 说明 |
|--------|------|
| `health` | 系统健康状态 |
| `runners` | Runner 状态 |
| `ping` | 关键依赖状态检查 (DB/Redis/Indexer) |
| `alerts` | 最近告警 |
| `errors` | 最近错误任务 |
| `disks` | 磁盘空间状态 |
| `stats` | 系统统计 |
| `whoami` | 当前用户信息 |

**示例：**
```
/admin health
/admin alerts
/admin disks
```

## 交互规范

### 按钮操作

所有列表页面都支持：
- **分页**：« 上一页 / 下一页 »
- **刷新**：🔄 刷新
- **返回**：« 返回主菜单 / « 返回列表

### 回调确认

操作结果通过弹窗提示（callback answer）：
- ✅ 操作成功
- ❌ 操作失败：原因

### 限流

- 搜索命令有 2 秒冷却时间
- 频繁操作会提示"请稍等片刻"

## 相关文件

### 命令模块
- `backend/app/modules/bots/commands/basic.py` - 基础命令
- `backend/app/modules/bots/commands/menu.py` - 菜单命令
- `backend/app/modules/bots/commands/search.py` - 搜索命令
- `backend/app/modules/bots/commands/subscriptions.py` - 订阅命令
- `backend/app/modules/bots/commands/downloads.py` - 下载命令
- `backend/app/modules/bots/commands/reading.py` - 阅读命令
- `backend/app/modules/bots/commands/music.py` - 音乐命令
- `backend/app/modules/bots/commands/admin.py` - 管理员命令
- `backend/app/modules/bots/commands/notify.py` - 通知偏好命令

### 核心组件
- `backend/app/modules/bots/telegram_router.py` - 命令路由
- `backend/app/modules/bots/telegram_context.py` - 上下文封装
- `backend/app/modules/bots/telegram_keyboard.py` - 键盘构建
- `backend/app/modules/bots/telegram_bot_handlers.py` - 消息处理
