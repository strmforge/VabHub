<!--
DOWNLOAD_MEDIA_PIPELINE_OVERVIEW.md v1

用途（单一事实来源 / 给未来 AI & IDE 看的）：
- 描述 VabHub "下载→整理→入库→播放 & 通知"的完整流水线；
- 让新窗口里的 ChatGPT / Windsurf / SWE-1.5 等，在写下载/整理相关任务书之前，先搞清楚：
  - 搜索/订阅/RSSHub 如何产生下载任务；
  - 下载管理如何处理任务并与 HR 安全策略联动；
  - 整理流程如何将文件重命名、刮削、分类入库；
  - 不同媒体类型（影视/音乐/书籍/漫画）的入库路径；
  - 媒体库/电视墙如何展示和播放；
  - 通知中心和 AI 顾问在流水线末端的角色；
  - 各模块之间的触发点和数据流向。

维护约定：
1. 本文件只描述"下载流水线"的高层结构和数据流向，不展开底层实现细节。
2. 每完成一轮下载/整理相关大任务（例如下载中心重构、整理流程优化等），
   必须更新本文件：
   - 更新对应的模块职责说明；
   - 调整流程图或触发点描述；
   - 补充新的媒体类型支持或入库路径。
3. 控制总长度在 ~5000–8000 字符内，重点在于"串成一条清晰的流水线脑图"。
4. 不要改动本文件的小节编号，方便其他工具（任务书 / 自动分析）跳转引用。
-->

# 下载→整理→入库→播放 & 通知 流水线总览 v1.0

> 关键词：**入口层 → 下载层 → 整理层 → 展示播放层 → 通知建议层**  
> 目标：让用户和 AI 都能清楚理解从"想要某个内容"到"能在各中心看到并播放"的完整路径。

---

## 0. 使用说明（给人类 + AI）

### 0.1 本文定位

本文是"下载→整理→入库→播放 & 通知"链路的 **高层总览**，专注于：
- **数据流向**：任务如何从一个模块传递到下一个模块；
- **触发机制**：什么事件会启动下一个处理步骤；
- **分支路径**：不同媒体类型（影视/音乐/书籍/漫画）的处理差异。

### 0.2 面向对象

- **想搞清楚"订阅/搜索之后到底发生了什么"的用户**：通过本文了解完整的处理链路；
- **新窗口 AI / IDE**：写任何下载/整理相关任务书前必须先看本文件，避免重复造轮子。

### 0.3 与其它文档的关系

| 横向专题文档 | 覆盖范围 | 本文引用方式 |
|-------------|----------|--------------|
| `SUBS_RULES_OVERVIEW.md` | 订阅/规则/RSSHub/工作流详解 | → 详见订阅规则总览 |
| `SITE_INTEL_OVERVIEW.md` | 站点/Local Intel/External Indexer/HR | → 详见站点与安全策略总览 |
| `TV_WALL_PLAYBACK_OVERVIEW.md` | 电视墙/播放策略(LAN/WAN/115) | → 详见电视墙播放策略总览 |
| `READING_STACK_OVERVIEW.md` | 阅读/听书/漫画完整链路 | → 详见阅读栈总览 |
| `AI_CENTER_UI_OVERVIEW.md` | AI 中心各页面与模式映射 | → 详见 AI 中心 UI 总览 |

**本文是把这些"横向线"在下载维度上串成一条时间线**，不重复各专题文档的实现细节。

---

## 1. 模块一览（按左侧导航）

### 📥 下载 & 订阅

| 模块 | 在流水线中的角色 | 核心职责 |
|------|------------------|----------|
| **搜索** | 入口层 | 用户主动搜索内容，可立即下载或转为订阅 |
| **下载管理** | 下载层 | 管理所有下载任务的状态和生命周期 |
| **订阅管理** | 入口层 | 基于规则的持续下载，分媒体类型管理 |
| **RSS 订阅** | 入口层 | 从 RSS 源自动获取新内容 |
| **RSSHub 订阅** | 入口层 | 从 RSSHub 榜单/热门源获取内容 |
| **工作流管理** | 入口层 | 将订阅/RSS/搜索/动作抽象成可视化工作流（WIP） |

### 📺 影视中心

| 模块 | 在流水线中的角色 | 核心职责 |
|------|------------------|----------|
| **电视墙** | 展示播放层 | 跨来源选片入口，聚合展示已入库资源 |
| **媒体库** | 展示播放层 | 按影视类型组织已整理入库的资源 |
| **短剧工作台** | 展示播放层 | 短剧类资源的专用展示页 |

### 📚 阅读 & 听书 / 📖 漫画中心

| 模块 | 在流水线中的角色 | 核心职责 |
|------|------------------|----------|
| **小说中心** | 展示播放层 | 电子书的阅读和管理 |
| **有声书中心** | 展示播放层 | 有声书的播放和管理 |
| **漫画中心** | 展示播放层 | 漫画的追更和阅读 |

### 🔔 通知中心

| 模块 | 在流水线中的角色 | 核心职责 |
|------|------------------|----------|
| **通知中心** | 通知建议层 | 推送下载/整理/入库等各环节的状态通知 |

### 🤖 AI 中心

| 模块 | 在流水线中的角色 | 核心职责 |
|------|------------------|----------|
| **AI 整理顾问** | 通知建议层 | 基于媒体库快照提供清理建议（只读） |
| **AI 故障医生** | 通知建议层 | 诊断下载/整理链路中的问题（只读） |

---

## 2. 生命周期总览：从"想要"到"看/听到了"

### 2.1 整体流程图

```
想要某个内容
    │ [用户主动/自动触发]
    ├─ 搜索（用户主动）
    ├─ 订阅（规则驱动，自动）
    ├─ RSS/RSSHub（源驱动，自动）
    └─ 工作流（自动化，WIP）
    │
    ↓
站点/外部索引 & Local Intel 找到种子 [自动]
    │
    ↓
下载管理接管任务 [自动]
    ├─ 多下载器支持（qBittorrent/Transmission）
    ├─ 任务状态跟踪
    └─ HR/HNR 风险监控
    │
    ↓ [下载完成事件，自动触发]
整理流程触发 [自动/手动重试]
    ├─ 媒体识别
    ├─ 重命名 & 刮削
    ├─ MOVE/COPY 策略（受 HR 影响）
    └─ STRM 文件生成（可选）
    │
    ↓
分类入库 [自动]
    ├─ 视频类 → 影视库 + 电视墙
    ├─ 音频类 → 音乐库
    ├─ 书籍类 → 阅读栈（小说/有声书）
    ├─ 漫画类 → 漫画中心
    └─ 其他资源 → 保留在下载管理
    │
    ↓
展示 & 播放 [用户主动]
    ├─ 媒体库浏览
    ├─ 电视墙选片
    ├─ LAN/WAN/115 播放策略
    └─ 阅读中心阅读
    │
    ↓
通知 & AI 建议 [自动推送/用户主动查询]
    ├─ 通知中心推送状态（自动）
    ├─ AI 整理顾问提供清理建议（用户主动）
    └─ AI 故障医生诊断问题（用户主动）
```

### 2.2 媒体类型分支表

| 资源类型 | 入口来源 | 整理路径 | 入库目标 | 播放方式 |
|----------|----------|----------|----------|----------|
| **电影** | 搜索/订阅/RSS | 电影命名规范 + 刮削 | 影视库(电影) + 电视墙 | LAN优先/WAN备用/115可选 |
| **剧集** | 搜索/订阅/RSS | 剧集命名规范 + 季集组织 | 影视库(剧集) + 电视墙 | LAN优先/WAN备用/115可选 |
| **短剧** | 搜索/订阅 | 短剧命名规范 | 影视库(短剧) + 短剧工作台 | LAN优先/WAN备用/115可选 |
| **音乐** | 音乐订阅/RSS | 音乐命名规范 + 专辑组织 | 音乐库 | 媒体库播放 |
| **有声书** | 书籍订阅/RSS | 有声书命名规范 + 章节组织 | 有声书中心 | TTS播放/直接播放 |
| **电子书** | 书籍订阅/RSS | 电子书命名规范 + 元数据 | 小说中心 | 阅读器打开 |
| **漫画** | 漫画订阅/RSS | 漫画命名规范 + 章节组织 | 漫画中心 | 漫画阅读器 |
| **其他资源** | 搜索/下载 | 基础重命名 | 保留在下载管理 | 不入库 |

---

## 3. 入口层：搜索 / 订阅 / RSSHub / 工作流

> 本节描述"如何产生下载任务"，详细实现请参考 [SUBS_RULES_OVERVIEW.md](SUBS_RULES_OVERVIEW.md)

### 3.1 搜索
- **多站点搜索**：使用 External Indexer + Local Intel 进行 multi-site 搜索；
- **即时操作**：搜索结果可以直接"立即下载"或"添加为订阅"；
- **智能推荐**：基于用户历史和站点状态推荐最优资源。

### 3.2 订阅
- **规则驱动**：基于媒体、演员、导演、站点等规则的持续下载；
- **分类型管理**：电影/电视剧/音乐/书籍各自独立的订阅管理界面；
- **安全默认**：新建订阅默认 `paused=true` / `auto_download=false` / `hr_safe=true`。

### 3.3 RSS & RSSHub
- **源驱动**：从 RSS 源（站点更新）和 RSSHub 源（榜单/热门）自动获取；
- **工作流联动**：通过工作流将 RSS 条目转化为搜索/下载任务；
- **自动过滤**：支持关键词、质量、大小等过滤规则。

### 3.4 工作流（WIP）
- **可视化编排**：未来将"订阅规则 / RSS / 搜索 / 动作"抽象成可视化工作流；
- **事件链**：当前支持简单的事件触发链（如 RSS → 搜索 → 下载）；
- **扩展空间**：预留更复杂的条件判断和分支处理能力。

---

## 4. 下载层：任务管理 & HR 安全联动

> 本节描述下载管理的核心职责，HR 安全策略详见 [SITE_INTEL_OVERVIEW.md](SITE_INTEL_OVERVIEW.md)

### 4.1 多下载器支持
- **下载器抽象**：统一支持 qBittorrent、Transmission 等主流下载器；
- **任务分发**：智能选择下载器（负载、站点兼容性等）；
- **状态同步**：实时同步下载器状态到 VabHub 数据库。

### 4.2 任务状态管理

| 状态 | 说明 | 后续动作 |
|------|------|----------|
| **下载中** | 正在下载 | 持续监控进度和速度 |
| **已完成** | 下载完成 | 触发整理流程 |
| **失败** | 下载失败 | 记录错误，支持重试 |
| **做种中** | 下载完成，正在做种 | 根据 HR 策略决定是否保留 |
| **已移除** | 用户手动移除 | 清理相关记录 |
| **HNR 风险** | 触发 HR/HNR 规则 | 调整整理策略（COPY vs MOVE） |

### 4.3 HR 安全策略联动
- **风险检测**：Local Intel + 下载器统计检测 HNR 风险；
- **策略控制**：
  - 是否允许移动原始下载目录；
  - 是否强制 COPY 以保护保种；
  - 风险任务的整理路径选择；
- **与整理层交汇**：**"下载完成事件"**是后续整理的触发点，HR 决策会影响整理策略。
- **冲突处理**：当 HR 策略与用户手动整理请求冲突时，系统会给出警告提示，用户可选择覆盖或遵循 HR 建议。

### 4.4 关键模块位置
- **前端页面**：`frontend/src/pages/Downloads.vue`
- **下载服务**：`backend/app/modules/download/service.py`
- **状态更新**：`backend/app/modules/download/status_updater.py`
- **下载器核心**：`backend/app/core/downloaders/`

---

## 5. 整理层：重命名 / 刮削 / STRM / 入库策略

### 5.1 整理触发机制
- **自动触发**：下载完成后自动触发整理流程；
- **手动重试**：用户在"整理失败列表"中手动重试；
- **批量整理**：支持对历史下载进行批量重新整理。

### 5.2 整理核心动作

| 动作 | 说明 | 受影响因素 |
|------|------|------------|
| **媒体识别** | 识别媒体类型和元数据 | 文件名、路径、内容特征 |
| **命名规范** | 按媒体类型重命名 | 电影/剧集/音乐/书籍等规范 |
| **元数据刮削** | 获取海报、简介、评分等 | TMDB/音乐库/书籍库 |
| **MOVE/COPY 策略** | 文件移动或复制 | HR 安全策略、磁盘空间 |
| **STRM 生成** | 生成流媒体链接文件 | 用户配置、媒体类型 |

### 5.3 入库目标分支
```
下载完成
  ↓
媒体识别
  ├─ 视频类
  │   ├─ 电影 → 影视库(电影) + 电视墙
  │   ├─ 剧集 → 影视库(剧集) + 电视墙
  │   └─ 短剧 → 影视库(短剧) + 短剧工作台
  ├─ 音频类 → 音乐库
  ├─ 书籍类
  │   ├─ 电子书 → 小说中心
  │   └─ 有声书 → 有声书中心
  ├─ 漫画类 → 漫画中心
  └─ 其他资源 → 保留在下载管理，不入库
```

### 5.4 关键模块位置
- **整理器**：`backend/app/modules/media_renamer/organizer.py`
- **重命名器**：`backend/app/modules/media_renamer/renamer.py`
- **识别器**：`backend/app/modules/media_renamer/identifier.py`
- **分类器**：`backend/app/modules/media_renamer/classifier.py`
- **前端页面**：`frontend/src/pages/MediaRenamer.vue`

---

## 6. 展示 & 播放层：媒体库 / 电视墙 / 多入口播放

> 播放策略详解请参考 [TV_WALL_PLAYBACK_OVERVIEW.md](TV_WALL_PLAYBACK_OVERVIEW.md)

### 6.1 媒体库
- **分类展示**：按电影/剧集/短剧等类型组织；
- **详情页面**：展示媒体元数据，提供播放入口；
- **搜索过滤**：支持按年份、评分、演员等条件筛选。

### 6.2 电视墙
- **跨来源聚合**：作为"选片中枢"聚合展示所有入库资源；
- **播放决策**：根据 `hasLocal` / `has115` 决定播放入口；
- **策略优先级**：
  - 局域网环境：优先媒体库播放；
  - 外网环境：偏向 115 内置播放器；
  - 用户可手动切换播放源。

### 6.3 阅读中心
- **小说中心**：电子书阅读器，支持进度记录；
- **有声书中心**：TTS 播放或直接播放，支持章节跳转；
- **漫画中心**：漫画阅读器，支持双页模式和缩放。

### 6.4 关键模块位置
- **电视墙**：`frontend/src/pages/PlayerWall.vue`
- **媒体详情**：`frontend/src/pages/MediaDetail.vue`
- **媒体识别**：`frontend/src/pages/MediaIdentification.vue`
- **漫画库**：`frontend/src/pages/manga/MangaLibraryPage.vue`

---

## 7. 通知 & AI 顾问：结果的"收尾层"

> AI 中心详解请参考 [AI_CENTER_UI_OVERVIEW.md](AI_CENTER_UI_OVERVIEW.md)

### 7.1 通知中心

| 通知类型 | 触发时机 | 跳转目标 |
|----------|----------|----------|
| **下载完成** | 下载任务完成 | 下载管理页面 |
| **整理成功** | 整理流程完成 | 媒体详情页面 |
| **整理失败** | 整理流程报错 | 整理失败列表 |
| **HNR 警告** | 检测到 HNR 风险 | 下载管理页面 |
| **有声书生成** | TTS 处理完成 | 有声书中心 |
| **漫画更新** | 漫画章节更新 | 漫画阅读页面 |

### 7.2 AI 整理顾问（CLEANUP_ADVISOR）
- **数据来源**：媒体库快照、存储快照、HNR 状态；
- **建议类型**：
  - 哪些文件可以安全删除；
  - 哪些需要保留以维护保种；
  - 重复版本的处理建议；
- **只读原则**：所有建议仅供用户参考，不自动执行删除。

### 7.3 AI 故障医生（DIAGNOSE）
- **诊断范围**：下载器状态、整理流程、站点连接等；
- **工具支持**：Runner 状态、日志快照、健康检查；
- **输出形式**：结构化诊断报告，包含问题定位和解决建议。

### 7.4 关键模块位置
- **通知页面**：`frontend/src/pages/Notifications.vue`
- **AI 整理顾问**：`frontend/src/pages/AiCleanupAdvisor.vue`
- **AI 故障医生**：`frontend/src/pages/AiLogDoctor.vue`
- **AI 整理服务**：`backend/app/services/ai_cleanup_advisor.py`
- **AI 诊断服务**：`backend/app/services/ai_log_doctor.py`

---

## 8. v1 限制 & 后续方向

### 8.1 当前限制
- **非媒体资源**：只在下载管理中可见，缺乏专门的"其他资源库"；
- **整理策略细化**：按字幕/音轨偏好自动选版等功能仍在规划中；
- **LAN/WAN 自动识别**：网络环境自动检测与默认播放方式选择未完全实现；
- **AI 联动**：下载流水线与 AI 整理顾问之间是"弱联动"（只读），缺乏智能标签和自动分组。

### 8.2 后续方向
- **工作流可视化**：完善工作流管理，支持更复杂的自动化场景；
- **智能整理**：基于用户习惯和媒体质量的自动整理策略；
- **跨媒体关联**：同一 IP 的不同媒体类型（小说/漫画/动画）的自动关联；
- **AI 增强**：从"只读建议"向"辅助决策"演进，提供更智能的资源管理建议。

---

## 9. 相关代码位置

### 9.1 前端页面
```
下载 & 订阅：
- 搜索: frontend/src/pages/Search.vue
- 下载管理: frontend/src/pages/Downloads.vue
- 订阅管理: frontend/src/pages/Subscriptions.vue
- 音乐订阅: frontend/src/pages/MusicSubscriptions.vue
- RSS 订阅: frontend/src/pages/RSSSubscriptions.vue
- 工作流管理: frontend/src/pages/Workflows.vue

影视中心：
- 电视墙: frontend/src/pages/PlayerWall.vue
- 媒体详情: frontend/src/pages/MediaDetail.vue
- 媒体识别: frontend/src/pages/MediaIdentification.vue
- 媒体重命名: frontend/src/pages/MediaRenamer.vue

阅读中心：
- 漫画库: frontend/src/pages/manga/MangaLibraryPage.vue

通知 & AI：
- 通知中心: frontend/src/pages/Notifications.vue
- AI 整理顾问: frontend/src/pages/AiCleanupAdvisor.vue
- AI 故障医生: frontend/src/pages/AiLogDoctor.vue
```

### 9.2 后端服务
```
下载相关：
- 下载 API: backend/app/api/download.py
- 下载服务: backend/app/modules/download/service.py
- 状态更新: backend/app/modules/download/status_updater.py
- 下载器核心: backend/app/core/downloaders/

整理相关：
- 整理器: backend/app/modules/media_renamer/organizer.py
- 重命名器: backend/app/modules/media_renamer/renamer.py
- 识别器: backend/app/modules/media_renamer/identifier.py
- 分类器: backend/app/modules/media_renamer/classifier.py

媒体库相关：
- 媒体 API: backend/app/api/media.py
- 媒体识别: backend/app/api/media_identification.py
- 媒体搜索: backend/app/api/media_search.py

AI 相关：
- AI 整理服务: backend/app/services/ai_cleanup_advisor.py
- AI 诊断服务: backend/app/services/ai_log_doctor.py
```

---

> 📌 **本文档与 VABHUB_SYSTEM_OVERVIEW.md 的关系**：  
> VABHUB_SYSTEM_OVERVIEW.md 描述整个系统的模块架构，本文档专注于"下载流水线"的数据流向和触发机制。两者配合使用，可以形成从"系统架构"到"业务流程"的完整理解。

---

*最后更新：2025-12-03 UI-GLUE-FILL-GAPS-1*  

> **UI状态更新**：下载流水线相关UI页面（搜索、下载管理、订阅管理、RSS订阅、工作流管理、媒体识别、媒体重命名）已完成真实API对接，前端与后端数据链路已打通。
