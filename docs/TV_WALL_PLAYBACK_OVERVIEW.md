# 电视墙播放策略总览

> **用途**：解释 VabHub 电视墙的定位、播放行为选择策略（局域网 vs 外网），以及 115 播放的边界。  
> **阅读对象**：想理解电视墙播放机制的用户、想改播放逻辑的开发者、新窗口 AI/IDE。

---

## 0. 使用说明

### 0.1 本文回答的问题

- "电视墙点击完，为什么有时候跳媒体库、有时候用内置播放器？"
- "局域网和外网应该怎么区分？"
- "115 播放和本地媒体库之间的权责怎么划分？"

### 0.2 面向对象

- 想调电视墙/播放行为的用户
- 想改播放核心逻辑的开发者
- 新窗口 AI / IDE（写任务书前要先看这篇）

### 0.3 给未来 AI 的提示

当用户问到以下问题时，请先读本文件：
- "电视墙怎么播放？"
- "115 播放和 Emby 播放有什么区别？"
- "为什么我在外网看不了本地媒体库？"

---

## 1. 场景总览：电视墙是"选片中枢"

### 1.1 电视墙的本质

电视墙（`/player/wall`）是 VabHub 的**统一选片入口**：

| 功能 | 说明 |
|------|------|
| **聚合展示** | 聚合电影/剧集/短剧/动漫/音乐等媒体海报 |
| **多源标记** | 显示每个作品有哪些播放源（本地/115）|
| **播放分发** | 根据环境和源情况，引导用户选择合适的播放方式 |

### 1.2 对用户的期望体验

| 场景 | 理想体验 | 说明 |
|------|----------|------|
| **LAN（局域网）** | 像"万能遥控器" | 选片 → 自动打开 Emby/Jellyfin/其他媒体库播放 |
| **WAN（外网）** | 像"在线播放器" | 选片 → 用 VabHub 内置 Web Player 播放 115 官方流 |

---

## 2. 点击链路：通用流程

### 2.1 基本流程图

```
点击电视墙卡片
    │
    ▼
定位媒体条目（work_id / tmdb_id）
    │
    ▼
进入详情页（MediaDetail / WorkDetail）
    │
    ▼
根据当前环境 & 源信息显示播放入口：
    ├── 「网页播放（115）」 ← has115 = true
    └── 「在媒体库中播放」 ← hasLocal = true
```

### 2.2 前端组件角色

| 组件 | 路径 | 职责 |
|------|------|------|
| **PlayerWall.vue** | `/player/wall` | 展示海报墙，点击卡片跳转详情 |
| **WorkPosterCard.vue** | 组件 | 单个作品卡片，显示源标记 |
| **MediaDetail.vue** | `/media/:type/:id` | 媒体详情页，展示播放按钮 |
| **Remote115Player.vue** | `/player/115/:id` | 115 内置播放器（hls.js） |

### 2.3 当前实现状态

| 功能点 | 状态 | 说明 |
|--------|------|------|
| 电视墙 → 详情页跳转 | ✅ 已实现 | `goToWorkDetail(workId)` |
| 详情页显示源信息 | ✅ 已实现 | `has115` / `hasLocal` 计算属性 |
| 「网页播放（115）」按钮 | ✅ 已实现 | 调用 `goRemote115Player()` |
| 「在媒体库中播放」按钮 | ⚠️ 占位 | 显示 "功能开发中" toast |
| Remote115Player + hls.js | ✅ 已实现 | 支持 115 HLS 流播放 |

---

## 2.5 电视墙海报点击行为规范 v1

> **定位**：本节定义电视墙海报点击的精确行为，避免实现歧义和随意改动。  
> **v1 目标**：**"一键进合适的详情页"**，不是"一键直接播放"。

### 2.5.1 媒体类型分支判断

| 媒体类型 | 归类 | 说明 |
|----------|------|------|
| **movie / 短片电影 / 单集纪录片** | 电影类 | 统一按电影逻辑处理 |
| **tv / series / 短剧 / 综艺** | 剧集类 | 统一按剧集逻辑处理 |
| **short_drama** | 剧集类 | 未来字段，也归入剧集类 |

### 2.5.2 内网（LAN）行为

**如果是电影类**：
- 有可用的 Emby/Jf 跳转信息 → **直接打开 Emby/Jf 的电影详情页或搜索页**
- 否则 → **回退到 VabHub MediaDetail**

**如果是剧集类**：
- 有可用的 Emby/Jf 跳转信息 → **直接打开 Emby/Jf 的剧集详情页**（让 Emby 负责选季/选集）
- 否则 → **回退到 VabHub MediaDetail**（由 VabHub 展示集数/版本信息）

### 2.5.3 外网（WAN）行为

**不管电影还是剧集**：
- **统一进入 VabHub 自己的 MediaDetail 页面**

在 MediaDetail 中：
- **电影**：展示可用源（本地/115）和多版本信息，用户选择播放
- **剧集/短剧**：展示集数/已下载集数/版本信息，用户选集后点"网页播放（115）"等

> **v1 约束**：外网不做"一键直接进 115 播放器"，统一走详情页。

### 2.5.4 点击路径总览

```
点击电视墙海报
    │
    ▼ 后端判断网络环境（LAN / WAN）
    ├── LAN + 有媒体库映射 → 跳 Emby/Jf 详情页
    ├── LAN + 无媒体库映射 → 跳 VabHub MediaDetail
    └── WAN → 一律跳 VabHub MediaDetail
```

### 2.5.5 与"一键播放"的区别

- **电视墙 v1**：**"一键进合适的详情页"**，根据环境智能选择入口
- **真正播放**：用户在 Emby/Jf 或 VabHub 详情页里自行决定播放方式
- **目的**：让用户在合适的界面里完成选集/版本选择，而不是强制播放

---

## 3. 局域网（LAN）下的理想行为

### 3.1 使用场景

用户在**局域网**（家宽 / NAS 同网段）里打开 VabHub Web：
- 客厅电视盒子上的浏览器
- 电脑/手机连家里的 Wi-Fi

### 3.2 理想播放策略

```
点击电视墙卡片
    │
    ▼
进入 MediaDetail
    │
    ├── 首要按钮：「在媒体库中播放」
    │       │
    │       └── 跳转 Emby/Jellyfin Web UI
    │           或构造 deep-link 唤起客户端
    │
    └── 次要按钮：「网页播放（115）」
            └── 仅当有 115 源时显示
```

### 3.3 当前实现状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 「在媒体库中播放」按钮显示 | ✅ 已实现 | 当 `hasLocal = true` 时显示 |
| Emby/Jellyfin 跳转逻辑 | ❌ 未实现 | 当前仅显示 toast "功能开发中" |
| 自动检测 LAN/WAN | ❌ 未实现 | 尚未做网络环境判断 |
| 自动选择默认播放方式 | ❌ 未实现 | 需用户手动点击对应按钮 |

### 3.4 未来规划

- 实现 Emby/Jellyfin Web URL 构造与跳转
- 支持 deep-link 唤起 TV 客户端（如 Infuse、Emby app）
- 可选：检测当前网络是否为 LAN，自动推荐播放方式

---

## 4. 外网（WAN）下的理想行为

### 4.1 使用场景

用户从**外网**访问 VabHub：
- 手机 4G/5G 网络
- 外地电脑/公共 Wi-Fi

### 4.2 理想播放策略

```
点击电视墙卡片
    │
    ▼
进入 MediaDetail
    │
    ├── 对 115 源内容：
    │       │
    │       └── 首要按钮：「网页播放（115）」
    │               │
    │               └── VabHub 获取 115 官方 HLS URL
    │                   → Remote115Player 播放
    │
    └── 对本地媒体库内容：
            │
            └── 不鼓励透过家宽进行大流量回源
                （除非用户自行配置反向代理）
```

### 4.3 当前实现状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 「网页播放（115）」按钮 | ✅ 已实现 | 调用统一播放逻辑 |
| 115 HLS 流播放 | ✅ 已实现 | Remote115Player + hls.js |
| 自动 LAN/WAN 判断 | ❌ 未实现 | 当前不区分网络环境 |
| 外网代理本地媒体 | ❌ 不建议 | 默认不提供，需用户自配 |

---

## 5. 115 播放专门说明

### 5.1 VabHub 的角色

VabHub 在 115 播放中只负责：

| 职责 | 说明 |
|------|------|
| **获取播放 URL** | 用 token/密钥调用 115 API 获取 HLS 地址 |
| **浏览器端播放** | 使用 hls.js 在 Web 端解码播放 |
| **不做流量转发** | 不在外网上转发大流量（默认） |

### 5.2 内网 vs 外网区别

| 场景 | 播放方式 | 说明 |
|------|----------|------|
| **内网** | VabHub 代理 HLS 流 | 可选实现（FUTURE） |
| **外网** | 115 官方直链播放 | 建议方式，流量走 115 CDN |

### 5.3 边界说明

- VabHub 不提供 115 之外的网盘代理播放
- 不建议在外网通过 VabHub 反向代理播放本地媒体库（流量大、延迟高）
- 如用户需要外网访问本地媒体，建议直接配置 Emby/Jellyfin 的公网访问

---

## 6. 已实现 / 未实现清单

### 6.1 已实现功能

| 功能 | 组件/模块 | 状态 |
|------|-----------|------|
| 电视墙海报展示 | PlayerWall.vue | ✅ |
| 源信息标记（本地/115） | WorkPosterCard | ✅ |
| 电视墙 → 详情页跳转 | goToWorkDetail() | ✅ |
| 详情页播放按钮显示 | MediaDetail.vue | ✅ |
| 「网页播放（115）」 | goRemote115Player() | ✅ |
| 115 HLS 播放器 | Remote115Player.vue | ✅ |
| hls.js 集成 | - | ✅ |

### 6.2 未实现功能（规划中）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| Emby/Jellyfin Web 跳转 | 构造媒体库播放 URL | 中 |
| 自动 LAN/WAN 检测 | 根据网络环境推荐播放方式 | 低 |
| 自动选择默认播放方式 | 无需用户手动选择 | 低 |
| deep-link 唤起客户端 | 唤起 Infuse/Emby app 等 | 低 |
| 外网代理本地媒体 | 可选配置，默认关闭 | 低 |

---

## 7. 相关代码位置

| 模块 | 路径 | 说明 |
|------|------|------|
| 电视墙页面 | `frontend/src/pages/PlayerWall.vue` | 海报墙主页面 |
| 媒体详情页 | `frontend/src/pages/MediaDetail.vue` | 播放按钮所在 |
| 115 播放器 | `frontend/src/pages/Remote115Player.vue` | HLS 播放器 |
| 播放动作 | `frontend/src/composables/useMediaPlayActions.ts` | 统一播放逻辑 |
| 电视墙 API | `frontend/src/services/api/playerWall.ts` | API 封装 |

---

*最后更新：2025-12-03 TVWALL-MUSIC-SPLIT-1*
