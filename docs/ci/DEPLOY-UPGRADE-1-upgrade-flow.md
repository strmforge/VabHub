# DEPLOY-UPGRADE-1 升级流程说明

**Date**: 2025-12-05  
**Status**: Implemented

## 端口策略

### 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `VABHUB_PORT` | `52180` | VabHub 主 Web 入口端口 |

### 默认端口选择理由

选择 `52180` 作为默认端口，避开以下常见端口：
- `8080` - 常用 Web 服务端口
- `7878` - Radarr
- `8989` - Sonarr
- `9091` - Transmission

### 修改端口

编辑 `.env` 文件：

```bash
# 修改为自定义端口
VABHUB_PORT=3020
```

端口配置为**内外同步**，即容器内监听端口与宿主机映射端口相同。

---

## Docker Socket 挂载

### 用途

`/var/run/docker.sock` 挂载用于：
1. UI 一键升级功能
2. 拉取最新 Docker 镜像
3. 重启应用容器

### docker-compose 配置

```yaml
vabhub:
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
```

### 安全说明

- 挂载为只读模式 (`:ro`)
- 仅用于升级操作，不用于其他 Docker 管理
- 如不需要 UI 升级功能，可移除此挂载

### 无 docker.sock 时的行为

- 版本检查功能正常
- 升级操作返回提示，引导用户使用手动命令

---

## 升级 API

### 端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/admin/system/version` | 获取版本信息 |
| POST | `/api/admin/system/upgrade` | 升级操作 |
| GET | `/api/admin/system/docker-status` | Docker 状态检查 |

### 升级请求

```json
// 检查更新
POST /api/admin/system/upgrade
{ "mode": "check_only" }

// 执行升级
POST /api/admin/system/upgrade
{ "mode": "apply" }
```

### 升级流程

```
┌─────────────────────────────────────────────────┐
│                 用户点击"立即升级"               │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│         POST /api/admin/system/upgrade          │
│               { mode: "apply" }                 │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│     检查 docker.sock 是否可用                    │
│     ├─ 否 → 返回错误，提示手动升级              │
│     └─ 是 → 继续                                │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│     docker pull ghcr.io/strmforge/vabhub:latest │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│     docker restart vabhub                        │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│     容器重启，前端自动刷新                       │
└─────────────────────────────────────────────────┘
```

---

## 手动升级

如果自动升级不可用，在服务器上执行：

```bash
cd /path/to/vabhub
docker compose pull
docker compose up -d
```

---

## 插件运行模型

### 术语约定

| 术语 | 定义 |
|------|------|
| **插件 (Plugin)** | 运行在 VabHub 进程内的扩展模块 |
| **外部集成 (Integration)** | 通过 HTTP/API 调用的外部服务 |

### 插件特点

- 以 Python 模块形式加载
- 运行于 VabHub 主进程
- 不需要单独的 Docker 容器
- 通过 Plugin SDK 注册事件和服务

### 外部集成示例

| 服务 | 类型 | 说明 |
|------|------|------|
| CookieCloud | 外部集成 | 配置 URL，VabHub 定时同步 |
| OCR 服务 | 内置/外部 | 可配置外部 OCR API |
| AI 服务 | 外部集成 | 硅基流动等 LLM 服务 |
| PT 索引服务 | 外部集成 | Prowlarr、Jackett 等 |

### 用户须知

- **不需要**为插件单独启动 Docker 容器
- **外部服务**（如自建 CookieCloud）需要用户自行部署
- 插件配置在 VabHub 管理界面完成
