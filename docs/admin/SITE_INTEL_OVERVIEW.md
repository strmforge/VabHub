# 站点 / Local Intel / External Indexer / HR 安全策略 体系总览

> **用途**：本文描述 VabHub 中"站点管理 / Local Intel / TorrentIndex / External Indexer / 站点 AI 适配 / HR 安全策略"这一整套 PT 智能栈的关系，并明确"云大脑 v1"的 LEGACY 边界。  
> **阅读对象**：想调站点/HR 策略的用户、想改 Local Intel/External Indexer 的开发者、新窗口 AI/IDE。

---

## 0. 使用说明

### 0.1 本文目的

解释 VabHub 如何：
- **理解 PT 站点**：站点管理模块维护站点配置与访问状态
- **构建本地智能大脑**：Local Intel + TorrentIndex 提供本地索引与智能决策
- **聚合多站搜索**：External Indexer 统一搜索体验
- **保证 HR 安全**：HR/HNR 策略与上述模块联动

### 0.2 核心原则

- 所有"站点抓取 / 索引 / AI 解析"都**只服务于本机 + 当前用户有账号的站点**
- **不存在任何跨用户的"云端 PT 目录大脑"**——云大脑 v1 设想已标记为 [LEGACY]
- 站点 AI 适配通道**专用于站点结构解析**，不可复用做通用聊天

### 0.3 给未来 AI 的提示

当用户问到以下问题时，请先读本文件：
- "站点管理模块怎么配置？"
- "Local Intel / TorrentIndex 是什么？"
- "搜索怎么做到多站聚合？"
- "HR/HNR 安全策略怎么配？"
- "站点 AI 适配是什么？"
- "云大脑是什么？为什么是 LEGACY？"

读完本文后，结合 `VABHUB_SYSTEM_OVERVIEW.md` §3.2/§4 和 `FUTURE_AI_OVERVIEW.md` §2.2/§2.3 可获得更多技术细节。

---

## 1. 模块一览

### 1.1 可见模块（左侧导航项）

#### 🌐 站点 & 插件 模块组

| 模块 | 路由 | 职责说明 |
|------|------|----------|
| **站点管理** | `/site-manager` | 站点墙 UI，展示/配置所有 PT 站点状态 |
| **HNR 风险检测** | `/hnr` | HNR 风险种子监控，做种统计 [PRO] |
| **Local Intel** | `/local-intel` | 本地智能大脑可视化入口 [Dev/PRO] |
| **外部索引** | `/external-indexer` | External Indexer 调试入口 [Dev] |
| **插件市场** | `/plugins` | 插件管理，部分插件可扩展站点能力 |

#### 📥 下载 & 订阅 模块组

| 模块 | 路由 | 职责说明 |
|------|------|----------|
| **搜索** | `/search` | 全局搜索入口，调用 External Indexer |
| **下载管理** | `/downloads` | 任务列表，显示 HR/HNR 风险标记 |

#### ⚙️ 系统 & 设置 模块组

| 模块 | 路由 | 职责说明 |
|------|------|----------|
| **系统设置** | `/settings` | HR 安全配置（保留源文件/COPY/MOVE 等） |

### 1.2 内部模块（非导航级）

| 模块 | 后端位置 | 职责说明 |
|------|----------|----------|
| **Local Intel** | `intel_local` | 本地 PT 行为分析、Torrent 索引、HR 决策 |
| **TorrentIndex** | `intel_local/torrent_index` | 全站/增量站点索引引擎 |
| **External Indexer** | `external_indexer` | 多站点聚合搜索模块 |
| **Site AI adapter** | `site_ai_adapter` | 站点结构 AI 解析专用通道 |
| **SiteGuard** | `intel_local/site_guard` | 扫描节流，防封号保护 |

---

## 2. 数据流 & 角色分工

### 2.1 站点配置 → 各模块

```
站点管理模块（Site Manager）
    │
    ├─ Cookie / UA / Host / Proxy / CookieCloud
    │
    ├──▶ Local Intel / TorrentIndex（用于扫站抓取）
    ├──▶ External Indexer（用于在线搜索）
    └──▶ 下载管理（下载任务绑定站点）
```

### 2.2 搜索链路

```
用户发起搜索 (/search)
    │
    ▼
External Indexer
    │
    ├─ 在线实时搜索（访问各 PT 站点 API/页面）
    ├─ 本地索引命中（TorrentIndex 已有数据）
    │
    ├─ 合并 / 去重 / 排序
    └─ 标记资源来源站点
         │
         ▼
搜索结果 → 用户选择 → 下载管理
```

### 2.3 TorrentIndex 扫站链路

```
定时任务 / 手动触发
    │
    ▼
SiteGuard（检查站点健康 + 节流）
    │
    ▼
TorrentIndex.sync_site_full / sync_site_incremental
    │
    ├─ 按页抓取种子列表
    ├─ 解析页面结构（借助站点 AI 适配）
    └─ 存入本地索引
         │
         ▼
Local Intel 使用索引数据
    │
    ├─ HR/HNR 风险判断
    ├─ 本地秒搜
    └─ 站点选择智能化
```

### 2.4 HR 安全决策链路

```
下载任务 / 整理请求
    │
    ▼
Local Intel + HR 决策引擎
    │
    ├─ 查询 TorrentIndex（种子 HR 标记）
    ├─ 查询下载器（实际做种状态）
    ├─ 结合设置模块配置
    │
    └─ 决策输出：
         ├─ 允许 MOVE / 强制 COPY
         ├─ 阻止删种 / 删文件
         └─ 标记 HNR 风险
              │
              ▼
         下载管理模块展示风险标记
```

---

## 3. Local Intel & TorrentIndex（本地大脑）

### 3.1 TorrentIndex

**用途**：为本地智能大脑提供数据基础。

| 能力 | 说明 |
|------|------|
| **全站扫描** | `sync_site_full(site_id)` 按页抓取整站种子目录 |
| **增量扫描** | `sync_site_incremental(site_id, max_pages)` 只扫最近 N 页 |
| **索引字段** | 站点 ID、种子 ID、标题、分类、HR/免费标记、大小、种子/下载人数、发布时间、是否删除等 |

**当前用途**：
- 为 HR/HNR / Local Intel 高级判断提供数据
- 为"本地秒搜"提供基础（IndexedSearchService 优先命中本地索引）
- 为未来"站点选择智能化"预留数据

### 3.2 Local Intel

**用途**：基于 TorrentIndex + 下载器数据做智能决策。

| 典型场景 | 说明 |
|----------|------|
| **判断 HR/HNR 风险** | 某站点/某类种子是否容易变 HR |
| **整理行为决策** | 是 MOVE 还是 COPY（保种安全优先） |
| **阻止危险操作** | 删除还在保种的文件时发出警告/阻止 |
| **本地秒搜** | 搜索时优先查本地索引，减少站点访问 |

### 3.3 SiteGuard / 扫描节流

```
before_pt_scan(site_id)
    │
    ├─ 检查站点健康状态
    ├─ 检查节流计数
    ├─ 评估封禁风险
    │
    └─ 通过 → 允许扫描
       未通过 → 延迟/跳过
```

- **目的**：避免短时间内对某站发起过多请求
- **效果**：降低封号和被视为攻击的风险

---

## 4. External Indexer & Global Search

### 4.1 职责

**External Indexer** 是面向搜索的多站点聚合模块：

| 功能 | 说明 |
|------|------|
| **汇聚多来源** | 实时在线搜索（PT 站）+ 本地 TorrentIndex 索引 |
| **合并去重** | 以媒体信息（名称/年份/分辨率等）为统一维度 |
| **来源标记** | 结果标明来自哪些站点 |
| **排序优化** | 按质量、做种数、HR 风险等排序 |

### 4.2 与 Local Intel 联动

- 利用本地索引统计信息，帮助判断"哪个站点更适合下"
- 示例：某站 HR 风险小 / 做种更稳 → 优先推荐该站资源

### 4.3 与订阅/工作流的关系

- 为订阅规则 / 工作流提供查询能力
- 订阅刷新时调用 External Indexer 搜索匹配资源

---

## 5. 站点 AI 适配 & CF adapter

### 5.1 用途

**站点 AI 适配** 只用于：
- 解析 PT 站点页面结构（列表页 / 详情页 / HR 页面等）
- 生成结构化"适配配置"
- 让 External Indexer / TorrentIndex 能在站点改版后自动恢复工作

### 5.2 实现概要

```
站点页面 HTML 片段
    │
    ▼
CF Pages（转发层）
    │
    ▼
外部大模型（Qwen2.5-Coder-7B-Instruct）
    │
    ├─ 分析 HTML 结构
    └─ 生成适配规则 JSON
         │
         ▼
本地缓存 + 频率控制
    │
    └─ 供 External Indexer / TorrentIndex 使用
```

### 5.3 硬性边界

| 限制 | 说明 |
|------|------|
| **专用通道** | 不能作为通用聊天或其他 AI 用途 |
| **最小数据** | 仅上传解析所需的页面结构片段，不上传用户下载内容/个人数据 |
| **仅限本机** | 解析结果只用于本机当前配置的站点，不做跨用户共享 |
| **频率控制** | 同一站点不会频繁重算，仅在必要时刷新 |

---

## 6. HR/HNR 安全策略

### 6.1 三者关系

```
设置模块配置
├── 是否允许移动源文件
├── 是否强制 COPY（尤其对 HR 种）
├── 是否允许删种/删除文件
│
    ▼
Local Intel 决策
├── 基于 TorrentIndex 判断种子 HR 标记
├── 基于下载器数据判断实际做种状态
├── 综合输出：允许/警告/阻止
│
    ▼
下载管理模块
├── 展示 HR/HNR 风险标记
├── 用户看到状态与 Local Intel/设置的关系
└── 整理行为按决策执行
```

### 6.2 典型场景示例

| 场景 | 设置 | Local Intel 判断 | 结果 |
|------|------|------------------|------|
| 整理一个 HR 种子 | 强制 COPY=开 | 种子仍在做种 | 执行 COPY，保留源文件 |
| 删除已完成种子 | 允许删种=关 | 种子仍在做种 | 阻止删除，提示风险 |
| 移动普通种子 | 强制 COPY=关 | 种子已停止做种 | 允许 MOVE |

---

## 7. "云大脑 v1" 历史 & 现状（LEGACY）

### 7.1 早期设想

```
用户 A ──┐
用户 B ──┼──▶ 本地抓取各自有账号的 PT 站
用户 C ──┘
              │
              ▼
         云端聚合
              │
              ├─ 分布式任务分配（不同用户扫不同页）
              ├─ 汇总成"站点资源视图 + 识别词大脑"
              └─ 提供跨用户的"共享识别经验"
                   │
                   ▼
              搜索时秒回结果（云端已有索引）
```

**目标**：
- 大家一起帮忙扫完各自能访问的站点
- 共享"谁大概有货 / 命名习惯 / HR 行为模式"的统计
- 用户搜索时优先命中云端汇总的识别经验

**权限边界**：即使云端维护了"全局视图"，每个用户仍然只能看到自己能登录的那些站点的结果。

### 7.2 现阶段决策

**出于成本与合规考虑，这条线已完全停用：**

- ❌ 不再做任何"云端站点目录聚合"
- ❌ 不再做跨用户的抓取任务分配
- ❌ 不再实现任何跨用户目录合并

**仓库中保留的相关代码**：
- `intel_center` / `mesh_scheduler` 等目录仅作为历史 PoC 与未来设计参考
- 当前版本不应直接启用

### 7.3 当前保留的部分

**仅保留"本地大脑"**：

| 能力 | 说明 |
|------|------|
| Local Intel | 在本机运行，分析本地数据 |
| TorrentIndex | 只索引自己有账号的站点 |
| HR 决策 | 基于本地数据做安全判断 |
| 本地秒搜 | 优先查本地索引 |

**每个用户只分析和搜索自己可访问的 PT 站点，不做任何跨用户数据共享。**

### 7.4 未来可能方向（仅备忘，不承诺实现）

- 通过**公开规则包 / 别名词典 / Git 仓库**来共享"识别经验"
- 共享的是规则和词典，而非任何用户具体目录数据
- 类似开源社区的"站点解析规则"共享模式

---

*最后更新：2025-12-03 UI-GLUE-FILL-GAPS-1*  

> **UI状态更新**：所有站点/智能栈相关UI页面（站点管理、HNR风险检测、Local Intel、外部索引）已完成真实API对接，前端与后端数据链路已打通。
