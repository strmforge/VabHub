# 订阅 / 规则 / RSSHub / 工作流 体系总览

> **用途**：本文描述 VabHub 中"订阅管理 / RSS 订阅 / RSSHub 订阅 / 工作流管理 / 规则中心 / AI 订阅助手"模块之间的关系与典型使用路径。  
> **阅读对象**：新接手的开发者、新窗口 AI、以及想要了解订阅自动化体系的用户。

---

## 0. 使用说明

### 0.1 本文结构

1. **模块一览**：按左侧导航列出所有订阅相关模块及其职责
2. **典型使用路径**：常见场景的操作步骤
3. **数据流 & 职责边界**：技术向的模块分工说明
4. **添加订阅入口汇总**：订阅创建入口清单
5. **v1 限制 & 后续优化**：当前已知局限

### 0.2 给未来 AI 的提示

当用户问到以下问题时，请先读本文件：
- "订阅规则在哪配置？"
- "自动订阅怎么设置？"
- "RSS/RSSHub 和订阅管理什么关系？"
- "工作流管理是干什么的？"
- "AI 订阅助手生成的订阅去哪看？"

读完本文后，结合 `VABHUB_SYSTEM_OVERVIEW.md` 和 `FUTURE_AI_OVERVIEW.md` 可获得更完整的技术细节。

---

## 1. 模块一览（按左侧导航）

> **模块**：左侧导航项 / 可展开的项目组  
> **页面**：模块内的具体视图或 Tab

### 📥 下载 & 订阅 模块组

| 模块 | 路由 | 职责说明 | 状态 |
|------|------|----------|------|
| **搜索** | `/search` | 多站点聚合搜索，可将搜索结果直接添加为订阅 | [NOW] |
| **下载管理** | `/downloads` | 查看/管理下载任务状态，不涉及订阅配置 | [NOW] |
| **订阅管理**（展开） | — | 查看订阅进度的"盘点面板"，不提供新建订阅按钮 | [NOW] |
| ├─ 电影订阅 | `/subscriptions/movies` | 电影类型订阅卡片视图 | [NOW] |
| ├─ 电视剧订阅 | `/subscriptions/tv` | 电视剧/动漫/短剧订阅，显示集数进度 | [NOW] |
| ├─ 音乐订阅 | `/subscriptions/music` | 音乐订阅卡片视图 | [NOW] |
| └─ 书籍订阅 | `/subscriptions/books` | 书籍/小说订阅卡片视图 | [NOW] |
| **RSS订阅** | `/rss-subscriptions` | 管理普通 RSS 源（站点/自定义 URL） | [NOW] |
| **RSSHub订阅** | `/rsshub` | 管理 RSSHub 源（豆瓣/榜单/更新源等） | [NOW] |
| **工作流管理** | `/workflows` | 查看/配置定时任务（RSS 拉取、订阅刷新等） | [NOW] |

### ⚙️ 系统 & 设置 模块组

| 模块 | 路由 | 职责说明 |
|------|------|----------|
| **设置** | `/settings` | 系统设置入口 |
| └─ 规则中心 | `/settings/rule-center` | 订阅默认配置 + 过滤规则组管理 |

### 🤖 AI 中心 模块组

| 模块 | 路由 | 职责说明 |
|------|------|----------|
| **AI 订阅助手** | `/ai-subs-assistant` | 自然语言 → 订阅工作流草案，需确认后应用 |

---

## 2. 典型使用路径

### 路径 A：从搜索结果添加订阅

```
搜索模块 (/search)
    │
    ├─ 输入关键词，执行多站点搜索
    │
    ├─ 在结果中点击"添加为订阅"
    │    └─ 弹出对话框，设置质量/站点/安全策略
    │
    └─ 订阅创建成功
         │
         └─ 在"订阅管理"对应子页面查看
              例如：电影订阅、电视剧订阅
```

### 路径 B：通过规则中心配置自动订阅

```
设置模块 (/settings) → 规则中心页面
    │
    ├─ 配置订阅默认规则
    │    ├─ 默认下载器 / 保存路径
    │    ├─ HR 安全策略（allow_hr / strict_free_only）
    │    └─ 质量偏好（min_resolution / effect）
    │
    ├─ 编辑过滤规则组
    │    └─ 可被订阅 / 工作流引用
    │
    └─ 这些规则在以下场景生效：
         ├─ 搜索时创建订阅
         ├─ 工作流刷新订阅
         └─ RSSHub/RSS 触发自动下载
```

### 路径 C：通过 RSSHub / RSS + 工作流实现榜单自动订阅

```
RSSHub订阅模块 (/rsshub)
    │
    ├─ 添加/启用 RSSHub 源
    │    例如：豆瓣热门韩剧、音乐榜单
    │
    └─ 关联到工作流
         │
         ▼
工作流管理模块 (/workflows)
    │
    ├─ 配置定时任务：每 N 小时拉取 RSSHub 源
    │
    ├─ 新条目触发：
    │    ├─ 自动搜索匹配资源
    │    └─ 按规则中心配置筛选 → 创建下载任务
    │
    └─ 结果可在以下位置查看：
         ├─ 下载管理：查看下载任务
         └─ 订阅管理：查看订阅卡片（如有）
```

### 路径 D：利用 AI 订阅助手生成订阅策略

```
AI 中心 → AI 订阅助手 (/ai-subs-assistant)
    │
    ├─ 输入自然语言需求
    │    例如："帮我订阅热门韩剧，1080p 以上，要有中字"
    │
    ├─ Orchestrator SUBS_ADVISOR 模式处理
    │    ├─ 调用站点概览工具
    │    ├─ 调用搜索预览工具
    │    └─ 生成订阅工作流草案（JSON）
    │
    ├─ 展示草案给用户
    │    └─ 用户确认/修改 → 点击"应用"
    │
    └─ 草案转为真实订阅
         │
         └─ 在"订阅管理"对应子页面可见
```

---

## 3. 数据流 & 职责边界

### 3.1 订阅数据存在哪里

| 订阅类型 | 核心模型 | 说明 |
|----------|----------|------|
| 媒体订阅（电影/电视剧/音乐等） | `Subscription` | 最核心的订阅表，包含质量/站点/安全策略 |
| RSS 订阅 | `RSSSubscription` | 普通 RSS 源订阅 |
| RSSHub 订阅 | `RSSHubSource` + `UserRSSHubSubscription` | RSSHub 源配置 + 用户订阅关系 |

### 3.2 规则中心负责什么

- **订阅默认配置**：新建订阅时的默认下载器、保存路径、HR 安全策略
- **过滤规则组**：可复用的过滤规则集合，供订阅/工作流引用
- **不直接持有订阅实例**：规则中心提供"模板"，具体订阅由其他入口创建

### 3.3 工作流管理负责什么

- **调度任务管理**：挂载定时任务（RSS/RSSHub 拉取、订阅刷新、自动搜索等）
- **使用规则中心配置**：执行时按规则中心的默认配置筛选资源
- **只负责"什么时候干活"**：不定义订阅本身，只触发订阅刷新/搜索/下载

### 3.4 AI 订阅助手负责什么

- **自然语言 → 结构化草案**：将用户需求转为 `SubsWorkflowDraft` JSON
- **草案需人工确认**：默认 `auto_download=False`，安全优先
- **最终落地为真实订阅**：确认后调用 `SubscriptionService` 创建订阅
- **不负责执行下载**：实际下载仍由订阅刷新 + 工作流触发

---

## 4. 添加/修改订阅的入口汇总

| 入口 | 位置 | 说明 |
|------|------|------|
| **搜索结果** | `/search` → 结果卡片 | 点击"添加为订阅"直接创建 |
| **规则中心** | `/settings/rule-center` | 配置规则模板，供其他入口使用 |
| **AI 订阅助手** | `/ai-subs-assistant` | 自然语言生成草案 → 确认后创建 |
| **RSS/RSSHub 订阅** | `/rss-subscriptions` `/rsshub` | 配置源，通过工作流触发自动订阅/下载 |
| **推荐页面** | `/recommendations` | AI 推荐结果可添加为订阅 |

> **注意**：订阅管理模块（`/subscriptions/*`）不提供"新建订阅"按钮，是一个"盘点 & 监控面板"。

---

## 5. v1 限制 & 后续可选优化

| 序号 | 限制说明 | 后续方向 |
|------|----------|----------|
| 1 | 电视剧"已下载集数"目前使用 `start_episode` 近似值 | 接入媒体库统计，获取精确已下载集数 |
| 2 | 音乐/书籍订阅卡片展示字段有限 | 增加"已下载曲目数"/"已入库书籍数"统计 |
| 3 | 工作流管理页面偏技术向 | 添加更"人话"的描述或预设模板 |
| 4 | 规则中心 UI 配置能力有限 | 增加可视化规则编辑器 |
| 5 | RSSHub 与工作流联动需手动配置 | 提供"一键订阅榜单"预设模板 |

---

*最后更新：2025-12-03 UI-GLUE-FILL-GAPS-1*  

> **UI状态更新**：所有订阅相关UI页面（搜索、下载管理、RSS订阅、RSSHub订阅、工作流管理）已完成真实API对接，前端与后端数据链路已打通。
