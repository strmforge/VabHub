# 站点签到功能说明

## 📋 概述

VabHub现在实现了**完整的站点签到系统**，支持多种PT站点的自动签到功能。

**完成时间**: 2025-11-08  
**状态**: ✅ 站点签到功能已实现

---

## 🎯 功能特性

### 1. 多站点类型支持
- **NexusPHP**: 最常见的PT站点类型
- **Unit3D**: 现代PT站点框架
- **TTG**: TTG站点专用签到
- **M-Team**: M-Team站点专用签到
- **通用站点**: 自动检测并尝试通用签到方式

### 2. 自动检测
- 自动检测站点类型
- 智能匹配签到方式
- 多种签到URL尝试

### 3. CookieCloud集成
- 自动从CookieCloud同步Cookie
- 支持密码加密的CookieCloud
- 域名自动匹配

### 4. 批量签到
- 支持批量签到所有站点
- 支持指定站点ID列表
- 详细的签到结果统计

### 5. 定时任务
- 每天凌晨3点自动执行签到
- 自动更新最后签到时间
- 详细的日志记录

---

## 🔧 技术实现

### 站点类型检测

系统会自动检测站点类型：

```python
# 检测逻辑
1. 访问站点首页
2. 分析HTML内容
3. 匹配特征关键词
4. 返回站点类型
```

### 签到流程

#### NexusPHP站点
```
1. 访问签到页面 (attendance.php, index.php?action=attendance等)
2. 检查是否已签到
3. 解析签到表单
4. 提交签到请求
5. 验证签到结果
```

#### Unit3D站点
```
1. 访问API端点 (/api/v1/checkin)
2. 发送POST请求
3. 解析JSON响应
4. 验证签到结果
```

#### TTG站点
```
1. 访问签到页面 (attendance.php)
2. 提取签到参数 (signed_timestamp, signed_token)
3. 提交签到请求
4. 验证签到结果
```

#### M-Team站点
```
1. 访问API端点 (/api/member/signin)
2. 发送POST请求
3. 解析JSON响应
4. 验证签到结果
```

#### 通用站点
```
1. 尝试常见签到URL
2. 检查响应内容
3. 尝试表单提交
4. 验证签到结果
```

---

## 📊 API端点

### 1. 单个站点签到
```bash
POST /api/v1/sites/{site_id}/checkin
```

响应:
```json
{
  "success": true,
  "message": "签到成功",
  "already_checked": false
}
```

### 2. 批量签到
```bash
POST /api/v1/sites/batch-checkin
```

响应:
```json
{
  "success": true,
  "total": 5,
  "success_count": 4,
  "failed_count": 1,
  "results": [
    {
      "site_id": 1,
      "site_name": "站点1",
      "success": true,
      "message": "签到成功"
    },
    ...
  ]
}
```

---

## 🎯 使用示例

### 手动签到单个站点
```bash
curl -X POST http://localhost:8000/api/v1/sites/1/checkin
```

### 批量签到所有站点
```bash
curl -X POST http://localhost:8000/api/v1/sites/batch-checkin
```

### 定时任务自动签到
- 系统每天凌晨3点自动执行所有启用的站点签到
- 无需手动操作

---

## 🔍 CookieCloud集成

### 配置CookieCloud
1. 在站点设置中配置CookieCloud服务器地址
2. 配置UUID和密码
3. 系统会自动从CookieCloud同步Cookie

### Cookie匹配逻辑
```
1. 从CookieCloud获取所有Cookie
2. 提取站点域名
3. 匹配CookieCloud中的域名
4. 使用匹配的Cookie进行签到
```

---

## 📈 功能特点

### 1. 智能检测
- 自动检测站点类型
- 智能匹配签到方式
- 多种URL尝试

### 2. 错误处理
- 完善的错误处理
- 详细的错误日志
- 友好的错误提示

### 3. 状态管理
- 更新最后签到时间
- 记录签到结果
- 支持已签到检测

### 4. 批量操作
- 支持批量签到
- 详细的统计信息
- 单独结果记录

---

## 🐛 故障排除

### 签到失败
1. 检查Cookie是否有效
2. 检查站点URL是否正确
3. 检查站点是否支持自动签到
4. 查看日志中的错误信息

### CookieCloud同步失败
1. 检查CookieCloud服务器地址
2. 检查UUID和密码
3. 检查网络连接
4. 查看日志中的错误信息

### 站点类型检测失败
1. 系统会尝试通用签到方式
2. 如果通用方式失败，可能需要手动配置
3. 查看日志中的检测结果

---

## ✅ 总结

### 优势
1. ✅ **多站点支持**: 支持多种PT站点类型
2. ✅ **自动检测**: 自动检测站点类型和签到方式
3. ✅ **CookieCloud集成**: 自动同步Cookie
4. ✅ **批量操作**: 支持批量签到
5. ✅ **定时任务**: 自动执行签到

### 支持的站点类型
1. ✅ NexusPHP
2. ✅ Unit3D
3. ✅ TTG
4. ✅ M-Team
5. ✅ 通用站点

---

**最后更新**: 2025-11-08  
**状态**: ✅ 站点签到功能已实现

