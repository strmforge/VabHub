# ç«¯ç‚¹å®ç°å®Œæˆæ€»ç»“

**å®Œæˆæ—¶é—´**: 2025-01-XX  
**çŠ¶æ€**: âœ… é«˜ä¼˜å…ˆçº§ä»»åŠ¡å·²å®Œæˆ

---

## ğŸ“‹ ä¸€ã€å·²å®Œæˆçš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡

### âœ… 1. ç»Ÿä¸€è·¯å¾„æ ¼å¼

**å˜æ›´**: ç§»é™¤ `/v1` å‰ç¼€

**ä¿®æ”¹æ–‡ä»¶**:
- `VabHub/backend/app/core/config.py`
  - `API_PREFIX: str = "/api/v1"` â†’ `API_PREFIX: str = "/api"`

**å½±å“**:
- æ‰€æœ‰APIç«¯ç‚¹ä» `/api/v1/...` å˜ä¸º `/api/...`
- ä¸æœŸæœ›åˆ—è¡¨æ ¼å¼ä¸€è‡´
- å‰ç«¯éœ€è¦æ›´æ–°APIè°ƒç”¨ï¼ˆç§»é™¤ `/v1` å‰ç¼€ï¼‰

**å…¼å®¹æ€§**:
- å¯¹é½æ£€æŸ¥è„šæœ¬å·²è‡ªåŠ¨å¤„ç† `/api/v1` â†’ `/api` çš„è½¬æ¢
- ç°æœ‰ä»£ç ä¸­çš„ `/api/v1` å¼•ç”¨éœ€è¦æ›´æ–°

---

### âœ… 2. å®ç°ä¸‹è½½ç®¡ç†åˆ«åç«¯ç‚¹

**çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆFastAPIè·¯ç”±å‚æ•°åä¸å½±å“URLåŒ¹é…ï¼‰

**è¯´æ˜**:
- FastAPIçš„è·¯ç”±å‚æ•°åä¸å½±å“URLåŒ¹é…
- `/{task_id}` å’Œ `/{download_id}` åœ¨URLå±‚é¢æ˜¯ä¸€æ ·çš„
- å› æ­¤ `/api/downloads/{task_id}` å’Œ `/api/downloads/{download_id}` éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- æ— éœ€æ·»åŠ åˆ«åç«¯ç‚¹

**å·²å®ç°çš„ç«¯ç‚¹**:
- âœ… `GET /api/downloads/{task_id}` - è·å–ä¸‹è½½è¯¦æƒ…ï¼ˆå…¼å®¹ `{download_id}`ï¼‰
- âœ… `POST /api/downloads/{task_id}/pause` - æš‚åœä¸‹è½½ï¼ˆå…¼å®¹ `{download_id}`ï¼‰
- âœ… `POST /api/downloads/{task_id}/resume` - æ¢å¤ä¸‹è½½ï¼ˆå…¼å®¹ `{download_id}`ï¼‰

---

### âœ… 3. å®ç°STRMç®¡ç†ç«¯ç‚¹

**æ–°å¢ç«¯ç‚¹**:
- âœ… `POST /api/strm/emit` - ç”ŸæˆSTRMæ–‡ä»¶ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
- âœ… `POST /api/strm/full-sync` - å…¨é‡åŒæ­¥ï¼ˆåˆ«åç«¯ç‚¹ï¼Œæ˜ å°„åˆ° `/sync/full`ï¼‰
- âœ… `POST /api/strm/incremental-sync` - å¢é‡åŒæ­¥ï¼ˆåˆ«åç«¯ç‚¹ï¼Œæ˜ å°„åˆ° `/sync/incremental`ï¼‰

**å·²å­˜åœ¨çš„ç«¯ç‚¹**ï¼ˆå·²ç¡®è®¤ï¼‰:
- âœ… `GET /api/strm/network-info` - è·å–ç½‘ç»œä¿¡æ¯
- âœ… `GET /api/strm/stream/{storage_type}/{token}` - æµåª’ä½“é‡å®šå‘
- âœ… `GET /api/strm/subtitle/{storage_type}/{token}` - å­—å¹•æµ
- âœ… `GET /api/strm/sync/history` - åŒæ­¥å†å²
- âœ… `POST /api/strm/sync/start` - å¯åŠ¨åŒæ­¥
- âœ… `POST /api/strm/sync/stop` - åœæ­¢åŒæ­¥
- âœ… `GET /api/strm/sync/tasks` - åŒæ­¥ä»»åŠ¡åˆ—è¡¨
- âœ… `GET /api/strm/sync/tasks/{task_id}` - åŒæ­¥ä»»åŠ¡è¯¦æƒ…
- âœ… `POST /api/strm/sync/tasks/{task_id}/stop` - åœæ­¢åŒæ­¥ä»»åŠ¡

**ä¿®æ”¹æ–‡ä»¶**:
- `VabHub/backend/app/api/strm.py`
  - æ·»åŠ  `EmitSTRMRequest` æ¨¡å‹
  - æ·»åŠ  `emit_strm` ç«¯ç‚¹
  - æ·»åŠ  `full_sync_alias` å’Œ `incremental_sync_alias` åˆ«åç«¯ç‚¹

---

### âœ… 4. å®ç°ä»»åŠ¡ç®¡ç†ç«¯ç‚¹

**æ–°å»ºæ–‡ä»¶**: `VabHub/backend/app/api/tasks.py`

**å®ç°çš„ç«¯ç‚¹**:
- âœ… `GET /api/tasks` - è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆæ”¯æŒç±»å‹å’ŒçŠ¶æ€è¿‡æ»¤ã€åˆ†é¡µï¼‰
- âœ… `GET /api/tasks/{task_id}` - è·å–ä»»åŠ¡è¯¦æƒ…
- âœ… `POST /api/tasks/{task_id}/retry` - é‡è¯•ä»»åŠ¡

**åŠŸèƒ½**:
- èšåˆæ‰€æœ‰ç±»å‹çš„ä»»åŠ¡ï¼ˆä¸‹è½½ã€ä¸Šä¼ ã€åŒæ­¥ï¼‰
- æ”¯æŒæŒ‰ç±»å‹å’ŒçŠ¶æ€è¿‡æ»¤
- æ”¯æŒåˆ†é¡µ
- ç»Ÿä¸€ä»»åŠ¡å“åº”æ ¼å¼

**æ³¨å†Œè·¯ç”±**:
- åœ¨ `app/api/__init__.py` ä¸­æ³¨å†Œ `tasks.router` åˆ° `/tasks` å‰ç¼€

---

### âœ… 5. å®ç°è®¢é˜…ç®¡ç†ç«¯ç‚¹

**æ–°å¢ç«¯ç‚¹**:
- âœ… `POST /api/subscriptions/test` - æµ‹è¯•è®¢é˜…é…ç½®

**å·²å­˜åœ¨çš„ç«¯ç‚¹**ï¼ˆå·²ç¡®è®¤ï¼‰:
- âœ… `GET /api/subscriptions/{subscription_id}` - è·å–è®¢é˜…è¯¦æƒ…ï¼ˆå…¼å®¹ `{sid}`ï¼‰
- âœ… `PUT /api/subscriptions/{subscription_id}` - æ›´æ–°è®¢é˜…ï¼ˆå…¼å®¹ `{sid}`ï¼‰
- âœ… `DELETE /api/subscriptions/{subscription_id}` - åˆ é™¤è®¢é˜…ï¼ˆå…¼å®¹ `{sid}`ï¼‰

**è¯´æ˜**:
- FastAPIè·¯ç”±å‚æ•°åä¸å½±å“URLåŒ¹é…
- `/{subscription_id}` å’Œ `/{sid}` åœ¨URLå±‚é¢æ˜¯ä¸€æ ·çš„
- å› æ­¤ `/api/subscriptions/{subscription_id}` å’Œ `/api/subscriptions/{sid}` éƒ½èƒ½æ­£å¸¸å·¥ä½œ

**ä¿®æ”¹æ–‡ä»¶**:
- `VabHub/backend/app/api/subscription.py`
  - æ·»åŠ  `test_subscription` ç«¯ç‚¹

---

## ğŸ“‹ äºŒã€è·¯å¾„æ ¼å¼ç»Ÿä¸€è¯´æ˜

### å˜æ›´è¯¦æƒ…

**ä¹‹å‰**: `/api/v1/...`  
**ç°åœ¨**: `/api/...`

### éœ€è¦æ›´æ–°çš„åœ°æ–¹

1. **å‰ç«¯APIè°ƒç”¨**
   - æ‰€æœ‰ `/api/v1/...` éœ€è¦æ”¹ä¸º `/api/...`

2. **æµ‹è¯•è„šæœ¬**
   - `test_api_endpoints_manual.py`
   - `test_api_endpoints.py`
   - å…¶ä»–æµ‹è¯•è„šæœ¬ä¸­çš„ `API_PREFIX` å¼•ç”¨

3. **æ–‡æ¡£**
   - APIæ–‡æ¡£ä¸­çš„è·¯å¾„ç¤ºä¾‹
   - éƒ¨ç½²æ–‡æ¡£ä¸­çš„APIåœ°å€

### å¯¹é½æ£€æŸ¥è„šæœ¬

å¯¹é½æ£€æŸ¥è„šæœ¬ (`tools/check_ui_backend_alignment.py`) å·²è‡ªåŠ¨å¤„ç†è·¯å¾„è½¬æ¢ï¼š
- è‡ªåŠ¨å°† `/api/v1/...` è½¬æ¢ä¸º `/api/...`
- ä¸æœŸæœ›åˆ—è¡¨æ ¼å¼åŒ¹é…

---

## ğŸ“‹ ä¸‰ã€å¾…å®ç°çš„ä¸­ä¼˜å…ˆçº§ä»»åŠ¡

### 1. è¯„ä¼°é¢å¤–ç«¯ç‚¹

**å½“å‰çŠ¶æ€**:
- åç«¯æœ‰ **292ä¸ªé¢å¤–ç«¯ç‚¹**ï¼ˆä¸åœ¨æœŸæœ›åˆ—è¡¨ä¸­ï¼‰
- éœ€è¦åˆ†æè¿™äº›ç«¯ç‚¹ï¼Œç¡®å®šå“ªäº›åº”è¯¥æ·»åŠ åˆ°æœŸæœ›åˆ—è¡¨

**å»ºè®®è¯„ä¼°æ ‡å‡†**:
1. **æ ¸å¿ƒåŠŸèƒ½ç«¯ç‚¹**: åº”è¯¥æ·»åŠ 
   - åª’ä½“æœåŠ¡å™¨ç®¡ç† (`/api/media-servers/...`)
   - å­˜å‚¨ç›‘æ§ (`/api/storage-monitor/...`)
   - æ–‡ä»¶æµè§ˆå™¨ (`/api/file-browser/...`)
   - è½¬ç§»å†å² (`/api/transfer-history/...`)

2. **è¾…åŠ©åŠŸèƒ½ç«¯ç‚¹**: å¯é€‰æ·»åŠ 
   - æ€§èƒ½ç›‘æ§ (`/api/performance/...`)
   - å¤šæ¨¡æ€åˆ†æ (`/api/multimodal/...`)
   - æ¨èç³»ç»Ÿ (`/api/recommendations/...`)

3. **å†…éƒ¨ç«¯ç‚¹**: ä¸éœ€è¦æ·»åŠ 
   - ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„ç«¯ç‚¹
   - è°ƒè¯•ç«¯ç‚¹

### 2. æ›´æ–°æœŸæœ›åˆ—è¡¨

**å»ºè®®æ·»åŠ çš„ç«¯ç‚¹**ï¼ˆéƒ¨åˆ†ï¼‰:

```
# åª’ä½“æœåŠ¡å™¨ç®¡ç†
GET /api/media-servers
POST /api/media-servers
GET /api/media-servers/{server_id}
PUT /api/media-servers/{server_id}
DELETE /api/media-servers/{server_id}
POST /api/media-servers/{server_id}/check
POST /api/media-servers/{server_id}/sync/libraries
POST /api/media-servers/{server_id}/sync/metadata
GET /api/media-servers/{server_id}/playback-sessions
GET /api/media-servers/{server_id}/sync-history

# å­˜å‚¨ç›‘æ§
GET /api/storage-monitor/directories
POST /api/storage-monitor/directories
GET /api/storage-monitor/directories/{directory_id}
PUT /api/storage-monitor/directories/{directory_id}
DELETE /api/storage-monitor/directories/{directory_id}
GET /api/storage-monitor/usage
GET /api/storage-monitor/statistics

# æ–‡ä»¶æµè§ˆå™¨
GET /api/file-browser/list
GET /api/file-browser/item
POST /api/file-browser/transfer
POST /api/file-browser/delete
POST /api/file-browser/rename
POST /api/file-browser/scrape

# è½¬ç§»å†å²
GET /api/transfer-history
GET /api/transfer-history/{history_id}
```

---

## ğŸ“‹ å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å»ºæ–‡ä»¶

1. `VabHub/backend/app/api/tasks.py` - ä»»åŠ¡ç®¡ç†API
2. `VabHub/backend/app/api/library.py` - åª’ä½“åº“å…¼å®¹æ€§ç«¯ç‚¹

### ä¿®æ”¹æ–‡ä»¶

1. `VabHub/backend/app/core/config.py` - ç§»é™¤ `/v1` å‰ç¼€
2. `VabHub/backend/app/api/auth.py` - æ·»åŠ ç™»å‡ºç«¯ç‚¹
3. `VabHub/backend/app/api/storage.py` - æ·»åŠ å­˜å‚¨çŠ¶æ€å’Œé…ç½®ç«¯ç‚¹
4. `VabHub/backend/app/api/strm.py` - æ·»åŠ STRM emitå’Œåˆ«åç«¯ç‚¹
5. `VabHub/backend/app/api/subscription.py` - æ·»åŠ è®¢é˜…æµ‹è¯•ç«¯ç‚¹
6. `VabHub/backend/app/api/download.py` - æ·»åŠ æ³¨é‡Šè¯´æ˜å‚æ•°åå…¼å®¹æ€§
7. `VabHub/backend/app/api/__init__.py` - æ³¨å†Œlibraryå’Œtasksè·¯ç”±
8. `VabHub/backend/main.py` - æ·»åŠ  `/healthz` å’Œ `/metrics` ç«¯ç‚¹

---

## ğŸ“‹ äº”ã€é‡è¦è¯´æ˜

### FastAPIè·¯ç”±å‚æ•°åå…¼å®¹æ€§

**é‡è¦**: FastAPIçš„è·¯ç”±å‚æ•°åä¸å½±å“URLåŒ¹é…ï¼

ä¾‹å¦‚ï¼š
- `@router.get("/{task_id}")` å’Œ `@router.get("/{download_id}")` åœ¨URLå±‚é¢æ˜¯ä¸€æ ·çš„
- `/api/downloads/{task_id}` å’Œ `/api/downloads/{download_id}` éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- å› æ­¤æ— éœ€æ·»åŠ åˆ«åç«¯ç‚¹

**å·²ç¡®è®¤å…¼å®¹çš„ç«¯ç‚¹**:
- âœ… `/api/downloads/{task_id}` å…¼å®¹ `/api/downloads/{download_id}`
- âœ… `/api/subscriptions/{subscription_id}` å…¼å®¹ `/api/subscriptions/{sid}`
- âœ… `/api/tasks/{task_id}` å…¼å®¹ `/api/tasks/{tid}`

---

## ğŸ“‹ å…­ã€ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³æ‰§è¡Œ

1. **æµ‹è¯•è·¯å¾„æ ¼å¼å˜æ›´**
   - å¯åŠ¨åç«¯æœåŠ¡
   - è¿è¡Œå¯¹é½æ£€æŸ¥è„šæœ¬
   - éªŒè¯æ‰€æœ‰ç«¯ç‚¹æ­£å¸¸å·¥ä½œ

2. **æ›´æ–°å‰ç«¯APIè°ƒç”¨**
   - å°†æ‰€æœ‰ `/api/v1/...` æ”¹ä¸º `/api/...`
   - æµ‹è¯•å‰ç«¯åŠŸèƒ½

### è¿‘æœŸæ‰§è¡Œ

1. **è¯„ä¼°é¢å¤–ç«¯ç‚¹**
   - åˆ†æ292ä¸ªé¢å¤–ç«¯ç‚¹
   - ç¡®å®šéœ€è¦æ·»åŠ åˆ°æœŸæœ›åˆ—è¡¨çš„ç«¯ç‚¹
   - æ›´æ–°æœŸæœ›åˆ—è¡¨æ–‡ä»¶

2. **å®Œå–„æ–‡æ¡£**
   - æ›´æ–°APIæ–‡æ¡£
   - æ›´æ–°éƒ¨ç½²æ–‡æ¡£
   - æ·»åŠ ç«¯ç‚¹ä½¿ç”¨ç¤ºä¾‹

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**çŠ¶æ€**: âœ… é«˜ä¼˜å…ˆçº§ä»»åŠ¡å·²å®Œæˆï¼Œä¸­ä¼˜å…ˆçº§ä»»åŠ¡å¾…æ‰§è¡Œ

