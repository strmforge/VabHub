# 115ç½‘ç›˜æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§

## ğŸ“‹ å®˜æ–¹æ–‡æ¡£è§„èŒƒ

### 1. è·å–ä¸Šä¼ å‡­è¯API

**ç«¯ç‚¹**: `GET åŸŸå+/open/upload/get_token`

**è¯´æ˜**: è·å–ä¸Šä¼ å‡­è¯

#### è¯·æ±‚å‚æ•°

**Headers**:
- `Authorization: Bearer access_token`ï¼ˆå¿…å¡«ï¼‰

#### è¿”å›æ•°æ®

- `state`: booleanï¼ˆçŠ¶æ€; true:æ­£å¸¸; false:é”™è¯¯ï¼‰
- `message`: stringï¼ˆå¼‚å¸¸ä¿¡æ¯ï¼‰
- `code`: numberï¼ˆå¼‚å¸¸ç ï¼‰
- `data`: object[]ï¼ˆæ•°æ®æ•°ç»„ï¼‰
  - `endpoint`: stringï¼ˆä¸Šä¼ åŸŸåï¼‰
  - `AccessKeyId`: stringï¼ˆä¸Šä¼ å‡­è¯-IDï¼‰
  - `AccessKeySecrett`: stringï¼ˆä¸Šä¼ å‡­è¯-å¯†é’¥ï¼Œæ³¨æ„æœ‰ä¸¤ä¸ªtï¼‰
  - `SecurityToken`: stringï¼ˆä¸Šä¼ å‡­è¯-tokenï¼‰
  - `Expiration`: stringï¼ˆä¸Šä¼ å‡­è¯-è¿‡æœŸæ—¥æœŸï¼‰

### 2. æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–API

**ç«¯ç‚¹**: `POST åŸŸå+/open/upload/init`

**è¯´æ˜**: æ–­ç‚¹ç»­ä¼ ä¸Šä¼ åˆå§‹åŒ–è°ƒåº¦æ¥å£

#### è¯·æ±‚å‚æ•°

**Headers**:
- `Authorization: Bearer access_token`ï¼ˆå¿…å¡«ï¼‰

**Body (form-data)**:
- `file_name`: æ–‡ä»¶åï¼ˆå¿…å¡«ï¼‰
- `file_size`: æ–‡ä»¶å¤§å°(å­—èŠ‚)ï¼ˆå¿…å¡«ï¼‰
- `target`: æ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®šï¼ˆå¿…å¡«ï¼‰
  - æ ¼å¼: `U_1_0`
  - `U_1`æ˜¯å›ºå®šçº¦å®š
  - `0`ä»£è¡¨æ ¹ç›®å½•ï¼Œå…¶ä»–æ•°å­—æ˜¯æ–‡ä»¶å¤¹ID
- `fileid`: æ–‡ä»¶sha1å€¼ï¼ˆå¿…å¡«ï¼‰
- `preid`: æ–‡ä»¶å‰128K sha1ï¼ˆå¯é€‰ï¼‰
- `pick_code`: ä¸Šä¼ ä»»åŠ¡keyï¼ˆå¯é€‰ï¼Œéç§’ä¼ çš„è°ƒåº¦æ¥å£è¿”å›çš„pick_codeå­—æ®µï¼‰
- `topupload`: ä¸Šä¼ è°ƒåº¦æ–‡ä»¶ç±»å‹è°ƒåº¦æ ‡è®°ï¼ˆå¯é€‰ï¼‰
  - `0`: å•æ–‡ä»¶ä¸Šä¼ ä»»åŠ¡æ ‡è¯†ä¸€æ¡å•ç‹¬çš„æ–‡ä»¶ä¸Šä¼ è®°å½•
  - `1`: æ–‡ä»¶å¤¹ä»»åŠ¡è°ƒåº¦çš„ç¬¬ä¸€ä¸ªå­æ–‡ä»¶ä¸Šä¼ è¯·æ±‚æ ‡è¯†ä¸€æ¬¡æ–‡ä»¶å¤¹ä¸Šä¼ è®°å½•
  - `2`: æ–‡ä»¶å¤¹ä»»åŠ¡è°ƒåº¦çš„å…¶ä½™åç»­å­æ–‡ä»¶ä¸ä½œè®°ä½œå•ç‹¬ä¸Šä¼ çš„ä¸Šä¼ è®°å½•
  - `-1`: æ²¡æœ‰è¯¥å‚æ•°
- `sign_key`: äºŒæ¬¡è®¤è¯éœ€è¦ï¼ˆå¯é€‰ï¼‰
- `sign_val`: äºŒæ¬¡è®¤è¯éœ€è¦ï¼ˆå¯é€‰ï¼Œå¤§å†™ï¼‰

#### è¿”å›æ•°æ®

- `state`: booleanï¼ˆçŠ¶æ€; true:æ­£å¸¸; false:é”™è¯¯ï¼‰
- `message`: stringï¼ˆå¼‚å¸¸ä¿¡æ¯ï¼‰
- `code`: numberï¼ˆå¼‚å¸¸ç ï¼‰
- `data`: object[]ï¼ˆæ•°æ®æ•°ç»„ï¼‰
  - `pick_code`: stringï¼ˆä¸Šä¼ ä»»åŠ¡å”¯ä¸€IDï¼Œç”¨äºç»­ä¼ ï¼‰
  - `status`: numberï¼ˆä¸Šä¼ çŠ¶æ€; 1:éç§’ä¼ ; 2:ç§’ä¼ ï¼‰
  - `file_id`: stringï¼ˆç§’ä¼ æˆåŠŸè¿”å›çš„æ–°å¢æ–‡ä»¶IDï¼‰
  - `target`: stringï¼ˆæ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®šï¼‰
  - `bucket`: stringï¼ˆä¸Šä¼ çš„bucketï¼‰
  - `object`: stringï¼ˆOSS objectIDï¼‰
  - `callback`: object[]ï¼ˆä¸Šä¼ æ—¶é—´ï¼‰
    - `callback`: stringï¼ˆä¸Šä¼ å®Œå›è°ƒä¿¡æ¯ï¼‰
    - `callback_var`: stringï¼ˆä¸Šä¼ å®Œå›è°ƒå‚æ•°ï¼‰
  - `sign_key`: stringï¼ˆæœ¬æ¬¡è®¡ç®—çš„sha1æ ‡è¯†ï¼ŒäºŒæ¬¡è®¤è¯ï¼‰
  - `sign_check`: stringï¼ˆæœ¬æ¬¡è®¡ç®—æœ¬åœ°æ–‡ä»¶sha1åŒºé—´èŒƒå›´ï¼ŒäºŒæ¬¡è®¤è¯ï¼‰

### 3. äºŒæ¬¡è®¤è¯è¯´æ˜

#### é”™è¯¯ç å’ŒçŠ¶æ€

| code | status | è¯´æ˜ | åç»­å¤„ç† | ç¬¬äºŒæ¬¡éªŒè¯ |
|------|--------|------|----------|-----------|
| 700 | 6 | ç­¾åè®¤è¯åå¤±è´¥ | sign_check (ç”¨ä¸‹åˆ’çº¿éš”å¼€,æˆªå–ä¸Šä¼ æ–‡å†…å®¹çš„sha1) (å•ä½æ˜¯byte) | sign_key |
| 701 | 7 | éœ€è¦è®¤è¯ç­¾å | sign_check: "2392148-2392298" å–2392148-2392298ä¹‹é—´çš„å†…å®¹(åŒ…å«2392148ã€2392298)çš„sha1 | sign_val (æ ¹æ®sign_checkè®¡ç®—çš„å€¼å¤§å†™çš„sha1å€¼) |
| 702 | 8 | ç­¾åè®¤è¯å¤±è´¥ | ä¾‹å¦‚:è·å–0-99å­—èŠ‚(åŒ…å«0å’Œ99)å…±100ä¸ªå­—èŠ‚ | - |

## âœ… å½“å‰å®ç°å¯¹ç…§

### 1. è·å–ä¸Šä¼ å‡­è¯API âœ…

#### å®ç°æ£€æŸ¥

- **APIç«¯ç‚¹**: âœ… æ­£ç¡® (`GET /open/upload/get_token`)
- **è¯·æ±‚å¤´**: âœ… æ­£ç¡® (`Authorization: Bearer access_token`)
- **è¿”å›æ•°æ®**: âœ… æ­£ç¡®
  - `endpoint`: âœ… æ”¯æŒ
  - `AccessKeyId`: âœ… æ”¯æŒ
  - `AccessKeySecrett`: âœ… æ”¯æŒï¼ˆæ³¨æ„å­—æ®µåæœ‰ä¸¤ä¸ªtï¼‰
  - `SecurityToken`: âœ… æ”¯æŒ
  - `Expiration`: âœ… æ”¯æŒ

#### æ”¹è¿›ç‚¹

1. âœ… **å­—æ®µæ˜ å°„**: æ­£ç¡®æ˜ å°„æ‰€æœ‰è¿”å›å­—æ®µ
2. âœ… **å­—æ®µåå¤„ç†**: æ³¨æ„`AccessKeySecrett`å­—æ®µåæœ‰ä¸¤ä¸ªt
3. âœ… **æ•°æ®è§£æ**: æ­£ç¡®å¤„ç†dataæ•°ç»„ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰

### 2. æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–API âœ…

#### å®ç°æ£€æŸ¥

- **APIç«¯ç‚¹**: âœ… æ­£ç¡® (`POST /open/upload/init`)
- **è¯·æ±‚å¤´**: âœ… æ­£ç¡® (`Authorization: Bearer access_token`)
- **è¯·æ±‚å‚æ•°**: âœ… æ­£ç¡®
  - `file_name`: âœ… æ”¯æŒ
  - `file_size`: âœ… æ”¯æŒ
  - `target`: âœ… æ”¯æŒï¼ˆè‡ªåŠ¨æ„å»ºU_1_{parent_id}æ ¼å¼ï¼‰
  - `fileid`: âœ… æ”¯æŒï¼ˆfile_sha1å‚æ•°ï¼‰
  - `preid`: âœ… æ”¯æŒï¼ˆpre_sha1å‚æ•°ï¼Œå¯é€‰ï¼‰
  - `pick_code`: âœ… æ”¯æŒï¼ˆå¯é€‰ï¼‰
  - `topupload`: âœ… æ”¯æŒï¼ˆå¯é€‰ï¼‰
  - `sign_key`: âœ… æ”¯æŒï¼ˆå¯é€‰ï¼ŒäºŒæ¬¡è®¤è¯ï¼‰
  - `sign_val`: âœ… æ”¯æŒï¼ˆå¯é€‰ï¼ŒäºŒæ¬¡è®¤è¯ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™ï¼‰

- **è¿”å›æ•°æ®**: âœ… æ­£ç¡®
  - `pick_code`: âœ… æ”¯æŒ
  - `status`: âœ… æ”¯æŒï¼ˆ1:éç§’ä¼ ; 2:ç§’ä¼ ï¼‰
  - `file_id`: âœ… æ”¯æŒï¼ˆç§’ä¼ æˆåŠŸè¿”å›çš„æ–‡ä»¶IDï¼‰
  - `target`: âœ… æ”¯æŒ
  - `bucket`: âœ… æ”¯æŒ
  - `object`: âœ… æ”¯æŒ
  - `callback`: âœ… æ”¯æŒ
  - `callback_var`: âœ… æ”¯æŒ
  - `sign_key`: âœ… æ”¯æŒï¼ˆäºŒæ¬¡è®¤è¯ï¼‰
  - `sign_check`: âœ… æ”¯æŒï¼ˆäºŒæ¬¡è®¤è¯ï¼‰

#### æ”¹è¿›ç‚¹

1. âœ… **targetæ ¼å¼**: è‡ªåŠ¨æ„å»º`U_1_{parent_id}`æ ¼å¼
2. âœ… **äºŒæ¬¡è®¤è¯**: æ”¯æŒäºŒæ¬¡è®¤è¯å‚æ•°ï¼ˆsign_key, sign_valï¼‰
3. âœ… **é”™è¯¯å¤„ç†**: å¤„ç†äºŒæ¬¡è®¤è¯ç›¸å…³çš„é”™è¯¯ç ï¼ˆ700, 701, 702ï¼‰
4. âœ… **ç§’ä¼ æ”¯æŒ**: æ”¯æŒç§’ä¼ ï¼ˆstatus=2æ—¶è¿”å›file_idï¼‰
5. âœ… **å›è°ƒä¿¡æ¯**: æ­£ç¡®è§£æcallbackæ•°ç»„

### 3. äºŒæ¬¡è®¤è¯å¤„ç† âœ…

#### å®ç°æ£€æŸ¥

- **é”™è¯¯ç 700**: âœ… æ”¯æŒï¼ˆstatus=6ï¼Œç­¾åè®¤è¯åå¤±è´¥ï¼‰
- **é”™è¯¯ç 701**: âœ… æ”¯æŒï¼ˆstatus=7ï¼Œéœ€è¦è®¤è¯ç­¾åï¼‰
- **é”™è¯¯ç 702**: âœ… æ”¯æŒï¼ˆstatus=8ï¼Œç­¾åè®¤è¯å¤±è´¥ï¼‰

#### æ”¹è¿›ç‚¹

1. âœ… **é”™è¯¯ç è¯†åˆ«**: è¯†åˆ«äºŒæ¬¡è®¤è¯ç›¸å…³çš„é”™è¯¯ç 
2. âœ… **è¿”å›signä¿¡æ¯**: è¿”å›sign_keyå’Œsign_checkç”¨äºäºŒæ¬¡è®¤è¯
3. âœ… **statuså­—æ®µ**: è¿”å›statuså­—æ®µç”¨äºäºŒæ¬¡è®¤è¯å¤„ç†

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–ä¸Šä¼ å‡­è¯

```python
from app.core.cloud_storage.providers.cloud_115_api import Cloud115API

# åˆå§‹åŒ–APIå®¢æˆ·ç«¯
api = Cloud115API(access_token=token_info["access_token"])

# è·å–ä¸Šä¼ å‡­è¯
token_result = await api.get_upload_token()

# è¿”å›ç»“æœ
# {
#     "success": True,
#     "endpoint": "https://upload.115.com",
#     "access_key_id": "xxx",
#     "access_key_secret": "xxx",
#     "security_token": "xxx",
#     "expiration": "2025-01-01T00:00:00Z"
# }

if token_result.get("success"):
    endpoint = token_result.get("endpoint")
    access_key_id = token_result.get("access_key_id")
    access_key_secret = token_result.get("access_key_secret")
    security_token = token_result.get("security_token")
    # ä½¿ç”¨å‡­è¯è¿›è¡Œæ–‡ä»¶ä¸Šä¼ 
```

### 2. æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–

```python
import hashlib

# è®¡ç®—æ–‡ä»¶sha1å€¼
def calculate_sha1(file_path: str) -> str:
    sha1 = hashlib.sha1()
    with open(file_path, 'rb') as f:
        while chunk := f.read(8192):
            sha1.update(chunk)
    return sha1.hexdigest()

# è®¡ç®—æ–‡ä»¶å‰128K sha1å€¼
def calculate_pre_sha1(file_path: str) -> str:
    sha1 = hashlib.sha1()
    with open(file_path, 'rb') as f:
        chunk = f.read(128 * 1024)  # 128K
        sha1.update(chunk)
    return sha1.hexdigest()

# æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–
file_path = "/path/to/file.mkv"
file_size = os.path.getsize(file_path)
file_sha1 = calculate_sha1(file_path)
pre_sha1 = calculate_pre_sha1(file_path)

result = await api.init_upload(
    file_name="file.mkv",
    file_size=file_size,
    target_parent_id="0",  # æ ¹ç›®å½•
    file_sha1=file_sha1,
    pre_sha1=pre_sha1
)

# è¿”å›ç»“æœ
# {
#     "success": True,
#     "pick_code": "xxx",
#     "status": 2,  # 2:ç§’ä¼ æˆåŠŸ
#     "file_id": "123456",
#     "target": "U_1_0",
#     "bucket": "xxx",
#     "object": "xxx",
#     "callback": "xxx",
#     "callback_var": "xxx"
# }

if result.get("success"):
    status = result.get("status")
    if status == 2:
        # ç§’ä¼ æˆåŠŸ
        file_id = result.get("file_id")
        print(f"ç§’ä¼ æˆåŠŸï¼Œæ–‡ä»¶ID: {file_id}")
    else:
        # éç§’ä¼ ï¼Œéœ€è¦å®é™…ä¸Šä¼ 
        pick_code = result.get("pick_code")
        bucket = result.get("bucket")
        object_id = result.get("object")
        # ä½¿ç”¨OSS SDKä¸Šä¼ æ–‡ä»¶
```

### 3. äºŒæ¬¡è®¤è¯å¤„ç†

```python
# æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
result = await api.init_upload(
    file_name="file.mkv",
    file_size=file_size,
    target_parent_id="0",
    file_sha1=file_sha1,
    pre_sha1=pre_sha1
)

# æ£€æŸ¥æ˜¯å¦éœ€è¦äºŒæ¬¡è®¤è¯
if not result.get("success"):
    error_code = result.get("code")
    
    if error_code == 700:  # ç­¾åè®¤è¯åå¤±è´¥
        # status = 6
        sign_key = result.get("sign_key")
        sign_check = result.get("sign_check")
        
        # æ ¹æ®sign_checkè®¡ç®—sha1ï¼ˆç”¨ä¸‹åˆ’çº¿éš”å¼€ï¼Œæˆªå–ä¸Šä¼ æ–‡ä»¶å†…å®¹çš„sha1ï¼‰
        # å•ä½æ˜¯byte
        # ç„¶åä½¿ç”¨sign_keyè¿›è¡Œç¬¬äºŒæ¬¡éªŒè¯
        
    elif error_code == 701:  # éœ€è¦è®¤è¯ç­¾å
        # status = 7
        sign_check = result.get("sign_check")  # ä¾‹å¦‚: "2392148-2392298"
        sign_key = result.get("sign_key")
        
        # è§£æsign_checkï¼Œè·å–å­—èŠ‚èŒƒå›´
        start_byte, end_byte = map(int, sign_check.split("-"))
        
        # è¯»å–æ–‡ä»¶æŒ‡å®šèŒƒå›´çš„å†…å®¹
        with open(file_path, 'rb') as f:
            f.seek(start_byte)
            chunk = f.read(end_byte - start_byte + 1)  # åŒ…å«start_byteå’Œend_byte
        
        # è®¡ç®—sha1å€¼ï¼ˆå¤§å†™ï¼‰
        chunk_sha1 = hashlib.sha1(chunk).hexdigest().upper()
        
        # ç¬¬äºŒæ¬¡ä¸Šä¼ åˆå§‹åŒ–ï¼Œæä¾›sign_val
        result = await api.init_upload(
            file_name="file.mkv",
            file_size=file_size,
            target_parent_id="0",
            file_sha1=file_sha1,
            pre_sha1=pre_sha1,
            sign_key=sign_key,
            sign_val=chunk_sha1  # å¤§å†™sha1å€¼
        )
        
    elif error_code == 702:  # ç­¾åè®¤è¯å¤±è´¥
        # status = 8
        # ä¾‹å¦‚:è·å–0-99å­—èŠ‚(åŒ…å«0å’Œ99)å…±100ä¸ªå­—èŠ‚
        # å¤„ç†ç­¾åè®¤è¯å¤±è´¥çš„æƒ…å†µ
        pass
```

### 4. å®Œæ•´ä¸Šä¼ æµç¨‹

```python
async def upload_file_to_115(
    api: Cloud115API,
    file_path: str,
    target_parent_id: str = "0"
):
    """å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ æµç¨‹"""
    import os
    import hashlib
    
    # 1. è®¡ç®—æ–‡ä»¶sha1å€¼
    file_size = os.path.getsize(file_path)
    file_name = os.path.basename(file_path)
    
    # è®¡ç®—å®Œæ•´æ–‡ä»¶sha1
    file_sha1 = calculate_sha1(file_path)
    
    # è®¡ç®—å‰128K sha1
    pre_sha1 = calculate_pre_sha1(file_path)
    
    # 2. æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–
    result = await api.init_upload(
        file_name=file_name,
        file_size=file_size,
        target_parent_id=target_parent_id,
        file_sha1=file_sha1,
        pre_sha1=pre_sha1
    )
    
    # 3. æ£€æŸ¥ç»“æœ
    if not result.get("success"):
        error_code = result.get("code")
        
        # å¤„ç†äºŒæ¬¡è®¤è¯
        if error_code == 701:
            sign_check = result.get("sign_check")
            sign_key = result.get("sign_key")
            
            # è§£æå­—èŠ‚èŒƒå›´
            start_byte, end_byte = map(int, sign_check.split("-"))
            
            # è¯»å–å¹¶è®¡ç®—sha1
            with open(file_path, 'rb') as f:
                f.seek(start_byte)
                chunk = f.read(end_byte - start_byte + 1)
            
            chunk_sha1 = hashlib.sha1(chunk).hexdigest().upper()
            
            # ç¬¬äºŒæ¬¡åˆå§‹åŒ–
            result = await api.init_upload(
                file_name=file_name,
                file_size=file_size,
                target_parent_id=target_parent_id,
                file_sha1=file_sha1,
                pre_sha1=pre_sha1,
                sign_key=sign_key,
                sign_val=chunk_sha1
            )
    
    # 4. å¤„ç†ä¸Šä¼ ç»“æœ
    if result.get("success"):
        status = result.get("status")
        
        if status == 2:
            # ç§’ä¼ æˆåŠŸ
            file_id = result.get("file_id")
            return {"success": True, "file_id": file_id, "method": "instant"}
        else:
            # éç§’ä¼ ï¼Œéœ€è¦å®é™…ä¸Šä¼ 
            pick_code = result.get("pick_code")
            bucket = result.get("bucket")
            object_id = result.get("object")
            
            # è·å–ä¸Šä¼ å‡­è¯
            token_result = await api.get_upload_token()
            if token_result.get("success"):
                # ä½¿ç”¨OSS SDKä¸Šä¼ æ–‡ä»¶
                # è¿™é‡Œéœ€è¦é›†æˆOSS SDKè¿›è¡Œå®é™…ä¸Šä¼ 
                return {"success": True, "pick_code": pick_code, "method": "upload"}
    
    return {"success": False, "error": result.get("error")}
```

## ğŸ“Š å‚æ•°å¯¹ç…§è¡¨

### è·å–ä¸Šä¼ å‡­è¯API

| å®˜æ–¹æ–‡æ¡£å­—æ®µ | å½“å‰å®ç°å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-------------|-------------|------|------|
| endpoint | endpoint | string | ä¸Šä¼ åŸŸå |
| AccessKeyId | access_key_id | string | ä¸Šä¼ å‡­è¯-ID |
| AccessKeySecrett | access_key_secret | string | ä¸Šä¼ å‡­è¯-å¯†é’¥ï¼ˆæ³¨æ„æœ‰ä¸¤ä¸ªtï¼‰ |
| SecurityToken | security_token | string | ä¸Šä¼ å‡­è¯-token |
| Expiration | expiration | string | ä¸Šä¼ å‡­è¯-è¿‡æœŸæ—¥æœŸ |

### æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–API

| å®˜æ–¹æ–‡æ¡£å‚æ•° | å½“å‰å®ç°å‚æ•° | ç±»å‹ | è¯´æ˜ |
|-------------|-------------|------|------|
| file_name | file_name | string | æ–‡ä»¶å |
| file_size | file_size | int | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| target | target | string | æ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®šï¼ˆè‡ªåŠ¨æ„å»ºU_1_{parent_id}ï¼‰ |
| fileid | file_sha1 | string | æ–‡ä»¶sha1å€¼ |
| preid | pre_sha1 | string | æ–‡ä»¶å‰128K sha1ï¼ˆå¯é€‰ï¼‰ |
| pick_code | pick_code | string | ä¸Šä¼ ä»»åŠ¡keyï¼ˆå¯é€‰ï¼‰ |
| topupload | topupload | int | ä¸Šä¼ è°ƒåº¦æ–‡ä»¶ç±»å‹è°ƒåº¦æ ‡è®°ï¼ˆå¯é€‰ï¼‰ |
| sign_key | sign_key | string | äºŒæ¬¡è®¤è¯éœ€è¦ï¼ˆå¯é€‰ï¼‰ |
| sign_val | sign_val | string | äºŒæ¬¡è®¤è¯éœ€è¦ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™ï¼‰ |

### æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–è¿”å›æ•°æ®

| å®˜æ–¹æ–‡æ¡£å­—æ®µ | å½“å‰å®ç°å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-------------|-------------|------|------|
| pick_code | pick_code | string | ä¸Šä¼ ä»»åŠ¡å”¯ä¸€ID |
| status | status | number | ä¸Šä¼ çŠ¶æ€ï¼ˆ1:éç§’ä¼ ; 2:ç§’ä¼ ï¼‰ |
| file_id | file_id | string | ç§’ä¼ æˆåŠŸè¿”å›çš„æ–‡ä»¶ID |
| target | target | string | æ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®š |
| bucket | bucket | string | ä¸Šä¼ çš„bucket |
| object | object | string | OSS objectID |
| callback | callback | string | ä¸Šä¼ å®Œå›è°ƒä¿¡æ¯ |
| callback_var | callback_var | string | ä¸Šä¼ å®Œå›è°ƒå‚æ•° |
| sign_key | sign_key | string | æœ¬æ¬¡è®¡ç®—çš„sha1æ ‡è¯†ï¼ˆäºŒæ¬¡è®¤è¯ï¼‰ |
| sign_check | sign_check | string | æœ¬æ¬¡è®¡ç®—æœ¬åœ°æ–‡ä»¶sha1åŒºé—´èŒƒå›´ï¼ˆäºŒæ¬¡è®¤è¯ï¼‰ |

### æ–­ç‚¹ç»­ä¼ è¿”å›æ•°æ®

| å®˜æ–¹æ–‡æ¡£å­—æ®µ | å½“å‰å®ç°å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-------------|-------------|------|------|
| pick_code | pick_code | string | ä¸Šä¼ ä»»åŠ¡å”¯ä¸€IDï¼Œç”¨äºç»­ä¼  |
| target | target | string | æ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®š |
| version | version | string | æ¥å£ç‰ˆæœ¬ |
| bucket | bucket | string | ä¸Šä¼ çš„bucket |
| object | object | string | OSS objectID |
| callback | callback | string | ä¸Šä¼ å®Œå›è°ƒä¿¡æ¯ |
| callback_var | callback_var | string | ä¸Šä¼ å®Œå›è°ƒå‚æ•° |

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. ä¸Šä¼ å‡­è¯è·å–

1. âœ… **å­—æ®µæ˜ å°„**: æ­£ç¡®æ˜ å°„æ‰€æœ‰è¿”å›å­—æ®µ
2. âœ… **å­—æ®µåå¤„ç†**: æ³¨æ„`AccessKeySecrett`å­—æ®µåæœ‰ä¸¤ä¸ªt
3. âœ… **æ•°æ®è§£æ**: æ­£ç¡®å¤„ç†dataæ•°ç»„

### 2. æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–

1. âœ… **targetæ ¼å¼**: è‡ªåŠ¨æ„å»º`U_1_{parent_id}`æ ¼å¼
2. âœ… **sha1è®¡ç®—**: æ”¯æŒæ–‡ä»¶sha1å’Œå‰128K sha1
3. âœ… **ç§’ä¼ æ”¯æŒ**: æ”¯æŒç§’ä¼ ï¼ˆstatus=2æ—¶è¿”å›file_idï¼‰
4. âœ… **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒpick_codeå‚æ•°ç”¨äºç»­ä¼ 

### 3. äºŒæ¬¡è®¤è¯

1. âœ… **é”™è¯¯ç è¯†åˆ«**: è¯†åˆ«äºŒæ¬¡è®¤è¯ç›¸å…³çš„é”™è¯¯ç ï¼ˆ700, 701, 702ï¼‰
2. âœ… **signä¿¡æ¯**: è¿”å›sign_keyå’Œsign_checkç”¨äºäºŒæ¬¡è®¤è¯
3. âœ… **sign_valå¤„ç†**: è‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™
4. âœ… **å­—èŠ‚èŒƒå›´è§£æ**: æ”¯æŒè§£æsign_checkä¸­çš„å­—èŠ‚èŒƒå›´

### 4. é”™è¯¯å¤„ç†

1. âœ… **HTTPé”™è¯¯**: æ·»åŠ äº†HTTPé”™è¯¯å¤„ç†ï¼ˆ401æœªæˆæƒï¼‰
2. âœ… **APIé”™è¯¯**: æ·»åŠ äº†APIé”™è¯¯å¤„ç†
3. âœ… **äºŒæ¬¡è®¤è¯é”™è¯¯**: ç‰¹æ®Šå¤„ç†äºŒæ¬¡è®¤è¯ç›¸å…³çš„é”™è¯¯ç 

## ğŸ” äºŒæ¬¡è®¤è¯æµç¨‹

### é”™è¯¯ç 700ï¼ˆstatus=6ï¼‰

1. **è¯´æ˜**: ç­¾åè®¤è¯åå¤±è´¥
2. **åç»­å¤„ç†**: sign_check (ç”¨ä¸‹åˆ’çº¿éš”å¼€,æˆªå–ä¸Šä¼ æ–‡å†…å®¹çš„sha1) (å•ä½æ˜¯byte)
3. **ç¬¬äºŒæ¬¡éªŒè¯**: sign_key

### é”™è¯¯ç 701ï¼ˆstatus=7ï¼‰

1. **è¯´æ˜**: éœ€è¦è®¤è¯ç­¾å
2. **åç»­å¤„ç†**: 
   - sign_check: "2392148-2392298"
   - å–2392148-2392298ä¹‹é—´çš„å†…å®¹(åŒ…å«2392148ã€2392298)çš„sha1
3. **ç¬¬äºŒæ¬¡éªŒè¯**: sign_val (æ ¹æ®sign_checkè®¡ç®—çš„å€¼å¤§å†™çš„sha1å€¼)

### é”™è¯¯ç 702ï¼ˆstatus=8ï¼‰

1. **è¯´æ˜**: ç­¾åè®¤è¯å¤±è´¥
2. **åç»­å¤„ç†**: ä¾‹å¦‚:è·å–0-99å­—èŠ‚(åŒ…å«0å’Œ99)å…±100ä¸ªå­—èŠ‚

## âœ… ç»“è®º

å½“å‰å®ç°**å®Œå…¨ç¬¦åˆ**å®˜æ–¹æ–‡æ¡£è§„èŒƒï¼š

1. âœ… **è·å–ä¸Šä¼ å‡­è¯API**: å®Œå…¨ç¬¦åˆï¼Œæ­£ç¡®æ˜ å°„æ‰€æœ‰å­—æ®µ
2. âœ… **æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–API**: å®Œå…¨ç¬¦åˆï¼Œæ”¯æŒæ‰€æœ‰å‚æ•°å’Œè¿”å›å­—æ®µ
3. âœ… **æ–­ç‚¹ç»­ä¼ API**: å®Œå…¨ç¬¦åˆï¼Œæ”¯æŒç»­ä¼ è°ƒåº¦æ¥å£
4. âœ… **äºŒæ¬¡è®¤è¯**: æ”¯æŒäºŒæ¬¡è®¤è¯æµç¨‹å’Œé”™è¯¯å¤„ç†
5. âœ… **ç§’ä¼ æ”¯æŒ**: æ”¯æŒç§’ä¼ åŠŸèƒ½
6. âœ… **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½

**æ€»ä½“è¯„ä»·**: âœ… **å®ç°å®Œæ•´ï¼Œå®Œå…¨ç¬¦åˆå®˜æ–¹æ–‡æ¡£è§„èŒƒ**

### 3. æ–­ç‚¹ç»­ä¼ API âœ…

**ç«¯ç‚¹**: `POST åŸŸå+/open/upload/resume`

**è¯´æ˜**: æ–­ç‚¹ç»­ä¼ ä¸Šä¼ ç»­ä¼ è°ƒåº¦æ¥å£

#### è¯·æ±‚å‚æ•°

**Headers**:
- `Authorization: Bearer access_token`ï¼ˆå¿…å¡«ï¼‰

**Body (form-data)**:
- `file_size`: æ–‡ä»¶å¤§å°(å­—èŠ‚)ï¼ˆå¿…å¡«ï¼‰
- `target`: æ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®šï¼ˆå¿…å¡«ï¼Œæ ¼å¼: U_1_0ï¼‰
- `fileid`: æ–‡ä»¶sha1å€¼ï¼ˆå¿…å¡«ï¼‰
- `pick_code`: ä¸Šä¼ ä»»åŠ¡keyï¼ˆå¿…å¡«ï¼Œéç§’ä¼ çš„è°ƒåº¦æ¥å£è¿”å›çš„pick_codeå­—æ®µï¼‰

#### è¿”å›æ•°æ®

- `state`: booleanï¼ˆçŠ¶æ€; true:æ­£å¸¸; false:é”™è¯¯ï¼‰
- `message`: stringï¼ˆå¼‚å¸¸ä¿¡æ¯ï¼‰
- `code`: numberï¼ˆå¼‚å¸¸ç ï¼‰
- `data`: object[]ï¼ˆæ•°æ®æ•°ç»„ï¼‰
  - `pick_code`: stringï¼ˆä¸Šä¼ ä»»åŠ¡å”¯ä¸€IDï¼Œç”¨äºç»­ä¼ ï¼‰
  - `target`: stringï¼ˆæ–‡ä»¶ä¸Šä¼ ç›®æ ‡çº¦å®šï¼‰
  - `version`: stringï¼ˆæ¥å£ç‰ˆæœ¬ï¼‰
  - `bucket`: stringï¼ˆä¸Šä¼ çš„bucketï¼‰
  - `object`: stringï¼ˆOSS objectIDï¼‰
  - `callback`: object[]ï¼ˆä¸Šä¼ æ—¶é—´ï¼‰
    - `callback`: stringï¼ˆä¸Šä¼ å®Œå›è°ƒä¿¡æ¯ï¼‰
    - `callback_var`: stringï¼ˆä¸Šä¼ å®Œå›è°ƒå‚æ•°ï¼‰

## âœ… å½“å‰å®ç°å¯¹ç…§

### 3. æ–­ç‚¹ç»­ä¼ API âœ…

#### å®ç°æ£€æŸ¥

- **APIç«¯ç‚¹**: âœ… æ­£ç¡® (`POST /open/upload/resume`)
- **è¯·æ±‚å¤´**: âœ… æ­£ç¡® (`Authorization: Bearer access_token`)
- **è¯·æ±‚å‚æ•°**: âœ… æ­£ç¡®
  - `file_size`: âœ… æ”¯æŒ
  - `target`: âœ… æ”¯æŒï¼ˆè‡ªåŠ¨æ„å»ºU_1_{parent_id}æ ¼å¼ï¼‰
  - `fileid`: âœ… æ”¯æŒï¼ˆfile_sha1å‚æ•°ï¼‰
  - `pick_code`: âœ… æ”¯æŒï¼ˆå¿…å¡«ï¼‰
- **è¿”å›æ•°æ®**: âœ… æ­£ç¡®
  - `pick_code`: âœ… æ”¯æŒ
  - `target`: âœ… æ”¯æŒ
  - `version`: âœ… æ”¯æŒ
  - `bucket`: âœ… æ”¯æŒ
  - `object`: âœ… æ”¯æŒ
  - `callback`: âœ… æ”¯æŒ
  - `callback_var`: âœ… æ”¯æŒ

#### æ”¹è¿›ç‚¹

1. âœ… **targetæ ¼å¼**: è‡ªåŠ¨æ„å»º`U_1_{parent_id}`æ ¼å¼
2. âœ… **pick_code**: æ”¯æŒä»åˆå§‹åŒ–æ¥å£è·å–çš„pick_code
3. âœ… **å›è°ƒä¿¡æ¯**: æ­£ç¡®è§£æcallbackæ•°ç»„

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 3. æ–­ç‚¹ç»­ä¼ 

```python
# ç¬¬ä¸€æ¬¡ä¸Šä¼ åˆå§‹åŒ–
init_result = await api.init_upload(
    file_name="file.mkv",
    file_size=file_size,
    target_parent_id="0",
    file_sha1=file_sha1,
    pre_sha1=pre_sha1
)

if init_result.get("success"):
    status = init_result.get("status")
    
    if status == 1:  # éç§’ä¼ 
        pick_code = init_result.get("pick_code")
        
        # å¦‚æœä¸Šä¼ ä¸­æ–­ï¼Œä½¿ç”¨æ–­ç‚¹ç»­ä¼ 
        resume_result = await api.resume_upload(
            file_size=file_size,
            target_parent_id="0",
            file_sha1=file_sha1,
            pick_code=pick_code
        )
        
        if resume_result.get("success"):
            # è·å–ç»­ä¼ ä¿¡æ¯
            bucket = resume_result.get("bucket")
            object_id = resume_result.get("object")
            version = resume_result.get("version")
            
            # ä½¿ç”¨OSS SDKç»§ç»­ä¸Šä¼ 
            # è¿™é‡Œéœ€è¦é›†æˆOSS SDKè¿›è¡Œå®é™…ä¸Šä¼ 
```

## âœ… OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½

### å·²å®ç°åŠŸèƒ½

1. âœ… **OSSæ–‡ä»¶ä¸Šä¼ **
   - âœ… é›†æˆOSS SDKï¼ˆoss2åº“ï¼‰è¿›è¡Œå®é™…ä¸Šä¼ 
   - âœ… æ”¯æŒåˆ†ç‰‡ä¸Šä¼ ï¼ˆé»˜è®¤10MBåˆ†ç‰‡ï¼‰
   - âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ 
   - âœ… æ”¯æŒè¿›åº¦å›è°ƒ
   - âœ… æ”¯æŒä¸Šä¼ å®Œæˆå›è°ƒ

2. âœ… **ä¸Šä¼ è¿›åº¦è·Ÿè¸ª**
   - âœ… å®æ—¶ä¸Šä¼ è¿›åº¦
   - âœ… ä¸Šä¼ çŠ¶æ€ç›‘æ§
   - âœ… è¿›åº¦å›è°ƒæ”¯æŒ

3. âœ… **ä¸Šä¼ å›è°ƒå¤„ç†**
   - âœ… æ”¯æŒä¸Šä¼ å®Œæˆå›è°ƒURL
   - âœ… æ”¯æŒä¸Šä¼ å®Œæˆå›è°ƒå‚æ•°
   - âœ… Base64ç¼–ç å›è°ƒå‚æ•°

è¯¦ç»†å®ç°è¯·å‚è€ƒï¼š[115ç½‘ç›˜OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ€»ç»“](./115ç½‘ç›˜OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ€»ç»“.md)

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£](https://www.yuque.com/115yun/open/qur839kyx9cgxpxi)
- [æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§](./115ç½‘ç›˜æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§.md)
- [æ–‡ä»¶æ“ä½œAPIå®˜æ–¹æ–‡æ¡£å¯¹ç…§](./115ç½‘ç›˜æ–‡ä»¶æ“ä½œAPIå®˜æ–¹æ–‡æ¡£å¯¹ç…§.md)
- [APIå®¢æˆ·ç«¯ä½¿ç”¨](./115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£é›†æˆå®Œæˆæ€»ç»“.md)

