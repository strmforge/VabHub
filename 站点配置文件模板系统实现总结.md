# 站点配置文件模板系统实现总结

**实现时间**: 2025-01-XX  
**阶段**: 方案C - 混合方案第二阶段  
**参考**: vabhub_resources_templates/resources/site-profiles/_template.yml

---

## 📋 一、实现内容

### ✅ 1. YAML配置文件解析器

**文件**: `backend/app/modules/site_profile/loader.py`

**功能**:
- 从 `resources/site-profiles/` 目录加载YAML配置文件
- 支持缓存机制
- 根据域名查找匹配的配置文件
- 列出所有可用的配置文件

**核心方法**:
- `load_profile(profile_id)`: 加载指定配置文件
- `list_profiles()`: 列出所有配置文件
- `find_profile_by_domain(domain)`: 根据域名查找配置文件

---

### ✅ 2. 站点验证规则引擎

**文件**: `backend/app/modules/site_profile/verifier.py`

**功能**:
- 根据verify规则验证站点类型
- 支持多种验证规则
- 支持any/all逻辑组合

**支持的验证规则**:
- `meta_generator_equals`: 检查meta generator标签
- `title_contains`: 检查标题包含
- `url_contains`: 检查URL包含
- `selector_exists`: 检查CSS选择器是否存在
- `text_contains`: 检查文本包含
- `regex_match`: 正则表达式匹配

**逻辑组合**:
- `any`: 任意一个规则通过即可
- `all`: 所有规则都必须通过

---

### ✅ 3. 站点解析规则引擎

**文件**: `backend/app/modules/site_profile/parser.py`

**功能**:
- 根据parse规则解析站点内容
- 支持列表、详情、用户信息解析
- 支持数据转换（size, int, float, date）

**支持的解析类型**:
- `list`: 列表解析（种子列表等）
- `detail`: 详情解析（种子详情等）
- `user`: 用户信息解析

**字段配置**:
- `selector`: CSS选择器
- `text`: 是否提取文本
- `attr`: 提取属性
- `transform`: 数据转换（size/int/float/date）

---

### ✅ 4. 站点配置文件服务

**文件**: `backend/app/modules/site_profile/service.py`

**功能**:
- 整合配置文件加载、验证和解析
- 站点自动识别
- 站点内容解析
- 获取站点类型（family）

**核心方法**:
- `identify_site(site)`: 识别站点类型
- `parse_site_content(site, parse_type, page_url)`: 解析站点内容
- `get_site_family(site)`: 获取站点类型

---

### ✅ 5. API端点

**文件**: `backend/app/api/site_profile.py`

**端点**:
1. `POST /api/v1/sites/{site_id}/profile/identify` - 识别站点类型
2. `POST /api/v1/sites/{site_id}/profile/parse` - 解析站点内容
3. `GET /api/v1/sites/{site_id}/profile/family` - 获取站点类型
4. `GET /api/v1/sites/{site_id}/profile/profiles` - 列出所有配置文件

---

### ✅ 6. 配置文件模板

**文件**: `resources/site-profiles/_template.yml`

**内容**:
- meta信息（id, name, family, version, domains）
- verify规则（站点验证）
- parse规则（列表、详情、用户信息解析）

---

## 📋 二、工作流程

### 2.1 站点识别流程

```
用户添加站点
    ↓
站点服务调用 identify_site()
    ↓
配置文件加载器查找匹配的配置文件
    ├─ 1. 根据域名查找
    └─ 2. 遍历所有配置文件验证
    ↓
验证规则引擎验证站点
    ↓
返回匹配的配置文件
```

### 2.2 站点解析流程

```
用户请求解析站点内容
    ↓
站点服务调用 parse_site_content()
    ↓
获取站点配置文件
    ↓
解析规则引擎解析内容
    ├─ list: 解析列表
    ├─ detail: 解析详情
    └─ user: 解析用户信息
    ↓
返回解析结果
```

---

## 📋 三、配置文件格式

### 3.1 基本结构

```yaml
meta:
  id: site_id          # 配置文件ID
  name: 站点名称       # 站点显示名称
  family: nexusphp     # 站点类型
  version: 1.0.0       # 版本号
  domains:             # 域名列表
    - "https://example.com"

verify:                # 验证规则
  any:                 # 任意一个规则通过
    - meta_generator_equals: "NexusPHP"
    - title_contains: "NexusPHP"

parse:                 # 解析规则
  list:                # 列表解析
    row: "table.torrents > tbody > tr"
    fields:
      title_raw:
        selector: "a[href*='details.php?id=']"
        text: true
```

---

## 📋 四、使用示例

### 4.1 识别站点

```python
from app.modules.site_profile.service import SiteProfileService

profile_service = SiteProfileService()
profile = await profile_service.identify_site(site)

if profile:
    family = profile.get("meta", {}).get("family")
    print(f"站点类型: {family}")
```

### 4.2 解析站点内容

```python
# 解析种子列表
result = await profile_service.parse_site_content(
    site,
    parse_type="list",
    page_url="https://example.com/browse.php"
)

# 解析用户信息
user_info = await profile_service.parse_site_content(
    site,
    parse_type="user"
)
```

---

## 📋 五、技术特点

### 5.1 优势

1. **灵活配置**: YAML配置文件，易于维护和扩展
2. **自动识别**: 根据验证规则自动识别站点类型
3. **规则引擎**: 支持多种验证和解析规则
4. **数据转换**: 自动转换数据类型（大小、数字等）
5. **缓存机制**: 配置文件缓存，提高性能

### 5.2 扩展性

- **新增站点类型**: 只需添加新的YAML配置文件
- **自定义规则**: 支持自定义验证和解析规则
- **数据转换**: 支持自定义数据转换函数

---

## 📋 六、与参考包的对比

| 功能 | 参考包 | 当前实现 | 状态 |
|------|--------|----------|------|
| YAML配置文件 | ✅ | ✅ | 完全一致 |
| 验证规则引擎 | ✅ | ✅ | 完全一致 |
| 解析规则引擎 | ✅ | ✅ | 完全一致 |
| 站点自动识别 | ✅ | ✅ | 完全一致 |

---

## 📋 七、下一步工作

### 7.1 前端界面（可选）

创建前端配置管理界面：
- 配置文件列表
- 配置文件编辑
- 站点识别测试
- 解析结果预览

### 7.2 集成优化

- 在站点创建/更新时自动识别
- 在站点访问时自动使用配置文件
- 缓存识别结果

---

**文档生成时间**: 2025-01-XX  
**实现状态**: ✅ 核心功能已完成

