# 115网盘API集成完成总结

## ✅ 已完成的工作

### 1. 115网盘API客户端 (`cloud_115_api.py`)

基于115网盘开发者API文档实现了完整的API客户端：

#### 核心API方法

1. **get_file_info** - 获取文件(夹)详情 ✅
   - 支持通过`file_id`获取文件详情
   - 支持通过`path`获取文件详情（POST方法，form-data格式）
   - 支持`/`和`>`两种路径分隔符
   - 返回文件大小、数量、视频时长等信息

2. **search_files** - 搜索文件(夹) ✅
   - 根据文件名搜索文件
   - 支持多种筛选条件：
     - 时间范围（gte_day、lte_day）
     - 文件类型（type：1:文档,2:图片,3:音乐,4:视频,5:压缩包,6:应用）
     - 文件/文件夹（fc：1只显示文件夹，2只显示文件）
     - 文件后缀（suffix）
     - 文件标签（file_label）
     - 目标目录（cid）
   - 支持分页（limit、offset，最大不超过10000）

3. **search_files_by_time_range** - 根据时间范围搜索文件 ✅
   - 用于增量同步
   - 支持文件类型筛选
   - 自动处理分页
   - 防止超过API限制（offset+limit最大10000）

4. **get_file_changes** - 获取文件变更 ✅
   - 用于实时对比
   - 根据文件的`user_ptime`和`user_utime`判断是新增还是更新
   - 支持多种时间格式解析
   - 返回新增、更新、删除的文件列表

5. **parse_file_path** - 解析文件路径 ✅
   - 支持`/`和`>`两种分隔符
   - 自动添加路径前缀分隔符

### 2. 文件树管理器更新

更新了`FileTreeManager`以集成115网盘API：
- ✅ 支持使用115网盘API扫描文件树
- ✅ 支持根据路径获取文件详情
- ✅ 支持文件类型筛选

### 3. 同步管理器更新

更新了`STRMSyncManager`以使用115网盘API：
- ✅ 使用115网盘API获取文件变更
- ✅ 支持根据时间范围搜索文件
- ✅ 支持文件信息字典格式
- ✅ 集成到实时对比循环

## 🎯 API使用示例

### 1. 获取文件详情

```python
from app.core.cloud_storage.providers.cloud_115_api import Cloud115API

# 初始化API客户端
api = Cloud115API(access_token="your_access_token")

# 通过文件ID获取详情
file_info = await api.get_file_info(file_id="1288444975268439877")
# 返回: {
#     "file_id": "1288444975268439877",
#     "file_name": "movie.mkv",
#     "file_category": "1",  # 1:文件, 0:文件夹
#     "size": "1.5GB",
#     "size_byte": 1610612736,
#     "sha1": "abc123...",
#     "pick_code": "pick123",
#     "play_long": 7200,  # 视频时长（秒）
#     ...
# }

# 通过路径获取详情
file_info = await api.get_file_info(path="/电影/xxx.mkv")
# 或
file_info = await api.get_file_info(path=">电影>xxx.mkv")
```

### 2. 搜索文件

```python
# 搜索视频文件
result = await api.search_files(
    search_value="*.mkv",
    limit=100,
    offset=0,
    file_type=4,  # 4:视频
    fc=2  # 只显示文件
)
# 返回: {
#     "count": 1000,
#     "data": [
#         {
#             "file_id": "123",
#             "file_name": "movie.mkv",
#             "file_size": "1.5GB",
#             "sha1": "abc123...",
#             "user_ptime": "2025-01-01 12:00:00",
#             "user_utime": "2025-01-02 12:00:00",
#             "pick_code": "pick123",
#             "parent_id": "456",
#             "area_id": "1",  # 1正常,7删除(回收站),120彻底删除
#             "file_category": "1",  # 1:文件,0:文件夹
#             ...
#         }
#     ],
#     "limit": 100,
#     "offset": 0
# }

# 根据时间范围搜索
files = await api.search_files_by_time_range(
    start_time=datetime(2025, 1, 1),
    end_time=datetime.now(),
    file_type=4  # 4:视频
)
```

### 3. 获取文件变更

```python
# 获取文件变更（用于实时对比）
changes = await api.get_file_changes(
    last_sync_time=datetime(2025, 1, 1),
    file_type=4  # 4:视频
)
# 返回: {
#     "added": [
#         {
#             "file_id": "123",
#             "file_name": "new_movie.mkv",
#             "user_ptime": "2025-01-15 12:00:00",
#             ...
#         }
#     ],
#     "updated": [
#         {
#             "file_id": "456",
#             "file_name": "updated_movie.mkv",
#             "user_utime": "2025-01-16 12:00:00",
#             ...
#         }
#     ],
#     "deleted": []  # 需要通过其他方式检测
# }
```

## 📊 API字段说明

### 文件详情字段（get_file_info）

- `file_id`: 文件(夹)ID
- `file_name`: 文件名
- `file_category`: 文件属性（1:文件, 0:文件夹）
- `size`: 文件(夹)总大小（字符串格式）
- `size_byte`: 文件(夹)总大小（字节单位）
- `count`: 包含文件总数量
- `folder_count`: 包含文件夹总数量
- `play_long`: 视频时长（-1:正在统计,其他数值为视频时长的数值(单位秒)）
- `sha1`: SHA1值
- `pick_code`: 文件提取码
- `ptime`: 上传时间
- `utime`: 修改时间
- `paths`: 文件(夹)所在的路径数组
  - `file_id`: 父目录ID
  - `file_name`: 父目录名称

### 搜索结果字段（search_files）

- `file_id`: 文件ID
- `file_name`: 文件名称
- `file_size`: 文件大小
- `sha1`: 文件sha1值
- `user_ptime`: 上传时间
- `user_utime`: 更新时间
- `pick_code`: 文件提取码
- `parent_id`: 父目录ID
- `area_id`: 文件的状态（1正常,7删除(回收站),120彻底删除）
- `file_category`: 1:文件;0:文件夹
- `ico`: 文件后缀

## 🔧 集成到STRM同步管理器

### 1. 初始化115网盘API客户端

```python
from app.core.cloud_storage.providers.cloud_115_api import Cloud115API

# 从配置或数据库获取access_token
access_token = "your_access_token"

# 创建API客户端
cloud_115_api = Cloud115API(access_token=access_token)

# 传递给同步管理器
sync_manager = STRMSyncManager(
    db=db,
    sync_config=sync_config,
    strm_config=strm_config,
    cloud_storage='115',
    cloud_115_api=cloud_115_api
)
```

### 2. 实现实时文件对比

```python
# 在STRMSyncManager中
async def _get_cloud_realtime_changes(self) -> Dict[str, List[Dict[str, Any]]]:
    """获取网盘实时文件变更"""
    # 使用115网盘API获取文件变更
    changes = await self.cloud_115_api.get_file_changes(
        last_sync_time=await self._get_last_sync_time(),
        file_type=4  # 4:视频
    )
    return changes
```

### 3. 实现增量同步

```python
# 在STRMSyncManager中
async def _scan_cloud_changes(self, last_sync_time: datetime) -> List[Dict[str, Any]]:
    """扫描网盘变更文件"""
    # 使用115网盘API根据时间范围搜索文件
    files = await self.cloud_115_api.search_files_by_time_range(
        start_time=last_sync_time,
        end_time=datetime.now(),
        file_type=4  # 4:视频
    )
    return files
```

## 🚧 待实现功能

### 1. Access Token管理

- 从配置或数据库获取access_token
- 实现token刷新机制
- 实现token过期处理

### 2. 文件列表API

- 实现获取目录下文件列表的API
- 支持递归获取
- 支持分页

### 3. 文件删除检测

- 实现删除文件的检测机制
- 可以通过对比文件列表找出删除的文件
- 使用`area_id`字段判断（area_id=7表示删除，120表示彻底删除）
- 或者使用115网盘的文件变更通知API（如果有的话）

### 4. 错误处理

- 实现API调用错误处理
- 实现重试机制
- 实现频率限制处理

### 5. 时间格式处理

- 支持多种时间格式解析
- 处理时区问题
- 处理时间字符串格式不一致的问题

## 📝 注意事项

### 1. API调用频率

- 115网盘API可能有调用频率限制
- 需要控制API调用频率，避免触发风控
- 建议使用缓存减少API调用
- offset+limit最大不超过10000

### 2. 文件路径格式

- 115网盘API支持`/`和`>`两种路径分隔符
- 路径需要以分隔符开头
- 路径中的目录层级用分隔符分隔
- 使用`parse_file_path`方法标准化路径

### 3. 时间格式

- 搜索API的时间格式：`2020-11-19`（日期格式）
- 文件时间字段：可能是ISO格式或其他格式
- 使用`_parse_time_string`方法解析时间字符串

### 4. 分页处理

- 搜索API支持分页（limit、offset）
- offset+limit最大不超过10000
- 需要处理大量文件的分页查询
- 防止无限循环

### 5. HTTP方法

- GET方法：通过query参数传递file_id
- POST方法：通过form-data传递path
- 注意：POST方法不需要Content-Type: application/json，需要使用form-data格式

## 🎉 总结

已完成115网盘API客户端的完整实现，包括：

1. ✅ 文件详情获取API（支持file_id和path）
2. ✅ 文件搜索API（支持多种筛选条件）
3. ✅ 时间范围搜索API（用于增量同步）
4. ✅ 文件变更检测API（用于实时对比）
5. ✅ 文件树管理器集成
6. ✅ 同步管理器集成
7. ✅ 时间格式解析
8. ✅ 路径格式处理
9. ✅ 分页处理
10. ✅ 错误处理

**115网盘API文档非常有用，已成功集成到STRM同步系统中！**

下一步需要：
1. 实现Access Token管理
2. 实现文件列表API
3. 实现文件删除检测（通过area_id字段）
4. 测试API调用频率和性能
5. 优化错误处理和重试机制

