# 资源模板系统功能检查总结

**检查时间**: 2025-01-XX  
**检查范围**: vabhub_resources_templates

---

## 📋 一、参考包内容分析

### 1.1 文件夹结构

```
vabhub_resources_templates/
├── resources/
│   ├── catalog.json              # 资源目录（版本管理）
│   ├── README.md                 # 说明文档
│   ├── site-domains/             # 站点域名配置
│   │   └── mantou.domains.json   # 示例：馒头站点域名
│   ├── site-logos/               # 站点Logo资源
│   │   └── mantou.svg            # 示例：馒头站点Logo
│   └── site-profiles/            # 站点配置文件模板
│       └── _template.yml         # 站点配置模板
```

### 1.2 功能说明

#### ① catalog.json - 资源目录

**功能**: 管理资源版本信息

```json
{
  "profiles": {
    "_template.yml": "1.0.0"
  },
  "domains": {
    "mantou.domains.json": "1.0.0"
  },
  "logos": {
    "mantou.svg": "1.0.0"
  }
}
```

**用途**: 
- 资源版本管理
- 资源更新检查
- 资源目录索引

---

#### ② site-domains/*.json - 站点域名配置

**功能**: 管理站点的多个域名（活跃/废弃）

**示例** (`mantou.domains.json`):
```json
{
  "site_id": "mantou",
  "active": [
    "https://mantou.one",
    "https://mantou.bar"
  ],
  "deprecated": [],
  "updated_at": "2025-11-09T03:34:46.640265Z",
  "sig": "ed25519:demo"
}
```

**用途**:
- 站点多域名管理
- 域名切换（当主域名不可用时）
- 域名废弃标记

---

#### ③ site-logos/*.svg - 站点Logo资源

**功能**: 预设的站点Logo资源

**用途**:
- 站点图标预设资源库
- 与站点图标系统的"预设资源库"对应

---

#### ④ site-profiles/*.yml - 站点配置文件模板

**功能**: 站点识别和解析配置

**示例** (`_template.yml`):
```yaml
meta:
  id: _template
  name: 示例站
  family: nexusphp        # 站点类型（NexusPHP/Gazelle等）
  version: 1.0.0
  domains: ["https://example.test"]

verify:                    # 站点验证规则
  any:
    - meta_generator_equals: "NexusPHP"

parse:                     # 解析规则
  list:
    row: "table.torrents > tbody > tr"
    fields:
      title_raw: { selector: "a[href*='details.php?id=']", text: true }
      size_bytes: { selector: "td.size", text: true, transform: "size" }
```

**用途**:
- 站点自动识别（通过verify规则）
- 站点内容解析（通过parse规则）
- 站点类型分类（family字段）

---

## 📋 二、当前系统实现状态

### ✅ 部分实现

#### 1. 站点域名提取

**实现位置**: `backend/app/modules/site_icon/service.py`

```python
def _extract_domain(self, url: str) -> Optional[str]:
    """从URL提取域名"""
    # 简单实现：提取主域名
```

**差异**:
- ✅ 有域名提取功能
- ❌ 不支持多域名管理（active/deprecated）
- ❌ 不支持域名切换

---

#### 2. 站点Logo资源

**实现位置**: `backend/app/modules/site_icon/service.py`

```python
PRESET_ICONS: Dict[str, str] = {
    # 可以在这里添加预设的站点图标URL或base64
}
```

**差异**:
- ✅ 有预设资源库概念
- ❌ 没有文件系统资源管理（site-logos/目录）
- ❌ 没有资源目录（catalog.json）

---

### ❌ 未实现

#### 1. 站点域名配置管理

**缺失功能**:
- ❌ 多域名配置（active/deprecated）
- ❌ 域名版本管理
- ❌ 域名自动切换
- ❌ 域名配置文件加载

**当前系统**: 只支持单个URL，无法管理多个域名

---

#### 2. 站点配置文件模板（Site Profiles）

**缺失功能**:
- ❌ 站点识别规则（verify）
- ❌ 站点解析规则（parse）
- ❌ 站点类型分类（family）
- ❌ 配置文件模板系统

**当前系统**: 没有站点自动识别和解析规则配置

---

#### 3. 资源目录管理

**缺失功能**:
- ❌ 资源版本管理（catalog.json）
- ❌ 资源更新检查
- ❌ 资源目录索引

---

## 📋 三、功能对比表

| 功能 | 参考包 | 当前系统 | 状态 |
|------|--------|----------|------|
| **站点域名提取** | ✅ | ✅ | 已实现（基础版） |
| **多域名管理** | ✅ (active/deprecated) | ❌ | 未实现 |
| **域名切换** | ✅ | ❌ | 未实现 |
| **站点Logo资源** | ✅ (文件系统) | ⚠️ (代码中) | 部分实现 |
| **资源目录** | ✅ (catalog.json) | ❌ | 未实现 |
| **站点识别规则** | ✅ (verify) | ❌ | 未实现 |
| **站点解析规则** | ✅ (parse) | ❌ | 未实现 |
| **站点类型分类** | ✅ (family) | ❌ | 未实现 |

---

## 📋 四、建议实现方案

### 🔴 高优先级

#### 1. 站点域名配置管理

**实现内容**:
- 创建 `SiteDomainConfig` 模型
- 支持多域名（active/deprecated）
- 域名自动切换逻辑
- 域名配置文件加载

**数据模型**:
```python
class SiteDomainConfig(Base):
    site_id: str  # 站点标识
    active_domains: List[str]  # 活跃域名列表
    deprecated_domains: List[str]  # 废弃域名列表
    updated_at: datetime
```

**使用场景**:
- 当主域名不可用时，自动尝试备用域名
- 标记废弃域名，避免使用

---

#### 2. 站点Logo资源管理

**实现内容**:
- 创建 `resources/site-logos/` 目录结构
- 资源加载服务
- 资源目录（catalog.json）管理
- 与站点图标系统集成

**实现方式**:
```python
# backend/app/modules/site_icon/resource_loader.py
class SiteLogoResourceLoader:
    def __init__(self, resources_dir: str = "resources/site-logos"):
        self.resources_dir = Path(resources_dir)
        self.catalog = self._load_catalog()
    
    def get_logo(self, site_id: str) -> Optional[str]:
        # 从文件系统加载SVG/PNG
        # 返回文件路径或Base64
```

---

### 🟡 中优先级

#### 3. 站点配置文件模板（Site Profiles）

**实现内容**:
- 创建 `SiteProfile` 模型
- 站点识别规则引擎（verify）
- 站点解析规则引擎（parse）
- 配置文件模板加载

**数据模型**:
```python
class SiteProfile(Base):
    site_id: str
    name: str
    family: str  # nexusphp, gazelle, unit3d等
    version: str
    domains: List[str]
    verify_rules: JSON  # 验证规则
    parse_rules: JSON   # 解析规则
```

**使用场景**:
- 自动识别站点类型
- 自动配置解析规则
- 站点模板化管理

---

### 🟢 低优先级

#### 4. 资源目录管理

**实现内容**:
- catalog.json 加载和解析
- 资源版本检查
- 资源更新机制

---

## 📋 五、实现建议

### 方案A: 完整实现（推荐）

**实现顺序**:
1. 站点域名配置管理（多域名支持）
2. 站点Logo资源管理（文件系统）
3. 站点配置文件模板（识别和解析规则）

**优点**: 功能完整，支持站点模板化配置

---

### 方案B: 简化实现

**实现内容**:
1. 站点域名配置管理（多域名支持）
2. 站点Logo资源管理（集成到现有系统）

**优点**: 实现简单，满足基本需求

---

## 📋 六、总结

### ✅ 已实现
- ✅ 站点域名提取（基础版）
- ✅ 站点图标预设资源库（代码中）

### ⚠️ 部分实现
- ⚠️ 站点Logo资源（有概念，无文件系统管理）

### ❌ 未实现
- ❌ 多域名管理（active/deprecated）
- ❌ 域名自动切换
- ❌ 站点配置文件模板（识别/解析规则）
- ❌ 资源目录管理（catalog.json）
- ❌ 站点类型分类（family）

### 🎯 推荐实现

**优先实现**:
1. **站点域名配置管理** - 支持多域名和自动切换
2. **站点Logo资源管理** - 文件系统资源管理

**可选实现**:
3. **站点配置文件模板** - 站点识别和解析规则（高级功能）

---

**文档生成时间**: 2025-01-XX  
**检查状态**: 核心功能部分实现，资源模板系统未实现

