# 站点多域名管理系统实现总结

**实现时间**: 2025-01-XX  
**功能目标**: 解决PT站点更换域名时需要等待版本更新的问题，允许用户自行配置和切换域名

---

## 📋 一、功能概述

### 1.1 核心需求

**问题背景**:
- MoviePilot在PT站点域名改变时需要等版本更新适配
- 用户希望自己可以在系统中更换站点域名，无需等待作者更新版本

**解决方案**:
- 实现站点多域名管理系统
- 支持用户自行添加、切换、管理站点域名
- 自动检测域名可访问性，支持自动切换
- 集成到站点服务中，自动使用最佳域名

---

## 📋 二、实现内容

### 2.1 数据模型

**文件**: `backend/app/models/site_domain.py`

**模型**: `SiteDomainConfig`

**字段**:
- `site_id`: 站点ID（外键，唯一）
- `active_domains`: 活跃域名列表（JSON数组）
- `deprecated_domains`: 废弃域名列表（JSON数组）
- `current_domain`: 当前使用的域名
- `switch_history`: 域名切换历史（JSON数组）
- `auto_detect`: 自动检测开关（1-启用，0-禁用）
- `last_detect_time`: 最后检测时间

**方法**:
- `get_active_domains()`: 获取活跃域名列表
- `get_deprecated_domains()`: 获取废弃域名列表
- `get_current_domain()`: 获取当前使用的域名
- `add_active_domain()`: 添加活跃域名
- `remove_active_domain()`: 移除活跃域名（移动到废弃列表）
- `switch_to_domain()`: 切换到指定域名

---

### 2.2 服务层

**文件**: `backend/app/modules/site_domain/service.py`

**服务类**: `SiteDomainService`

**核心方法**:

1. **`get_or_create_domain_config(site_id)`**
   - 获取或创建站点域名配置
   - 如果不存在，从站点URL提取初始域名

2. **`update_domain_config(site_id, ...)`**
   - 更新站点域名配置
   - 支持更新活跃域名、废弃域名、当前域名、自动检测开关

3. **`add_domain(site_id, domain, is_active)`**
   - 添加域名到活跃或废弃列表
   - 自动规范化域名（确保包含协议）

4. **`remove_domain(site_id, domain)`**
   - 移除活跃域名（移动到废弃列表）
   - 如果移除的是当前域名，自动切换到第一个活跃域名

5. **`switch_domain(site_id, domain, reason)`**
   - 切换到指定域名
   - 记录切换历史

6. **`detect_and_switch_domain(site_id)`**
   - 自动检测并切换域名
   - 测试所有活跃域名的可访问性
   - 选择第一个可访问的域名

7. **`get_best_domain(site_id)`**
   - 获取最佳域名（当前域名或自动检测）
   - 用于站点服务中自动选择域名

8. **`_test_domain_accessibility(domain)`**
   - 测试域名是否可访问
   - 使用httpx异步请求，超时5秒

---

### 2.3 API端点

**文件**: `backend/app/api/site_domain.py`

**路由前缀**: `/api/v1/sites/{site_id}/domains`

**端点**:

1. **`GET /`** - 获取站点域名配置
2. **`PUT /`** - 更新站点域名配置
3. **`POST /add`** - 添加域名
4. **`DELETE /remove`** - 移除域名（从活跃移到废弃）
5. **`POST /switch`** - 切换到指定域名
6. **`POST /detect`** - 自动检测并切换域名

---

### 2.4 站点服务集成

**文件**: `backend/app/modules/site/service.py`

**集成点**:

1. **`_get_site_url(site)`**
   - 获取站点URL（优先使用域名配置中的最佳域名）
   - 如果配置了域名管理，使用最佳域名；否则使用原始URL

2. **`checkin(site_id)`**
   - 站点签到时使用最佳域名
   - 自动从域名配置中获取可访问的域名

---

### 2.5 前端界面

**组件**:

1. **`SiteDomainDialog.vue`**
   - 站点域名管理对话框
   - 显示当前域名、活跃域名列表、废弃域名列表、切换历史
   - 支持添加、移除、切换、恢复域名
   - 支持自动检测和切换

2. **`SiteCard.vue`**
   - 添加"域名管理"按钮
   - 点击后打开域名管理对话框

3. **`Sites.vue`**
   - 集成域名管理对话框
   - 处理域名管理事件

---

## 📋 三、使用流程

### 3.1 用户操作流程

1. **添加新域名**
   - 点击站点卡片的"域名管理"按钮
   - 点击"添加域名"
   - 输入新域名（如 `https://new-domain.com`）
   - 选择是否添加到活跃域名
   - 点击"添加"

2. **切换域名**
   - 在活跃域名列表中，点击"切换"按钮
   - 系统自动切换到该域名并记录历史

3. **自动检测和切换**
   - 点击"检测并切换"按钮
   - 系统自动测试所有活跃域名的可访问性
   - 自动切换到第一个可访问的域名

4. **移除域名**
   - 在活跃域名列表中，点击"删除"按钮
   - 域名被移动到废弃列表

5. **恢复域名**
   - 在废弃域名列表中，点击"恢复"按钮
   - 域名被恢复到活跃列表

---

### 3.2 自动切换流程

1. **启用自动检测**
   - 在域名管理对话框中，开启"自动检测和切换"开关

2. **自动检测触发**
   - 当站点服务需要访问站点时（如签到）
   - 系统调用 `get_best_domain()`
   - 如果当前域名不可访问，自动检测并切换

3. **检测逻辑**
   - 测试当前域名的可访问性
   - 如果不可访问，测试所有活跃域名
   - 选择第一个可访问的域名
   - 切换到新域名并记录历史

---

## 📋 四、技术特点

### 4.1 优势

1. **用户自主管理**
   - 用户无需等待版本更新
   - 可以自行添加和切换域名

2. **自动检测**
   - 支持自动检测域名可访问性
   - 自动切换到可用域名

3. **历史记录**
   - 记录域名切换历史
   - 方便追踪域名变更

4. **无缝集成**
   - 自动集成到站点服务
   - 站点访问时自动使用最佳域名

5. **向后兼容**
   - 如果未配置域名管理，使用原始URL
   - 不影响现有站点

---

### 4.2 实现细节

1. **域名规范化**
   - 自动添加协议（http/https）
   - 移除末尾斜杠

2. **可访问性测试**
   - 使用httpx异步请求
   - 超时时间5秒
   - 支持重定向

3. **切换历史**
   - 记录切换时间、原因、来源域名、目标域名
   - 只保留最近50条记录

4. **错误处理**
   - 优雅降级：如果域名管理失败，使用原始URL
   - 详细的错误日志

---

## 📋 五、API示例

### 5.1 获取域名配置

```bash
GET /api/v1/sites/1/domains/
```

**响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "site_id": 1,
    "active_domains": [
      "https://example.com",
      "https://example.net"
    ],
    "deprecated_domains": [
      "https://old.example.com"
    ],
    "current_domain": "https://example.com",
    "auto_detect": true,
    "last_detect_time": "2025-01-XXT10:00:00Z",
    "switch_history": [
      {
        "from": "https://old.example.com",
        "to": "https://example.com",
        "reason": "自动检测切换",
        "time": "2025-01-XXT10:00:00Z"
      }
    ]
  }
}
```

### 5.2 添加域名

```bash
POST /api/v1/sites/1/domains/add
Content-Type: application/json

{
  "domain": "https://new.example.com",
  "is_active": true
}
```

### 5.3 切换域名

```bash
POST /api/v1/sites/1/domains/switch?domain=https://example.net&reason=手动切换
```

### 5.4 自动检测

```bash
POST /api/v1/sites/1/domains/detect
```

**响应**:
```json
{
  "success": true,
  "message": "检测完成",
  "data": {
    "switched": true,
    "from": "https://example.com",
    "to": "https://example.net",
    "reason": "自动检测切换",
    "current_domain": "https://example.net"
  }
}
```

---

## 📋 六、数据库迁移

**新增表**: `site_domain_configs`

**字段**:
- `id`: 主键
- `site_id`: 站点ID（外键，唯一）
- `active_domains`: 活跃域名列表（JSON）
- `deprecated_domains`: 废弃域名列表（JSON）
- `current_domain`: 当前使用的域名
- `switch_history`: 切换历史（JSON）
- `auto_detect`: 自动检测开关
- `last_detect_time`: 最后检测时间
- `created_at`: 创建时间
- `updated_at`: 更新时间

**索引**:
- `idx_site_domain_config_site_id`: 站点ID唯一索引

---

## 📋 七、总结

### 7.1 实现成果

✅ **数据模型**: 完成 `SiteDomainConfig` 模型  
✅ **服务层**: 完成 `SiteDomainService` 服务  
✅ **API端点**: 完成6个API端点  
✅ **站点集成**: 集成到站点服务，自动使用最佳域名  
✅ **前端界面**: 完成域名管理对话框和集成  

### 7.2 核心价值

1. **解决用户痛点**: 用户无需等待版本更新即可自行管理域名
2. **提升用户体验**: 自动检测和切换，减少手动操作
3. **系统稳定性**: 域名不可访问时自动切换，提高系统可用性
4. **向后兼容**: 不影响现有站点，平滑升级

### 7.3 后续优化建议

1. **定时任务**: 定期检测所有站点的域名可访问性
2. **通知功能**: 域名切换时发送通知
3. **批量操作**: 支持批量添加、切换域名
4. **域名验证**: 添加域名时验证格式和可访问性
5. **统计功能**: 显示域名使用统计和切换频率

---

**文档生成时间**: 2025-01-XX  
**实现状态**: ✅ 已完成

