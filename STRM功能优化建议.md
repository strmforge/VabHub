# STRM功能优化建议

## 📋 基于用户反馈的优化

### 用户观点

> 当用户设置为本地到网盘时，系统通过用户搜索指定下载或订阅自动下载媒体文件到本地之后开始上传分类重命名等一系列操作，最后通知STRM（如果用户开启了STRM文件功能的话）STRM系统生成一系列文件到本地STRM媒体库，这个流程不就是增量同步了吗？

## ✅ 优化方案

### 1. 自动增量同步功能重新定位

**当前状态**：默认启用（`auto_incremental_sync: true`）

**优化后**：默认禁用（`auto_incremental_sync: false`）

**原因**：
- 如果系统已有完整工作流（下载完成 → 上传到网盘 → 通知STRM → 生成STRM文件），自动增量同步是多余的
- 工作流模式是事件驱动的，更高效，风控风险更低
- 自动增量同步是定时扫描的，需要调用115 API，有风控风险

**适用场景**：
- ✅ 系统没有完整工作流时，启用自动增量同步作为补充
- ❌ 系统已有完整工作流时，禁用自动增量同步

### 2. 定期全量同步功能保留

**原因**：
- ✅ 补全历史文件（系统之前没有STRM功能，现在开启了）
- ✅ 修复缺失的STRM文件（可能被误删）
- ✅ 处理手动上传到网盘的文件（不是通过系统下载的）
- ✅ 检查本地STRM文件是否完整

**优化**：
- 使用"本地缺失检查模式"（不调用115 API，降低风控风险）
- 默认间隔：7天
- 默认启用：`periodic_full_sync: true`

## 📊 功能对比

| 功能 | 工作流模式 | 自动增量同步 | 定期全量同步 |
|------|-----------|-------------|-------------|
| **新文件STRM生成** | ✅ 自动（事件驱动） | ✅ 自动（定时扫描） | ❌ 不支持 |
| **历史文件补全** | ❌ 不支持 | ✅ 支持（首次全量） | ✅ 支持 |
| **修复缺失文件** | ❌ 不支持 | ✅ 支持（定期全量） | ✅ 支持 |
| **手动上传文件** | ❌ 不支持 | ✅ 支持（监测变更） | ✅ 支持 |
| **风控风险** | ⭐⭐⭐⭐⭐（最低） | ⭐⭐⭐（中等） | ⭐⭐⭐⭐⭐（最低） |
| **效率** | ⭐⭐⭐⭐⭐（最高） | ⭐⭐⭐（中等） | ⭐⭐（较低，但安全） |

## 🎯 推荐配置

### 场景1：系统已有完整工作流（推荐）

```json
{
  "auto_incremental_sync": false,  // 禁用（工作流已处理）
  "periodic_full_sync": true,  // 启用（补全历史文件）
  "periodic_full_sync_interval_days": 7,  // 每7天
  "cloud_media_library_path": "/115/电影"
}
```

**工作流**：
1. 搜索/订阅 → 下载 → 上传 → STRM生成（自动，事件驱动）
2. 定期全量同步（每7天，检查本地缺失，补全历史文件）

### 场景2：系统没有完整工作流

```json
{
  "auto_incremental_sync": true,  // 启用（监测网盘变更）
  "periodic_full_sync": true,  // 启用（补全历史文件）
  "periodic_full_sync_interval_days": 7,
  "cloud_media_library_path": "/115/电影"
}
```

**工作流**：
1. 自动增量同步（实时监测网盘变更，生成STRM文件）
2. 定期全量同步（每7天，检查本地缺失，补全历史文件）

## 📝 实施建议

1. **检查系统是否已有完整工作流**
   - 下载完成回调 → 上传到网盘 → 通知STRM → 生成STRM文件

2. **如果已有完整工作流**：
   - ✅ 将 `auto_incremental_sync` 默认值改为 `false`
   - ✅ 更新前端说明文字
   - ✅ 更新文档说明

3. **如果还没有完整工作流**：
   - ⚠️ 保留自动增量同步功能
   - 💡 建议实现完整工作流，然后禁用自动增量同步

## ✨ 优势

1. **降低风控风险**：
   - 工作流模式是事件驱动的，不主动调用115 API
   - 定期全量同步使用本地缺失检查模式，不调用115 API

2. **提高效率**：
   - 工作流模式实时响应，无需定时扫描
   - 定期全量同步只在需要时执行（7天一次）

3. **用户友好**：
   - 默认配置适合大多数场景（假设系统已有完整工作流）
   - 如果系统没有完整工作流，用户可以手动启用自动增量同步

