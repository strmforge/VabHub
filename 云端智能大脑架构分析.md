# VabHub 云端智能大脑架构分析

## 📋 架构概述

根据 `README.md` 和 `architecture.png`，这是一个**全免费云端智能大脑架构**，具有以下特点：

### 核心创新点

1. **完全免费** - 使用免费云服务组合
2. **完全云端** - 所有智能服务在云端
3. **对用户零配置** - 用户只需连接，无需配置
4. **分布式架构** - 多个云服务商组合，避免单点故障

---

## 🏗️ 架构组件

### 1. Cloudflare Edge（统一入口）

**功能**:
- DNS管理
- HTTPS/TLS
- WAF（Web应用防火墙）
- 反代和负载均衡
- CDN加速

**优势**:
- 隐藏后端服务器IP
- 全球边缘节点，低延迟
- 免费额度充足

---

### 2. Mesh Scheduler（任务调度中心）

**子域**: `mesh.vabhub.net`

**后端**: Railway + Supabase/Neon

**功能**:
- 避免多人同时抓取同一PT站点
- 任务分发和调度
- 节点注册和管理
- 租约机制

**API设计**:
```
POST /v1/worker/register  - 节点注册能力
POST /v1/jobs/lease       - 节点领取任务（租约）
POST /v1/jobs/finish      - 回报抓取完成，推进站点指针
```

**数据库**: Supabase/Neon 免费Postgres（存储轻量元数据）

---

### 3. Intel Center（智能大脑）

**子域**: `intel.vabhub.net`

**后端**: Deta.Space

**功能**:
- 别名识别（alias_terms）
- 发布索引（release_index / release_sites）
- 智能推荐
- 轻量API查询

**API设计**:
```
GET /v1/index/{release_key}      - 获取发布索引
GET /v1/rules/latest            - 获取最新规则
GET /v1/alias/search?q=xxx      - 别名搜索
```

---

### 4. Snapshots（静态快照/CDN）

**子域**: `snap.vabhub.net`

**后端**: Cloudflare Pages / R2

**功能**:
- 离线/低带宽环境支持
- 规则包快照
- 索引快照
- 长期缓存

**文件**:
```
alias-latest.json.gz    - 别名快照
index-latest.json.gz    - 索引快照
rules.json              - 规则包
```

**工作流程**:
1. 客户端启动时优先加载快照
2. 根据在线状态增量更新
3. 支持完全离线使用

---

## 🌟 独特优势

### 1. 完全免费架构
- ✅ Railway - 免费额度充足
- ✅ Deta.Space - 完全免费
- ✅ Supabase/Neon - 免费Postgres
- ✅ Cloudflare - 免费CDN和反代

### 2. 分布式设计
- ✅ 不依赖单一云厂商
- ✅ 可迁移、可替换
- ✅ 自动伸缩
- ✅ 高可用性

### 3. 用户零配置
- ✅ 用户只需连接Cloudflare统一入口
- ✅ 所有智能服务自动可用
- ✅ 无需配置后端服务器

### 4. 离线支持
- ✅ 快照机制支持离线使用
- ✅ 增量更新机制
- ✅ 低带宽环境优化

---

## 🆚 与其他平台对比

### MoviePilot
- ❌ 没有分布式任务调度
- ❌ 没有云端智能大脑
- ❌ 没有离线快照机制
- ❌ 用户需要自己配置所有服务

### Plex/Jellyfin/Emby
- ❌ 完全是本地部署
- ❌ 没有云端智能服务
- ❌ 没有分布式架构

### Sonarr/Radarr
- ❌ 本地部署为主
- ❌ 没有云端智能大脑
- ❌ 没有任务调度中心

**结论**: ✅ **VabHub的云端智能大脑架构是独特的创新**

---

## 📊 实现状态分析

### 当前实现状态

#### ✅ 已实现
- 本地VabHub核心功能
- 媒体管理、订阅、搜索等基础功能

#### ⚠️ 未实现（架构中的创新功能）
- Mesh Scheduler（任务调度中心）
- Intel Center（智能大脑）
- Snapshots（静态快照）
- Cloudflare集成

---

## 🎯 实现建议

### 阶段1: 基础架构搭建（1-2周）

#### 1.1 Cloudflare配置
- [ ] 域名托管
- [ ] 配置3个子域（mesh/intel/snap）
- [ ] 全部开启Proxied（橙云）
- [ ] snap子域开启长期缓存

#### 1.2 Mesh Scheduler（Railway）
- [ ] 创建Railway服务
- [ ] 绑定Supabase/Neon Postgres
- [ ] 实现节点注册API
- [ ] 实现任务租约API
- [ ] 实现任务完成API
- [ ] Cloudflare反代配置

#### 1.3 Intel Center（Deta.Space）
- [ ] 创建Deta.Space项目
- [ ] 创建Base：alias/index/rules
- [ ] 部署FastAPI服务
- [ ] 实现别名识别API
- [ ] 实现索引查询API
- [ ] Cloudflare反代配置

#### 1.4 Snapshots（Cloudflare Pages/R2）
- [ ] 创建GitHub仓库
- [ ] Pages部署配置
- [ ] CI推送快照文件
- [ ] 配置长期缓存

---

### 阶段2: 核心功能实现（2-3周）

#### 2.1 Mesh Scheduler功能
- [ ] 节点注册和管理
- [ ] 任务分发算法
- [ ] 租约机制
- [ ] 站点指针管理
- [ ] 防重复抓取逻辑

#### 2.2 Intel Center功能
- [ ] 别名识别算法
- [ ] 发布索引构建
- [ ] 规则包管理
- [ ] 智能推荐API
- [ ] 数据同步机制

#### 2.3 Snapshots功能
- [ ] 快照生成脚本
- [ ] 增量更新机制
- [ ] 客户端快照加载
- [ ] 离线模式支持

---

### 阶段3: 客户端集成（1-2周）

#### 3.1 VabHub-Core集成
- [ ] 配置智能端点
- [ ] 实现快照加载
- [ ] 实现增量更新
- [ ] 实现离线模式
- [ ] 实现任务调度集成

---

## 💡 技术实现要点

### 1. Mesh Scheduler设计

**核心概念**:
- **节点（Worker）**: 用户客户端实例
- **任务（Job）**: PT站点抓取任务
- **租约（Lease）**: 任务分配机制
- **站点指针（Site Pointer）**: 记录抓取进度

**工作流程**:
1. 节点注册，声明可抓取的站点
2. 节点请求任务，获取租约
3. 节点执行抓取任务
4. 节点回报完成，更新站点指针

**防重复机制**:
- 同一站点同时只能有一个活跃租约
- 租约有过期时间（如300秒）
- 节点需要定期续租

---

### 2. Intel Center设计

**核心概念**:
- **别名（Alias）**: 媒体名称的变体
- **发布索引（Release Index）**: 全网发布信息
- **规则包（Rules）**: 站点解析规则

**数据模型**:
```python
# 别名表
alias_terms = {
    "movie_name": ["别名1", "别名2", "别名3"]
}

# 发布索引
release_index = {
    "release_key": {
        "sites": ["site1", "site2"],
        "metadata": {...}
    }
}

# 规则包
rules = {
    "site_id": {
        "parser": {...},
        "selectors": {...}
    }
}
```

---

### 3. Snapshots设计

**快照内容**:
- 别名数据（压缩JSON）
- 发布索引（压缩JSON）
- 规则包（JSON）

**更新机制**:
- 定期生成快照（如每小时）
- CI自动推送
- 客户端启动时检查版本
- 支持增量更新

---

## 🚀 部署流程

### 1. Cloudflare配置
```bash
# DNS配置
mesh.vabhub.net    → Railway (反代)
intel.vabhub.net   → Deta.Space (反代)
snap.vabhub.net    → Cloudflare Pages/R2
```

### 2. Railway部署
```bash
# 环境变量
APP_ENV=production
DB_URL=postgresql+psycopg2://user:pass@host:5432/vabhub_mesh
NETWORK_SHARED_KEY=SOME_RANDOM_STRING
JWT_SECRET=SOME_RANDOM_STRING
MAX_WORKERS_PER_SITE=3
LEASE_DURATION_SECONDS=300
```

### 3. Deta.Space部署
```bash
# 环境变量
APP_ENV=production
DETA_PROJECT_KEY=xxxx
DETA_BASE_ALIAS=vabhub_alias
DETA_BASE_INDEX=vabhub_index
DETA_BASE_RULES=vabhub_rules
NETWORK_SHARED_KEY=SOME_RANDOM_STRING
```

---

## 📈 优势分析

### 1. 成本优势
- ✅ 完全免费（使用免费额度）
- ✅ 无需自建服务器
- ✅ 自动伸缩，按需使用

### 2. 技术优势
- ✅ 全球CDN，低延迟
- ✅ 高可用性（多云架构）
- ✅ 易于扩展

### 3. 用户体验优势
- ✅ 零配置
- ✅ 自动更新
- ✅ 离线支持

---

## 🎯 实现优先级

### 高优先级（核心功能）
1. **Mesh Scheduler** - 任务调度是核心
2. **Intel Center基础** - 别名识别和索引
3. **Snapshots基础** - 离线支持

### 中优先级（增强功能）
4. **Intel Center增强** - 智能推荐
5. **Snapshots增强** - 增量更新
6. **客户端集成** - 完整集成

### 低优先级（优化功能）
7. **多Mesh集群** - 扩展性
8. **多Intel Center** - 社区节点
9. **完全分布式** - 实验性功能

---

## 📝 总结

### 架构独特性
✅ **这是目前媒体库管理平台中独一无二的架构设计**

### 核心创新
1. **完全免费云端架构** - 使用免费云服务组合
2. **分布式任务调度** - 避免重复抓取
3. **云端智能大脑** - 共享智能服务
4. **离线快照机制** - 支持离线使用

### 实现建议
- 这是一个**长期项目**，需要分阶段实现
- 建议先实现**Mesh Scheduler**（核心功能）
- 然后实现**Intel Center基础功能**
- 最后实现**Snapshots和客户端集成**

---

**状态**: ⚠️ 架构设计已完成，需要开始实现

