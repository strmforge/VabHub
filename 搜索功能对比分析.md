# 搜索功能对比分析

## 📊 三个版本的搜索功能对比

### 1. 当前版本（VabHub - 高级搜索）✅ 最新

#### 核心特性
- ✅ **媒体ID搜索**：支持TMDB ID、IMDB ID、豆瓣ID搜索
- ✅ **多维度筛选**：语言、分类、编码格式、来源等
- ✅ **智能分组**：按站点、质量、分辨率、分类分组
- ✅ **SSE流式推送**：实时推送搜索结果和进度
- ✅ **媒体信息集成**：自动获取并附加媒体元数据

#### 搜索参数
```python
class SearchRequest:
    # 媒体ID搜索（新增）
    tmdb_id: Optional[int]
    imdb_id: Optional[str]
    douban_id: Optional[str]
    
    # 基础筛选
    query: Optional[str]
    media_type: Optional[str]
    year: Optional[int]
    quality: Optional[str]
    resolution: Optional[str]
    min_size/max_size: Optional[float]
    min_seeders/max_seeders: Optional[int]
    include/exclude: Optional[str]
    sites: Optional[List[str]]
    
    # 多维度筛选（新增）
    language: Optional[str]      # 语言
    category: Optional[str]      # 资源分类
    encoding: Optional[str]      # 编码格式 (H.264, H.265, AV1)
    source: Optional[str]        # 来源 (BluRay, WEB-DL, HDTV, DVD)
    
    # 排序和分页
    sort_by: Optional[str]
    sort_order: Optional[str]
    page: Optional[int]
    page_size: Optional[int]
    
    # 分组选项（新增）
    group_by: Optional[str]      # site, quality, resolution, category
```

#### 搜索结果
```python
class SearchResult:
    title: str
    site: str
    magnet_link: Optional[str]
    torrent_url: Optional[str]
    size_gb: float
    seeders: int
    leechers: int
    resolution: Optional[str]
    quality: Optional[str]
    upload_date: Optional[datetime]
    
    # 新增字段
    category: Optional[str]      # 资源分类
    language: Optional[str]      # 语言
    encoding: Optional[str]      # 编码格式
    source: Optional[str]        # 来源
    media_info: Optional[dict]   # 媒体信息（如果通过ID搜索）
```

#### API端点
- `POST /api/search/` - 增强的搜索端点（支持ID搜索、分组）
- `POST /api/search/stream` - SSE流式推送端点（新增）
- `GET /api/search/history` - 搜索历史
- `GET /api/search/suggestions` - 搜索建议

#### 特色功能
1. **媒体ID搜索**：通过TMDB/IMDB/豆瓣ID直接搜索，自动获取媒体信息
2. **智能分组**：按不同维度对搜索结果进行分组展示
3. **SSE推送**：实时推送搜索结果，提升用户体验
4. **多维度筛选**：更精细的资源筛选能力

---

### 2. 之前版本（VabHub - 基础搜索）

#### 核心特性
- ✅ **关键词搜索**：基础的关键词搜索功能
- ✅ **基础筛选**：媒体类型、年份、质量、分辨率、大小、做种数
- ✅ **多站点搜索**：支持指定多个站点
- ✅ **搜索历史**：记录搜索历史
- ✅ **搜索建议**：基于搜索历史的建议

#### 搜索参数
```python
class SearchRequest:
    query: str                    # 必需的关键词
    media_type: Optional[str]
    year: Optional[int]
    quality: Optional[str]
    resolution: Optional[str]
    min_size/max_size: Optional[float]
    min_seeders/max_seeders: Optional[int]
    include/exclude: Optional[str]
    sites: Optional[List[str]]
    sort_by: Optional[str]
    sort_order: Optional[str]
    page: Optional[int]
    page_size: Optional[int]
```

#### 搜索结果
```python
class SearchResult:
    title: str
    site: str
    magnet_link: Optional[str]
    torrent_url: Optional[str]
    size_gb: float
    seeders: int
    leechers: int
    resolution: Optional[str]
    quality: Optional[str]
    upload_date: Optional[datetime]
    category: Optional[str]      # 基础分类
    language: Optional[str]      # 基础语言
```

#### API端点
- `POST /api/search/` - 基础搜索端点
- `GET /api/search/history` - 搜索历史
- `GET /api/search/suggestions` - 搜索建议

#### 限制
- ❌ 不支持媒体ID搜索
- ❌ 不支持多维度筛选（语言、编码、来源等）
- ❌ 不支持智能分组
- ❌ 不支持SSE流式推送
- ❌ 搜索结果缺少媒体元数据

---

### 3. VabHub-1版本（高级搜索系统）

#### 核心特性
- ✅ **多源索引器管理**：RARBG、1337x、Nyaa、YTS等
- ✅ **智能搜索查询构建**：根据标题、年份、媒体类型构建关键词
- ✅ **并发搜索**：同时搜索多个源
- ✅ **结果去重**：基于info_hash、磁力链接和标题相似度
- ✅ **结果排序**：按种子数、大小、时间排序
- ✅ **缓存机制**：缓存搜索结果
- ✅ **健康检查**：监控索引器状态，自动禁用异常站点
- ✅ **HNR风险集成**：自动检测和过滤高风险内容
- ✅ **质量配置过滤**：根据分辨率、大小等条件过滤

#### 搜索架构
```python
class SearchEngine:
    """搜索引擎核心"""
    - 多源索引器管理
    - 并发搜索
    - 结果去重
    - 结果排序
    - 缓存机制
    - 健康检查

class AdvancedSearchPlugin:
    """高级搜索插件"""
    - 统一搜索接口
    - 多源搜索
    - HNR风险集成
    - 质量配置过滤
    - 搜索历史管理
    - 源健康状态检查
```

#### 搜索参数
```python
class SearchRequest:
    query: str
    media_type: Optional[str]
    year: Optional[int]
    quality: Optional[str]
    resolution: Optional[str]
    min_size/max_size: Optional[float]
    min_seeders: Optional[int]
    sites: Optional[List[str]]
    # HNR风险检测
    filter_hnr: Optional[bool]
    # 质量配置
    quality_config: Optional[dict]
```

#### 搜索结果
```python
class SearchResult:
    title: str
    site: str
    magnet_link: str
    info_hash: str              # 用于去重
    size_gb: float
    seeders: int
    leechers: int
    resolution: Optional[str]
    quality: Optional[str]
    upload_date: Optional[datetime]
    # HNR风险信息
    hnr_risk: Optional[dict]
    # 索引器信息
    indexer: str
    indexer_status: str
```

#### API端点
- `GET /api/v1/subscription/search` - 搜索媒体内容
- `GET /api/v1/subscription/search/indexers` - 获取索引器状态
- `GET /api/v1/subscription/search/statistics` - 获取搜索统计信息
- `POST /api/v1/subscription/search/subscription/{id}` - 为订阅执行搜索

#### 特色功能
1. **多源索引器**：支持多个真实PT站点和资源站点
2. **并发搜索**：同时搜索多个源，提高效率
3. **结果去重**：基于info_hash和相似度的智能去重
4. **健康检查**：自动监控和管理索引器状态
5. **HNR风险检测**：集成HNR风险检测功能
6. **缓存机制**：缓存搜索结果，提高响应速度

---

## 📈 功能对比表

| 功能特性 | 当前版本（高级搜索） | 之前版本（基础搜索） | VabHub-1版本 |
|---------|-------------------|-------------------|------------|
| **关键词搜索** | ✅ | ✅ | ✅ |
| **媒体ID搜索** | ✅ TMDB/IMDB/豆瓣 | ❌ | ❌ |
| **多维度筛选** | ✅ 语言/分类/编码/来源 | ⚠️ 基础筛选 | ⚠️ 基础筛选 |
| **智能分组** | ✅ 按站点/质量/分辨率/分类 | ❌ | ❌ |
| **SSE流式推送** | ✅ | ❌ | ❌ |
| **媒体信息集成** | ✅ 自动获取元数据 | ❌ | ❌ |
| **多源索引器** | ⚠️ 模拟数据 | ⚠️ 模拟数据 | ✅ 真实站点 |
| **并发搜索** | ⚠️ 基础实现 | ⚠️ 基础实现 | ✅ 完整实现 |
| **结果去重** | ⚠️ 基础实现 | ⚠️ 基础实现 | ✅ 智能去重 |
| **健康检查** | ❌ | ❌ | ✅ |
| **HNR风险检测** | ❌ | ❌ | ✅ |
| **缓存机制** | ⚠️ 基础实现 | ⚠️ 基础实现 | ✅ 完整实现 |
| **搜索历史** | ✅ | ✅ | ✅ |
| **搜索建议** | ✅ | ✅ | ✅ |

---

## 🎯 主要差异总结

### 当前版本 vs 之前版本

#### 新增功能
1. **媒体ID搜索**：支持通过TMDB/IMDB/豆瓣ID直接搜索
2. **多维度筛选**：新增语言、分类、编码格式、来源等筛选维度
3. **智能分组**：支持按不同维度对搜索结果进行分组
4. **SSE流式推送**：实时推送搜索结果，提升用户体验
5. **媒体信息集成**：自动获取并附加媒体元数据

#### 改进
- 搜索参数更灵活（query变为可选，支持ID搜索）
- 搜索结果包含更多信息（编码、来源、媒体信息等）
- 响应格式更丰富（支持分组结果和媒体信息）

### 当前版本 vs VabHub-1版本

#### 当前版本的优势
1. **媒体ID搜索**：VabHub-1不支持
2. **智能分组**：VabHub-1不支持
3. **SSE流式推送**：VabHub-1不支持
4. **多维度筛选**：更精细的筛选能力

#### VabHub-1版本的优势
1. **真实站点集成**：支持真实的PT站点和资源站点
2. **并发搜索**：更高效的并发搜索实现
3. **智能去重**：基于info_hash和相似度的去重
4. **健康检查**：自动监控和管理索引器状态
5. **HNR风险检测**：集成HNR风险检测功能
6. **缓存机制**：更完善的缓存实现

---

## 💡 建议

### 可以迁移的功能（从VabHub-1）
1. **多源索引器管理**：集成真实的PT站点和资源站点
2. **并发搜索优化**：改进并发搜索的实现
3. **智能去重算法**：基于info_hash和相似度的去重
4. **健康检查机制**：监控和管理索引器状态
5. **HNR风险检测**：集成HNR风险检测功能
6. **缓存优化**：改进缓存策略和实现

### 当前版本的优势（保持）
1. **媒体ID搜索**：这是当前版本的独特优势
2. **智能分组**：提供更好的结果展示方式
3. **SSE流式推送**：提升用户体验
4. **多维度筛选**：更精细的筛选能力

---

## 🎉 总结

**当前版本（高级搜索）**在以下方面超越了之前版本和VabHub-1：
- ✅ 媒体ID搜索能力
- ✅ 智能分组功能
- ✅ SSE流式推送
- ✅ 多维度筛选

**VabHub-1版本**在以下方面仍有优势：
- ✅ 真实站点集成
- ✅ 并发搜索优化
- ✅ 智能去重算法
- ✅ 健康检查机制
- ✅ HNR风险检测

**建议**：将VabHub-1的优势功能迁移到当前版本，形成最强大的搜索系统。

