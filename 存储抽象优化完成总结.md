# å­˜å‚¨æŠ½è±¡ä¼˜åŒ–å®Œæˆæ€»ç»“

## ğŸ“‹ æ¦‚è¿°

å­˜å‚¨æŠ½è±¡ä¼˜åŒ–ï¼ˆé˜¶æ®µ2ï¼‰å·²å…¨éƒ¨å®Œæˆï¼Œç»Ÿä¸€äº†å­˜å‚¨æ¥å£ï¼Œæ”¯æŒå¤šç§å­˜å‚¨åç«¯ï¼Œå‚è€ƒäº†MoviePilotçš„æœ€ä½³å®è·µã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å¢å¼ºå­˜å‚¨åŸºç±»æ¥å£ âœ…

#### æ–‡ä»¶
- `backend/app/core/cloud_storage/providers/base.py`

#### æ–°å¢åŠŸèƒ½
- **ä¼ è¾“ç±»å‹æ”¯æŒ**ï¼š`transtype` å±æ€§ï¼Œå­ç±»å¯å®šä¹‰æ”¯æŒçš„ä¼ è¾“ç±»å‹
- **å¿«ç…§æ£€æŸ¥æ”¯æŒ**ï¼š`snapshot_check_folder_modtime` å±æ€§
- **é…ç½®ç®¡ç†æ–¹æ³•**ï¼š
  - `get_config()` - è·å–é…ç½®
  - `set_config(conf)` - è®¾ç½®é…ç½®
  - `reset_config()` - é‡ç½®é…ç½®
- **äºŒç»´ç ç™»å½•æ”¯æŒ**ï¼š
  - `generate_qrcode()` - ç”ŸæˆäºŒç»´ç 
  - `check_login()` - æ£€æŸ¥ç™»å½•çŠ¶æ€
- **æ–‡ä»¶æ“ä½œæ‰©å±•**ï¼š
  - `move_file()` - ç§»åŠ¨æ–‡ä»¶
  - `copy_file()` - å¤åˆ¶æ–‡ä»¶
  - `rename_file()` - é‡å‘½åæ–‡ä»¶
- **å­˜å‚¨æ£€æŸ¥**ï¼š`check()` - æ£€æŸ¥å­˜å‚¨æ˜¯å¦å¯ç”¨

### 2. ç»Ÿä¸€æ•°æ®æ¨¡å‹ âœ…

#### æ–‡ä»¶
- `backend/app/core/cloud_storage/schemas.py`

#### æ•°æ®æ¨¡å‹
- **FileItem**ï¼šç»Ÿä¸€æ–‡ä»¶é¡¹æ¨¡å‹ï¼ˆå‚è€ƒMoviePilotï¼‰
  - æ”¯æŒæ–‡ä»¶/ç›®å½•
  - æ”¯æŒè·¯å¾„ã€å¤§å°ã€æ—¶é—´ç­‰ä¿¡æ¯
  - æ”¯æŒ115ç½‘ç›˜ä¸“ç”¨å­—æ®µï¼ˆpickcodeã€drive_idç­‰ï¼‰
  - æ”¯æŒå…ƒæ•°æ®æ‰©å±•
- **StorageUsage**ï¼šå­˜å‚¨ä½¿ç”¨æƒ…å†µæ¨¡å‹
  - æ€»ç©ºé—´ã€å·²ä½¿ç”¨ã€å‰©ä½™ç©ºé—´
  - ä½¿ç”¨ç‡è®¡ç®—
  - ä¾¿æ·å±æ€§ï¼ˆGBå•ä½è½¬æ¢ï¼‰
- **StorageConfig**ï¼šå­˜å‚¨é…ç½®æ¨¡å‹
  - æä¾›å•†ç±»å‹ã€é…ç½®åç§°
  - å¯ç”¨çŠ¶æ€ã€å…·ä½“é…ç½®
  - æ—¶é—´æˆ³
- **TransferInfo**ï¼šä¼ è¾“ä¿¡æ¯æ¨¡å‹
  - æºè·¯å¾„ã€ç›®æ ‡è·¯å¾„
  - ä¼ è¾“ç±»å‹ã€çŠ¶æ€ã€è¿›åº¦
  - ä¼ è¾“é€Ÿåº¦ã€é”™è¯¯ä¿¡æ¯

#### æ¨¡å‹è½¬æ¢å·¥å…·
- `cloud_file_info_to_file_item()` - CloudFileInfo â†’ FileItem
- `file_item_to_cloud_file_info()` - FileItem â†’ CloudFileInfo
- `cloud_storage_usage_to_storage_usage()` - CloudStorageUsage â†’ StorageUsage

### 3. å®Œå–„115ç½‘ç›˜Provider âœ…

#### æ–‡ä»¶
- `backend/app/core/cloud_storage/providers/cloud_115.py`

#### æ–°å¢åŠŸèƒ½
- **ä¼ è¾“ç±»å‹æ”¯æŒ**ï¼šcopyï¼ˆå¤åˆ¶ï¼‰ã€moveï¼ˆç§»åŠ¨ï¼‰
- **é…ç½®ç®¡ç†**ï¼š`get_config()`ã€`set_config()`
- **äºŒç»´ç ç™»å½•**ï¼š`generate_qrcode()`ã€`check_login()`
- **æ–‡ä»¶æ“ä½œæ‰©å±•**ï¼š
  - `move_file()` - ç§»åŠ¨æ–‡ä»¶
  - `copy_file()` - å¤åˆ¶æ–‡ä»¶
  - `rename_file()` - é‡å‘½åæ–‡ä»¶
- **è¾…åŠ©æ–¹æ³•**ï¼š`_get_folder_id_by_path()` - æ ¹æ®è·¯å¾„è·å–æ–‡ä»¶å¤¹ID

### 4. å®Œå–„RClone Provider âœ…

#### æ–‡ä»¶
- `backend/app/core/cloud_storage/providers/rclone.py`

#### æ–°å¢åŠŸèƒ½
- **ä¼ è¾“ç±»å‹æ”¯æŒ**ï¼šcopyï¼ˆå¤åˆ¶ï¼‰ã€moveï¼ˆç§»åŠ¨ï¼‰ã€syncï¼ˆåŒæ­¥ï¼‰
- **é…ç½®ç®¡ç†**ï¼š`get_config()`ã€`set_config()`
- **å­˜å‚¨æ£€æŸ¥**ï¼š`check()` - æ£€æŸ¥RCloneæ˜¯å¦å¯ç”¨

### 5. å®Œå–„OpenList Provider âœ…

#### æ–‡ä»¶
- `backend/app/core/cloud_storage/providers/openlist.py`

#### æ–°å¢åŠŸèƒ½
- **é…ç½®ç®¡ç†**ï¼š`get_config()`ã€`set_config()`
- **å­˜å‚¨æ£€æŸ¥**ï¼š`check()` - æ£€æŸ¥OpenListæ˜¯å¦å¯ç”¨
- **OAuthæ”¯æŒ**ï¼š
  - `get_oauth_url()` - è·å–OAuthç™»å½•URL
  - `exchange_code_for_token()` - ä½¿ç”¨æˆæƒç æ¢å–ä»¤ç‰Œ
  - `refresh_token()` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ
  - `get_cookie_from_token()` - ä»Tokenè·å–Cookie

### 6. åˆ›å»ºå­˜å‚¨Providerç®¡ç†å™¨ âœ…

#### æ–‡ä»¶
- `backend/app/core/cloud_storage/manager.py`

#### åŠŸèƒ½
- **Provideræ³¨å†Œ**ï¼š`register()` - æ³¨å†ŒProvider
- **Providerè·å–**ï¼š`get_provider_class()` - è·å–Providerç±»
- **å®ä¾‹ç®¡ç†**ï¼š
  - `create_provider()` - åˆ›å»ºProviderå®ä¾‹
  - `get_or_create_provider()` - è·å–æˆ–åˆ›å»ºProviderå®ä¾‹ï¼ˆå¸¦ç¼“å­˜ï¼‰
- **Provideråˆ—è¡¨**ï¼š`list_providers()` - åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œçš„Provider
- **Provideræ£€æŸ¥**ï¼š`is_provider_registered()` - æ£€æŸ¥Provideræ˜¯å¦å·²æ³¨å†Œ
- **ç¼“å­˜ç®¡ç†**ï¼š`clear_instances()` - æ¸…é™¤Providerå®ä¾‹ç¼“å­˜

#### ä¾¿æ·å‡½æ•°
- `get_storage_provider_manager()` - è·å–ç®¡ç†å™¨å®ä¾‹
- `register_storage_provider()` - æ³¨å†ŒProvider
- `get_storage_provider()` - è·å–Providerå®ä¾‹
- `list_storage_providers()` - åˆ—å‡ºæ‰€æœ‰Provider

## ğŸ“Š æŠ€æœ¯ç‰¹ç‚¹

### 1. ç»Ÿä¸€çš„æ¥å£è®¾è®¡
- æ‰€æœ‰Providerå®ç°ç›¸åŒçš„åŸºç±»æ¥å£
- æ”¯æŒæ‰©å±•æ–¹æ³•ï¼ˆå¯é€‰å®ç°ï¼‰
- å‘åå…¼å®¹ç°æœ‰ä»£ç 

### 2. çµæ´»çš„æ•°æ®æ¨¡å‹
- ä½¿ç”¨Pydanticæ¨¡å‹ï¼ˆç±»å‹å®‰å…¨ï¼‰
- æ”¯æŒæ¨¡å‹è½¬æ¢å·¥å…·
- æ”¯æŒå…ƒæ•°æ®æ‰©å±•

### 3. å®Œå–„çš„Providerç®¡ç†
- å•ä¾‹æ¨¡å¼ç®¡ç†å™¨
- è‡ªåŠ¨æ³¨å†Œå†…ç½®Provider
- æ”¯æŒè‡ªå®šä¹‰Provideræ³¨å†Œ
- Providerå®ä¾‹ç¼“å­˜

### 4. å‚è€ƒMoviePilotæœ€ä½³å®è·µ
- StorageBaseæ¥å£è®¾è®¡
- FileItemæ•°æ®æ¨¡å‹
- ä¼ è¾“ç±»å‹æ”¯æŒ
- é…ç½®ç®¡ç†æœºåˆ¶

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from app.core.cloud_storage import get_storage_provider

# è·å–115ç½‘ç›˜Provider
provider = get_storage_provider(
    "115",
    credentials={
        "app_id": "...",
        "app_key": "...",
        "app_secret": "..."
    }
)

# åˆå§‹åŒ–
await provider.initialize(credentials)

# åˆ—å‡ºæ–‡ä»¶
files = await provider.list_files("/")

# è·å–å­˜å‚¨ä½¿ç”¨æƒ…å†µ
usage = await provider.get_storage_usage()
```

### ä½¿ç”¨Providerç®¡ç†å™¨

```python
from app.core.cloud_storage import (
    get_storage_provider_manager,
    list_storage_providers
)

# åˆ—å‡ºæ‰€æœ‰Provider
providers = list_storage_providers()
# ['115', 'rclone', 'openlist']

# è·å–ç®¡ç†å™¨
manager = get_storage_provider_manager()

# åˆ›å»ºProvider
provider = manager.create_provider("115", credentials)
```

### ä½¿ç”¨æ•°æ®æ¨¡å‹

```python
from app.core.cloud_storage import (
    FileItem,
    StorageUsage,
    cloud_file_info_to_file_item
)

# è½¬æ¢æ¨¡å‹
file_item = cloud_file_info_to_file_item(cloud_file_info, storage="115")

# ä½¿ç”¨FileItem
print(file_item.name)
print(file_item.size)
print(file_item.modify_time)
```

## ğŸ“ˆ æ”¹è¿›æ•ˆæœ

### ä»£ç è´¨é‡
- âœ… ç»Ÿä¸€çš„æ¥å£è®¾è®¡
- âœ… ç±»å‹å®‰å…¨çš„æ•°æ®æ¨¡å‹
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… æ¸…æ™°çš„ä»£ç ç»“æ„

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ”¯æŒå¤šç§å­˜å‚¨åç«¯
- âœ… ç»Ÿä¸€çš„é…ç½®ç®¡ç†
- âœ… æ‰©å±•çš„æ–‡ä»¶æ“ä½œ
- âœ… å®Œå–„çš„Providerç®¡ç†

### å¯ç»´æŠ¤æ€§
- âœ… æ˜“äºæ‰©å±•æ–°Provider
- âœ… æ¸…æ™°çš„ä»£ç ç»„ç»‡
- âœ… å®Œå–„çš„æ–‡æ¡£
- âœ… å‘åå…¼å®¹

## ğŸ”„ ä¸ç°æœ‰ä»£ç çš„é›†æˆ

### å…¼å®¹æ€§
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… ç°æœ‰ä»£ç å¯ä»¥ç»§ç»­ä½¿ç”¨
- âœ… æ–°åŠŸèƒ½é€šè¿‡æ‰©å±•æä¾›

### è¿ç§»å»ºè®®
1. é€æ­¥ä½¿ç”¨æ–°çš„æ•°æ®æ¨¡å‹
2. ä½¿ç”¨Providerç®¡ç†å™¨
3. åˆ©ç”¨æ¨¡å‹è½¬æ¢å·¥å…·
4. ä½¿ç”¨æ‰©å±•çš„æ–‡ä»¶æ“ä½œ

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

### 1. é˜¶æ®µ3ï¼š115ç½‘ç›˜é›†æˆæ”¹è¿›
- å®ç°PKCEè®¤è¯
- å®ç°OSSä¸Šä¼ 
- ä¼˜åŒ–æ–‡ä»¶æ“ä½œ
- æµ‹è¯•éªŒè¯

### 2. å®Œå–„æµ‹è¯•
- å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•
- æ€§èƒ½æµ‹è¯•

### 3. æ–‡æ¡£å®Œå–„
- APIæ–‡æ¡£
- ä½¿ç”¨æŒ‡å—
- æœ€ä½³å®è·µ

---

**çŠ¶æ€**: âœ… å®Œæˆ  
**å®Œæˆæ—¥æœŸ**: 2025-01-XX  
**ç‰ˆæœ¬**: 1.0

