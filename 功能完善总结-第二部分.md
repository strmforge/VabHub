# åŠŸèƒ½å®Œå–„æ€»ç»“ - ç¬¬äºŒéƒ¨åˆ†

## ğŸ“‹ å®Œæˆæ¦‚è¿°

æœ¬æ¬¡å®Œå–„äº†OpenSubtitlesä¸‹è½½é€»è¾‘å’ŒRSSé¡¹åŒ¹é…è®¢é˜…é€»è¾‘ï¼Œè¿™æ˜¯ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½çš„å…³é”®éƒ¨åˆ†ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½å®Œå–„

### 1. OpenSubtitlesä¸‹è½½é€»è¾‘å®Œå–„ âœ…

**æ–‡ä»¶**: `backend/app/modules/subtitle/sources.py`

**å·²å®Œæˆ**:
- âœ… å®ç°file_idåˆ°ä¸‹è½½é“¾æ¥çš„è½¬æ¢
- âœ… å®ç°å®é™…çš„ä¸‹è½½é€»è¾‘
- âœ… å¤„ç†ä¸‹è½½å¤±è´¥å’Œé‡è¯•æœºåˆ¶
- âœ… æ”¹è¿›æœç´¢ç»“æœè§£æï¼ˆæå–file_idã€è¯„åˆ†ã€ä¸‹è½½æ¬¡æ•°ç­‰ï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å…³é”®æ”¹è¿›**:
1. **ä¸‹è½½æµç¨‹**:
   - ä½¿ç”¨file_idè°ƒç”¨OpenSubtitles API `/download`ç«¯ç‚¹
   - è·å–ä¸‹è½½é“¾æ¥
   - ä¸‹è½½å­—å¹•æ–‡ä»¶
   - ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„

2. **æœç´¢ç»“æœæ”¹è¿›**:
   - æ­£ç¡®æå–file_id
   - æå–æ–‡ä»¶æ ¼å¼
   - æå–è¯„åˆ†å’Œä¸‹è½½æ¬¡æ•°
   - æå–å¼ºåˆ¶å­—å¹•å’Œå¬åŠ›impairedä¿¡æ¯

### 2. RSSé¡¹åŒ¹é…è®¢é˜…é€»è¾‘å®Œå–„ âœ…

**æ–‡ä»¶**: `backend/app/modules/rss/service.py`

**å·²å®Œæˆ**:
- âœ… åˆ›å»ºåª’ä½“ä¿¡æ¯æå–å™¨ï¼ˆ`RSSMediaExtractor`ï¼‰
- âœ… å®ç°RSSé¡¹åˆ°åª’ä½“è®¢é˜…çš„åŒ¹é…é€»è¾‘
- âœ… å®ç°è®¢é˜…è§„åˆ™æ£€æŸ¥
- âœ… å®ç°è‡ªåŠ¨ä¸‹è½½è§¦å‘
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å…³é”®åŠŸèƒ½**:

1. **åª’ä½“ä¿¡æ¯æå–** (`backend/app/modules/rss/media_extractor.py`):
   - ä»RSSé¡¹æ ‡é¢˜æå–åª’ä½“ä¿¡æ¯
   - æ”¯æŒç”µå½±å’Œç”µè§†å‰§è¯†åˆ«
   - æå–å¹´ä»½ã€å­£æ•°ã€é›†æ•°ç­‰ä¿¡æ¯
   - æå–è´¨é‡ã€åˆ†è¾¨ç‡ã€ç¼–ç ç­‰ä¿¡æ¯

2. **è®¢é˜…åŒ¹é…** (`_find_matching_subscription`):
   - åŸºäºæ ‡é¢˜åŒ¹é…ï¼ˆæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æ ‡é¢˜ï¼‰
   - åŸºäºåª’ä½“ç±»å‹åŒ¹é…
   - åŸºäºå¹´ä»½åŒ¹é…ï¼ˆå…è®¸Â±1å¹´è¯¯å·®ï¼‰
   - åŸºäºå­£æ•°å’Œé›†æ•°åŒ¹é…ï¼ˆç”µè§†å‰§ï¼‰
   - æ™ºèƒ½è¯„åˆ†é€‰æ‹©æœ€ä½³åŒ¹é…

3. **è§„åˆ™æ£€æŸ¥** (`_check_subscription_rules`):
   - æ£€æŸ¥è´¨é‡è¦æ±‚
   - æ£€æŸ¥åˆ†è¾¨ç‡è¦æ±‚
   - å¯æ‰©å±•æ£€æŸ¥å…¶ä»–è§„åˆ™

4. **è‡ªåŠ¨ä¸‹è½½**:
   - åŒ¹é…æˆåŠŸåè‡ªåŠ¨åˆ›å»ºä¸‹è½½ä»»åŠ¡
   - æ”¯æŒmagneté“¾æ¥å’Œtorrent URL
   - æ”¯æŒè‡ªå®šä¹‰ä¸‹è½½è·¯å¾„å’Œä¸‹è½½å™¨

## ğŸ“Š åŠŸèƒ½æµç¨‹å›¾

### OpenSubtitlesä¸‹è½½æµç¨‹

```
1. æœç´¢å­—å¹• â†’ è·å–file_id
2. è°ƒç”¨/download API â†’ è·å–ä¸‹è½½é“¾æ¥
3. ä¸‹è½½å­—å¹•æ–‡ä»¶ â†’ ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
4. è®°å½•ä¸‹è½½å†å² â†’ è¿”å›æˆåŠŸ/å¤±è´¥
```

### RSSé¡¹åŒ¹é…è®¢é˜…æµç¨‹

```
1. RSSé¡¹è§£æ â†’ æå–åª’ä½“ä¿¡æ¯
2. åŒ¹é…åª’ä½“è®¢é˜… â†’ æŸ¥æ‰¾åŒ¹é…çš„è®¢é˜…
3. æ£€æŸ¥è®¢é˜…è§„åˆ™ â†’ éªŒè¯è´¨é‡ã€åˆ†è¾¨ç‡ç­‰
4. åˆ›å»ºä¸‹è½½ä»»åŠ¡ â†’ è‡ªåŠ¨ä¸‹è½½åŒ¹é…çš„èµ„æº
5. æ›´æ–°RSSé¡¹çŠ¶æ€ â†’ æ ‡è®°ä¸ºå·²å¤„ç†/å·²ä¸‹è½½
```

## ğŸ¯ æŠ€æœ¯å®ç°

### 1. OpenSubtitlesä¸‹è½½

```python
# ä¸‹è½½æµç¨‹
async def download(self, subtitle_info: SubtitleInfo, save_path: str) -> bool:
    # 1. è®¤è¯
    if not self.token:
        await self._authenticate()
    
    # 2. è·å–ä¸‹è½½é“¾æ¥
    response = await client.post(
        f"{self.base_url}/download",
        json={"file_id": int(file_id)},
        headers=headers
    )
    download_link = response.json().get("link")
    
    # 3. ä¸‹è½½æ–‡ä»¶
    download_response = await client.get(download_link)
    with open(save_path, 'wb') as f:
        f.write(download_response.content)
    
    return True
```

### 2. RSSé¡¹åŒ¹é…

```python
# åŒ¹é…æµç¨‹
async def _process_rss_item(self, item, subscription):
    # 1. æå–åª’ä½“ä¿¡æ¯
    extracted_info = self.media_extractor.extract(item.title, item.description)
    
    # 2. åŒ¹é…è®¢é˜…
    matched_subscription = await self._find_matching_subscription(extracted_info)
    
    # 3. æ£€æŸ¥è§„åˆ™
    if not self._check_subscription_rules(extracted_info, matched_subscription):
        return {"downloaded": False}
    
    # 4. åˆ›å»ºä¸‹è½½ä»»åŠ¡
    download_task = await self._download_service.create_download(download_data)
    
    return {"downloaded": True, "task_id": download_task_id}
```

## ğŸš§ å¾…å®Œå–„çš„åŠŸèƒ½

### 1. åª’ä½“åˆ†ç±»è§„åˆ™å¼•æ“ âš ï¸

**å½“å‰çŠ¶æ€**: åŸºç¡€åˆ†ç±»å·²å®ç°ï¼Œä½†åˆ†ç±»è§„åˆ™å¼•æ“éœ€è¦å®Œå–„

**éœ€è¦å®ç°**:
- åŸºäºTMDBçš„genre_idsåˆ†ç±»
- åŸºäºè¯­è¨€çš„åœ°åŒºåˆ†ç±»
- è‡ªå®šä¹‰åˆ†ç±»è§„åˆ™
- åˆ†ç±»æ¨¡æ¿é…ç½®

### 2. æ›´å¤šå­—å¹•æºé›†æˆ âš ï¸

**å½“å‰çŠ¶æ€**: OpenSubtitleså·²å®ç°ï¼Œå…¶ä»–å­—å¹•æºå¾…å®ç°

**éœ€è¦å®ç°**:
- SubHDå®¢æˆ·ç«¯å®Œå–„
- å°„æ‰‹å­—å¹•å®¢æˆ·ç«¯
- å­—å¹•åº“å®¢æˆ·ç«¯
- å¤šæºèšåˆæœç´¢

### 3. æ–‡ä»¶å“ˆå¸ŒåŒ¹é… âš ï¸

**å½“å‰çŠ¶æ€**: å“ˆå¸Œè®¡ç®—å·²å®ç°ï¼Œä½†æœªç”¨äºåŒ¹é…

**éœ€è¦å®ç°**:
- ä½¿ç”¨æ–‡ä»¶å“ˆå¸Œç²¾ç¡®åŒ¹é…å­—å¹•
- æ”¯æŒOpenSubtitlesçš„å“ˆå¸ŒåŒ¹é…API

### 4. å‰ç«¯ç•Œé¢å¼€å‘ âš ï¸

**å½“å‰çŠ¶æ€**: åç«¯APIå·²å®ç°ï¼Œå‰ç«¯ç•Œé¢å¾…å¼€å‘

**éœ€è¦å®ç°**:
- RSSè®¢é˜…ç®¡ç†ç•Œé¢
- å­—å¹•ç®¡ç†ç•Œé¢
- åª’ä½“æ–‡ä»¶ç®¡ç†ç•Œé¢
- æ‰¹é‡æ“ä½œç•Œé¢

## ğŸ“Š å®Œæˆåº¦ç»Ÿè®¡

### åç«¯åŠŸèƒ½å®Œæˆåº¦

| åŠŸèƒ½æ¨¡å— | å®Œæˆåº¦ | çŠ¶æ€ |
|---------|--------|------|
| RSSè®¢é˜…åŠŸèƒ½ | 90% | âœ… å‡ ä¹å®Œæˆ |
| å­—å¹•è‡ªåŠ¨åŒ¹é… | 85% | âœ… åŸºæœ¬å®Œæˆ |
| åª’ä½“æ–‡ä»¶ç®¡ç† | 90% | âœ… å‡ ä¹å®Œæˆ |
| åª’ä½“åˆ†ç±»è§„åˆ™ | 60% | âš ï¸ å¾…å®Œå–„ |

### æ€»ä½“å®Œæˆåº¦

- **åç«¯æ ¸å¿ƒåŠŸèƒ½**: 85%
- **å‰ç«¯ç•Œé¢**: 0%
- **æ€»ä½“å®Œæˆåº¦**: 60%

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®Œå–„äº†ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š

1. âœ… **OpenSubtitlesä¸‹è½½é€»è¾‘**: å®Œæ•´å®ç°äº†å­—å¹•ä¸‹è½½åŠŸèƒ½
2. âœ… **RSSé¡¹åŒ¹é…è®¢é˜…é€»è¾‘**: å®Œæ•´å®ç°äº†RSSé¡¹åˆ°è®¢é˜…çš„åŒ¹é…å’Œè‡ªåŠ¨ä¸‹è½½

**ä¸‹ä¸€æ­¥**: ç»§ç»­å®Œå–„åª’ä½“åˆ†ç±»è§„åˆ™å¼•æ“ï¼Œé›†æˆæ›´å¤šå­—å¹•æºï¼Œå¹¶å¼€å§‹å‰ç«¯ç•Œé¢å¼€å‘ã€‚

