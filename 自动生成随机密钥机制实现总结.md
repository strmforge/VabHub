# 自动生成随机密钥机制实现总结

**实现时间**: 2025-01-XX  
**目标**: 实现类似MoviePilot的机制，每次安装时自动生成随机密钥，确保每个客户端实例的唯一性

---

## 📋 需求分析

### MoviePilot机制

- ✅ **每次安装随机生成**: apikey在每次安装时自动生成
- ✅ **每个客户端唯一**: 不同安装实例的apikey都不同
- ✅ **持久化存储**: 生成的apikey保存到配置文件
- ✅ **安全可靠**: 使用加密存储，防止泄露

### VabHub当前问题

- ❌ `SECRET_KEY` 和 `JWT_SECRET_KEY` 使用固定默认值
- ❌ 所有安装实例使用相同的默认密钥（安全风险）
- ❌ 需要用户手动配置（不够自动化）

---

## ✅ 实现方案

### 1. 创建SecretManager（密钥管理器）

**文件**: `backend/app/core/secret_manager.py`

**功能**:
- ✅ 自动检测是否需要生成新密钥
- ✅ 使用 `secrets.token_urlsafe(32)` 生成32字节（256位）随机密钥
- ✅ 密钥持久化到 `./data/.vabhub_secrets.json`
- ✅ 支持环境变量覆盖
- ✅ 自动检测占位符并替换

**密钥类型**:
1. `SECRET_KEY` - 应用密钥
2. `JWT_SECRET_KEY` - JWT签名密钥
3. `API_TOKEN` - API令牌（用于STRM重定向等）

### 2. 集成到配置系统

**修改**: `backend/app/core/config.py`

**新增属性**:
- `SECRET_KEY_DYNAMIC` - 动态获取SECRET_KEY
- `JWT_SECRET_KEY_DYNAMIC` - 动态获取JWT_SECRET_KEY
- `API_TOKEN_DYNAMIC` - 动态获取API_TOKEN

**工作流程**:
1. 首次访问时，检查密钥是否存在
2. 如果不存在或使用占位符，自动生成新密钥
3. 保存到配置文件
4. 后续启动时从配置文件加载

### 3. 应用启动时初始化

**修改**: `backend/main.py`

**在lifespan中添加**:
```python
# 初始化密钥管理器（自动生成随机密钥）
from app.core.secret_manager import initialize_secrets
initialize_secrets()
```

---

## 🔐 安全特性

### 1. 密钥生成

- ✅ 使用 `secrets.token_urlsafe(32)` 生成32字节随机密钥
- ✅ URL安全的base64编码（适合在URL中使用）
- ✅ 每个安装实例生成唯一的密钥

### 2. 密钥存储

- ✅ 保存到 `./data/.vabhub_secrets.json`
- ✅ 文件权限：仅所有者可读写（Unix系统：0o600）
- ✅ JSON格式，便于备份和迁移

### 3. 密钥优先级

1. **环境变量**（最高优先级）
   - `SECRET_KEY`
   - `JWT_SECRET_KEY`
   - `API_TOKEN`

2. **配置文件**（次优先级）
   - `./data/.vabhub_secrets.json`

3. **自动生成**（最低优先级）
   - 如果都不存在，自动生成新密钥

---

## 📊 对比分析

### MoviePilot方案

```
apikey: 每次安装随机生成，保存到配置文件
特点:
- 固定值（不会过期）
- 每个实例唯一
- 需要手动配置或自动生成
```

### VabHub新方案

```
SECRET_KEY: 首次启动自动生成，保存到配置文件
JWT_SECRET_KEY: 首次启动自动生成，保存到配置文件
API_TOKEN: 首次启动自动生成，保存到配置文件

特点:
- ✅ 自动生成（无需手动配置）
- ✅ 每个实例唯一
- ✅ 支持环境变量覆盖
- ✅ 持久化存储
- ✅ 更安全（多密钥机制）
```

**优势**:
- ✅ **更自动化**: 无需用户手动配置
- ✅ **更安全**: 使用多个密钥，而不是单一的apikey
- ✅ **更灵活**: 支持环境变量覆盖
- ✅ **更可靠**: 自动检测占位符并替换

---

## 🔄 工作流程

### 首次安装

```
1. 应用启动
2. 调用 initialize_secrets()
3. SecretManager检查配置文件
4. 发现密钥不存在或使用占位符
5. 自动生成随机密钥
6. 保存到 ./data/.vabhub_secrets.json
7. 后续使用从配置文件加载
```

### 后续启动

```
1. 应用启动
2. 调用 initialize_secrets()
3. SecretManager检查配置文件
4. 发现密钥已存在
5. 从配置文件加载
6. 直接使用（无需重新生成）
```

### 环境变量覆盖

```
1. 设置环境变量 SECRET_KEY=xxx
2. SecretManager优先使用环境变量
3. 忽略配置文件中的值
```

---

## 📝 代码变更

### 新增文件

1. **`backend/app/core/secret_manager.py`**
   - SecretManager类
   - 密钥生成、加载、保存逻辑

### 修改文件

1. **`backend/app/core/config.py`**
   - 添加动态密钥属性
   - `SECRET_KEY_DYNAMIC`
   - `JWT_SECRET_KEY_DYNAMIC`
   - `API_TOKEN_DYNAMIC`

2. **`backend/main.py`**
   - 在lifespan中添加密钥初始化

3. **`backend/app/core/security.py`**
   - 使用 `JWT_SECRET_KEY_DYNAMIC`

4. **`backend/app/api/strm.py`**
   - 使用 `JWT_SECRET_KEY_DYNAMIC`

5. **`backend/app/modules/strm/generator.py`**
   - 使用 `JWT_SECRET_KEY_DYNAMIC`

6. **`backend/scripts/start.py`**
   - 更新启动检查脚本

---

## 🎯 使用示例

### 获取密钥

```python
from app.core.config import settings

# 自动获取（首次启动时自动生成）
secret_key = settings.SECRET_KEY_DYNAMIC
jwt_secret = settings.JWT_SECRET_KEY_DYNAMIC
api_token = settings.API_TOKEN_DYNAMIC
```

### 手动管理密钥

```python
from app.core.secret_manager import get_secret_manager

manager = get_secret_manager()

# 获取密钥
secret = manager.get_secret('SECRET_KEY')

# 设置密钥
manager.set_secret('SECRET_KEY', 'your-custom-secret')

# 检查密钥是否存在
if manager.has_secret('SECRET_KEY'):
    print("密钥已存在")
```

---

## 🔒 安全建议

### 1. 配置文件保护

- ✅ 文件权限：仅所有者可读写（0o600）
- ✅ 位置：`./data/.vabhub_secrets.json`（隐藏文件）
- ⚠️ **不要**将配置文件提交到Git仓库

### 2. 环境变量使用

生产环境建议使用环境变量：
```bash
export SECRET_KEY="your-production-secret-key"
export JWT_SECRET_KEY="your-production-jwt-secret-key"
export API_TOKEN="your-production-api-token"
```

### 3. 备份和迁移

- ✅ 备份 `./data/.vabhub_secrets.json` 文件
- ✅ 迁移时复制配置文件到新实例
- ⚠️ 确保文件权限正确

---

## ✅ 测试建议

### 1. 首次安装测试

```bash
# 删除配置文件（模拟首次安装）
rm -f ./data/.vabhub_secrets.json

# 启动应用
python -m uvicorn main:app --reload

# 检查是否生成了密钥文件
cat ./data/.vabhub_secrets.json
```

### 2. 密钥唯一性测试

```bash
# 安装1
python -m uvicorn main:app --reload
# 记录生成的密钥

# 安装2（不同目录）
cd /path/to/another/instance
python -m uvicorn main:app --reload
# 验证密钥不同
```

### 3. 环境变量覆盖测试

```bash
export SECRET_KEY="custom-secret-key"
python -m uvicorn main:app --reload
# 验证使用环境变量的值
```

---

## 🎉 总结

**自动生成随机密钥机制已实现！** ✅

- ✅ 类似MoviePilot的apikey机制
- ✅ 每次安装自动生成唯一密钥
- ✅ 支持环境变量覆盖
- ✅ 持久化存储
- ✅ 更安全的多密钥机制

**优势**:
- ✅ **自动化**: 无需手动配置
- ✅ **唯一性**: 每个实例都有唯一的密钥
- ✅ **安全性**: 使用加密存储和文件权限保护
- ✅ **灵活性**: 支持环境变量覆盖

**所有密钥管理功能已完成！** 🚀

---

**文档生成时间**: 2025-01-XX  
**文档版本**: 1.0

