# VabHub CI - 主流水线
# CI-DOCKER-ONE-IMAGE-1 + DOCKER-RELEASE-1 实现
#
# 触发条件: push (所有分支) / pull_request / 手动触发
# 流程: 后端 CI ✅ + 前端 CI ✅ → Docker 构建验证 (仅 build，不 push)
#
# 镜像发布由 docker-release.yml 负责（仅在 tag 时触发）

name: VabHub CI

on:
  push:
    branches: ["*"]
    # 移除 tags 触发，tag 发布由 docker-release.yml 处理
  pull_request:
    branches: ["*"]
  workflow_dispatch:
    inputs:
      skip_ci:
        description: 'Skip CI checks (use with caution)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/strmforge/vabhub
  DOCKERHUB_IMAGE: strmforge/vabhub

jobs:
  # ============== 后端 CI 检查 ==============
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_ci != true }}
    
    env:
      VABHUB_CI: "1"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install backend dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run backend dev_check
        run: |
          bash scripts/dev_check_backend.sh

  # ============== 前端 CI 检查 ==============
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_ci != true }}
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
          run_install: false
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run frontend dev_check
        run: pnpm run dev_check

  # ============== Docker 构建验证 (仅 build，不 push) ==============
  # DOCKER-RELEASE-1: CI 只验证 Docker 构建，镜像发布由 docker-release.yml 负责
  docker-build:
    name: Docker Build (CI Only)
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    # 仅在 CI 通过后执行构建验证
    if: |
      always() &&
      (needs.backend-ci.result == 'success' && needs.frontend-ci.result == 'success')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 仅构建，不推送 - 验证 Dockerfile 有效性
      - name: Build VabHub Image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          platforms: linux/amd64
          tags: ${{ env.IMAGE_NAME }}:ci-${{ github.sha }}
          cache-from: type=gha,scope=vabhub
          cache-to: type=gha,mode=max,scope=vabhub
      
      # 输出构建结果
      - name: Build Summary
        run: |
          echo "## Docker Build Summary (CI Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker image built successfully (not pushed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "镜像发布请使用 git tag:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git tag v0.1.0-rc2" >> $GITHUB_STEP_SUMMARY
          echo "git push origin v0.1.0-rc2" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
