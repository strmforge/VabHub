# VabHub Docker Build & Push CI
# DOCKER-CI-1 实现
#
# 触发条件: push 到 main 分支、push 版本 tag、手动触发
# 流程: 后端 CI ✅ + 前端 CI ✅ → Docker 构建 & 推送到 GHCR

name: Docker Build & Push

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_ci:
        description: 'Skip CI checks (use with caution)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  # 镜像名使用小写，符合 OCI 规范
  BACKEND_IMAGE: ghcr.io/strmforge/vabhub-backend
  FRONTEND_IMAGE: ghcr.io/strmforge/vabhub-frontend

jobs:
  # ============== 后端 CI 检查 ==============
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_ci != 'true' }}
    
    env:
      VABHUB_CI: "1"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install backend dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run backend dev_check
        run: |
          bash scripts/dev_check_backend.sh

  # ============== 前端 CI 检查 ==============
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_ci != 'true' }}
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
          run_install: false
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run frontend dev_check
        run: pnpm run dev_check

  # ============== Docker 构建 & 推送 ==============
  docker-build:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    # 如果 skip_ci 为 true，则不依赖 CI job
    if: |
      always() && 
      (github.event.inputs.skip_ci == 'true' || 
       (needs.backend-ci.result == 'success' && needs.frontend-ci.result == 'success'))
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # 计算 Docker 标签
      - name: Generate Docker tags
        id: tags
        run: |
          # 基础标签
          BACKEND_TAGS="${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
          FRONTEND_TAGS="${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"
          
          # 如果是 main 分支，添加 latest 标签
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            BACKEND_TAGS="${BACKEND_TAGS},${{ env.BACKEND_IMAGE }}:latest"
            FRONTEND_TAGS="${FRONTEND_TAGS},${{ env.FRONTEND_IMAGE }}:latest"
          fi
          
          # 如果是版本 tag，添加版本标签
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            BACKEND_TAGS="${BACKEND_TAGS},${{ env.BACKEND_IMAGE }}:${VERSION}"
            FRONTEND_TAGS="${FRONTEND_TAGS},${{ env.FRONTEND_IMAGE }}:${VERSION}"
          fi
          
          echo "backend_tags=${BACKEND_TAGS}" >> $GITHUB_OUTPUT
          echo "frontend_tags=${FRONTEND_TAGS}" >> $GITHUB_OUTPUT
          
          echo "Backend tags: ${BACKEND_TAGS}"
          echo "Frontend tags: ${FRONTEND_TAGS}"
      
      # 构建并推送后端镜像
      - name: Build & Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.tags.outputs.backend_tags }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          labels: |
            org.opencontainers.image.source=https://github.com/strmforge/VabHub
            org.opencontainers.image.description=VabHub Backend Service
            org.opencontainers.image.revision=${{ github.sha }}
      
      # 构建并推送前端镜像
      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.tags.outputs.frontend_tags }}
          build-args: |
            VITE_API_BASE_URL=/api
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          labels: |
            org.opencontainers.image.source=https://github.com/strmforge/VabHub
            org.opencontainers.image.description=VabHub Frontend Service
            org.opencontainers.image.revision=${{ github.sha }}
      
      # 输出构建结果
      - name: Build Summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.backend_tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.frontend_tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.BACKEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.FRONTEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
