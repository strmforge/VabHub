# VabHub Docker Release - ç‰ˆæœ¬å·é©±åŠ¨çš„é•œåƒå‘å¸ƒï¼ˆåŒä»“åº“ï¼‰
# DOCKER-RELEASE-1 å®ç°
#
# è§¦å‘æ¡ä»¶: ä»…åœ¨æ¨é€ v* tag æ—¶è§¦å‘
# æµç¨‹: è¯»å–ä»£ç ç‰ˆæœ¬å· â†’ æ ¡éªŒ tag ä¸€è‡´æ€§ â†’ æ„å»ºå¹¶æ¨é€é•œåƒåˆ° GHCR + Docker Hub
#
# é•œåƒå‘å¸ƒç›®æ ‡ï¼ˆåŒæ—¶æ¨é€ï¼‰:
#   GHCR:
#     - ghcr.io/strmforge/vabhub:<version>
#     - ghcr.io/strmforge/vabhub:latest
#   Docker Hub:
#     - strmforge/vabhub:<version>
#     - strmforge/vabhub:latest
#
# æ‰€éœ€ Secrets:
#   - DOCKERHUB_USERNAME: Docker Hub ç”¨æˆ·å
#   - DOCKERHUB_TOKEN: Docker Hub Access Token

name: Docker Release

on:
  push:
    tags:
      - 'v*'  # ä¾‹å¦‚ v0.1.0ã€v0.1.0-rc1
  workflow_dispatch:
    inputs:
      version_override:
        description: 'ç‰ˆæœ¬å·è¦†ç›–ï¼ˆç•™ç©ºåˆ™ä»ä»£ç è¯»å–ï¼‰'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/strmforge/vabhub
  DOCKERHUB_IMAGE: strmforge/vabhub

jobs:
  release:
    name: Build & Push Release Image
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Read version from code
        id: version
        run: |
          VERSION=$(python backend/scripts/print_version.py)
          echo "value=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Code version: $VERSION"
      
      # P4: é˜²å‘†æ£€æŸ¥ - tag ä¸ä»£ç ç‰ˆæœ¬å·å¿…é¡»ä¸€è‡´
      - name: Ensure tag matches version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"   # v0.1.0-rc1 -> 0.1.0-rc1
          CODE_VERSION="${{ steps.version.outputs.value }}"
          echo "ğŸ·ï¸  Tag version:  $TAG_VERSION"
          echo "ğŸ“ Code version: $CODE_VERSION"
          if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
            echo ""
            echo "âŒ ERROR: Tag and code version mismatch!"
            echo ""
            echo "è¯·ç¡®ä¿ä»¥ä¸‹ä¸¤æ­¥éª¤å·²å®Œæˆï¼š"
            echo "1. ä¿®æ”¹ backend/app/core/version.py ä¸­çš„ APP_VERSION"
            echo "2. æäº¤ä»£ç åå†æ‰“ tag"
            echo ""
            exit 1
          fi
          echo "âœ… Version check passed"
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # è®¡ç®— Docker æ ‡ç­¾
      - name: Generate Docker tags
        id: tags
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          
          # ç‰ˆæœ¬æ ‡ç­¾ + latest (GHCR + Docker Hub)
          TAGS="${{ env.IMAGE_NAME }}:${VERSION}"
          TAGS="${TAGS},${{ env.IMAGE_NAME }}:latest"
          TAGS="${TAGS},${{ env.DOCKERHUB_IMAGE }}:${VERSION}"
          TAGS="${TAGS},${{ env.DOCKERHUB_IMAGE }}:latest"
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Docker tags:"
          echo "$TAGS" | tr ',' '\n' | sed 's/^/   - /'
      
      # æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build & Push VabHub Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha,scope=vabhub
          cache-to: type=gha,mode=max,scope=vabhub
          labels: |
            org.opencontainers.image.source=https://github.com/strmforge/VabHub
            org.opencontainers.image.description=VabHub All-in-One Application
            org.opencontainers.image.version=${{ steps.version.outputs.value }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      # è¾“å‡ºå‘å¸ƒç»“æœ
      - name: Release Summary
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          echo "## ğŸ‰ Docker Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Images" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# From GHCR (æ¨è)" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_NAME }}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# From Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKERHUB_IMAGE }}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
