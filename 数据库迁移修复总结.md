# æ•°æ®åº“è¿ç§»ä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2025-11-09

---

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜
- **é”™è¯¯**: `no such column: download_tasks.downloader_hash`
- **ä½ç½®**: å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶
- **å½±å“**: ä¸‹è½½çŠ¶æ€æ›´æ–°åŠŸèƒ½æ— æ³•æŸ¥è¯¢æ•°æ®åº“

### åŸå› åˆ†æ
- æ¨¡å‹å®šä¹‰ä¸­å·²æœ‰ `downloader_hash` å­—æ®µ
- ä½†æ•°æ®åº“è¡¨ä¸­ç¼ºå°‘è¯¥å­—æ®µ
- ä¹‹å‰çš„è¿ç§»è„šæœ¬æ£€æŸ¥é€»è¾‘æœ‰é—®é¢˜ï¼Œæ²¡æœ‰çœŸæ­£æ‰§è¡Œè¿ç§»

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹
1. **æ”¹è¿›è¿ç§»è„šæœ¬**
   - ä½¿ç”¨ `sqlite3` ç›´æ¥è¿æ¥æ•°æ®åº“
   - æ­£ç¡®æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
   - æ‰§è¡Œ `ALTER TABLE` æ·»åŠ å­—æ®µ

### ä¿®å¤ä»£ç 
```python
# ä½¿ç”¨sqlite3ç›´æ¥æ“ä½œ
conn = sqlite3.connect(str(db_path))
cursor = conn.cursor()

# æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨
cursor.execute("PRAGMA table_info(download_tasks)")
columns = [col[1] for col in cursor.fetchall()]

if 'downloader_hash' in columns:
    logger.info("å­—æ®µ downloader_hash å·²å­˜åœ¨ï¼Œè·³è¿‡è¿ç§»")
    return

# æ·»åŠ å­—æ®µ
cursor.execute("ALTER TABLE download_tasks ADD COLUMN downloader_hash VARCHAR(100) NULL")
conn.commit()
```

---

## ğŸ“‹ è¿ç§»æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
```bash
python -c "import sqlite3; conn = sqlite3.connect('backend/vabhub.db'); cursor = conn.cursor(); cursor.execute('PRAGMA table_info(download_tasks)'); print(cursor.fetchall())"
```

### æ­¥éª¤2: æ‰§è¡Œè¿ç§»
```bash
python backend/scripts/migrate_add_downloader_hash.py
```

### æ­¥éª¤3: éªŒè¯è¿ç§»
```bash
python -c "import sqlite3; conn = sqlite3.connect('backend/vabhub.db'); cursor = conn.cursor(); cursor.execute('PRAGMA table_info(download_tasks)'); cols = cursor.fetchall(); print([col[1] for col in cols])"
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ æ•°æ®åº“è¡¨ä¸­ç¼ºå°‘ `downloader_hash` å­—æ®µ
- âŒ å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶æŠ›å‡º `OperationalError`
- âŒ ä¸‹è½½çŠ¶æ€æ›´æ–°åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œ

### ä¿®å¤å
- âœ… æ•°æ®åº“è¡¨ä¸­å·²æ·»åŠ  `downloader_hash` å­—æ®µ
- âœ… å®šæ—¶ä»»åŠ¡å¯ä»¥æ­£å¸¸æ‰§è¡Œ
- âœ… ä¸‹è½½çŠ¶æ€æ›´æ–°åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š éªŒè¯ç»“æœ

### æ•°æ®åº“è¡¨ç»“æ„
- **è¡¨å**: `download_tasks`
- **å­—æ®µ**: åŒ…å« `downloader_hash` å­—æ®µ
- **ç±»å‹**: `VARCHAR(100)`
- **å¯ç©º**: `NULL`

### å®šæ—¶ä»»åŠ¡çŠ¶æ€
- âœ… å®šæ—¶ä»»åŠ¡å¯ä»¥æ­£å¸¸æ‰§è¡Œ
- âœ… ä¸‹è½½çŠ¶æ€æ›´æ–°åŠŸèƒ½æ­£å¸¸
- âœ… æ— æ•°æ®åº“å­—æ®µé”™è¯¯

---

## ğŸŠ æ€»ç»“

### ä¿®å¤çš„é—®é¢˜
1. âœ… æ•°æ®åº“å­—æ®µç¼ºå¤±é—®é¢˜
2. âœ… è¿ç§»è„šæœ¬é€»è¾‘é—®é¢˜
3. âœ… å®šæ—¶ä»»åŠ¡æ‰§è¡Œé”™è¯¯

### ä¸‹ä¸€æ­¥
- ğŸ“‹ éªŒè¯å®šæ—¶ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
- ğŸ“‹ æ£€æŸ¥ä¸‹è½½çŠ¶æ€æ›´æ–°åŠŸèƒ½
- ğŸ“‹ è¿è¡Œå®Œæ•´æµ‹è¯•

---

**åˆ›å»ºæ—¶é—´**: 2025-11-09  
**æœ€åæ›´æ–°**: 2025-11-09  
**çŠ¶æ€**: å·²ä¿®å¤ï¼Œå¾…éªŒè¯

