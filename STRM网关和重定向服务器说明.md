# STRM网关和重定向服务器说明

## 📋 概述

您说得对！**STRM工作流（搜索→下载→上传）这部分功能已经和系统本体功能重合了**，不需要重复实现。STRM系统只需要专注于**STRM文件生成**和**链接管理**。

本文档重点说明**STRM网关和重定向服务器**的工作原理和部署方式。

## 🔍 两种STRM URL生成模式

当前版本支持两种STRM URL生成模式，用户可以根据需求选择：

### 1. Direct模式（直接下载地址）✅ 推荐

**特点**：
- ✅ **无需额外服务器**：STRM文件直接包含115网盘的下载地址
- ✅ **零成本**：不需要部署云服务器
- ✅ **简单直接**：媒体服务器直接访问115下载地址

**工作原理**：
```
STRM文件内容：
https://proapi.115.com/.../download_url?pick_code=xxx
```

**优点**：
- 无需维护重定向服务器
- 减少中间环节，播放更流畅
- 适合个人用户和小规模使用

**缺点**：
- 115下载地址可能会过期（通常有效期较长）
- 如果地址过期，需要重新生成STRM文件

**适用场景**：
- 个人用户
- 本地NAS环境
- 不需要频繁刷新链接的场景

### 2. Local Redirect模式（本地重定向）🔄 可选

**特点**：
- ✅ **自动链接刷新**：当115下载地址过期时，自动获取新地址
- ✅ **集成在主服务中**：不需要独立部署，使用VabHub主服务
- ✅ **JWT认证**：通过JWT token保护，更安全

**工作原理**：
```
STRM文件内容：
http://192.168.1.100:8000/api/strm/stream/115/eyJ0eXAiOiJKV1QiLCJhbGc...

重定向服务器流程：
1. 媒体服务器请求STRM文件中的URL
2. VabHub验证JWT token
3. 从token中提取pick_code
4. 调用115 API获取最新下载地址
5. 302重定向到115下载地址
```

**优点**：
- 自动刷新过期链接
- 统一管理下载地址
- 可以添加访问控制和日志

**缺点**：
- 需要VabHub服务持续运行
- 增加一次重定向，略微增加延迟

**适用场景**：
- 需要自动刷新链接的场景
- 需要访问控制和日志的场景
- 企业或团队使用

## 🏗️ 架构对比

### Direct模式架构

```
媒体服务器 (Emby/Jellyfin/Plex)
    ↓
直接访问115下载地址
    ↓
115网盘服务器
```

**无需中间服务器**

### Local Redirect模式架构

```
媒体服务器 (Emby/Jellyfin/Plex)
    ↓
访问STRM文件中的本地重定向URL
    ↓
VabHub主服务 (本地运行)
    ├── 验证JWT token
    ├── 调用115 API获取下载地址
    └── 302重定向
    ↓
115网盘服务器
```

**需要VabHub服务运行（本地即可，无需云服务器）**

## ❓ 是否需要部署云服务器？

### 答案：**不需要！** ✅

**原因**：

1. **Direct模式**：
   - 完全不需要服务器
   - STRM文件直接包含115下载地址
   - 媒体服务器直接访问115

2. **Local Redirect模式**：
   - 使用**本地VabHub服务**即可
   - 重定向API已集成在VabHub主服务中（`/api/strm/stream/{storage_type}/{token}`）
   - 只需要在本地运行VabHub，媒体服务器通过内网IP访问

### 部署场景说明

#### 场景1：本地NAS环境（推荐）

```
NAS服务器
├── VabHub服务 (运行在NAS上)
├── 媒体服务器 (Emby/Jellyfin/Plex)
└── STRM文件 (存储在NAS上)

媒体服务器通过内网IP访问VabHub重定向服务
例如：http://192.168.1.100:8000/api/strm/stream/115/token
```

**优点**：
- 所有服务都在本地
- 无需公网IP
- 无需云服务器
- 数据安全

#### 场景2：云服务器部署（可选，不推荐）

如果确实需要在云服务器上部署重定向服务，可以：

```
云服务器
└── VabHub服务 (运行在云服务器上)
    └── 重定向API: https://your-domain.com/api/strm/stream/115/token

本地NAS
├── 媒体服务器
└── STRM文件 (指向云服务器重定向URL)
```

**缺点**：
- 需要云服务器成本
- 需要域名和SSL证书
- 增加网络延迟
- 数据需要经过云服务器

**适用场景**：
- 多地点访问需求
- 需要公网访问的场景
- 企业级部署

## 🔄 VabHub-1的独立重定向服务器

VabHub-1有一个**独立的STRM重定向服务器**（`strm_redirect_server.py`），可以独立部署。

### VabHub-1独立服务器特点

- **独立服务**：可以单独部署，不依赖VabHub主服务
- **完整功能**：包含限流、缓存、日志、统计等功能
- **Redis支持**：使用Redis缓存下载地址
- **访问控制**：支持JWT认证和访问日志

### 当前版本 vs VabHub-1

| 特性 | 当前版本 | VabHub-1独立服务器 |
|------|---------|-------------------|
| **部署方式** | 集成在主服务中 | 独立服务 |
| **部署位置** | 本地VabHub服务 | 可独立部署 |
| **是否需要云服务器** | ❌ 不需要 | ❌ 不需要（但可以） |
| **功能完整性** | ✅ 基础功能 | ✅ 完整功能（限流/缓存/日志） |
| **维护成本** | ✅ 低（集成在主服务） | 🟡 中（需要单独维护） |
| **适用场景** | 个人/小团队 | 企业/大规模 |

## 💡 推荐方案

### 个人用户推荐：Direct模式

```python
# STRM配置
strm_url_mode = "direct"  # 直接使用115下载地址
```

**优点**：
- 最简单，无需维护
- 零成本
- 播放流畅

### 需要自动刷新链接：Local Redirect模式

```python
# STRM配置
strm_url_mode = "local_redirect"  # 使用本地重定向
local_redirect_host = ""  # 自动检测内网IP
local_redirect_port = 0  # 使用系统端口
```

**优点**：
- 自动刷新过期链接
- 集成在主服务中，无需额外部署
- 本地运行，无需云服务器

### 企业级部署：可考虑独立服务器

如果需要更完整的功能（限流、缓存、日志、统计），可以考虑迁移VabHub-1的独立重定向服务器。

## 📝 总结

1. **STRM工作流（搜索→下载→上传）**：✅ 已和系统本体功能重合，不需要重复实现

2. **STRM网关和重定向服务器**：
   - **Direct模式**：✅ 完全不需要服务器
   - **Local Redirect模式**：✅ 使用本地VabHub服务即可，**无需云服务器**

3. **是否需要云服务器**：❌ **不需要**
   - 本地NAS环境即可
   - 媒体服务器通过内网IP访问VabHub重定向服务
   - 只有在需要公网访问时才考虑云服务器（不推荐）

4. **当前实现 vs VabHub-1**：
   - 当前版本：集成在主服务中，简单实用
   - VabHub-1：独立服务器，功能更完整
   - 建议：当前版本已足够，除非需要企业级功能

## 🎯 下一步建议

1. **保持当前实现**：Direct模式和Local Redirect模式已经满足大部分需求
2. **可选增强**：如果需要企业级功能，可以考虑迁移VabHub-1的独立服务器功能（限流、缓存、日志等）
3. **重点优化**：专注于STRM文件生成、同步、生命周期管理等核心功能

