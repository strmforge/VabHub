# 订阅规则引擎实现总结

## ✅ 完成状态

**状态**: ✅ **已完成**

**完成时间**: 2025-11-13

---

## 🎯 实现内容

### 订阅规则引擎 (`backend/app/modules/subscription/rule_engine.py`)

#### 核心功能
- ✅ **高级规则匹配**：
  - 基础规则检查（质量、分辨率、特效、做种数、文件大小）
  - 包含规则（支持正则表达式和简单字符串，OR逻辑）
  - 排除规则（支持正则表达式和简单字符串，OR逻辑）
  - 优先级规则组（支持AND/OR逻辑组合）
  - 电视剧特殊规则（季数、集数检查）

- ✅ **结果评分系统**：
  - 做种数评分（最高40分）
  - 文件大小评分（最高20分）
  - 质量匹配评分（最高20分）
  - 分辨率匹配评分（最高10分）
  - 特效匹配评分（最高10分）
  - 总分：0-100分

- ✅ **过滤和排序**：
  - 自动过滤不符合规则的结果
  - 支持按评分、做种数、大小排序
  - 集成到订阅服务中

---

## 📊 功能特性

### 1. 规则匹配

#### 基础规则
- **质量匹配**：检查标题和结果中的质量信息
- **分辨率匹配**：检查标题和结果中的分辨率信息
- **特效匹配**：检查HDR、Dolby Vision等特效
- **做种数检查**：最小做种数要求
- **文件大小检查**：最小/最大文件大小限制

#### 包含规则（include）
- **简单字符串**：多个关键词用逗号分隔，OR逻辑
  - 示例：`"CHD,WiKi,CMCT"` - 匹配包含任一关键词的结果
- **正则表达式**：以 `/` 开头和结尾
  - 示例：`"/CHD|WiKi|CMCT/"` - 使用正则表达式匹配

#### 排除规则（exclude）
- **简单字符串**：多个关键词用逗号分隔，OR逻辑
  - 示例：`"CAM,TS,TC"` - 排除包含任一关键词的结果
- **正则表达式**：以 `/` 开头和结尾
  - 示例：`"/CAM|TS|TC/"` - 使用正则表达式排除

#### 优先级规则组（filter_groups）
```json
[
  {
    "name": "发布组优先级",
    "priority": 1,
    "rules": [
      {"type": "include", "pattern": "CHD", "logic": "or"},
      {"type": "include", "pattern": "WiKi", "logic": "or"}
    ]
  },
  {
    "name": "编码格式",
    "priority": 2,
    "rules": [
      {"type": "include", "pattern": "H.265", "logic": "and"}
    ]
  }
]
```

- **优先级**：数字越小优先级越高
- **逻辑类型**：`and`（必须全部匹配）或 `or`（至少匹配一个）
- **规则类型**：`include`（包含）或 `exclude`（排除）

### 2. 结果评分

评分维度：
- **做种数**（40分）：做种数越多分数越高
- **文件大小**（20分）：适中大小（5-20GB电影，1-5GB剧集）得分最高
- **质量匹配**（20分）：匹配订阅要求的质量
- **分辨率匹配**（10分）：匹配订阅要求的分辨率
- **特效匹配**（10分）：匹配订阅要求的特效

### 3. 电视剧特殊规则

- **季数检查**：自动检查标题中的季数信息
  - 支持格式：`S01`, `Season 1`, `Season1`, `S1`
- **集数范围**：支持起始集数和总集数检查（待完善）

---

## 🔄 代码变更

### 新增文件
1. **rule_engine.py**：
   - `RuleEngine` 类：规则引擎核心
   - `match_result()`: 规则匹配方法
   - `score_result()`: 结果评分方法
   - `filter_and_sort_results()`: 过滤和排序方法

### 修改文件
1. **service.py**：
   - 集成 `RuleEngine` 到 `SubscriptionService`
   - 更新 `_filter_search_results()` 使用规则引擎
   - 更新 `_select_best_result()` 使用规则引擎评分

---

## 📝 使用示例

### 基础规则
```python
subscription = {
    "quality": "1080p",
    "resolution": "1080p",
    "effect": "HDR",
    "min_seeders": 10,
    "min_size": 5.0,
    "max_size": 20.0
}

# 规则引擎会自动检查这些条件
```

### 包含规则
```python
# 简单字符串（OR逻辑）
subscription["include"] = "CHD,WiKi,CMCT"

# 正则表达式
subscription["include"] = "/CHD|WiKi|CMCT/"
```

### 排除规则
```python
# 简单字符串（OR逻辑）
subscription["exclude"] = "CAM,TS,TC"

# 正则表达式
subscription["exclude"] = "/CAM|TS|TC/"
```

### 优先级规则组
```python
subscription["filter_groups"] = [
    {
        "name": "发布组",
        "priority": 1,
        "rules": [
            {"type": "include", "pattern": "CHD", "logic": "or"},
            {"type": "include", "pattern": "WiKi", "logic": "or"}
        ]
    },
    {
        "name": "编码格式",
        "priority": 2,
        "rules": [
            {"type": "include", "pattern": "H.265", "logic": "and"}
        ]
    }
]
```

---

## 🎯 下一步

### 已完成
- ✅ 订阅规则引擎
- ✅ 订阅历史追踪
- ✅ 订阅状态管理

### 待完成
- ⏳ 系统监控完善
- ⏳ 前端性能优化

---

**状态**: ✅ 订阅规则引擎已完成
**下一步**: 继续实现系统监控完善或前端性能优化

