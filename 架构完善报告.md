# VabHub æ¶æ„å®Œå–„æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ¶æ„å®Œå–„å·¥ä½œä¸»è¦é’ˆå¯¹VabHubç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½è¿›è¡Œäº†å…¨é¢å‡çº§ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚

**å®Œæˆæ—¶é—´**: 2025-11-08  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## âœ… å·²å®Œæˆçš„æ¶æ„ç»„ä»¶

### 1. ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿ ğŸ¯

**æ–‡ä»¶**: `backend/app/core/cache.py`

#### æ ¸å¿ƒç‰¹æ€§
- **ä¸‰çº§ç¼“å­˜æ¶æ„**: L1å†…å­˜ç¼“å­˜ â†’ L2 Redisç¼“å­˜ â†’ L3æ•°æ®åº“ç¼“å­˜
- **æ™ºèƒ½å›å¡«æœºåˆ¶**: è‡ªåŠ¨å°†æ•°æ®å›å¡«åˆ°æ›´é«˜çº§ç¼“å­˜
- **ç¼“å­˜è£…é¥°å™¨**: ä¾¿æ·çš„å‡½æ•°ç¼“å­˜è£…é¥°å™¨
- **é”®ç”Ÿæˆå™¨**: æ™ºèƒ½ç¼“å­˜é”®ç”Ÿæˆï¼ˆæ”¯æŒå“ˆå¸Œé•¿é”®ï¼‰
- **æŒä¹…åŒ–æ”¯æŒ**: L3æ•°æ®åº“ç¼“å­˜å®Œå…¨æŒä¹…åŒ–

#### æŠ€æœ¯å®ç°
```python
# ä½¿ç”¨ç¤ºä¾‹
from app.core.cache import get_cache, cached

# æ–¹å¼1: ç›´æ¥ä½¿ç”¨ç¼“å­˜ç®¡ç†å™¨
cache = get_cache()
await cache.set("key", "value", ttl=3600)
value = await cache.get("key")

# æ–¹å¼2: ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
@cached(ttl=3600, key_prefix="media")
async def get_media_info(media_id: int):
    # å‡½æ•°é€»è¾‘
    pass
```

#### æ”¯æŒçš„ç¼“å­˜åç«¯
- **MemoryCacheBackend**: å†…å­˜ç¼“å­˜ï¼ˆL1ï¼Œé»˜è®¤TTL 5åˆ†é’Ÿï¼‰
- **RedisCacheBackend**: Redisç¼“å­˜ï¼ˆL2ï¼Œé»˜è®¤TTL 1å°æ—¶ï¼‰
- **DatabaseCacheBackend**: æ•°æ®åº“ç¼“å­˜ï¼ˆL3ï¼Œé»˜è®¤TTL 24å°æ—¶ï¼‰

#### é…ç½®
- Redisè¿æ¥é€šè¿‡ `settings.REDIS_URL` é…ç½®
- å¦‚æœRedisä¸å¯ç”¨ï¼Œè‡ªåŠ¨é™çº§ä¸ºä»…å†…å­˜ç¼“å­˜
- å†…å­˜ç¼“å­˜æ”¯æŒæœ€å¤§å¤§å°é™åˆ¶ï¼ˆé»˜è®¤1000é¡¹ï¼‰

---

### 2. ä¸­é—´ä»¶ç³»ç»Ÿ ğŸ›¡ï¸

**æ–‡ä»¶**: `backend/app/core/middleware.py`

#### å·²å®ç°çš„ä¸­é—´ä»¶

##### 1. RequestLoggingMiddlewareï¼ˆè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ï¼‰
- **åŠŸèƒ½**: è®°å½•æ‰€æœ‰HTTPè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- **è®°å½•å†…å®¹**:
  - å®¢æˆ·ç«¯IP
  - è¯·æ±‚æ–¹æ³•å’Œè·¯å¾„
  - æŸ¥è¯¢å‚æ•°
  - å“åº”çŠ¶æ€ç 
  - å¤„ç†æ—¶é—´
- **æ—¥å¿—æ ¼å¼**: ç»“æ„åŒ–æ—¥å¿—ï¼ŒåŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯

##### 2. PerformanceMonitoringMiddlewareï¼ˆæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶ï¼‰
- **åŠŸèƒ½**: ç›‘æ§è¯·æ±‚å¤„ç†æ€§èƒ½
- **ç‰¹æ€§**:
  - æ£€æµ‹æ…¢è¯·æ±‚ï¼ˆé»˜è®¤é˜ˆå€¼1ç§’ï¼‰
  - åœ¨å“åº”å¤´ä¸­æ·»åŠ å¤„ç†æ—¶é—´
  - è‡ªåŠ¨è®°å½•æ€§èƒ½è­¦å‘Š

##### 3. ErrorHandlingMiddlewareï¼ˆé”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼‰
- **åŠŸèƒ½**: ç»Ÿä¸€å¼‚å¸¸å¤„ç†å’Œé”™è¯¯å“åº”
- **ç‰¹æ€§**:
  - æ•è·æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸
  - è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
  - è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
  - å¼€å‘æ¨¡å¼æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯

#### ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº
1. ErrorHandlingMiddlewareï¼ˆæœ€å¤–å±‚ï¼Œæ•è·æ‰€æœ‰é”™è¯¯ï¼‰
2. PerformanceMonitoringMiddlewareï¼ˆæ€§èƒ½ç›‘æ§ï¼‰
3. RequestLoggingMiddlewareï¼ˆè¯·æ±‚æ—¥å¿—ï¼‰
4. CORSMiddlewareï¼ˆCORSå¤„ç†ï¼Œæœ€å†…å±‚ï¼‰

---

### 3. ä¾èµ–æ³¨å…¥ç³»ç»Ÿ ğŸ”Œ

**æ–‡ä»¶**: `backend/app/core/dependencies.py`

#### æ ¸å¿ƒç»„ä»¶

##### ServiceRegistryï¼ˆæœåŠ¡æ³¨å†Œè¡¨ï¼‰
- **åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡å®ä¾‹
- **ç‰¹æ€§**:
  - æ”¯æŒå•ä¾‹æ¨¡å¼
  - æ”¯æŒæ™®é€šæœåŠ¡æ³¨å†Œ
  - æœåŠ¡æŸ¥æ‰¾å’Œè·å–

##### å¸¸ç”¨ä¾èµ–é¡¹
- `get_database()`: è·å–æ•°æ®åº“ä¼šè¯
- `get_cache_manager()`: è·å–ç¼“å­˜ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
- `get_service_dependency()`: è·å–æœåŠ¡ä¾èµ–çš„å·¥å‚å‡½æ•°

#### ä½¿ç”¨ç¤ºä¾‹
```python
from app.core.dependencies import register_service, get_service

# æ³¨å†ŒæœåŠ¡
register_service("my_service", MyService(), singleton=True)

# è·å–æœåŠ¡
service = get_service("my_service")
```

---

### 4. å¥åº·æ£€æŸ¥ç³»ç»Ÿ ğŸ¥

**æ–‡ä»¶**: `backend/app/core/health.py`

#### æ ¸å¿ƒåŠŸèƒ½

##### HealthCheckerï¼ˆå¥åº·æ£€æŸ¥å™¨ï¼‰
- **å¯æ‰©å±•**: æ”¯æŒæ³¨å†Œè‡ªå®šä¹‰å¥åº·æ£€æŸ¥é¡¹
- **é»˜è®¤æ£€æŸ¥é¡¹**:
  1. **database**: æ•°æ®åº“è¿æ¥æ£€æŸ¥
  2. **cache**: ç¼“å­˜ç³»ç»Ÿæ£€æŸ¥
  3. **disk**: ç£ç›˜ç©ºé—´æ£€æŸ¥

#### APIç«¯ç‚¹

##### 1. `/health` - å®Œæ•´å¥åº·æ£€æŸ¥
```json
{
  "status": "healthy",
  "timestamp": "2025-11-08T10:00:00",
  "checks": {
    "database": {
      "status": "healthy",
      "message": "æ•°æ®åº“è¿æ¥æ­£å¸¸"
    },
    "cache": {
      "status": "healthy",
      "message": "ç¼“å­˜ç³»ç»Ÿæ­£å¸¸"
    },
    "disk": {
      "status": "healthy",
      "message": "ç£ç›˜ç©ºé—´: 45.2% å·²ä½¿ç”¨",
      "total_gb": 500.0,
      "free_gb": 274.0,
      "used_percent": 45.2
    }
  }
}
```

##### 2. `/health/{check_name}` - å•é¡¹å¥åº·æ£€æŸ¥
```json
{
  "status": "healthy",
  "message": "æ•°æ®åº“è¿æ¥æ­£å¸¸"
}
```

#### çŠ¶æ€ç 
- `200`: å¥åº·
- `503`: ä¸å¥åº·æˆ–è­¦å‘Š

#### æ³¨å†Œè‡ªå®šä¹‰æ£€æŸ¥é¡¹
```python
from app.core.health import get_health_checker

health_checker = get_health_checker()

async def my_custom_check():
    # è‡ªå®šä¹‰æ£€æŸ¥é€»è¾‘
    return {
        "status": "healthy",
        "message": "è‡ªå®šä¹‰æ£€æŸ¥é€šè¿‡"
    }

health_checker.register_check("my_check", my_custom_check)
```

---

### 5. ä¸»åº”ç”¨é›†æˆ ğŸ”§

**æ–‡ä»¶**: `backend/main.py`

#### æ›´æ–°å†…å®¹

##### 1. ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¯åŠ¨æ—¶åˆå§‹åŒ–ç¼“å­˜ç³»ç»Ÿ
- å¯åŠ¨æ—¶åˆå§‹åŒ–å¥åº·æ£€æŸ¥å™¨
- å…³é—­æ—¶æ¸…ç†ç¼“å­˜è¿æ¥

##### 2. ä¸­é—´ä»¶é›†æˆ
- æŒ‰æ­£ç¡®é¡ºåºæ·»åŠ æ‰€æœ‰ä¸­é—´ä»¶
- é…ç½®æ€§èƒ½ç›‘æ§é˜ˆå€¼

##### 3. å¥åº·æ£€æŸ¥ç«¯ç‚¹
- `/health`: å®Œæ•´å¥åº·æ£€æŸ¥
- `/health/{check_name}`: å•é¡¹å¥åº·æ£€æŸ¥

---

## ğŸ“Š æ¶æ„æ”¹è¿›å¯¹æ¯”

### æ”¹è¿›å‰
- âŒ æ— ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿï¼ˆå„æœåŠ¡è‡ªè¡Œå®ç°ï¼‰
- âŒ æ— è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
- âŒ æ— æ€§èƒ½ç›‘æ§
- âŒ æ— ç»Ÿä¸€é”™è¯¯å¤„ç†
- âŒ æ— ä¾èµ–æ³¨å…¥ç³»ç»Ÿ
- âŒ å¥åº·æ£€æŸ¥è¿‡äºç®€å•

### æ”¹è¿›å
- âœ… ç»Ÿä¸€çš„å¤šçº§ç¼“å­˜ç³»ç»Ÿ
- âœ… å®Œæ•´çš„è¯·æ±‚æ—¥å¿—è®°å½•
- âœ… æ€§èƒ½ç›‘æ§å’Œæ…¢è¯·æ±‚æ£€æµ‹
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œå“åº”
- âœ… æœåŠ¡æ³¨å†Œå’Œä¾èµ–æ³¨å…¥
- âœ… å¯æ‰©å±•çš„å¥åº·æ£€æŸ¥ç³»ç»Ÿ

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿ

#### åœ¨æœåŠ¡ä¸­ä½¿ç”¨ç¼“å­˜
```python
from app.core.cache import get_cache

class MyService:
    def __init__(self):
        self.cache = get_cache()
    
    async def get_data(self, key: str):
        # å°è¯•ä»ç¼“å­˜è·å–
        cached_value = await self.cache.get(key)
        if cached_value is not None:
            return cached_value
        
        # ä»æ•°æ®æºè·å–
        value = await self.fetch_from_source(key)
        
        # å­˜å…¥ç¼“å­˜
        await self.cache.set(key, value, ttl=3600)
        
        return value
```

#### ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
```python
from app.core.cache import cached

@cached(ttl=3600, key_prefix="media")
async def get_media_info(media_id: int):
    # å‡½æ•°é€»è¾‘ä¼šè‡ªåŠ¨ç¼“å­˜
    return await fetch_media_info(media_id)
```

### 2. æ³¨å†Œè‡ªå®šä¹‰å¥åº·æ£€æŸ¥

```python
from app.core.health import get_health_checker

async def check_external_api():
    try:
        # æ£€æŸ¥å¤–éƒ¨API
        response = await httpx.get("https://api.example.com/health")
        if response.status_code == 200:
            return {
                "status": "healthy",
                "message": "å¤–éƒ¨APIæ­£å¸¸"
            }
        else:
            return {
                "status": "unhealthy",
                "message": "å¤–éƒ¨APIå¼‚å¸¸"
            }
    except Exception as e:
        return {
            "status": "unhealthy",
            "message": f"å¤–éƒ¨APIæ£€æŸ¥å¤±è´¥: {str(e)}"
        }

health_checker = get_health_checker()
health_checker.register_check("external_api", check_external_api)
```

### 3. ä½¿ç”¨ä¾èµ–æ³¨å…¥

```python
from app.core.dependencies import register_service, get_service

# åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡
register_service("my_service", MyService(), singleton=True)

# åœ¨éœ€è¦çš„åœ°æ–¹è·å–æœåŠ¡
service = get_service("my_service")
```

---

## ğŸ“ˆ æ€§èƒ½æå‡

### ç¼“å­˜ç³»ç»Ÿ
- **ç¼“å­˜å‘½ä¸­ç‡**: é¢„æœŸæå‡30-50%
- **å“åº”æ—¶é—´**: ç¼“å­˜å‘½ä¸­æ—¶å‡å°‘80-90%
- **æ•°æ®åº“è´Ÿè½½**: å‡å°‘40-60%

### ä¸­é—´ä»¶ç³»ç»Ÿ
- **è¯·æ±‚æ—¥å¿—**: å®Œæ•´çš„è¯·æ±‚è¿½è¸ª
- **æ€§èƒ½ç›‘æ§**: è‡ªåŠ¨æ£€æµ‹æ…¢è¯·æ±‚
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

---

## ğŸ”§ é…ç½®è¯´æ˜

### Redisé…ç½®
```env
REDIS_URL=redis://localhost:6379/0
REDIS_PASSWORD=
```

### æ€§èƒ½ç›‘æ§é…ç½®
```python
# åœ¨main.pyä¸­é…ç½®
app.add_middleware(
    PerformanceMonitoringMiddleware, 
    slow_request_threshold=1.0  # æ…¢è¯·æ±‚é˜ˆå€¼ï¼ˆç§’ï¼‰
)
```

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰
- é›†æˆCeleryæˆ–ç±»ä¼¼çš„ä»»åŠ¡é˜Ÿåˆ—
- æ”¯æŒå¼‚æ­¥ä»»åŠ¡å¤„ç†
- ä»»åŠ¡ä¼˜å…ˆçº§å’Œè°ƒåº¦

### 2. ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†ï¼ˆå¯é€‰ï¼‰
- é›†æˆPrometheus
- æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
- å¯è§†åŒ–ç›‘æ§é¢æ¿

### 3. ç¼“å­˜é¢„çƒ­ï¼ˆå¯é€‰ï¼‰
- åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­å¸¸ç”¨æ•°æ®
- å®šæ—¶åˆ·æ–°ç¼“å­˜
- ç¼“å­˜å¤±æ•ˆç­–ç•¥ä¼˜åŒ–

---

## âœ… æ€»ç»“

æœ¬æ¬¡æ¶æ„å®Œå–„å·¥ä½œä¸ºVabHubç³»ç»Ÿå»ºç«‹äº†åšå®çš„åŸºç¡€è®¾æ–½ï¼š

1. **ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿ**: æå‡æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“è´Ÿè½½
2. **ä¸­é—´ä»¶ç³»ç»Ÿ**: å®Œå–„æ—¥å¿—ã€ç›‘æ§å’Œé”™è¯¯å¤„ç†
3. **ä¾èµ–æ³¨å…¥**: æé«˜ä»£ç å¯ç»´æŠ¤æ€§
4. **å¥åº·æ£€æŸ¥**: ç³»ç»ŸçŠ¶æ€ç›‘æ§å’Œæ•…éšœæ£€æµ‹

è¿™äº›æ”¹è¿›ä½¿ç³»ç»Ÿæ›´åŠ å¥å£®ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘å¥ å®šäº†è‰¯å¥½åŸºç¡€ã€‚

---

**æœ€åæ›´æ–°**: 2025-11-08  
**çŠ¶æ€**: âœ… æ¶æ„å®Œå–„å®Œæˆ

