# 阶段3: 115网盘集成改进实施计划

## 📋 目标
完善115网盘集成，实现PKCE认证、OSS上传和文件操作优化

## ✅ 当前状态

### 已完成
- ✅ PKCE认证（已在generate_qr_code中实现）
- ✅ 基础文件操作（list_files, get_file_info, create_folder, delete_file）
- ✅ 文件操作扩展（move_file, copy_file, rename_file）
- ✅ 密钥管理（只需要AppID和AppKey）

### 待实现
- ⏳ OSS上传功能（分片上传、秒传、断点续传）
- ⏳ SHA1计算工具方法
- ⏳ 上传进度回调
- ⏳ 错误处理和重试机制

## 🎯 实施任务

### 任务1: 添加OSS依赖
- [ ] 添加oss2到requirements.txt
- [ ] 安装依赖

### 任务2: 实现SHA1计算
- [ ] 实现_calc_sha1方法（完整文件SHA1）
- [ ] 实现_calc_sha1_preid方法（前128MB的SHA1，用于秒传）

### 任务3: 实现OSS上传
- [ ] 实现上传初始化（init upload）
- [ ] 实现二次认证处理
- [ ] 实现秒传检测
- [ ] 实现获取上传凭证
- [ ] 实现断点续传检测
- [ ] 实现分片上传
- [ ] 实现完成上传回调

### 任务4: 优化文件操作
- [ ] 优化move_file（已实现，需测试）
- [ ] 优化copy_file（已实现，需测试）
- [ ] 优化rename_file（已实现，需测试）

### 任务5: 测试和验证
- [ ] 测试PKCE认证流程
- [ ] 测试OSS上传（小文件）
- [ ] 测试OSS上传（大文件，分片）
- [ ] 测试秒传功能
- [ ] 测试断点续传
- [ ] 测试文件操作

## 📝 技术细节

### OSS上传流程
1. **初始化上传** - 获取bucket、object、callback等信息
2. **二次认证** - 如果需要，计算指定区间的SHA1
3. **秒传检测** - 如果文件已存在，直接返回
4. **获取上传凭证** - 获取OSS的AccessKeyId、AccessKeySecret、SecurityToken
5. **断点续传检测** - 检查是否有未完成的上传
6. **分片上传** - 使用oss2进行分片上传
7. **完成上传** - 调用回调完成上传

### SHA1计算
- **完整文件SHA1**: 用于文件唯一标识
- **前128MB SHA1**: 用于秒传检测（preid）

### 分片上传
- 默认分片大小: 10MB
- 使用oss2的determine_part_size确定分片大小
- 使用SizedFileAdapter处理文件读取
- 支持进度回调

## 🚀 实施步骤

### 第1步: 添加依赖
```bash
pip install oss2
```

### 第2步: 实现SHA1计算
- 实现_calc_sha1方法
- 实现_calc_sha1_preid方法

### 第3步: 实现OSS上传
- 实现upload_file方法的完整逻辑
- 添加错误处理和重试机制
- 添加进度回调支持

### 第4步: 测试
- 单元测试
- 集成测试
- 性能测试

## 📚 参考
- MoviePilot实现: `MoviePilot/MoviePilot-2/app/modules/filemanager/storages/u115.py`
- OSS2文档: https://help.aliyun.com/document_detail/32026.html

---

**状态**: 进行中  
**开始时间**: 2025-01-XX  
**预计完成**: 2025-01-XX

