# è¦†ç›–æ¨¡å¼å®ç°å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆ

### 1. è¦†ç›–æ¨¡å¼å¤„ç†æ¨¡å—

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/file_operation/overwrite_handler.py`

**åŠŸèƒ½**ï¼š
- âœ… å®ç°å››ç§è¦†ç›–æ¨¡å¼ï¼š`never`ã€`always`ã€`size`ã€`latest`
- âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨ï¼ˆ115/123ï¼‰
- âœ… å®ç°ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤åŠŸèƒ½ï¼ˆ`latest`æ¨¡å¼ï¼‰
- âœ… é›†æˆåª’ä½“ä¿¡æ¯è§£æï¼ˆç”¨äºè¯†åˆ«ç›¸åŒåª’ä½“ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `check_overwrite()`: æ£€æŸ¥æ˜¯å¦åº”è¯¥è¦†ç›–ç°æœ‰æ–‡ä»¶
- `delete_version_files()`: åˆ é™¤ç‰ˆæœ¬æ–‡ä»¶ï¼ˆlatestæ¨¡å¼ï¼‰
- `_is_same_media()`: æ£€æŸ¥æ˜¯å¦æ˜¯ç›¸åŒåª’ä½“ï¼ˆç”µå½±ï¼štitle+yearï¼Œå‰§é›†ï¼štitle+season+episodeï¼‰

### 2. è¦†ç›–æ¨¡å¼ç±»å‹

| æ¨¡å¼ | è¯´æ˜ | è¡Œä¸º |
|------|------|------|
| `never` | ä»ä¸è¦†ç›– | å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡æ“ä½œï¼Œè¿”å›å¤±è´¥ |
| `always` | æ€»æ˜¯è¦†ç›– | å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œç›´æ¥è¦†ç›– |
| `size` | æŒ‰æ–‡ä»¶å¤§å° | å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ¯”è¾ƒæ–‡ä»¶å¤§å°ï¼Œæ–°æ–‡ä»¶æ›´å¤§æ—¶è¦†ç›– |
| `latest` | ä»…ä¿ç•™æœ€æ–° | å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ€»æ˜¯è¦†ç›–ï¼Œå¹¶åˆ é™¤æ—§ç‰ˆæœ¬æ–‡ä»¶ |

### 3. ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤é€»è¾‘

**åŠŸèƒ½**ï¼šåˆ é™¤åŒä¸€ç›®å½•ä¸‹çš„å…¶ä»–ç‰ˆæœ¬æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼š`movie.mkv`, `movie.1080p.mkv`, `movie.720p.mkv`ç­‰ï¼‰

**å®ç°é€»è¾‘**ï¼š
1. è§£æç›®æ ‡æ–‡ä»¶çš„åª’ä½“ä¿¡æ¯ï¼ˆtitleã€yearã€seasonã€episodeï¼‰
2. è·å–çˆ¶ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
3. è¯†åˆ«ç›¸åŒåª’ä½“çš„æ–‡ä»¶ï¼ˆç”µå½±ï¼štitle+yearï¼Œå‰§é›†ï¼štitle+season+episodeï¼‰
4. åˆ é™¤é™¤å½“å‰æ–‡ä»¶å¤–çš„æ‰€æœ‰ç‰ˆæœ¬æ–‡ä»¶

## ğŸ“‹ å¾…å®Œæˆ

### 1. æ›´æ–°æ–‡ä»¶æ“ä½œæ¨¡å—

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/strm/file_handler.py`

**ä»»åŠ¡**ï¼š
- [ ] é›†æˆè¦†ç›–æ¨¡å¼å¤„ç†
- [ ] æ”¯æŒä¸Šä¼ åˆ°115ç½‘ç›˜æ—¶çš„è¦†ç›–æ¨¡å¼
- [ ] æ”¯æŒç§»åŠ¨åˆ°æœ¬åœ°å­˜å‚¨æ—¶çš„è¦†ç›–æ¨¡å¼
- [ ] æ”¯æŒå¤åˆ¶åˆ°æœ¬åœ°å­˜å‚¨æ—¶çš„è¦†ç›–æ¨¡å¼

### 2. ç®€åŒ–STRMç³»ç»Ÿ

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/strm/generator.py`

**ä»»åŠ¡**ï¼š
- [ ] ç§»é™¤è¦†ç›–æ¨¡å¼ç›¸å…³ä»£ç ï¼ˆè¦†ç›–æ¨¡å¼ä¸ç”¨äºSTRMæ–‡ä»¶ï¼‰
- [ ] åªä¿ç•™STRMæ–‡ä»¶ç”Ÿæˆæ ¸å¿ƒåŠŸèƒ½
- [ ] ç®€åŒ–é…ç½®å’Œé€»è¾‘

### 3. å®ç°åˆ®å‰ŠåŠŸèƒ½é›†æˆ

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/strm/scraper.py`ï¼ˆæ–°å»ºï¼‰

**ä»»åŠ¡**ï¼š
- [ ] å®ç°115ç½‘ç›˜åˆ®å‰Šæ–‡ä»¶ä¸‹è½½
- [ ] å®ç°æœ¬åœ°STRMåª’ä½“åº“åˆ®å‰Š
- [ ] å®ç°åˆ®å‰Šæ–‡ä»¶åŒæ­¥

### 4. å®ç°æœåŠ¡å¼€å…³

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/strm/config.py`

**ä»»åŠ¡**ï¼š
- [ ] åœ¨STRMé…ç½®ä¸­æ·»åŠ æœåŠ¡å¼€å…³ï¼ˆ`enabled`å­—æ®µï¼‰
- [ ] åœ¨STRMç”Ÿæˆå™¨ä¸­æ£€æŸ¥æœåŠ¡å¼€å…³
- [ ] åœ¨APIç«¯ç‚¹ä¸­æ£€æŸ¥æœåŠ¡å¼€å…³

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### è¦†ç›–æ¨¡å¼æ£€æŸ¥

```python
from app.modules.file_operation import OverwriteHandler, OverwriteMode
from pathlib import Path

# æ£€æŸ¥æ˜¯å¦åº”è¯¥è¦†ç›–
target_path = Path("/media/movie.mkv")
new_file_size = 1024 * 1024 * 1024  # 1GB

should_overwrite, reason = await OverwriteHandler.check_overwrite(
    target_path=target_path,
    overwrite_mode=OverwriteMode.SIZE,
    new_file_size=new_file_size,
    storage_type="local"
)

if should_overwrite:
    # æ‰§è¡Œæ–‡ä»¶æ“ä½œ
    pass
else:
    # è·³è¿‡æ“ä½œ
    logger.info(f"è·³è¿‡æ“ä½œ: {reason}")
```

### ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤ï¼ˆlatestæ¨¡å¼ï¼‰

```python
from app.modules.file_operation import OverwriteHandler
from pathlib import Path
from app.modules.media_renamer.parser import MediaInfo

target_path = Path("/media/movie.mkv")
media_info = MediaInfo(title="Movie", year=2023, media_type="movie")

deleted_files = await OverwriteHandler.delete_version_files(
    target_path=target_path,
    storage_type="local",
    media_info=media_info
)

logger.info(f"åˆ é™¤äº† {len(deleted_files)} ä¸ªç‰ˆæœ¬æ–‡ä»¶")
```

## ğŸ“š å‚è€ƒå®ç°

### MoviePilotè¦†ç›–æ¨¡å¼
- `never`ï¼šä»ä¸è¦†ç›–
- `always`ï¼šæ€»æ˜¯è¦†ç›–
- `size`ï¼šæŒ‰å¤§å°è¦†ç›–ï¼ˆå¤§è¦†ç›–å°ï¼‰
- `latest`ï¼šä»…ä¿ç•™æœ€æ–°ç‰ˆæœ¬

### VabHub-1è¦†ç›–æ¨¡å¼
- æ”¯æŒç›¸åŒçš„å››ç§è¦†ç›–æ¨¡å¼
- ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤é€»è¾‘ç›¸åŒ

## âœ… ä¸‹ä¸€æ­¥

1. **æ›´æ–°æ–‡ä»¶æ“ä½œæ¨¡å—**ï¼šé›†æˆè¦†ç›–æ¨¡å¼å¤„ç†
2. **ç®€åŒ–STRMç³»ç»Ÿ**ï¼šç§»é™¤è¦†ç›–æ¨¡å¼ç›¸å…³ä»£ç 
3. **å®ç°åˆ®å‰ŠåŠŸèƒ½é›†æˆ**ï¼š115ç½‘ç›˜å’Œæœ¬åœ°åˆ®å‰Š
4. **å®ç°æœåŠ¡å¼€å…³**ï¼šSTRMæœåŠ¡å¼€å…³

