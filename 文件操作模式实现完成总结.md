# æ–‡ä»¶æ“ä½œæ¨¡å¼å®ç°å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆ

### 1. æ–‡ä»¶æ“ä½œæ¨¡å¼å®šä¹‰

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/strm/file_operation_mode.py`

**æ›´æ–°å†…å®¹**ï¼š
- âœ… ç®€åŒ–æ–‡ä»¶æ“ä½œæ¨¡å¼æšä¸¾ï¼š`COPY`ã€`MOVE`ã€`LINK`ï¼ˆç¡¬é“¾æ¥ï¼‰ã€`SOFTLINK`ï¼ˆè½¯é“¾æ¥ï¼‰
- âœ… æ›´æ–°`get_available_modes()`ï¼šæ ¹æ®æºå­˜å‚¨å’Œç›®æ ‡å­˜å‚¨è¿”å›å¯ç”¨æ¨¡å¼
- âœ… æ›´æ–°`validate_operation_mode()`ï¼šéªŒè¯æ“ä½œæ¨¡å¼æ˜¯å¦é€‚ç”¨äºæŒ‡å®šçš„å­˜å‚¨ç±»å‹
- âœ… æ›´æ–°`FileOperationConfig`ï¼šæ·»åŠ `source_storage`ã€`target_storage`ã€`overwrite_mode`å­—æ®µ

### 2. è¦†ç›–æ¨¡å¼å¤„ç†æ¨¡å—

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/file_operation/overwrite_handler.py`

**åŠŸèƒ½**ï¼š
- âœ… å®ç°å››ç§è¦†ç›–æ¨¡å¼ï¼š`never`ã€`always`ã€`size`ã€`latest`
- âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨
- âœ… å®ç°ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤åŠŸèƒ½ï¼ˆ`latest`æ¨¡å¼ï¼‰

### 3. æ–‡ä»¶ä¼ è¾“å¤„ç†å™¨

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/file_operation/transfer_handler.py`

**åŠŸèƒ½**ï¼š
- âœ… å‚è€ƒMoviePilotçš„å®ç°
- âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ4ç§æ¨¡å¼ï¼šcopyã€moveã€linkã€softlinkï¼‰
- âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼šcopyã€moveï¼‰
- âœ… æ”¯æŒäº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼šcopyã€moveï¼‰
- âœ… æ”¯æŒäº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼šcopyã€moveï¼‰
- âœ… é›†æˆè¦†ç›–æ¨¡å¼å¤„ç†

## ğŸ“Š æ–‡ä»¶æ“ä½œæ¨¡å¼æ”¯æŒçŸ©é˜µ

| æºå­˜å‚¨ | ç›®æ ‡å­˜å‚¨ | æ”¯æŒçš„æ¨¡å¼ |
|--------|----------|------------|
| local | local | copy, move, link, softlink |
| local | 115/123 | copy, move |
| 115/123 | local | copy, move |
| 115/123 | 115/123 | copy, move |

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. æœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨

```python
# æ”¯æŒ4ç§æ¨¡å¼
if transfer_type == "copy":
    shutil.copy2(source_path, target_path)
elif transfer_type == "move":
    shutil.move(source_path, target_path)
elif transfer_type == "link":
    os.link(source_path, target_path)  # ç¡¬é“¾æ¥
elif transfer_type == "softlink":
    target_path.symlink_to(source_path)  # è½¯é“¾æ¥
```

### 2. æœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨

```python
# åªæ”¯æŒ2ç§æ¨¡å¼
if transfer_type == "copy":
    # ä¸Šä¼ æ–‡ä»¶ï¼Œä¿ç•™æœ¬åœ°æ–‡ä»¶
    target_oper.upload(target_folder, source_path, target_path.name)
elif transfer_type == "move":
    # ä¸Šä¼ æ–‡ä»¶ï¼Œåˆ é™¤æœ¬åœ°æ–‡ä»¶
    target_oper.upload(target_folder, source_path, target_path.name)
    source_path.unlink()
```

### 3. äº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨

```python
# åªæ”¯æŒ2ç§æ¨¡å¼
if transfer_type == "copy":
    # ä¸‹è½½æ–‡ä»¶ï¼Œä¿ç•™äº‘å­˜å‚¨æ–‡ä»¶
    tmp_file = source_oper.download(fileitem, target_path.parent)
    shutil.move(tmp_file, target_path)
elif transfer_type == "move":
    # ä¸‹è½½æ–‡ä»¶ï¼Œåˆ é™¤äº‘å­˜å‚¨æ–‡ä»¶
    tmp_file = source_oper.download(fileitem, target_path.parent)
    shutil.move(tmp_file, target_path)
    source_oper.delete(fileitem)
```

### 4. äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨

```python
# åªæ”¯æŒ2ç§æ¨¡å¼
if transfer_type == "copy":
    # å¤åˆ¶æ–‡ä»¶åˆ°æ–°ç›®å½•
    source_oper.copy(fileitem, target_folder, target_path.name)
elif transfer_type == "move":
    # ç§»åŠ¨æ–‡ä»¶åˆ°æ–°ç›®å½•
    source_oper.move(fileitem, target_folder, target_path.name)
```

## ğŸ“ è¦†ç›–æ¨¡å¼é›†æˆ

### è¦†ç›–æ¨¡å¼æ£€æŸ¥æµç¨‹

1. **æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨**
2. **æ ¹æ®è¦†ç›–æ¨¡å¼å†³å®šæ˜¯å¦è¦†ç›–**
   - `never`ï¼šä¸è¦†ç›–ï¼Œè¿”å›å¤±è´¥
   - `always`ï¼šæ€»æ˜¯è¦†ç›–
   - `size`ï¼šæ¯”è¾ƒæ–‡ä»¶å¤§å°ï¼Œæ–°æ–‡ä»¶æ›´å¤§æ—¶è¦†ç›–
   - `latest`ï¼šæ€»æ˜¯è¦†ç›–ï¼Œå¹¶åˆ é™¤æ—§ç‰ˆæœ¬æ–‡ä»¶
3. **æ‰§è¡Œæ–‡ä»¶æ“ä½œ**ï¼ˆå¦‚æœå…è®¸è¦†ç›–ï¼‰

## âœ… ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°æ–‡ä»¶æ“ä½œæ¨¡å—**ï¼šåœ¨æ–‡ä»¶æ“ä½œæ¨¡å—ä¸­ä½¿ç”¨`TransferHandler`
2. **å®ç°StorageBaseæ¥å£**ï¼šä¸ºæœ¬åœ°å­˜å‚¨å’Œ115ç½‘ç›˜å­˜å‚¨å®ç°ç»Ÿä¸€æ¥å£
3. **ç®€åŒ–STRMç³»ç»Ÿ**ï¼šç§»é™¤è¦†ç›–æ¨¡å¼ç›¸å…³ä»£ç ï¼ˆè¦†ç›–æ¨¡å¼ä¸ç”¨äºSTRMæ–‡ä»¶ï¼‰
4. **å®ç°åˆ®å‰ŠåŠŸèƒ½é›†æˆ**ï¼š115ç½‘ç›˜å’Œæœ¬åœ°åˆ®å‰Š
5. **å®ç°æœåŠ¡å¼€å…³**ï¼šSTRMæœåŠ¡å¼€å…³

## ğŸ“š å‚è€ƒå®ç°

### MoviePilotå®ç°

- **æœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨**ï¼šæ”¯æŒcopyã€moveã€linkã€softlink
- **æœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨**ï¼šæ”¯æŒcopyã€move
- **äº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨**ï¼šæ”¯æŒcopyã€move
- **äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨**ï¼šæ”¯æŒcopyã€move

### VabHubå®ç°

- âœ… å‚è€ƒMoviePilotçš„å®ç°
- âœ… æ”¯æŒç›¸åŒçš„æ–‡ä»¶æ“ä½œæ¨¡å¼
- âœ… é›†æˆè¦†ç›–æ¨¡å¼å¤„ç†
- âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨

