# 系统设置功能实现总结

**实现时间**: 2025-01-XX  
**参考**: MoviePilot系统设置页面  
**状态**: ✅ 已完成

---

## 📋 一、实现概述

实现了MoviePilot风格的系统设置功能，包括基础设置和高级设置（5个标签页），提供了完整的系统配置管理界面。

---

## 📋 二、后端实现

### 2.1 配置模型扩展

**文件**: `VabHub/backend/app/core/config.py`

**新增配置项**:

#### 基础设置
- `APP_DOMAIN`: 访问域名
- `RECOGNIZE_SOURCE`: 识别数据源（themoviedb/douban）
- `API_TOKEN`: API令牌
- `WALLPAPER`: 背景壁纸来源
- `CUSTOMIZE_WALLPAPER_API_URL`: 自定义壁纸API URL
- `MEDIASERVER_SYNC_INTERVAL`: 媒体服务器同步间隔
- `GITHUB_TOKEN`: Github Token

#### 高级设置 - 系统
- `AUXILIARY_AUTH_ENABLE`: 用户辅助认证
- `GLOBAL_IMAGE_CACHE`: 全局图片缓存
- `SUBSCRIBE_STATISTIC_SHARE`: 分享订阅数据
- `WORKFLOW_STATISTIC_SHARE`: 分享工作流数据
- `PLUGIN_STATISTIC_SHARE`: 上报插件安装数据
- `BIG_MEMORY_MODE`: 大内存模式
- `DB_WAL_ENABLE`: 数据库WAL模式
- `VABHUB_AUTO_UPDATE`: 自动更新VabHub
- `AUTO_UPDATE_RESOURCE`: 自动更新站点资源

#### 高级设置 - 媒体
- `TMDB_API_DOMAIN`: TMDB API域名
- `TMDB_IMAGE_DOMAIN`: TMDB图片域名
- `TMDB_LOCALE`: TMDB元数据语言
- `META_CACHE_EXPIRE`: 元数据缓存过期时间
- `SCRAP_FOLLOW_TMDB`: 刮削跟随TMDB
- `FANART_ENABLE`: Fanart启用
- `FANART_LANG`: Fanart语言
- `TMDB_SCRAP_ORIGINAL_IMAGE`: 刮削使用TMDB原始语种图片

#### 高级设置 - 网络
- `GITHUB_PROXY`: Github代理
- `PIP_PROXY`: PIP代理
- `SECURITY_IMAGE_DOMAINS`: 安全图片域名列表

#### 高级设置 - 日志
- `LOG_MAX_FILE_SIZE`: 日志文件最大大小
- `LOG_BACKUP_COUNT`: 日志备份数量
- `LOG_FILE_FORMAT`: 日志文件格式

#### 高级设置 - 实验室
- `PLUGIN_AUTO_RELOAD`: 插件自动重载
- `ENCODING_DETECTION_PERFORMANCE_MODE`: 编码检测性能模式

### 2.2 系统设置API

**文件**: `VabHub/backend/app/api/system_settings.py`

**主要端点**:
- `GET /api/v1/system/env` - 获取系统环境变量（配置）
- `POST /api/v1/system/env` - 更新系统环境变量（配置）

**功能特性**:
- ✅ 自动验证API_TOKEN（长度至少16个字符）
- ✅ 自动生成API_TOKEN（如果未设置或长度不足）
- ✅ 支持空字符串清理（设置为null以恢复默认值）
- ✅ 配置分类管理（basic, advanced_system, advanced_media, advanced_network, advanced_log, advanced_lab）
- ✅ 加密字段支持（API_TOKEN, GITHUB_TOKEN等）

### 2.3 刮削开关设置API

**文件**: `VabHub/backend/app/api/scraping_switches.py`

**主要端点**:
- `GET /api/v1/system/setting/ScrapingSwitchs` - 获取刮削开关设置
- `POST /api/v1/system/setting/ScrapingSwitchs` - 更新刮削开关设置

**支持的开关**:
- **电影**: NFO, 海报, 背景图, Logo, 光盘图, 横幅图, 缩略图
- **电视剧**: NFO, 海报, 背景图, 横幅图, Logo, 缩略图
- **季**: NFO, 海报, 横幅图, 缩略图
- **集**: NFO, 缩略图

---

## 📋 三、前端实现

### 3.1 系统设置页面

**文件**: `VabHub/frontend/src/pages/SystemSettings.vue`

**主要功能**:
- ✅ 基础设置表单（访问域名、识别数据源、API令牌、验证码识别服务器等）
- ✅ 高级设置对话框（5个标签页）
- ✅ API令牌生成和复制功能
- ✅ 配置加载和保存
- ✅ 表单验证

### 3.2 标签页组件

#### 系统标签 (`SystemTab.vue`)
- ✅ 用户辅助认证开关
- ✅ 全局图片缓存开关
- ✅ 分享订阅数据开关
- ✅ 上报插件安装数据开关
- ✅ 分享工作流数据开关
- ✅ 大内存模式开关
- ✅ 数据库WAL模式开关（仅SQLite）
- ✅ 自动更新VabHub开关
- ✅ 自动更新站点资源开关

#### 媒体标签 (`MediaTab.vue`)
- ✅ TMDB API域名配置
- ✅ TMDB图片域名配置
- ✅ TMDB元数据语言配置
- ✅ 元数据缓存过期时间配置
- ✅ 刮削跟随TMDB开关
- ✅ 刮削原始图片开关
- ✅ Fanart启用开关
- ✅ Fanart语言多选配置
- ✅ **刮削开关设置**（展开面板）
  - 电影：NFO, 海报, 背景图, Logo, 光盘图, 横幅图, 缩略图
  - 电视剧：NFO, 海报, 背景图, 横幅图, Logo, 缩略图
  - 季：NFO, 海报, 横幅图, 缩略图
  - 集：NFO, 缩略图

#### 网络标签 (`NetworkTab.vue`)
- ✅ 代理服务器配置
- ✅ Github代理配置
- ✅ PIP代理配置（预设多个镜像站）
- ✅ DOH启用开关
- ✅ DOH解析器配置
- ✅ DOH域名配置
- ✅ **安全图片域名管理**（展开面板，支持添加/删除）

#### 日志标签 (`LogTab.vue`)
- ✅ 调试模式开关
- ✅ 日志级别选择（当调试模式关闭时）
- ✅ 日志文件最大大小配置
- ✅ 日志备份数量配置
- ✅ 日志文件格式配置

#### 实验室标签 (`LabTab.vue`)
- ✅ 插件自动重载开关
- ✅ 编码检测性能模式开关

### 3.3 路由配置

**文件**: `VabHub/frontend/src/router/index.ts`

**新增路由**:
```typescript
{
  path: '/system-settings',
  name: 'SystemSettings',
  component: () => import('@/pages/SystemSettings.vue'),
  meta: { requiresAuth: true, title: '系统设置' }
}
```

---

## 📋 四、功能特性

### 4.1 基础设置

1. **访问域名**: 用于发送通知时，添加快捷跳转地址
2. **识别数据源**: 设置默认媒体信息识别数据源（TheMovieDb/豆瓣）
3. **API令牌**: 
   - 自动验证长度（至少16个字符）
   - 支持自动生成
   - 支持复制到剪贴板
4. **验证码识别服务器**: 用于站点签到、更新站点Cookie等识别验证码
5. **背景壁纸**: 选择登录页面背景来源（TMDB/Bing/媒体服务器/自定义/无）
6. **自定义壁纸API**: 当选择自定义壁纸时显示
7. **媒体服务器同步间隔**: 媒体服务器同步间隔时间（小时）
8. **Github Token**: 用于访问Github API（可选）

### 4.2 高级设置

#### 系统标签
- 9个开关配置项，涵盖用户认证、数据分享、性能优化等方面

#### 媒体标签
- TMDB配置（API域名、图片域名、元数据语言）
- 元数据缓存配置
- 刮削配置（跟随TMDB、原始图片）
- Fanart配置（启用、语言）
- **刮削开关设置**（精确控制各种元数据文件的生成）

#### 网络标签
- 代理配置（全局代理、Github代理、PIP代理）
- DOH配置（启用、解析器、域名）
- **安全图片域名管理**（支持添加/删除多个域名）

#### 日志标签
- 调试模式开关
- 日志级别选择
- 日志文件大小和备份配置
- 日志文件格式配置

#### 实验室标签
- 插件自动重载
- 编码检测性能模式

---

## 📋 五、API端点总结

### 5.1 系统设置API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/v1/system/env` | 获取系统环境变量（配置） |
| POST | `/api/v1/system/env` | 更新系统环境变量（配置） |

### 5.2 刮削开关设置API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/v1/system/setting/ScrapingSwitchs` | 获取刮削开关设置 |
| POST | `/api/v1/system/setting/ScrapingSwitchs` | 更新刮削开关设置 |

---

## 📋 六、文件清单

### 后端文件
- ✅ `VabHub/backend/app/core/config.py` - 配置模型扩展
- ✅ `VabHub/backend/app/api/system_settings.py` - 系统设置API
- ✅ `VabHub/backend/app/api/scraping_switches.py` - 刮削开关设置API
- ✅ `VabHub/backend/app/api/__init__.py` - 路由注册

### 前端文件
- ✅ `VabHub/frontend/src/pages/SystemSettings.vue` - 系统设置页面
- ✅ `VabHub/frontend/src/components/settings/SystemTab.vue` - 系统标签页
- ✅ `VabHub/frontend/src/components/settings/MediaTab.vue` - 媒体标签页
- ✅ `VabHub/frontend/src/components/settings/NetworkTab.vue` - 网络标签页
- ✅ `VabHub/frontend/src/components/settings/LogTab.vue` - 日志标签页
- ✅ `VabHub/frontend/src/components/settings/LabTab.vue` - 实验室标签页
- ✅ `VabHub/frontend/src/router/index.ts` - 路由配置

---

## 📋 七、使用说明

### 7.1 访问系统设置

1. 登录VabHub系统
2. 导航到 `/system-settings` 页面
3. 或通过菜单访问"系统设置"

### 7.2 配置基础设置

1. 在"基础设置"卡片中填写各项配置
2. 点击"保存"按钮保存配置
3. API令牌可以点击刷新图标自动生成，或点击复制图标复制到剪贴板

### 7.3 配置高级设置

1. 点击"高级设置"按钮打开高级设置对话框
2. 在5个标签页中配置各项设置
3. 点击"保存"按钮保存所有高级设置

### 7.4 配置刮削开关

1. 在高级设置的"媒体"标签页中
2. 展开"刮削开关设置"面板
3. 勾选/取消勾选需要生成的各种元数据文件
4. 点击"保存"按钮保存配置

---

## 📋 八、后续优化建议

1. **配置验证增强**: 添加更详细的配置验证规则
2. **配置导入/导出**: 支持配置的导入和导出功能
3. **配置历史**: 记录配置变更历史，支持回滚
4. **配置模板**: 提供预设的配置模板（开发环境、生产环境等）
5. **实时预览**: 某些配置项支持实时预览效果
6. **配置搜索**: 在高级设置中添加配置搜索功能

---

## 📋 九、总结

✅ **已完成功能**:
- 基础设置（8个配置项）
- 高级设置 - 系统标签（9个配置项）
- 高级设置 - 媒体标签（8个配置项 + 刮削开关设置）
- 高级设置 - 网络标签（7个配置项 + 安全图片域名管理）
- 高级设置 - 日志标签（5个配置项）
- 高级设置 - 实验室标签（2个配置项）
- API端点实现
- 前端页面和组件实现

🎯 **核心特性**:
- ✅ MoviePilot风格的界面设计
- ✅ 完整的配置管理功能
- ✅ 精确的刮削开关控制
- ✅ 安全的API令牌管理
- ✅ 友好的用户体验

---

**文档版本**: 1.0  
**最后更新**: 2025-01-XX

