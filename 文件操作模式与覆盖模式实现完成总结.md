# æ–‡ä»¶æ“ä½œæ¨¡å¼ä¸è¦†ç›–æ¨¡å¼å®ç°å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆ

### 1. æ–‡ä»¶æ“ä½œæ¨¡å¼å®šä¹‰ï¼ˆå‚è€ƒMoviePilotï¼‰

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/strm/file_operation_mode.py`

**æ›´æ–°å†…å®¹**ï¼š
- âœ… ç®€åŒ–æ–‡ä»¶æ“ä½œæ¨¡å¼æšä¸¾ï¼š`COPY`ã€`MOVE`ã€`LINK`ï¼ˆç¡¬é“¾æ¥ï¼‰ã€`SOFTLINK`ï¼ˆè½¯é“¾æ¥ï¼‰
- âœ… æ›´æ–°`get_available_modes()`ï¼šæ ¹æ®æºå­˜å‚¨å’Œç›®æ ‡å­˜å‚¨è¿”å›å¯ç”¨æ¨¡å¼
  - æœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼šæ”¯æŒæ‰€æœ‰4ç§æ¨¡å¼ï¼ˆcopyã€moveã€linkã€softlinkï¼‰
  - å…¶ä»–æƒ…å†µï¼ˆæœ¬åœ°åˆ°äº‘å­˜å‚¨ã€äº‘å­˜å‚¨åˆ°æœ¬åœ°ã€äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼‰ï¼šåªæ”¯æŒ2ç§æ¨¡å¼ï¼ˆcopyã€moveï¼‰
- âœ… æ›´æ–°`validate_operation_mode()`ï¼šéªŒè¯æ“ä½œæ¨¡å¼æ˜¯å¦é€‚ç”¨äºæŒ‡å®šçš„å­˜å‚¨ç±»å‹
- âœ… æ›´æ–°`FileOperationConfig`ï¼š
  - æ·»åŠ `source_storage`å’Œ`target_storage`å­—æ®µ
  - æ·»åŠ `overwrite_mode`å­—æ®µï¼ˆnever/always/size/latestï¼‰

### 2. è¦†ç›–æ¨¡å¼å¤„ç†æ¨¡å—

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/file_operation/overwrite_handler.py`

**åŠŸèƒ½**ï¼š
- âœ… å®ç°å››ç§è¦†ç›–æ¨¡å¼ï¼š`never`ã€`always`ã€`size`ã€`latest`
- âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨
- âœ… å®ç°ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤åŠŸèƒ½ï¼ˆ`latest`æ¨¡å¼ï¼‰
- âœ… é›†æˆåª’ä½“ä¿¡æ¯è§£æï¼ˆç”¨äºè¯†åˆ«ç›¸åŒåª’ä½“ï¼‰

### 3. æ–‡ä»¶ä¼ è¾“å¤„ç†å™¨ï¼ˆå‚è€ƒMoviePilotï¼‰

**æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/file_operation/transfer_handler.py`

**åŠŸèƒ½**ï¼š
- âœ… å‚è€ƒMoviePilotçš„`transhandler.py`å®ç°
- âœ… æ”¯æŒ4ç§ä¼ è¾“åœºæ™¯ï¼š
  1. **æœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨**ï¼šæ”¯æŒcopyã€moveã€linkã€softlink
  2. **æœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨**ï¼šæ”¯æŒcopyã€move
  3. **äº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨**ï¼šæ”¯æŒcopyã€move
  4. **äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨**ï¼šæ”¯æŒcopyã€move
- âœ… é›†æˆè¦†ç›–æ¨¡å¼å¤„ç†
- âœ… æ”¯æŒç‰ˆæœ¬æ–‡ä»¶åˆ é™¤ï¼ˆlatestæ¨¡å¼ï¼‰

## ğŸ“Š æ–‡ä»¶æ“ä½œæ¨¡å¼æ”¯æŒçŸ©é˜µ

| æºå­˜å‚¨ | ç›®æ ‡å­˜å‚¨ | æ”¯æŒçš„æ¨¡å¼ | è¯´æ˜ |
|--------|----------|------------|------|
| local | local | copy, move, link, softlink | æœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ”¯æŒæ‰€æœ‰æ¨¡å¼ |
| local | 115/123 | copy, move | æœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼Œåªæ”¯æŒå¤åˆ¶å’Œç§»åŠ¨ |
| 115/123 | local | copy, move | äº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼Œåªæ”¯æŒå¤åˆ¶å’Œç§»åŠ¨ |
| 115/123 | 115/123 | copy, move | äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼Œåªæ”¯æŒå¤åˆ¶å’Œç§»åŠ¨ |

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. æœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ4ç§æ¨¡å¼ï¼‰

```python
# åˆ›å»ºç›®å½•
target_path.parent.mkdir(parents=True, exist_ok=True)

if transfer_type == "copy":
    shutil.copy2(source_path, target_path)  # å¤åˆ¶
elif transfer_type == "move":
    shutil.move(source_path, target_path)  # ç§»åŠ¨
elif transfer_type == "link":
    os.link(source_path, target_path)  # ç¡¬é“¾æ¥
elif transfer_type == "softlink":
    target_path.symlink_to(source_path)  # è½¯é“¾æ¥
```

### 2. æœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼‰

```python
# è·å–ç›®æ ‡æ–‡ä»¶å¤¹
target_folder = target_oper.get_folder(target_path.parent)

# ä¸Šä¼ æ–‡ä»¶
new_item = target_oper.upload(target_folder, source_path, target_path.name)

if transfer_type == "copy":
    # å¤åˆ¶ï¼šä¸Šä¼ æ–‡ä»¶ï¼Œä¿ç•™æœ¬åœ°æ–‡ä»¶
    pass
elif transfer_type == "move":
    # ç§»åŠ¨ï¼šä¸Šä¼ æ–‡ä»¶ï¼Œåˆ é™¤æœ¬åœ°æ–‡ä»¶
    source_path.unlink()
```

### 3. äº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼‰

```python
# ä¸‹è½½æ–‡ä»¶
tmp_file = source_oper.download(fileitem, target_path.parent)

# ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
shutil.move(tmp_file, target_path)

if transfer_type == "copy":
    # å¤åˆ¶ï¼šä¸‹è½½æ–‡ä»¶ï¼Œä¿ç•™äº‘å­˜å‚¨æ–‡ä»¶
    pass
elif transfer_type == "move":
    # ç§»åŠ¨ï¼šä¸‹è½½æ–‡ä»¶ï¼Œåˆ é™¤äº‘å­˜å‚¨æ–‡ä»¶
    source_oper.delete(fileitem)
```

### 4. äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼‰

```python
if transfer_type == "copy":
    # å¤åˆ¶ï¼šè°ƒç”¨115 API /open/ufile/copy
    source_oper.copy(fileitem, target_folder, target_path.name)
elif transfer_type == "move":
    # ç§»åŠ¨ï¼šè°ƒç”¨115 API /open/ufile/move
    source_oper.move(fileitem, target_folder, target_path.name)
```

## ğŸ“ è¦†ç›–æ¨¡å¼é›†æˆ

### è¦†ç›–æ¨¡å¼æ£€æŸ¥æµç¨‹

1. **æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨**
   - æœ¬åœ°å­˜å‚¨ï¼šä½¿ç”¨`Path.exists()`
   - äº‘å­˜å‚¨ï¼šä½¿ç”¨`storage_oper.get_item()`

2. **æ ¹æ®è¦†ç›–æ¨¡å¼å†³å®šæ˜¯å¦è¦†ç›–**
   - `never`ï¼šä¸è¦†ç›–ï¼Œè¿”å›å¤±è´¥
   - `always`ï¼šæ€»æ˜¯è¦†ç›–
   - `size`ï¼šæ¯”è¾ƒæ–‡ä»¶å¤§å°ï¼Œæ–°æ–‡ä»¶æ›´å¤§æ—¶è¦†ç›–
   - `latest`ï¼šæ€»æ˜¯è¦†ç›–ï¼Œå¹¶åˆ é™¤æ—§ç‰ˆæœ¬æ–‡ä»¶

3. **æ‰§è¡Œæ–‡ä»¶æ“ä½œ**ï¼ˆå¦‚æœå…è®¸è¦†ç›–ï¼‰

### ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤ï¼ˆlatestæ¨¡å¼ï¼‰

1. è§£æç›®æ ‡æ–‡ä»¶çš„åª’ä½“ä¿¡æ¯ï¼ˆtitleã€yearã€seasonã€episodeï¼‰
2. è·å–çˆ¶ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
3. è¯†åˆ«ç›¸åŒåª’ä½“çš„æ–‡ä»¶ï¼š
   - ç”µå½±ï¼štitle + year
   - å‰§é›†ï¼štitle + season + episode
4. åˆ é™¤é™¤å½“å‰æ–‡ä»¶å¤–çš„æ‰€æœ‰ç‰ˆæœ¬æ–‡ä»¶

## âœ… ä¸MoviePilotçš„ä¸€è‡´æ€§

### æ–‡ä»¶æ“ä½œæ¨¡å¼

| åŠŸèƒ½ | MoviePilot | VabHub | çŠ¶æ€ |
|------|------------|--------|------|
| æœ¬åœ°åˆ°æœ¬åœ°ï¼ˆcopyï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| æœ¬åœ°åˆ°æœ¬åœ°ï¼ˆmoveï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| æœ¬åœ°åˆ°æœ¬åœ°ï¼ˆlinkï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| æœ¬åœ°åˆ°æœ¬åœ°ï¼ˆsoftlinkï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| æœ¬åœ°åˆ°äº‘å­˜å‚¨ï¼ˆcopyï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| æœ¬åœ°åˆ°äº‘å­˜å‚¨ï¼ˆmoveï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| äº‘å­˜å‚¨åˆ°æœ¬åœ°ï¼ˆcopyï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| äº‘å­˜å‚¨åˆ°æœ¬åœ°ï¼ˆmoveï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆcopyï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| äº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆmoveï¼‰ | âœ… | âœ… | ä¸€è‡´ |

### è¦†ç›–æ¨¡å¼

| åŠŸèƒ½ | MoviePilot | VabHub | çŠ¶æ€ |
|------|------------|--------|------|
| neverï¼ˆä»ä¸è¦†ç›–ï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| alwaysï¼ˆæ€»æ˜¯è¦†ç›–ï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| sizeï¼ˆæŒ‰å¤§å°è¦†ç›–ï¼‰ | âœ… | âœ… | ä¸€è‡´ |
| latestï¼ˆä»…ä¿ç•™æœ€æ–°ï¼‰ | âœ… | âœ… | ä¸€è‡´ |

## ğŸ“š å‚è€ƒå®ç°

### MoviePilotå®ç°

- **æ–‡ä»¶**ï¼š`MoviePilot-2/app/modules/filemanager/transhandler.py`
- **æ ¸å¿ƒæ–¹æ³•**ï¼š`__transfer_command()`
- **è¦†ç›–æ¨¡å¼æ£€æŸ¥**ï¼šåœ¨`transfer_media()`æ–¹æ³•ä¸­
- **ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤**ï¼š`__delete_version_files()`æ–¹æ³•

### VabHubå®ç°

- **æ–‡ä»¶**ï¼š`VabHub/backend/app/modules/file_operation/transfer_handler.py`
- **æ ¸å¿ƒæ–¹æ³•**ï¼š`transfer_file()`
- **è¦†ç›–æ¨¡å¼æ£€æŸ¥**ï¼šä½¿ç”¨`OverwriteHandler.check_overwrite()`
- **ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤**ï¼šä½¿ç”¨`OverwriteHandler.delete_version_files()`

## ğŸ”„ ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°æ–‡ä»¶æ“ä½œæ¨¡å—**ï¼šåœ¨æ–‡ä»¶æ“ä½œæ¨¡å—ä¸­ä½¿ç”¨`TransferHandler`
2. **å®ç°StorageBaseæ¥å£**ï¼šä¸ºæœ¬åœ°å­˜å‚¨å’Œ115ç½‘ç›˜å­˜å‚¨å®ç°ç»Ÿä¸€æ¥å£ï¼ˆå‚è€ƒMoviePilotï¼‰
3. **ç®€åŒ–STRMç³»ç»Ÿ**ï¼šç§»é™¤è¦†ç›–æ¨¡å¼ç›¸å…³ä»£ç ï¼ˆè¦†ç›–æ¨¡å¼ä¸ç”¨äºSTRMæ–‡ä»¶ï¼‰
4. **å®ç°åˆ®å‰ŠåŠŸèƒ½é›†æˆ**ï¼š115ç½‘ç›˜å’Œæœ¬åœ°åˆ®å‰Š
5. **å®ç°æœåŠ¡å¼€å…³**ï¼šSTRMæœåŠ¡å¼€å…³

## âœ… å®Œæˆæ ‡å‡†

1. âœ… æ–‡ä»¶æ“ä½œæ¨¡å¼ä¸MoviePilotä¸€è‡´
2. âœ… è¦†ç›–æ¨¡å¼ä¸MoviePilotä¸€è‡´
3. âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ4ç§æ¨¡å¼ï¼‰
4. âœ… æ”¯æŒæœ¬åœ°å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼‰
5. âœ… æ”¯æŒäº‘å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼‰
6. âœ… æ”¯æŒäº‘å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆ2ç§æ¨¡å¼ï¼‰
7. âœ… é›†æˆè¦†ç›–æ¨¡å¼å¤„ç†
8. âœ… å®ç°ç‰ˆæœ¬æ–‡ä»¶åˆ é™¤åŠŸèƒ½ï¼ˆlatestæ¨¡å¼ï¼‰

