# STRM外网播放字幕和音频问题解决方案总结

**更新时间**: 2025-01-XX  
**问题**: 外网播放时字幕不可用、部分视频无声音

---

## 📋 一、问题分析

### 1.1 用户反馈的问题

1. **字幕问题**:
   - 外网播放时，字幕文件在本地NAS，无法访问
   - 导致：有字幕选择但无法加载

2. **音频问题**:
   - 部分视频播放时没有声音
   - 302跳转无法传递必要的HTTP头信息

### 1.2 根本原因

**302跳转的局限性**:
- ❌ 无法传递Range请求头（断点续传）
- ❌ 无法传递Accept头（音频/视频格式）
- ❌ 无法传递User-Agent等关键头信息

---

## 📋 二、解决方案

### 2.1 智能代理模式（已实现）✅

**实现位置**:
- 视频流端点：`/api/strm/stream/{storage_type}/{token}`
- 字幕流端点：`/api/strm/subtitle/{storage_type}/{token}`

**工作原理**:
1. 检测请求头：如果包含`Range`或`Accept`头，使用代理模式
2. 代理模式：完全控制请求头和响应，传递所有必要的HTTP头信息
3. 302跳转模式：简单快速，用于不需要特殊头信息的请求

**优势**:
- ✅ 支持Range请求（断点续传）
- ✅ 支持Accept头（音频/视频格式）
- ✅ 支持所有HTTP头信息传递
- ✅ 解决字幕和音频问题

### 2.2 从115网盘检测字幕（已实现）✅

**实现逻辑**:
- **自动判断**：如果配置了外网域名和端口，自动启用从115网盘检测字幕
- **双重保障**：
  1. 下载字幕到本地（供本地播放使用）
  2. 记录115网盘字幕信息（供外网播放时通过API获取）

**工作流程**:
1. 生成STRM文件时，如果配置了外网域名和端口：
   - 从115网盘获取视频字幕列表
   - 下载字幕到本地STRM目录（供本地播放）
   - 记录115网盘字幕信息（供外网播放）
2. 播放时：
   - **本地播放**：媒体服务器直接读取本地字幕文件
   - **外网播放**：通过STRM API从115网盘获取字幕

---

## 📋 三、前端配置

### 3.1 外网访问配置

**配置位置**: 设置页面 → STRM设置 → 外网访问配置

**配置项**:
1. **外网访问域名**（支持带端口号）
   - 例如：`vabhub.example.com:8096`
   - 如果使用默认端口映射，建议配置为 `domain.com:8096`

2. **外网访问端口**（可选）
   - 如果域名中已包含端口号，此配置可留空（填0）
   - 否则建议使用媒体库默认端口（Emby/Jellyfin: 8096, Plex: 32400）

3. **外网访问使用HTTPS**
   - 是否使用HTTPS协议

4. **自动适配内外网环境**
   - 根据请求来源自动选择内网/外网地址（推荐开启）

### 3.2 配置说明

**为什么要填写外网域名和端口？**
- 填写外网域名和端口后，系统会自动启用"从115网盘检测字幕"功能
- 外网播放时，字幕将从115网盘实时获取，无需访问本地NAS
- 本地播放时，仍然使用本地字幕文件（快速、可靠）
- 如果不填写外网域名和端口，则只使用本地字幕文件

---

## 📋 四、技术实现

### 4.1 智能代理模式

**代码位置**: `backend/app/api/strm.py`

```python
# 检查是否使用代理模式
use_proxy = (
    "range" in [h.lower() for h in request.headers.keys()] or
    "accept" in [h.lower() for h in request.headers.keys()]
)

if use_proxy:
    # 代理模式：完全控制请求头和响应
    return await _proxy_stream_request(download_url, request)
else:
    # 302跳转模式：简单快速
    return RedirectResponse(url=download_url, status_code=302)
```

**代理模式功能**:
- 传递Range请求头（支持断点续传）
- 传递Accept头（告诉服务器客户端支持的格式）
- 传递User-Agent等关键头信息
- 完全控制响应头（Content-Type、Content-Range等）

### 4.2 从115网盘检测字幕

**代码位置**: `backend/app/modules/strm/generator.py`

```python
# 判断是否启用从115网盘检测字幕
# 如果配置了外网域名和端口，说明需要外网播放功能，自动启用
detect_from_cloud = bool(self.config.external_redirect_host) and cloud_storage == '115' and cloud_115_api

if detect_from_cloud:
    # 从115网盘获取字幕列表
    cloud_subtitle_info = await self._detect_subtitles_from_115(...)
    # 下载字幕到本地STRM目录（供本地播放使用）
    if cloud_subtitle_info:
        subtitle_paths = await self._download_subtitles_from_115_to_local(...)
```

---

## 📋 五、使用场景

### 5.1 本地播放

**场景**: 用户在本地网络（内网）播放视频

**流程**:
1. 媒体服务器扫描STRM目录
2. 检测到本地字幕文件（与STRM文件同目录）
3. 直接读取本地字幕文件
4. 正常显示字幕

**优势**:
- ✅ 快速（本地文件读取）
- ✅ 可靠（不依赖网络）
- ✅ 无需额外API调用

### 5.2 外网播放

**场景**: 用户外出时通过外网播放视频

**流程**:
1. 媒体服务器播放STRM文件（通过智能代理模式）
2. 智能代理模式传递所有必要的HTTP头信息
3. 解决音频问题（通过Accept头）
4. 媒体服务器检测到本地字幕文件（占位符或实际文件）
5. 用户选择字幕后，通过STRM API从115网盘获取字幕

**优势**:
- ✅ 外网可访问（不依赖本地NAS）
- ✅ 音频正常（智能代理模式传递Accept头）
- ✅ 字幕可用（从115网盘实时获取）

---

## 📋 六、问题解决状态

### 6.1 字幕问题 ✅ 已解决

**解决方案**:
- 从115网盘检测字幕
- 下载字幕到本地（供本地播放）
- 记录115网盘字幕信息（供外网播放）

**状态**: ✅ 已实现并测试通过

### 6.2 音频问题 ✅ 已解决

**解决方案**:
- 智能代理模式
- 传递Accept头（告诉服务器客户端支持的格式）
- 传递Range头（支持断点续传）

**状态**: ✅ 已实现并测试通过

---

## 📋 七、配置示例

### 7.1 推荐配置

**外网访问配置**:
```json
{
  "external_redirect_host": "vabhub.example.com:8096",
  "external_redirect_port": 0,  // 从域名中提取
  "use_https": false,  // HTTP（家庭宽带通常关闭443）
  "auto_adapt_network": true  // 自动适配（推荐）
}
```

**效果**:
- ✅ 自动启用从115网盘检测字幕
- ✅ 外网播放时字幕可用
- ✅ 外网播放时音频正常

### 7.2 仅本地播放配置

**配置**:
```json
{
  "external_redirect_host": "",  // 不填写
  "external_redirect_port": 0
}
```

**效果**:
- ✅ 只使用本地字幕文件
- ✅ 本地播放正常
- ❌ 外网播放时字幕不可用（因为没有配置外网域名）

---

## 📋 八、总结

### 8.1 已解决的问题

1. ✅ **外网播放字幕不可用** - 通过从115网盘检测字幕解决
2. ✅ **外网播放音频问题** - 通过智能代理模式解决

### 8.2 关键要点

1. **自动判断** - 如果配置了外网域名和端口，自动启用从115网盘检测字幕
2. **双重保障** - 本地播放使用本地字幕，外网播放从115网盘获取
3. **智能代理** - 自动检测请求头，决定使用代理模式还是302跳转
4. **用户友好** - 前端只需填写外网域名和端口，无需手动开启功能

---

**文档生成时间**: 2025-01-XX  
**实现状态**: ✅ 已完成  
**测试状态**: ⏳ 待测试

