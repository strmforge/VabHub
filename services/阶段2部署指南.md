# 阶段2部署指南：云端服务基础版

## 📋 概述

阶段2需要部署三个云端服务：
1. **Mesh Scheduler** - 任务调度中心（Railway + Supabase/Neon）
2. **Intel Center** - 智能大脑（Deta.Space）
3. **Snapshots** - 静态快照（Cloudflare Pages/R2）

---

## 🏗️ 部署前必做：统一数据库迁移

无论采用何种数据库，**在升级或新部署 VabHub 主服务后请先运行统一迁移脚本**：

```bash
python backend/scripts/migrate.py --dry-run   # 先预览
python backend/scripts/migrate.py             # 确认无误后正式执行
```

- 该脚本会顺序执行短剧字段、音乐订阅字段、RSSHub 健康字段等结构性补齐步骤，所有操作均为幂等设计，可重复运行。
- 如遇 RSSHub 关联数据异常，可在结构迁移完成后再根据提示执行 `python backend/scripts/fix_rsshub_fk.py` 进行**数据修复**；两者互补，前者负责结构，后者负责数据一致性。
- 建议将 “migrate.py → fix_rsshub_fk.py” 作为部署流水线中的固定步骤，并将输出日志（JSON）归档，便于排查。

---

## 🚀 1. Mesh Scheduler部署

### 1.1 准备数据库

#### 选项A: Supabase（推荐）
1. 访问 https://supabase.com
2. 创建新项目
3. 获取PostgreSQL连接字符串
4. 格式：`postgresql+asyncpg://postgres:password@host:5432/postgres`

#### 选项B: Neon
1. 访问 https://neon.tech
2. 创建新项目
3. 获取PostgreSQL连接字符串
4. 格式：`postgresql+asyncpg://user:password@host:5432/dbname`

### 1.2 部署到Railway

1. **创建Railway项目**
   - 访问 https://railway.app
   - 创建新项目
   - 选择"Deploy from GitHub repo"或"Empty Project"

2. **配置环境变量**
   ```env
   APP_ENV=production
   DB_URL=postgresql+asyncpg://user:password@host:5432/vabhub_mesh
   NETWORK_SHARED_KEY=YOUR_RANDOM_SECRET_KEY_HERE
   MAX_WORKERS_PER_SITE=3
   LEASE_DURATION_SECONDS=300
   ```

3. **部署代码**
   - 如果使用GitHub，推送代码后自动部署
   - 如果手动部署，使用Dockerfile构建

4. **获取部署URL**
   - Railway会提供类似 `https://xxx.up.railway.app` 的URL
   - 记录此URL用于Cloudflare反代

### 1.3 Cloudflare反代配置

1. **DNS配置**
   - 在Cloudflare添加A记录或CNAME
   - 名称：`mesh`
   - 目标：Railway提供的URL
   - 开启Proxied（橙云）

2. **页面规则（可选）**
   - 设置缓存规则
   - 配置安全规则

---

## 🧠 2. Intel Center部署

### 2.1 准备数据

1. **创建数据目录**
   ```bash
   mkdir -p data
   ```

2. **准备数据文件**
   - `data/aliases.json` - 别名数据
   - `data/index.json` - 索引数据
   - `data/rules.json` - 规则包

### 2.2 部署到Deta.Space

1. **创建Deta.Space项目**
   - 访问 https://deta.space
   - 创建新项目
   - 选择Python运行时

2. **配置环境变量**
   ```env
   APP_ENV=production
   DATA_DIR=./data
   ```

3. **部署代码**
   - 使用Deta CLI或Web界面部署
   - 确保数据文件包含在部署中

4. **获取部署URL**
   - Deta.Space会提供类似 `https://xxx.deta.app` 的URL
   - 记录此URL用于Cloudflare反代

### 2.3 Cloudflare反代配置

1. **DNS配置**
   - 在Cloudflare添加A记录或CNAME
   - 名称：`intel`
   - 目标：Deta.Space提供的URL
   - 开启Proxied（橙云）

---

## 📦 3. Snapshots部署

### 3.1 准备快照文件

1. **创建快照文件**
   - `alias-latest.json` / `alias-latest.json.gz`
   - `index-latest.json` / `index-latest.json.gz`
   - `rules.json`

2. **文件位置**
   - 可以放在GitHub仓库
   - 或直接上传到Cloudflare R2

### 3.2 部署到Cloudflare Pages

#### 选项A: Cloudflare Pages（推荐）
1. **创建GitHub仓库**
   - 创建新仓库（如 `vabhub-snapshots`）
   - 上传快照文件

2. **部署到Pages**
   - 在Cloudflare Pages中连接GitHub仓库
   - 选择仓库和分支
   - 构建命令：无（静态文件）
   - 输出目录：`/`

3. **自定义域名**
   - 设置自定义域名：`snap.hbnetwork.top`
   - 开启长期缓存

#### 选项B: Cloudflare R2
1. **创建R2存储桶**
   - 在Cloudflare R2中创建新存储桶
   - 上传快照文件

2. **配置公共访问**
   - 设置公共访问权限
   - 获取公共URL

3. **自定义域名**
   - 绑定自定义域名：`snap.hbnetwork.top`
   - 配置缓存规则

---

## 🔧 4. Cloudflare统一配置

### 4.1 DNS配置

在Cloudflare DNS中添加以下记录：

| 类型 | 名称 | 目标 | 代理状态 |
|------|------|------|---------|
| CNAME | mesh | railway-url | 已代理（橙云） |
| CNAME | intel | deta-url | 已代理（橙云） |
| CNAME | snap | pages-url | 已代理（橙云） |

### 4.2 页面规则

为 `snap.hbnetwork.top` 设置缓存规则：
- 缓存级别：标准
- 边缘缓存TTL：1个月
- 浏览器缓存TTL：1个月

---

## ✅ 5. 验证部署

### 5.1 测试Mesh Scheduler

```bash
# 测试节点注册
curl -X POST https://mesh.hbnetwork.top/v1/worker/register \
  -H "X-Network-Key: YOUR_SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{"node_id": "test-worker", "capabilities": {"sites": ["site1"]}}'
```

### 5.2 测试Intel Center

```bash
# 测试别名解析
curl "https://intel.hbnetwork.top/v1/alias/resolve?q=钢铁侠"

# 测试索引查询
curl "https://intel.hbnetwork.top/v1/index/iron-man-2008-movie"
```

### 5.3 测试Snapshots

```bash
# 测试快照下载
curl "https://snap.hbnetwork.top/alias-latest.json"
curl "https://snap.hbnetwork.top/index-latest.json"
curl "https://snap.hbnetwork.top/rules.json"
```

---

## 📝 6. 配置VabHub客户端

在VabHub主项目的 `.env` 中配置：

```env
INTEL_ENABLED=true
INTEL_MODE=hybrid
INTEL_SCHEDULER_ENDPOINT=https://mesh.hbnetwork.top
INTEL_INTEL_ENDPOINT=https://intel.hbnetwork.top
INTEL_SNAPSHOT_BASE_URL=https://snap.hbnetwork.top
INTEL_FALLBACK_TO_LOCAL=true
```

---

## 🛡 7. RSSHub 数据修复与巡检

> 当主服务启用 RSSHub 订阅时，请务必完成以下步骤，避免旧历史数据影响生产环境。

1. **上线/升级后立即执行**
   - 停止旧版 uvicorn 实例，确保只有最新代码在运行。
   - 备份数据库，然后执行：
     ```bash
     python backend/scripts/fix_rsshub_fk.py --dry-run
     ```
     检查输出的 JSON 摘要（`scanned`、`fixed_sources`、`fixed_composites`、`disabled` 等）。如符合预期，再运行一次不带 `--dry-run` 的正式修复。

2. **快速回归**
   - 建议使用生产地址执行一键回归：
     ```bash
     API_BASE_URL=https://your.domain python backend/scripts/test_all.py --skip-music-execute
     ```
   - 若需要验证音乐真实下载，可再执行一次完整的 `test_all.py`（不带 `--skip-music-execute`）。

3. **日常巡检**
   - 至少每月运行一次 `fix_rsshub_fk.py --dry-run`，同时通过 `/api/rsshub/subscriptions/health`（或前端 RSSHub 页面中的“订阅健康检查”）筛选 `only_legacy=true` / `target_type=source|composite`，快速定位新的“孤儿订阅”。
   - 关注日志关键字：`[RSSHub-FIX]`、`FETCH_FAILED`、`MISSING_TARGET`，及时发现抓取异常。

4. **legacy 占位说明**
   - `legacy_rsshub_source` / `legacy_rsshub_composite` 仅用作历史脏数据容器与诊断线索，不会参与真实抓取。
   - 管理员在订阅管理页修正并保存后，可通过健康页面的“重新启用”按钮清空 `last_error_*` 并恢复正常状态。

---

## 🧩 8. 插件部署与热更新

1. **目录挂载**
   - 主服务部署时，请将仓库根目录的 `plugins/` 与 `data/plugin_configs/` 作为可写卷，便于热更新与配置持久化。
   - 新插件直接放入 `plugins/<name>.py`，参考 `plugins/example_pt_site.py` 的结构。

2. **启用热更新**
   - 后端启动后默认会 watch `plugins/`；如在生产环境不需要自动 reload，可调用 `/api/plugins/hot-reload/disable` 或在前端“插件管理”页面关闭开关。
   - 若热更新关闭，修改插件后需点击“重载”按钮手动生效。

3. **配置管理**
   - 插件可以通过 `PluginContext.config` 读取/写入 JSON 配置，实际存储在 `data/plugin_configs/<name>.json`。
   - 前端页面支持简单的键值编辑，适合快速调整开关/Token 等轻量配置。

4. **参考文档**
   - 详见 `docs/PLUGIN_PDK.md`，内含元信息字段说明、register/on_startup 用法以及调试技巧。

---

## 🔐 9. 插件安装安全

1. **默认关闭远程安装**  
   - `PLUGIN_REMOTE_INSTALL_ENABLED=false` 时只允许手动把 `.py` 文件放入 `plugins/` 目录，避免任何外部写入。

2. **启用白名单**  
   - 如需让 `/api/plugins/{id}/install` 从网络下载，请在环境变量中显式配置：  
     ```env
     PLUGIN_REMOTE_INSTALL_ENABLED=true
     PLUGIN_REMOTE_ALLOWED_HOSTS=["raw.githubusercontent.com","plugins.example.com"]
     PLUGIN_INSTALL_MAX_BYTES=262144
     ```  
     下载链接必须属于白名单域名，且文件大小受 `PLUGIN_INSTALL_MAX_BYTES` 限制（默认 256 KB）。

3. **审查流程**  
   - 生产环境建议先在独立仓库/内部网盘托管受信任的插件，再将该域名加入白名单。  
   - 安装前务必审阅源码，确认不会上传敏感数据或执行危险操作。

4. **安装完成后的检查**  
   - 留意后端日志中 `插件 <name> 加载成功/失败` 的记录；如失败，可删除下载的 `.py` 文件并重新审查。

---

## 🎯 10. 部署检查清单

### Mesh Scheduler
- [ ] Supabase/Neon数据库已创建
- [ ] Railway项目已创建
- [ ] 环境变量已配置
- [ ] 代码已部署
- [ ] Cloudflare DNS已配置
- [ ] API测试通过

### Intel Center
- [ ] Deta.Space项目已创建
- [ ] 数据文件已准备
- [ ] 代码已部署
- [ ] Cloudflare DNS已配置
- [ ] API测试通过

### Snapshots
- [ ] 快照文件已准备
- [ ] Cloudflare Pages/R2已配置
- [ ] 自定义域名已设置
- [ ] 缓存规则已配置
- [ ] 文件下载测试通过

---

## 🚨 常见问题

### 问题1: Railway部署失败
- 检查环境变量是否正确
- 检查数据库连接字符串格式
- 查看Railway日志

### 问题2: Deta.Space数据不更新
- 检查数据文件是否包含在部署中
- 检查DATA_DIR路径是否正确

### 问题3: Cloudflare反代502错误
- 检查源站URL是否正确
- 检查源站是否可访问
- 检查SSL/TLS设置

---

## 📊 部署状态

- ⏳ Mesh Scheduler: 待部署
- ⏳ Intel Center: 待部署
- ⏳ Snapshots: 待部署

---

**下一步**: 按照本指南逐步部署三个服务，然后进行阶段3（本地端集成云端）。

