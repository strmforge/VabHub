# VabHub 功能整合方案设计

## 📋 整合功能清单

### 1. 深度学习推荐系统（来自VabHub-变异版）⭐高优先级
- 神经协同过滤（NCF）
- 深度因子分解机（DeepFM）
- 自编码器推荐模型
- GPU加速支持

### 2. 实时推荐系统（来自VabHub-变异版）⭐高优先级
- 流式推荐计算
- 实时特征更新
- A/B测试框架

### 3. 老电视剧搜索优化（来自VabHub1.4版）⭐中优先级
- 查询扩展（去除年份、添加后缀、繁体字、拼音）
- 特殊搜索策略

### 4. 插件热更新（来自VabHub1.4版）⭐中优先级
- 无需重启安装插件
- 插件热重载

### 5. 可拖拽仪表盘布局（来自VabHub1.4版）⭐中优先级
- 响应式拖拽布局系统

### 6. 可选增强功能（低优先级）
- Netflix Top 10集成
- IMDb Datasets集成
- GPU加速支持（已在深度学习推荐中）

---

## 🎯 整合策略

### 阶段一：深度学习推荐系统（高优先级）

#### 1.1 架构设计

```
VabHub/backend/app/modules/recommendation/
├── deep_learning/
│   ├── __init__.py
│   ├── models/
│   │   ├── ncf.py          # 神经协同过滤
│   │   ├── deepfm.py       # 深度因子分解机
│   │   └── autoencoder.py  # 自编码器
│   ├── trainer.py          # 模型训练器
│   ├── predictor.py        # 预测器
│   └── gpu_utils.py        # GPU工具
├── realtime/
│   ├── __init__.py
│   ├── stream_processor.py  # 流式处理
│   ├── feature_updater.py   # 特征更新
│   └── ab_testing.py        # A/B测试
└── service.py (增强现有)
```

#### 1.2 整合步骤

1. **迁移深度学习模型**
   - 从 `VabHub-变异版/vabhub-Core/ai/deep_learning_recommender.py` 迁移
   - 适配当前数据库模型
   - 集成GPU检测和加速

2. **增强推荐服务**
   - 在现有 `RecommendationService` 中添加深度学习推荐
   - 实现模型选择策略（NCF/DeepFM/Autoencoder）
   - 添加模型训练和更新机制

3. **GPU支持**
   - 检测GPU可用性
   - 自动选择CPU/GPU训练
   - 模型加载优化

#### 1.3 依赖管理

```python
# requirements.txt 新增
torch>=2.0.0
torchvision>=0.15.0
pytorch-lightning>=2.0.0  # 可选，用于简化训练
```

---

### 阶段二：实时推荐系统（高优先级）

#### 2.1 架构设计

```
VabHub/backend/app/modules/recommendation/realtime/
├── __init__.py
├── stream_processor.py    # 流式推荐计算
├── feature_updater.py      # 实时特征更新
├── ab_testing.py           # A/B测试框架
└── cache_manager.py       # 缓存管理
```

#### 2.2 整合步骤

1. **流式推荐计算**
   - 使用消息队列（Redis/RabbitMQ）处理实时事件
   - 增量更新推荐结果
   - 异步处理用户行为

2. **实时特征更新**
   - 监听用户交互事件（观看、评分、收藏）
   - 实时更新用户画像
   - 增量更新物品特征

3. **A/B测试框架**
   - 实验组/对照组分配
   - 指标收集和统计
   - 自动切换最佳策略

#### 2.3 技术选型

- **消息队列**: Redis Streams 或 RabbitMQ
- **缓存**: Redis
- **异步处理**: Celery 或 asyncio

---

### 阶段三：老电视剧搜索优化（中优先级）

#### 3.1 架构设计

```
VabHub/backend/app/modules/search/
├── query_expander.py       # 查询扩展器
├── old_tv_optimizer.py     # 老电视剧优化器
└── search_strategy.py      # 搜索策略
```

#### 3.2 整合步骤

1. **查询扩展器**
   - 去除年份
   - 添加后缀（电视剧、剧集、TV版）
   - 繁体字转换（使用 `zhconv` 或 `opencc`）
   - 拼音转换（使用 `pypinyin`）

2. **老电视剧检测**
   - 关键词库匹配
   - 年份范围判断（1990-2010）
   - 内容类型识别

3. **搜索策略**
   - 扩展搜索（多查询并行）
   - 模糊匹配（针对老内容）
   - 结果合并和去重

#### 3.3 依赖管理

```python
# requirements.txt 新增
zhconv>=1.4.2  # 繁简转换
pypinyin>=0.47.0  # 拼音转换
```

---

### 阶段四：插件热更新（中优先级）

#### 4.1 架构设计

```
VabHub/backend/app/core/plugins/
├── hot_reload.py           # 热重载管理器
├── file_watcher.py         # 文件监控
└── plugin_loader.py        # 插件加载器（增强）
```

#### 4.2 整合步骤

1. **文件监控**
   - 使用 `watchdog` 监控插件目录
   - 检测文件变化（创建、修改、删除）
   - 防抖处理（避免重复触发）

2. **热重载机制**
   - 保存插件状态（配置、启用状态）
   - 卸载旧插件
   - 重新加载新插件
   - 恢复状态

3. **API端点**
   - `POST /api/plugins/{plugin_id}/reload` - 手动重载
   - `GET /api/plugins/hot-reload/status` - 热重载状态

#### 4.3 技术选型

- **文件监控**: `watchdog`
- **模块重载**: `importlib.reload()`

---

### 阶段五：可拖拽仪表盘布局（中优先级）

#### 5.1 架构设计

```
VabHub/frontend/src/
├── components/dashboard/
│   ├── DraggableDashboard.vue  # 可拖拽仪表盘
│   ├── DashboardGrid.vue       # 网格布局
│   └── WidgetLibrary.vue        # 小部件库
├── stores/dashboard.ts          # 仪表盘状态管理
└── api/dashboard.ts              # 仪表盘API
```

#### 5.2 整合步骤

1. **前端组件**
   - 使用 `vue-draggable-plus` 或 `vuedraggable`
   - 实现网格布局系统
   - 小部件库和配置面板

2. **后端API**
   - `GET /api/dashboard/layout` - 获取布局
   - `PUT /api/dashboard/layout` - 保存布局
   - `POST /api/dashboard/widgets` - 添加小部件

3. **数据模型**
   - `DashboardLayout` 模型
   - `DashboardWidget` 模型
   - 用户个性化布局

#### 5.3 技术选型

- **拖拽库**: `vue-draggable-plus` 或 `vuedraggable`
- **网格布局**: CSS Grid + 响应式设计

---

### 阶段六：可选增强功能（低优先级）

#### 6.1 Netflix Top 10集成

```
VabHub/backend/app/modules/external/
├── netflix_client.py       # Netflix API客户端
└── netflix_integration.py  # 集成服务
```

#### 6.2 IMDb Datasets集成

```
VabHub/backend/app/modules/external/
├── imdb_datasets.py        # IMDb数据集处理
└── imdb_importer.py        # 数据导入
```

---

## 📊 优先级和时间规划

| 阶段 | 功能 | 优先级 | 预计时间 | 依赖 |
|------|------|--------|----------|------|
| 1 | 深度学习推荐系统 | ⭐⭐⭐ | 3-5天 | PyTorch, GPU |
| 2 | 实时推荐系统 | ⭐⭐⭐ | 2-3天 | Redis, 消息队列 |
| 3 | 老电视剧搜索优化 | ⭐⭐ | 1-2天 | zhconv, pypinyin |
| 4 | 插件热更新 | ⭐⭐ | 1-2天 | watchdog |
| 5 | 可拖拽仪表盘 | ⭐⭐ | 2-3天 | vue-draggable |
| 6 | Netflix/IMDb集成 | ⭐ | 1-2天 | 外部API |

---

## 🔧 技术依赖汇总

### Python依赖
```python
# 深度学习
torch>=2.0.0
torchvision>=0.15.0

# 搜索优化
zhconv>=1.4.2
pypinyin>=0.47.0

# 插件热更新
watchdog>=3.0.0

# 实时推荐
redis>=5.0.0
celery>=5.3.0  # 可选
```

### 前端依赖
```json
{
  "vue-draggable-plus": "^0.4.0",
  "@vueuse/core": "^10.0.0"
}
```

---

## 🚀 实施建议

### 建议顺序
1. **先整合深度学习推荐系统** - 核心功能，影响最大
2. **再整合实时推荐系统** - 提升用户体验
3. **然后整合搜索优化** - 解决实际问题
4. **接着整合插件热更新** - 提升开发体验
5. **最后整合仪表盘布局** - 提升UI体验

### 注意事项
1. **GPU支持**: 需要检测GPU可用性，提供CPU降级方案
2. **性能优化**: 深度学习模型需要缓存和批处理
3. **向后兼容**: 确保新功能不影响现有功能
4. **配置管理**: 所有新功能都需要配置开关
5. **测试覆盖**: 每个功能都需要单元测试和集成测试

---

## 📝 下一步行动

1. ✅ 创建整合方案文档（本文档）
2. ⏳ 开始阶段一：深度学习推荐系统整合
3. ⏳ 创建数据库迁移脚本
4. ⏳ 更新API文档
5. ⏳ 编写测试用例

---

## 🔍 参考资源

- VabHub-变异版: `vabhub-Core/ai/deep_learning_recommender.py`
- VabHub-变异版: `vabhub-Core/ai/realtime_recommendation.py`
- VabHub1.4版: `VabHub-Core/core/optimized_search_manager.py`
- VabHub1.4版: `VabHub-Core/core/hot_plugin_manager.py`
- VabHub-CodeBuddy版: `vabhub-frontend/src/components/Dashboard.vue`

