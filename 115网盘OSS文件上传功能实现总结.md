# 115ç½‘ç›˜OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

åŸºäº115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£å’ŒVabHub-1çš„å®ç°ï¼Œå®Œæˆäº†å®Œæ•´çš„OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç§’ä¼ ã€äºŒæ¬¡è®¤è¯ã€åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ç­‰ç‰¹æ€§ã€‚

## âœ… å·²å®ç°åŠŸèƒ½

### 1. OSSä¸Šä¼ å®¢æˆ·ç«¯ (`cloud_115_oss.py`)

#### æ ¸å¿ƒç‰¹æ€§

- **ä½¿ç”¨oss2åº“**: åŸºäºé˜¿é‡Œäº‘OSS SDK (`oss2`) å®ç°ï¼Œä¸VabHub-1ä¿æŒä¸€è‡´
- **STSè®¤è¯**: ä½¿ç”¨ä¸´æ—¶å®‰å…¨å‡­è¯ (`StsAuth`) è¿›è¡Œè®¤è¯
- **åˆ†ç‰‡ä¸Šä¼ **: æ”¯æŒå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼Œé»˜è®¤åˆ†ç‰‡å¤§å°10MB
- **è¿›åº¦å›è°ƒ**: æ”¯æŒä¸Šä¼ è¿›åº¦å®æ—¶å›è°ƒ
- **å›è°ƒæ”¯æŒ**: æ”¯æŒä¸Šä¼ å®Œæˆå›è°ƒURLå’Œå›è°ƒå‚æ•°

#### ä¸»è¦æ–¹æ³•

```python
class Cloud115OSS:
    def __init__(self, endpoint, access_key_id, access_key_secret, security_token):
        """åˆå§‹åŒ–OSSå®¢æˆ·ç«¯ï¼Œä½¿ç”¨STSä¸´æ—¶å‡­è¯"""
    
    async def upload_file(
        self,
        file_path: str,
        bucket: str,
        object_key: str,
        callback: Optional[str] = None,
        callback_var: Optional[str] = None,
        progress_callback: Optional[Callable] = None
    ) -> Dict[str, Any]:
        """ä¸Šä¼ æ–‡ä»¶åˆ°OSSï¼ˆåˆ†ç‰‡ä¸Šä¼ ï¼‰"""
```

#### å®ç°ç»†èŠ‚

1. **åˆ†ç‰‡ä¸Šä¼ æµç¨‹**:
   - ä½¿ç”¨`determine_part_size`ç¡®å®šåˆ†ç‰‡å¤§å°ï¼ˆé»˜è®¤10MBï¼‰
   - ä½¿ç”¨`bucket.init_multipart_upload`åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
   - é€ä¸ªä¸Šä¼ åˆ†ç‰‡ï¼Œä½¿ç”¨`bucket.upload_part`
   - ä½¿ç”¨`bucket.complete_multipart_upload`å®Œæˆä¸Šä¼ 

2. **å¼‚æ­¥å¤„ç†**:
   - ä½¿ç”¨`asyncio.run_in_executor`åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡ŒåŒæ­¥çš„OSSæ“ä½œ
   - é¿å…é˜»å¡äº‹ä»¶å¾ªç¯

3. **å›è°ƒç¼–ç **:
   - ä½¿ç”¨`oss2.utils.b64encode_as_string`ç¼–ç å›è°ƒURLå’Œå‚æ•°
   - ä¸VabHub-1å®ç°ä¿æŒä¸€è‡´

### 2. ä¸Šä¼ ç®¡ç†å™¨ (`cloud_115_upload.py`)

#### æ ¸å¿ƒç‰¹æ€§

- **å®Œæ•´ä¸Šä¼ æµç¨‹**: æ•´åˆä¸Šä¼ åˆå§‹åŒ–ã€äºŒæ¬¡è®¤è¯ã€OSSä¸Šä¼ ç­‰æ­¥éª¤
- **ç§’ä¼ æ”¯æŒ**: è‡ªåŠ¨æ£€æµ‹ç§’ä¼ ï¼Œç›´æ¥è¿”å›æˆåŠŸ
- **äºŒæ¬¡è®¤è¯**: å¤„ç†äºŒæ¬¡è®¤è¯æµç¨‹ï¼ˆé”™è¯¯ç 700, 701, 702ï¼‰
- **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½
- **è¿›åº¦è·Ÿè¸ª**: æ”¯æŒä¸Šä¼ è¿›åº¦å®æ—¶è·Ÿè¸ª

#### ä¸»è¦æ–¹æ³•

```python
class Cloud115UploadManager:
    def __init__(self, api_client: Cloud115API):
        """åˆå§‹åŒ–ä¸Šä¼ ç®¡ç†å™¨"""
    
    async def upload_file(
        self,
        file_path: str,
        target_parent_id: str = "0",
        file_name: Optional[str] = None,
        progress_callback: Optional[Callable] = None
    ) -> Dict[str, Any]:
        """ä¸Šä¼ æ–‡ä»¶åˆ°115ç½‘ç›˜ï¼ˆå®Œæ•´æµç¨‹ï¼‰"""
    
    async def resume_upload(
        self,
        file_path: str,
        target_parent_id: str,
        file_sha1: str,
        pick_code: str,
        progress_callback: Optional[Callable] = None
    ) -> Dict[str, Any]:
        """æ–­ç‚¹ç»­ä¼ ä¸Šä¼ æ–‡ä»¶"""
    
    async def calculate_file_hash(self, file_path: str) -> Dict[str, str]:
        """è®¡ç®—æ–‡ä»¶çš„å®Œæ•´sha1å€¼å’Œå‰128K sha1å€¼"""
```

#### ä¸Šä¼ æµç¨‹

1. **è®¡ç®—æ–‡ä»¶ç‰¹å¾å€¼**:
   - è®¡ç®—æ–‡ä»¶å®Œæ•´sha1å€¼
   - è®¡ç®—æ–‡ä»¶å‰128K sha1å€¼ï¼ˆç”¨äºç§’ä¼ æ£€æµ‹ï¼‰

2. **åˆå§‹åŒ–ä¸Šä¼ **:
   - è°ƒç”¨`/open/upload/init`æ¥å£
   - å¤„ç†è¿”å›çš„statusï¼ˆ1: éç§’ä¼ , 2: ç§’ä¼ ï¼‰

3. **å¤„ç†ç§’ä¼ **:
   - å¦‚æœstatus=2ï¼Œç›´æ¥è¿”å›æˆåŠŸå’Œfile_id

4. **å¤„ç†äºŒæ¬¡è®¤è¯**:
   - å¦‚æœè¿”å›é”™è¯¯ç 700/701/702ï¼Œè¿›è¡ŒäºŒæ¬¡è®¤è¯
   - è¯»å–æ–‡ä»¶æŒ‡å®šå­—èŠ‚èŒƒå›´ï¼Œè®¡ç®—sha1å€¼
   - é‡æ–°è°ƒç”¨åˆå§‹åŒ–æ¥å£ï¼Œæä¾›sign_val

5. **è·å–ä¸Šä¼ å‡­è¯**:
   - è°ƒç”¨`/open/upload/get_token`è·å–ä¸´æ—¶å‡­è¯

6. **ä¸Šä¼ åˆ°OSS**:
   - ä½¿ç”¨ä¸´æ—¶å‡­è¯åˆå§‹åŒ–OSSå®¢æˆ·ç«¯
   - è°ƒç”¨OSSå®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶
   - æ”¯æŒè¿›åº¦å›è°ƒ

7. **æ–­ç‚¹ç»­ä¼ **:
   - ä½¿ç”¨pick_codeè°ƒç”¨`/open/upload/resume`æ¥å£
   - è·å–ç»­ä¼ ä¿¡æ¯åï¼Œä¸Šä¼ åˆ°OSS

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ä¾èµ–åº“

- **oss2**: é˜¿é‡Œäº‘OSS SDKï¼Œç”¨äºå®é™…ä¸Šä¼ 
- **asyncio**: å¼‚æ­¥å¤„ç†
- **hashlib**: æ–‡ä»¶å“ˆå¸Œè®¡ç®—

### 2. å…³é”®é…ç½®

- **åˆ†ç‰‡å¤§å°**: 10MBï¼ˆä¸VabHub-1ä¸€è‡´ï¼‰
- **å›è°ƒç¼–ç **: Base64ç¼–ç 
- **é¡ºåºä¸Šä¼ **: ä½¿ç”¨`sequential`å‚æ•°

### 3. é”™è¯¯å¤„ç†

- **OSSé”™è¯¯**: æ•è·`oss2.exceptions.OssError`
- **ç½‘ç»œé”™è¯¯**: æ•è·é€šç”¨å¼‚å¸¸
- **äºŒæ¬¡è®¤è¯**: å¤„ç†é”™è¯¯ç 700/701/702

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from app.core.cloud_storage.providers.cloud_115_api import Cloud115API
from app.core.cloud_storage.providers.cloud_115_upload import Cloud115UploadManager

# åˆå§‹åŒ–APIå®¢æˆ·ç«¯
api = Cloud115API(access_token="your_access_token")

# åˆå§‹åŒ–ä¸Šä¼ ç®¡ç†å™¨
upload_manager = Cloud115UploadManager(api)

# ä¸Šä¼ æ–‡ä»¶
result = await upload_manager.upload_file(
    file_path="/path/to/file.mkv",
    target_parent_id="0",  # æ ¹ç›®å½•
    file_name="file.mkv",
    progress_callback=lambda uploaded, total, status: print(f"{status}: {uploaded}/{total}")
)

if result.get("success"):
    if result.get("method") == "instant":
        print(f"ç§’ä¼ æˆåŠŸ: file_id={result.get('file_id')}")
    else:
        print(f"ä¸Šä¼ æˆåŠŸ: bucket={result.get('bucket')}, object_key={result.get('object_key')}")
else:
    print(f"ä¸Šä¼ å¤±è´¥: {result.get('error')}")
```

### æ–­ç‚¹ç»­ä¼ 

```python
# è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
hash_info = await upload_manager.calculate_file_hash("/path/to/file.mkv")

# æ–­ç‚¹ç»­ä¼ 
result = await upload_manager.resume_upload(
    file_path="/path/to/file.mkv",
    target_parent_id="0",
    file_sha1=hash_info["file_sha1"],
    pick_code="your_pick_code",
    progress_callback=lambda uploaded, total, status: print(f"{status}: {uploaded}/{total}")
)
```

## ğŸ¯ ä¸VabHub-1çš„å¯¹æ¯”

### ç›¸åŒç‚¹

1. **ä½¿ç”¨oss2åº“**: éƒ½ä½¿ç”¨é˜¿é‡Œäº‘OSS SDK
2. **åˆ†ç‰‡å¤§å°**: éƒ½ä½¿ç”¨10MBåˆ†ç‰‡
3. **STSè®¤è¯**: éƒ½ä½¿ç”¨ä¸´æ—¶å®‰å…¨å‡­è¯
4. **å›è°ƒç¼–ç **: éƒ½ä½¿ç”¨Base64ç¼–ç 
5. **ä¸Šä¼ æµç¨‹**: æµç¨‹åŸºæœ¬ä¸€è‡´

### æ”¹è¿›ç‚¹

1. **å¼‚æ­¥æ”¯æŒ**: å½“å‰ç‰ˆæœ¬å®Œå…¨å¼‚æ­¥ï¼Œä½¿ç”¨`asyncio.run_in_executor`
2. **é”™è¯¯å¤„ç†**: æ›´å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
3. **è¿›åº¦å›è°ƒ**: æ”¯æŒæ›´è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼ˆçŠ¶æ€ã€å·²ä¸Šä¼ ã€æ€»æ•°ï¼‰
4. **ä»£ç ç»“æ„**: æ›´æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼ˆOSSå®¢æˆ·ç«¯ã€ä¸Šä¼ ç®¡ç†å™¨ï¼‰

## ğŸš§ å¾…å®ç°åŠŸèƒ½

### é«˜ä¼˜å…ˆçº§

1. **ä¸Šä¼ ä»»åŠ¡ç®¡ç†**:
   - ä¸Šä¼ ä»»åŠ¡é˜Ÿåˆ—
   - ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
   - ä»»åŠ¡é‡è¯•æœºåˆ¶

2. **ä¸Šä¼ è¿›åº¦æŒä¹…åŒ–**:
   - ä¿å­˜ä¸Šä¼ è¿›åº¦
   - æ”¯æŒæ–­ç‚¹ç»­ä¼ æ¢å¤

3. **å¹¶å‘ä¸Šä¼ **:
   - æ”¯æŒå¤šä¸ªæ–‡ä»¶å¹¶å‘ä¸Šä¼ 
   - é™åˆ¶å¹¶å‘æ•°

### ä¸­ä¼˜å…ˆçº§

1. **ä¸Šä¼ é€Ÿåº¦é™åˆ¶**:
   - æ”¯æŒä¸Šä¼ é€Ÿåº¦é™åˆ¶
   - åŠ¨æ€è°ƒæ•´åˆ†ç‰‡å¤§å°

2. **ä¸Šä¼ é‡è¯•**:
   - è‡ªåŠ¨é‡è¯•å¤±è´¥çš„åˆ†ç‰‡
   - é‡è¯•ç­–ç•¥é…ç½®

3. **ä¸Šä¼ éªŒè¯**:
   - ä¸Šä¼ åéªŒè¯æ–‡ä»¶å®Œæ•´æ€§
   - å¯¹æ¯”ETag

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **oss2åº“å®‰è£…**: éœ€è¦å®‰è£…`oss2`åº“ (`pip install oss2`)
2. **å¼‚æ­¥å¤„ç†**: OSSæ“ä½œåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯
3. **ä¸´æ—¶å‡­è¯**: ä¸Šä¼ å‡­è¯æœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦åŠæ—¶ä½¿ç”¨
4. **åˆ†ç‰‡å¤§å°**: åˆ†ç‰‡å¤§å°å½±å“ä¸Šä¼ é€Ÿåº¦å’Œç¨³å®šæ€§ï¼Œå»ºè®®10MB
5. **å›è°ƒå¤„ç†**: å›è°ƒURLå’Œå‚æ•°éœ€è¦Base64ç¼–ç 

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£](https://www.yuque.com/115yun/open/qur839kyx9cgxpxi)
- [115ç½‘ç›˜æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§](./115ç½‘ç›˜æ–‡ä»¶ä¸Šä¼ APIå®˜æ–¹æ–‡æ¡£å¯¹ç…§.md)
- [115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£é›†æˆå®Œæˆæ€»ç»“](./115ç½‘ç›˜å®˜æ–¹APIæ–‡æ¡£é›†æˆå®Œæˆæ€»ç»“.md)
- [oss2åº“æ–‡æ¡£](https://help.aliyun.com/document_detail/32026.html)

## âœ… æ€»ç»“

å·²æˆåŠŸå®ç°115ç½‘ç›˜OSSæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… OSSä¸Šä¼ å®¢æˆ·ç«¯ï¼ˆåŸºäºoss2åº“ï¼‰
2. âœ… ä¸Šä¼ ç®¡ç†å™¨ï¼ˆå®Œæ•´ä¸Šä¼ æµç¨‹ï¼‰
3. âœ… ç§’ä¼ æ”¯æŒ
4. âœ… äºŒæ¬¡è®¤è¯å¤„ç†
5. âœ… åˆ†ç‰‡ä¸Šä¼ 
6. âœ… æ–­ç‚¹ç»­ä¼ 
7. âœ… è¿›åº¦å›è°ƒ
8. âœ… é”™è¯¯å¤„ç†

å®ç°ä¸VabHub-1ä¿æŒä¸€è‡´ï¼ŒåŒæ—¶è¿›è¡Œäº†å¼‚æ­¥ä¼˜åŒ–å’Œä»£ç ç»“æ„æ”¹è¿›ã€‚ä¸‹ä¸€æ­¥å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šå®ç°ä¸Šä¼ ä»»åŠ¡ç®¡ç†ã€è¿›åº¦æŒä¹…åŒ–ç­‰åŠŸèƒ½ã€‚

