# 前后端对齐检查执行指南

**状态**: ⚠️ 需要手动启动后端服务

---

## 📋 一、当前状态

### ⚠️ 后端服务未运行

检查结果显示后端服务未在 `http://localhost:8001` 运行，需要先启动后端服务。

---

## 📋 二、执行步骤

### 步骤1: 启动后端服务

**方法1: 使用uvicorn直接启动**

```bash
cd VabHub/backend
python -m uvicorn main:app --host 0.0.0.0 --port 8001
```

**方法2: 使用后台进程启动（Windows PowerShell）**

```powershell
cd VabHub/backend
Start-Process python -ArgumentList "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000" -WindowStyle Hidden
```

**方法3: 使用后台进程启动（Linux/Mac）**

```bash
cd VabHub/backend
nohup python -m uvicorn main:app --host 0.0.0.0 --port 8001 > backend.log 2>&1 &
```

---

### 步骤2: 等待服务完全启动

**等待时间**: 约30-60秒

**验证服务是否启动**:

```bash
# Windows PowerShell
curl http://localhost:8001/healthz

# 或使用Python
python -c "import requests; r = requests.get('http://localhost:8001/healthz', timeout=5); print('服务已启动' if r.status_code == 200 else '服务未就绪')"
```

**验证OpenAPI规范是否可访问**:

```bash
# Windows PowerShell
curl http://localhost:8001/openapi.json

# 或使用Python
python -c "import requests; r = requests.get('http://localhost:8001/openapi.json', timeout=10); print('OpenAPI可访问' if r.status_code == 200 else 'OpenAPI不可访问')"
```

---

### 步骤3: 运行前后端对齐检查

**执行命令**:

```bash
cd VabHub/backend
python tools/check_ui_backend_alignment.py \
  --openapi http://localhost:8001/openapi.json \
  --expected tools/ui_expected_endpoints.txt \
  --output alignment_report.json
```

---

### 步骤4: 查看检查结果

**查看报告**:

```bash
# Windows PowerShell
Get-Content alignment_report.json | ConvertFrom-Json | ConvertTo-Json -Depth 10

# Linux/Mac
cat alignment_report.json | python -m json.tool
```

**报告内容**:
- `missing_endpoints`: 前端期望但后端未提供的API端点
- `extra_endpoints`: 后端提供但前端未期望的API端点
- `ok`: 是否完全对齐（true/false）

---

## 📋 三、常见问题

### 问题1: 服务启动超时

**原因**: 后端服务需要更长时间初始化

**解决方案**:
- 增加等待时间（从30秒增加到60秒或更长）
- 检查服务启动日志
- 检查端口8001是否被占用

---

### 问题2: OpenAPI规范不可访问

**原因**: 服务未完全启动或配置问题

**解决方案**:
- 等待更长时间
- 检查服务日志
- 确认FastAPI应用正确配置了OpenAPI

---

### 问题3: 端口被占用

**原因**: 端口8001已被其他进程占用

**解决方案**:
- 更改端口（修改启动命令中的 `--port` 参数）
- 或停止占用端口的进程

**Windows检查端口占用**:
```powershell
netstat -ano | findstr :8000
```

**Linux/Mac检查端口占用**:
```bash
lsof -i :8000
```

---

## 📋 四、自动化脚本

### Windows PowerShell脚本

创建 `run_alignment_check.ps1`:

```powershell
# 启动后端服务
Write-Host "启动后端服务..."
Start-Process python -ArgumentList "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000" -WindowStyle Hidden

# 等待服务启动
Write-Host "等待服务启动（30秒）..."
Start-Sleep -Seconds 30

# 验证服务
Write-Host "验证服务..."
$response = Invoke-WebRequest -Uri "http://localhost:8001/healthz" -TimeoutSec 5 -ErrorAction SilentlyContinue
if ($response.StatusCode -eq 200) {
    Write-Host "服务已启动"
} else {
    Write-Host "服务未就绪，继续等待..."
    Start-Sleep -Seconds 30
}

# 运行对齐检查
Write-Host "运行前后端对齐检查..."
python tools/check_ui_backend_alignment.py `
  --openapi http://localhost:8001/openapi.json `
  --expected tools/ui_expected_endpoints.txt `
  --output alignment_report.json

# 显示结果
Write-Host "检查完成，查看 alignment_report.json"
```

---

### Linux/Mac Bash脚本

创建 `run_alignment_check.sh`:

```bash
#!/bin/bash

# 启动后端服务
echo "启动后端服务..."
nohup python -m uvicorn main:app --host 0.0.0.0 --port 8001 > backend.log 2>&1 &
BACKEND_PID=$!

# 等待服务启动
echo "等待服务启动（30秒）..."
sleep 30

# 验证服务
echo "验证服务..."
if curl -f http://localhost:8001/healthz > /dev/null 2>&1; then
    echo "服务已启动"
else
    echo "服务未就绪，继续等待..."
    sleep 30
fi

# 运行对齐检查
echo "运行前后端对齐检查..."
python tools/check_ui_backend_alignment.py \
  --openapi http://localhost:8001/openapi.json \
  --expected tools/ui_expected_endpoints.txt \
  --output alignment_report.json

# 显示结果
echo "检查完成，查看 alignment_report.json"

# 停止后端服务（可选）
# kill $BACKEND_PID
```

---

## 📋 五、总结

### ✅ 准备工作

1. **启动后端服务**: 使用上述任一方法启动服务
2. **等待服务就绪**: 等待30-60秒
3. **验证服务**: 确认服务可访问

### ✅ 执行检查

1. **运行对齐检查工具**: 使用提供的命令
2. **查看报告**: 检查 `alignment_report.json`
3. **修复问题**: 根据报告修复缺失或多余的端点

---

**文档生成时间**: 2025-01-XX  
**状态**: ⚠️ 需要手动启动后端服务后执行

**下一步**: 按照上述步骤启动后端服务并运行对齐检查

