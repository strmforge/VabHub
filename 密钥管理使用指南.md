# VabHub 密钥管理使用指南

## 📋 概述

VabHub采用自动生成随机密钥机制，确保每个安装实例都有唯一的密钥，提高系统安全性。本指南将详细介绍密钥管理的使用方法。

---

## 🔑 密钥类型

VabHub系统会自动生成以下三种密钥：

### 1. SECRET_KEY
- **用途**: 应用主密钥，用于加密和签名
- **长度**: 43字符（32字节base64编码）
- **生成时机**: 首次启动时自动生成

### 2. JWT_SECRET_KEY
- **用途**: JWT Token签名密钥，用于用户认证和STRM重定向
- **长度**: 43字符（32字节base64编码）
- **生成时机**: 首次启动时自动生成

### 3. API_TOKEN
- **用途**: API令牌，用于STRM重定向等功能的API调用
- **长度**: 43字符（32字节base64编码）
- **生成时机**: 首次启动时自动生成

---

## 📁 密钥文件位置

所有密钥都存储在以下文件中：

```
./data/.vabhub_secrets.json
```

**文件格式**:
```json
{
  "SECRET_KEY": "your-secret-key-here",
  "JWT_SECRET_KEY": "your-jwt-secret-key-here",
  "API_TOKEN": "your-api-token-here"
}
```

**文件权限**:
- Unix系统: `0o600`（仅所有者可读写）
- Windows系统: 默认权限

---

## 🚀 首次安装

### 自动生成流程

1. **启动应用**
   - 系统会自动检测密钥文件是否存在
   - 如果不存在，会自动生成所有必需的密钥

2. **密钥生成**
   - 使用`secrets.token_urlsafe(32)`生成随机密钥
   - 密钥长度：43字符（URL安全的base64编码）

3. **密钥保存**
   - 自动保存到`./data/.vabhub_secrets.json`
   - 设置适当的文件权限

### 验证密钥生成

启动应用后，检查以下内容：

1. **密钥文件存在**
   ```bash
   ls -la ./data/.vabhub_secrets.json
   ```

2. **文件权限正确**（Unix系统）
   ```bash
   stat -c "%a" ./data/.vabhub_secrets.json
   # 应该显示: 600
   ```

3. **文件内容格式正确**
   ```bash
   cat ./data/.vabhub_secrets.json
   ```

---

## 🔄 重启应用

### 密钥加载

重启应用时，系统会：

1. **自动加载密钥**
   - 从`./data/.vabhub_secrets.json`读取密钥
   - 验证密钥格式和完整性

2. **保持一致性**
   - 确保每次启动使用相同的密钥
   - 避免密钥丢失或变更

### 验证密钥加载

查看应用日志，应该看到：

```
密钥已从 data/.vabhub_secrets.json 加载
```

---

## 🌍 环境变量覆盖

### 设置环境变量

可以通过环境变量覆盖密钥值：

```bash
# Linux/macOS
export SECRET_KEY="your-custom-secret-key"
export JWT_SECRET_KEY="your-custom-jwt-secret-key"
export API_TOKEN="your-custom-api-token"

# Windows (PowerShell)
$env:SECRET_KEY="your-custom-secret-key"
$env:JWT_SECRET_KEY="your-custom-jwt-secret-key"
$env:API_TOKEN="your-custom-api-token"
```

### 优先级

环境变量 > 配置文件 > 默认值

### 使用场景

- **Docker部署**: 使用Docker secrets或环境变量
- **生产环境**: 通过环境变量设置密钥，更安全
- **多实例部署**: 每个实例使用不同的密钥

---

## 🔒 安全最佳实践

### 1. 密钥文件安全

- ✅ **不要提交到Git仓库**
  ```bash
  # 添加到 .gitignore
  echo "data/.vabhub_secrets.json" >> .gitignore
  ```

- ✅ **定期备份密钥文件**
  ```bash
  # 备份密钥文件
  cp ./data/.vabhub_secrets.json ./backup/.vabhub_secrets.json.backup
  ```

- ✅ **设置正确的文件权限**（Unix系统）
  ```bash
  chmod 600 ./data/.vabhub_secrets.json
  ```

### 2. 生产环境建议

- ✅ **使用环境变量设置密钥**
  ```bash
  # 在启动脚本中设置
  export SECRET_KEY="$(openssl rand -base64 32)"
  export JWT_SECRET_KEY="$(openssl rand -base64 32)"
  export API_TOKEN="$(openssl rand -base64 32)"
  ```

- ✅ **使用密钥管理服务**
  - AWS Secrets Manager
  - HashiCorp Vault
  - Kubernetes Secrets

- ✅ **定期轮换密钥**（可选）
  - 定期更新密钥以提高安全性
  - 注意：轮换密钥会导致现有Token失效

### 3. Docker部署

```yaml
# docker-compose.yml
services:
  vabhub:
    image: vabhub:latest
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - API_TOKEN=${API_TOKEN}
    volumes:
      - ./data:/app/data
```

---

## 🖥️ 系统设置UI

### 查看API Token

1. **打开系统设置**
   - 登录VabHub
   - 导航到"设置" → "系统设置"

2. **查看API Token**
   - 在"系统密钥"部分可以看到API Token
   - Token是只读的，无法修改

3. **复制API Token**
   - 点击复制按钮
   - Token会复制到剪贴板

### 密钥管理说明

系统设置页面包含：

- ✅ **密钥管理说明**: 介绍密钥生成和管理机制
- ✅ **API Token显示**: 显示当前API Token（只读）
- ✅ **安全提示**: 提供安全使用建议
- ✅ **密钥文件位置**: 显示密钥文件路径

---

## 🔧 故障排除

### 问题1: 密钥文件不存在

**症状**: 应用启动时提示密钥文件不存在

**解决方案**:
1. 检查`./data`目录是否存在
2. 确保应用有写入权限
3. 手动创建目录：
   ```bash
   mkdir -p ./data
   chmod 755 ./data
   ```

### 问题2: 密钥文件权限错误

**症状**: 应用无法读取密钥文件

**解决方案**:
```bash
# 修复文件权限
chmod 600 ./data/.vabhub_secrets.json
chown $(whoami) ./data/.vabhub_secrets.json
```

### 问题3: 密钥丢失

**症状**: 密钥文件被删除或损坏

**解决方案**:
1. **从备份恢复**
   ```bash
   cp ./backup/.vabhub_secrets.json.backup ./data/.vabhub_secrets.json
   ```

2. **重新生成密钥**
   ```bash
   # 删除现有文件，重启应用
   rm ./data/.vabhub_secrets.json
   # 重启应用，系统会自动生成新密钥
   ```

**注意**: 重新生成密钥会导致：
- 现有JWT Token失效（需要重新登录）
- STRM重定向功能需要更新Token

### 问题4: 环境变量不生效

**症状**: 设置了环境变量，但系统仍使用配置文件中的密钥

**解决方案**:
1. 检查环境变量名称是否正确（全大写）
2. 确保在应用启动前设置环境变量
3. 检查环境变量值是否包含特殊字符（需要转义）

---

## 📊 密钥管理测试

### 运行测试脚本

```bash
cd backend
python scripts/test_secret_manager.py
```

### 测试内容

1. ✅ **密钥生成**: 验证首次安装时自动生成密钥
2. ✅ **密钥加载**: 验证重启后正确加载密钥
3. ✅ **环境变量覆盖**: 验证环境变量优先级
4. ✅ **密钥唯一性**: 验证每个实例密钥不同
5. ✅ **STRM集成**: 验证STRM功能正常使用动态密钥

---

## 📚 相关文档

- `自动生成随机密钥机制实现总结.md` - 实现文档
- `密钥管理功能测试完成总结.md` - 测试文档
- `MoviePilot-STRM-URL结构分析.md` - STRM URL分析

---

## ❓ 常见问题

### Q1: 可以手动修改密钥吗？

**A**: 可以，但不推荐。手动修改密钥可能导致：
- 现有Token失效
- 需要重新登录
- STRM功能异常

### Q2: 密钥会过期吗？

**A**: 不会。密钥是永久有效的，除非手动删除或重新生成。

### Q3: 多个实例可以共享密钥吗？

**A**: 可以，但不推荐。每个实例应该有唯一的密钥以确保安全性。

### Q4: 如何备份密钥？

**A**: 定期复制`./data/.vabhub_secrets.json`文件到安全位置。

### Q5: 密钥丢失后如何恢复？

**A**: 
1. 从备份恢复（推荐）
2. 删除密钥文件，重启应用自动生成新密钥（注意：会导致现有Token失效）

---

## 🎯 总结

VabHub的密钥管理机制：

- ✅ **自动化**: 首次启动自动生成，无需手动配置
- ✅ **安全性**: 每个实例唯一，足够随机
- ✅ **灵活性**: 支持环境变量覆盖
- ✅ **可靠性**: 密钥持久化，重启后保持一致
- ✅ **易用性**: 系统设置UI提供可视化管理

**建议**: 
- 生产环境使用环境变量设置密钥
- 定期备份密钥文件
- 不要将密钥文件提交到Git仓库

---

**最后更新**: 2025-01-XX  
**版本**: VabHub 1.0

