# 系统更新功能增强总结

## 概述

根据用户需求，VabHub的系统更新功能已经增强，**超越了MoviePilot的实现**，提供了更智能、更友好的更新体验。

## MoviePilot的实现方式

### 功能点
1. **每次重启检测更新** - 重启时自动检查是否有更新
2. **系统设置页面显示更新状态** - 在关于MoviePilot页面显示是否有更新
3. **头像下拉菜单重启选项** - 点击头像下拉菜单中的重启完成更新

### 局限性
- 更新状态只在设置页面显示
- 需要手动进入设置页面才能看到更新状态
- 更新提示不够明显

## VabHub的增强实现

### 1. 启动时自动检测更新 ✅

**实现位置**：`backend/main.py`

**功能**：
- 系统启动时自动检查更新模式配置
- 如果启用自动更新，在后台任务中检查并执行更新
- **先检查再更新**：先检查是否有更新，有更新才执行更新操作
- 不阻塞系统启动，异步执行

**代码逻辑**：
```python
# 从数据库读取更新模式配置
update_mode_value = await settings_service.get_setting("system_auto_update_mode", category="system")
auto_update_enabled = await settings_service.get_setting("system_auto_update_enabled", category="system", default=False)

if update_mode_value != "never" and auto_update_enabled:
    # 先检查是否有更新
    update_info = await update_manager.check_update_available()
    if update_info.get("has_update"):
        # 有更新才执行更新
        result = await update_manager.update_system()
```

### 2. 定期检查更新状态 ✅

**实现位置**：`frontend/src/layouts/components/AppBar.vue`

**功能**：
- 前端启动时立即检查更新
- **每30分钟自动检查一次**（可配置）
- 静默检查，不影响用户体验
- 发现更新时自动显示提示

**代码逻辑**：
```typescript
// 启动时检查更新，然后每30分钟检查一次
onMounted(() => {
  checkUpdate()
  updateCheckInterval = window.setInterval(checkUpdate, 30 * 60 * 1000) // 30分钟
})
```

### 3. 头像下拉菜单显示更新状态 ✅

**实现位置**：`frontend/src/layouts/components/AppBar.vue`

**功能增强**：

#### 3.1 更新提示徽章
- 头像右上角显示**红色圆点徽章**，提示有可用更新
- 视觉提示明显，用户一眼就能看到

#### 3.2 更新状态菜单项
- 在用户菜单中显示**"发现新版本"**菜单项
- 显示版本对比：`当前版本 → 最新版本`
- 高亮显示（黄色背景），吸引用户注意

#### 3.3 智能重启选项
- **有更新时**：显示"重启并更新"，带"更新"标签
- **无更新时**：显示"重启系统"
- 根据更新状态动态调整菜单文本

### 4. 更新对话框 ✅

**功能**：
- 点击"发现新版本"菜单项打开更新对话框
- 显示详细的版本信息
- **两种更新方式**：
  - **仅重启** - 如果已自动更新，只需重启
  - **更新并重启** - 先更新再重启
- 用户可以选择更新方式

### 5. 重启API端点 ✅

**实现位置**：`backend/app/api/system_update.py`

**功能**：
- `POST /api/system/restart` - 重启系统
- 根据部署方式选择重启方法：
  - **Docker**：执行`docker restart`
  - **源代码**：触发进程管理器重启（TODO）
- 如果启用自动更新，重启时会自动更新

## 功能对比

| 功能 | MoviePilot | VabHub |
|------|-----------|--------|
| **启动时检测更新** | ✅ 重启时检测 | ✅ 启动时检测（更早） |
| **定期检查更新** | ❌ | ✅ 每30分钟自动检查 |
| **更新状态显示** | ✅ 设置页面 | ✅ **头像徽章 + 菜单项**（更明显） |
| **更新提示** | ⚠️ 需要进入设置页面 | ✅ **实时提示，无需操作** |
| **重启选项** | ✅ 头像下拉菜单 | ✅ **智能显示（有更新/无更新）** |
| **更新方式选择** | ❌ | ✅ **仅重启/更新并重启** |
| **Docker支持** | ❌ | ✅ **自动检测并支持** |

## 用户体验改进

### 1. 更明显的更新提示
- **MoviePilot**：需要进入设置页面才能看到更新状态
- **VabHub**：头像上直接显示红色徽章，用户一眼就能看到

### 2. 更智能的更新流程
- **MoviePilot**：重启时自动更新（如果启用）
- **VabHub**：
  - 启动时自动检查并更新（如果启用）
  - 前端定期检查更新状态
  - 用户可以选择更新方式

### 3. 更友好的交互
- **MoviePilot**：重启选项固定显示
- **VabHub**：
  - 有更新时显示"重启并更新"（带标签）
  - 无更新时显示"重启系统"
  - 更新对话框提供详细信息和选择

## 技术实现细节

### 后端实现

1. **启动时自动更新**（`backend/main.py`）
   - 从数据库读取配置
   - 异步执行，不阻塞启动
   - 先检查再更新，避免不必要的操作

2. **重启API**（`backend/app/api/system_update.py`）
   - 支持Docker和源代码两种部署方式
   - 检查自动更新配置
   - 返回更新状态信息

### 前端实现

1. **更新状态管理**（`frontend/src/layouts/components/AppBar.vue`）
   - 响应式状态：`hasUpdate`、`updateInfo`
   - 定期检查：每30分钟自动检查
   - 生命周期管理：组件卸载时清理定时器

2. **UI组件**
   - 头像徽章：使用`v-badge`显示更新提示
   - 更新菜单项：高亮显示，带版本对比
   - 更新对话框：提供详细信息和选择

## 配置说明

### 自动更新配置

在系统设置中配置：
- `system_auto_update_mode`：更新模式（never/release/dev）
- `system_auto_update_enabled`：是否启用自动更新

### 前端检查间隔

当前设置为30分钟，可以在`AppBar.vue`中修改：
```typescript
updateCheckInterval = window.setInterval(checkUpdate, 30 * 60 * 1000) // 30分钟
```

## 使用流程

### 场景1：自动更新已启用

1. **系统启动** → 自动检查更新 → 如果有更新，自动更新
2. **前端加载** → 立即检查更新状态 → 显示更新提示
3. **用户看到更新提示** → 点击头像 → 看到"发现新版本"菜单项
4. **用户选择**：
   - 点击"发现新版本" → 打开更新对话框 → 选择更新方式
   - 直接点击"重启并更新" → 更新并重启

### 场景2：自动更新未启用

1. **系统启动** → 不执行自动更新
2. **前端加载** → 检查更新状态 → 显示更新提示
3. **用户看到更新提示** → 点击头像 → 看到"发现新版本"菜单项
4. **用户选择**：
   - 点击"发现新版本" → 打开更新对话框 → 选择"更新并重启"
   - 直接点击"重启并更新" → 更新并重启

## 总结

VabHub的系统更新功能在MoviePilot的基础上进行了全面增强：

1. ✅ **更早的更新检测** - 启动时自动检测，而不是等到重启
2. ✅ **更明显的更新提示** - 头像徽章 + 菜单项，无需进入设置页面
3. ✅ **更智能的更新流程** - 定期检查 + 用户选择
4. ✅ **更好的用户体验** - 实时提示、详细信息、灵活选择
5. ✅ **更完善的部署支持** - Docker和源代码两种方式

这些改进使得VabHub的系统更新功能**超越了MoviePilot**，提供了更智能、更友好的更新体验！

