# 定时任务系统说明

## 📋 概述

VabHub现在实现了**完整的定时任务调度系统**，支持自动执行订阅搜索、更新下载状态、清理过期缓存等任务。

**完成时间**: 2025-11-08  
**状态**: ✅ 定时任务系统已实现

---

## 🎯 功能特性

### 1. 自动执行订阅搜索
- **频率**: 每小时执行一次
- **功能**: 自动搜索所有启用的订阅
- **任务ID**: `auto_search_subscriptions`

### 2. 更新下载状态
- **频率**: 每30秒执行一次
- **功能**: 自动更新所有下载任务的状态
- **任务ID**: `update_download_status`

### 3. 清理过期缓存
- **频率**: 每天凌晨2点执行
- **功能**: 清理L3数据库缓存中的过期条目
- **任务ID**: `cleanup_expired_cache`

### 4. 站点自动签到
- **频率**: 每天凌晨3点执行
- **功能**: 自动为所有启用的站点执行签到
- **任务ID**: `auto_checkin_sites`

### 5. 更新HNR监控任务
- **频率**: 每5分钟执行一次
- **功能**: 更新HNR监控任务的指标（分享率、做种时间等）
- **任务ID**: `update_hnr_tasks`

---

## 🔧 技术实现

### 调度器
- **库**: APScheduler (AsyncIOScheduler)
- **存储**: MemoryJobStore (内存存储)
- **执行器**: AsyncIOExecutor (异步执行)
- **时区**: Asia/Shanghai

### 任务配置
- **合并执行**: `coalesce=True` (合并多个待执行的任务)
- **最大并发**: `max_instances=3` (每个任务最多3个并发实例)
- **宽限时间**: `misfire_grace_time=60` (任务错过执行时间的宽限时间)

---

## 📊 任务列表

| 任务ID | 任务名称 | 触发方式 | 频率 | 状态 |
|--------|----------|----------|------|------|
| `auto_search_subscriptions` | 自动执行订阅搜索 | 间隔触发 | 1小时 | ✅ 启用 |
| `update_download_status` | 更新下载状态 | 间隔触发 | 30秒 | ✅ 启用 |
| `cleanup_expired_cache` | 清理过期缓存 | Cron触发 | 每天2:00 | ✅ 启用 |
| `auto_checkin_sites` | 站点自动签到 | Cron触发 | 每天3:00 | ✅ 启用 |
| `update_hnr_tasks` | 更新HNR监控任务 | 间隔触发 | 5分钟 | ✅ 启用 |

---

## 🎯 使用示例

### 1. 查看所有任务
```bash
GET /api/v1/scheduler/jobs
```

响应:
```json
[
  {
    "id": "auto_search_subscriptions",
    "name": "自动执行订阅搜索",
    "next_run_time": "2025-11-08T15:00:00",
    "trigger": "interval[0:01:00]"
  },
  {
    "id": "update_download_status",
    "name": "更新下载状态",
    "next_run_time": "2025-11-08T14:31:00",
    "trigger": "interval[0:00:30]"
  }
]
```

### 2. 查看任务详情
```bash
GET /api/v1/scheduler/jobs/auto_search_subscriptions
```

### 3. 立即执行任务
```bash
POST /api/v1/scheduler/jobs/auto_search_subscriptions/run
```

### 4. 移除任务
```bash
DELETE /api/v1/scheduler/jobs/auto_search_subscriptions
```

---

## 🔍 任务执行流程

### 自动执行订阅搜索
```
1. 获取所有启用的订阅
2. 遍历每个订阅
3. 执行搜索（使用订阅的搜索规则）
4. 如果找到匹配的资源，自动下载（如果启用）
```

### 更新下载状态
```
1. 获取所有下载任务
2. 从下载器（qBittorrent/Transmission）获取状态
3. 更新数据库中的任务状态
4. 通过WebSocket广播更新
```

### 清理过期缓存
```
1. 查询L3数据库缓存
2. 查找所有过期的缓存条目
3. 批量删除过期条目
4. 记录清理数量
```

### 站点自动签到
```
1. 获取所有启用的站点
2. 遍历每个站点
3. 执行签到操作
4. 更新签到时间
```

### 更新HNR监控任务
```
1. 获取所有监控中的HNR任务
2. 从下载器获取任务指标
3. 更新分享率、做种时间等
4. 重新计算风险评分
```

---

## 💡 扩展任务

### 添加自定义任务

```python
from app.core.scheduler import get_scheduler
from apscheduler.triggers.interval import IntervalTrigger

scheduler = get_scheduler()

# 添加新任务
scheduler.add_job(
    func=my_custom_task,
    trigger=IntervalTrigger(minutes=10),
    id="my_custom_task",
    name="我的自定义任务",
    replace_existing=True
)
```

### 使用Cron表达式

```python
from apscheduler.triggers.cron import CronTrigger

scheduler.add_job(
    func=my_task,
    trigger=CronTrigger(hour=2, minute=0),  # 每天凌晨2点
    id="my_task",
    name="我的任务"
)
```

---

## 🔧 配置说明

### 任务默认配置
- **合并执行**: 启用（避免任务堆积）
- **最大并发**: 3个实例
- **宽限时间**: 60秒

### 时区配置
- **默认时区**: Asia/Shanghai
- **Cron任务**: 使用配置的时区

---

## 📈 性能优化

### 1. 异步执行
- 所有任务使用异步函数
- 不会阻塞主线程
- 支持并发执行

### 2. 任务合并
- 启用任务合并，避免重复执行
- 减少系统负载

### 3. 错误处理
- 任务执行失败不会影响其他任务
- 详细的错误日志记录

---

## 🐛 故障排除

### 任务不执行
1. 检查调度器是否启动
2. 检查任务是否启用
3. 查看日志中的错误信息

### 任务执行失败
1. 查看任务日志
2. 检查任务函数的实现
3. 检查依赖服务是否正常

### 任务执行频率不正确
1. 检查触发器的配置
2. 检查时区设置
3. 查看任务的next_run_time

---

## ✅ 总结

### 优势
1. ✅ **自动化**: 自动执行常用任务
2. ✅ **可靠性**: 任务执行失败不影响其他任务
3. ✅ **灵活性**: 支持添加自定义任务
4. ✅ **可监控**: 提供API查看任务状态

### 默认任务
1. ✅ 自动执行订阅搜索
2. ✅ 更新下载状态
3. ✅ 清理过期缓存
4. ✅ 站点自动签到
5. ✅ 更新HNR监控任务

---

**最后更新**: 2025-11-08  
**状态**: ✅ 定时任务系统已实现

