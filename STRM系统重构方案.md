# STRMç³»ç»Ÿé‡æ„æ–¹æ¡ˆ

## ğŸ“‹ ç”¨æˆ·éœ€æ±‚åˆ†æ

### æ ¸å¿ƒåŠŸèƒ½
1. **STRMæ–‡ä»¶ç”Ÿæˆ**ï¼šå°†115ç½‘ç›˜çš„åª’ä½“æ–‡ä»¶ç”ŸæˆSTRMæ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°STRMåª’ä½“åº“æ–‡ä»¶å¤¹
2. **åª’ä½“åº“è¯†åˆ«**ï¼šè®©Embyç­‰åª’ä½“åº“è¯†åˆ«å¹¶æ’­æ”¾å­˜åœ¨115ç½‘ç›˜çš„åª’ä½“
3. **è¦†ç›–æ¨¡å¼**ï¼šæ”¯æŒneverã€alwaysã€sizeä¸‰ç§è¦†ç›–æ¨¡å¼
4. **åˆ®å‰Šé›†æˆ**ï¼š
   - 115ç½‘ç›˜åˆ®å‰Šï¼ˆå¯é€‰ï¼Œç”±ç”¨æˆ·å†³å®šï¼‰
   - å¦‚æœ115ç½‘ç›˜å·²å¼€å¯åˆ®å‰Šå¹¶å®Œæˆåˆ®å‰Šï¼Œç”Ÿæˆæœ¬åœ°STRMæ–‡ä»¶æ—¶åŒæ­¥ä¸‹è½½åˆ®å‰Šæ–‡ä»¶åˆ°æœ¬åœ°
   - å¦‚æœæœ¬åœ°STRMåª’ä½“åº“æ–‡ä»¶å¤¹å¼€å¯åˆ®å‰ŠåŠŸèƒ½ï¼Œç”Ÿæˆæœ¬åœ°STRMæ–‡ä»¶æ—¶è¦é¡ºä¾¿åˆ®å‰Š
   - å¦‚æœéƒ½æ²¡å¼€ï¼Œéƒ½ä¸åˆ®å‰Š
5. **æœåŠ¡å¼€å…³**ï¼šå¦‚æœç³»ç»Ÿä¸­ä¸å¼€å¯STRMæœåŠ¡åŠŸèƒ½ï¼Œä¹Ÿä¸ä¼šç”ŸæˆSTRMæ–‡ä»¶

### éæ ¸å¿ƒåŠŸèƒ½ï¼ˆåº”ç§»é™¤æˆ–ç‹¬ç«‹ï¼‰
- ä¸Šä¼ åª’ä½“æ–‡ä»¶
- é‡å‘½åæ–‡ä»¶
- åˆ†ç±»æ–‡ä»¶
- æ–°å»ºæ–‡ä»¶å¤¹
- ç§»åŠ¨ã€å¤åˆ¶æ–‡ä»¶

## ğŸ¯ é‡æ„ç›®æ ‡

1. **ç®€åŒ–STRMç³»ç»Ÿ**ï¼šåªä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼ˆç”ŸæˆSTRMæ–‡ä»¶ï¼‰
2. **æ•´åˆVabHub-1å®ç°**ï¼šä½¿ç”¨VabHub-1ä¸­æ›´å®Œæ•´çš„STRMå®ç°
3. **å®ç°è¦†ç›–æ¨¡å¼**ï¼šå‚è€ƒMoviePilotçš„å®ç°
4. **å®ç°åˆ®å‰Šé›†æˆ**ï¼šæ”¯æŒ115ç½‘ç›˜å’Œæœ¬åœ°åˆ®å‰Š
5. **å®ç°æœåŠ¡å¼€å…³**ï¼šæ”¯æŒå…¨å±€å¼€å…³æ§åˆ¶

## ğŸ“Š æ¶æ„è®¾è®¡

### 1. STRMç³»ç»Ÿæ ¸å¿ƒæ¨¡å—

```
STRMç³»ç»Ÿ
â”œâ”€â”€ STRMGenerator (æ ¸å¿ƒç”Ÿæˆå™¨)
â”‚   â”œâ”€â”€ ç”ŸæˆSTRMæ–‡ä»¶
â”‚   â”œâ”€â”€ è¦†ç›–æ¨¡å¼å¤„ç†
â”‚   â””â”€â”€ åˆ®å‰Šæ–‡ä»¶å¤„ç†
â”œâ”€â”€ STRMService (æœåŠ¡å±‚)
â”‚   â”œâ”€â”€ ç³»ç»Ÿè®¤è¯é›†æˆ
â”‚   â”œâ”€â”€ 115ç½‘ç›˜APIå®¢æˆ·ç«¯
â”‚   â””â”€â”€ æœåŠ¡å¼€å…³æ§åˆ¶
â”œâ”€â”€ STRMConfig (é…ç½®ç®¡ç†)
â”‚   â”œâ”€â”€ åª’ä½“åº“è·¯å¾„é…ç½®
â”‚   â”œâ”€â”€ è¦†ç›–æ¨¡å¼é…ç½®
â”‚   â”œâ”€â”€ åˆ®å‰Šé…ç½®
â”‚   â””â”€â”€ æœåŠ¡å¼€å…³é…ç½®
â””â”€â”€ STRMAPI (APIç«¯ç‚¹)
    â”œâ”€â”€ ç”ŸæˆSTRMæ–‡ä»¶
    â”œâ”€â”€ é‡å®šå‘æœåŠ¡
    â””â”€â”€ æœåŠ¡çŠ¶æ€
```

### 2. è¦†ç›–æ¨¡å¼å®ç°

```python
class OverwriteMode(str, Enum):
    """è¦†ç›–æ¨¡å¼"""
    NEVER = "never"  # ä»ä¸è¦†ç›–
    ALWAYS = "always"  # æ€»æ˜¯è¦†ç›–
    SIZE = "size"  # æŒ‰å¤§å°è¦†ç›–ï¼ˆå¤§è¦†ç›–å°ï¼‰
```

**è¦†ç›–é€»è¾‘**ï¼š
- `never`ï¼šå¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆ
- `always`ï¼šå¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œç›´æ¥è¦†ç›–
- `size`ï¼šå¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ¯”è¾ƒæ–‡ä»¶å¤§å°ï¼Œæ–°æ–‡ä»¶æ›´å¤§æ—¶è¦†ç›–

### 3. åˆ®å‰ŠåŠŸèƒ½é›†æˆ

```python
class ScrapeConfig(BaseModel):
    """åˆ®å‰Šé…ç½®"""
    # 115ç½‘ç›˜åˆ®å‰Š
    scrape_on_cloud: bool = False  # æ˜¯å¦åœ¨115ç½‘ç›˜åˆ®å‰Š
    download_scrape_files: bool = True  # æ˜¯å¦ä¸‹è½½115ç½‘ç›˜çš„åˆ®å‰Šæ–‡ä»¶åˆ°æœ¬åœ°
    
    # æœ¬åœ°STRMåª’ä½“åº“åˆ®å‰Š
    scrape_on_local: bool = False  # æ˜¯å¦åœ¨æœ¬åœ°STRMåª’ä½“åº“åˆ®å‰Š
    
    # åˆ®å‰Šæ–‡ä»¶ç±»å‹
    scrape_file_types: List[str] = ["nfo", "jpg", "png"]  # åˆ®å‰Šæ–‡ä»¶ç±»å‹
```

**åˆ®å‰Šæµç¨‹**ï¼š
1. å¦‚æœ115ç½‘ç›˜å·²å¼€å¯åˆ®å‰Šå¹¶å®Œæˆåˆ®å‰Šï¼Œç”Ÿæˆæœ¬åœ°STRMæ–‡ä»¶æ—¶åŒæ­¥ä¸‹è½½åˆ®å‰Šæ–‡ä»¶åˆ°æœ¬åœ°
2. å¦‚æœæœ¬åœ°STRMåª’ä½“åº“æ–‡ä»¶å¤¹å¼€å¯åˆ®å‰ŠåŠŸèƒ½ï¼Œç”Ÿæˆæœ¬åœ°STRMæ–‡ä»¶æ—¶è¦é¡ºä¾¿åˆ®å‰Š
3. å¦‚æœéƒ½æ²¡å¼€ï¼Œéƒ½ä¸åˆ®å‰Š

### 4. æœåŠ¡å¼€å…³

```python
class STRMConfig(BaseModel):
    """STRMé…ç½®"""
    # æœåŠ¡å¼€å…³
    enabled: bool = True  # STRMæœåŠ¡æ˜¯å¦å¯ç”¨
    
    # å…¶ä»–é…ç½®...
```

**æœåŠ¡å¼€å…³é€»è¾‘**ï¼š
- å¦‚æœ`enabled=False`ï¼Œä¸ç”ŸæˆSTRMæ–‡ä»¶
- å¦‚æœ`enabled=True`ï¼Œæ­£å¸¸ç”ŸæˆSTRMæ–‡ä»¶

## ğŸ”§ å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šç®€åŒ–STRMç³»ç»Ÿ
- [ ] ç§»é™¤ä¸Šä¼ ã€é‡å‘½åã€åˆ†ç±»ç­‰éæ ¸å¿ƒåŠŸèƒ½
- [ ] åªä¿ç•™STRMæ–‡ä»¶ç”Ÿæˆæ ¸å¿ƒåŠŸèƒ½
- [ ] æ›´æ–°APIç«¯ç‚¹ï¼Œç§»é™¤éæ ¸å¿ƒåŠŸèƒ½

### æ­¥éª¤2ï¼šæ•´åˆVabHub-1å®ç°
- [ ] æ•´åˆ`StrmFileGenerator`ç±»
- [ ] æ•´åˆ`CloudStorageStrmManager`ç±»
- [ ] æ•´åˆè¦†ç›–æ¨¡å¼å¤„ç†é€»è¾‘
- [ ] æ•´åˆæ–‡ä»¶æ ‘ç®¡ç†

### æ­¥éª¤3ï¼šå®ç°è¦†ç›–æ¨¡å¼
- [ ] å®ç°`OverwriteMode`æšä¸¾
- [ ] å®ç°è¦†ç›–æ¨¡å¼æ£€æŸ¥é€»è¾‘
- [ ] å®ç°æ–‡ä»¶å¤§å°æ¯”è¾ƒé€»è¾‘
- [ ] æ›´æ–°STRMç”Ÿæˆå™¨ï¼Œæ”¯æŒè¦†ç›–æ¨¡å¼

### æ­¥éª¤4ï¼šå®ç°åˆ®å‰Šé›†æˆ
- [ ] å®ç°`ScrapeConfig`é…ç½®ç±»
- [ ] å®ç°115ç½‘ç›˜åˆ®å‰Šæ–‡ä»¶ä¸‹è½½
- [ ] å®ç°æœ¬åœ°STRMåª’ä½“åº“åˆ®å‰Š
- [ ] æ›´æ–°STRMç”Ÿæˆå™¨ï¼Œæ”¯æŒåˆ®å‰ŠåŠŸèƒ½

### æ­¥éª¤5ï¼šå®ç°æœåŠ¡å¼€å…³
- [ ] åœ¨`STRMConfig`ä¸­æ·»åŠ `enabled`å­—æ®µ
- [ ] åœ¨STRMç”Ÿæˆå™¨ä¸­æ£€æŸ¥æœåŠ¡å¼€å…³
- [ ] åœ¨APIç«¯ç‚¹ä¸­æ£€æŸ¥æœåŠ¡å¼€å…³
- [ ] æ›´æ–°å‰ç«¯ç•Œé¢ï¼Œæ”¯æŒæœåŠ¡å¼€å…³

## ğŸ“ ä»£ç ç»“æ„

### 1. STRMç”Ÿæˆå™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
class STRMGenerator:
    """STRMæ–‡ä»¶ç”Ÿæˆå™¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰"""
    
    def __init__(self, config: STRMConfig, db: Optional[Any] = None):
        self.config = config
        self.db = db
        self._strm_service: Optional[STRMService] = None
    
    async def generate_strm_file(
        self,
        cloud_file_id: str,
        cloud_storage: str,
        media_info: Dict[str, Any],
        overwrite_mode: OverwriteMode = OverwriteMode.NEVER
    ) -> Optional[Path]:
        """
        ç”ŸæˆSTRMæ–‡ä»¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
        
        Args:
            cloud_file_id: äº‘å­˜å‚¨æ–‡ä»¶IDï¼ˆpick_codeï¼‰
            cloud_storage: äº‘å­˜å‚¨ç±»å‹ï¼ˆ115/123ï¼‰
            media_info: åª’ä½“ä¿¡æ¯
            overwrite_mode: è¦†ç›–æ¨¡å¼
        
        Returns:
            ç”Ÿæˆçš„STRMæ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœè·³è¿‡åˆ™è¿”å›None
        """
        # 1. æ£€æŸ¥æœåŠ¡å¼€å…³
        if not self.config.enabled:
            logger.info("STRMæœåŠ¡æœªå¯ç”¨ï¼Œè·³è¿‡ç”Ÿæˆ")
            return None
        
        # 2. æ£€æŸ¥è¦†ç›–æ¨¡å¼
        strm_path = self._get_strm_path(media_info)
        if strm_path.exists():
            if not await self._should_overwrite(strm_path, overwrite_mode):
                logger.info(f"STRMæ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆ: {strm_path}")
                return None
        
        # 3. ç”ŸæˆSTRMæ–‡ä»¶
        # ...
        
        # 4. å¤„ç†åˆ®å‰Šæ–‡ä»¶
        if self.config.scrape_config.download_scrape_files:
            await self._download_scrape_files(cloud_file_id, cloud_storage, strm_path.parent)
        
        if self.config.scrape_config.scrape_on_local:
            await self._scrape_local_strm(strm_path, media_info)
        
        return strm_path
```

### 2. è¦†ç›–æ¨¡å¼å¤„ç†

```python
async def _should_overwrite(
    self,
    existing_path: Path,
    overwrite_mode: OverwriteMode
) -> bool:
    """æ£€æŸ¥æ˜¯å¦åº”è¯¥è¦†ç›–ç°æœ‰æ–‡ä»¶"""
    if overwrite_mode == OverwriteMode.NEVER:
        return False
    elif overwrite_mode == OverwriteMode.ALWAYS:
        return True
    elif overwrite_mode == OverwriteMode.SIZE:
        # éœ€è¦è·å–æ–°æ–‡ä»¶å¤§å°è¿›è¡Œæ¯”è¾ƒ
        # è¿™é‡Œéœ€è¦ä»115ç½‘ç›˜è·å–æ–‡ä»¶å¤§å°
        new_size = await self._get_cloud_file_size(cloud_file_id)
        existing_size = existing_path.stat().st_size
        return new_size > existing_size
    return False
```

### 3. åˆ®å‰Šæ–‡ä»¶å¤„ç†

```python
async def _download_scrape_files(
    self,
    cloud_file_id: str,
    cloud_storage: str,
    local_dir: Path
):
    """ä¸‹è½½115ç½‘ç›˜çš„åˆ®å‰Šæ–‡ä»¶åˆ°æœ¬åœ°"""
    if not self.config.scrape_config.scrape_on_cloud:
        return
    
    # è·å–115ç½‘ç›˜APIå®¢æˆ·ç«¯
    api_client = await self._get_115_api_client()
    if not api_client:
        return
    
    # è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆåŒ…æ‹¬åˆ®å‰Šæ–‡ä»¶ï¼‰
    file_info = await api_client.get_file_info(file_id=cloud_file_id)
    
    # ä¸‹è½½åˆ®å‰Šæ–‡ä»¶ï¼ˆNFOã€å°é¢ç­‰ï¼‰
    scrape_files = await api_client.get_scrape_files(cloud_file_id)
    for scrape_file in scrape_files:
        await self._download_file(scrape_file, local_dir)
```

## ğŸ“š å‚è€ƒå®ç°

### MoviePilotè¦†ç›–æ¨¡å¼
- `never`ï¼šä»ä¸è¦†ç›–
- `always`ï¼šæ€»æ˜¯è¦†ç›–
- `size`ï¼šæŒ‰å¤§å°è¦†ç›–ï¼ˆå¤§è¦†ç›–å°ï¼‰

### VabHub-1 STRMå®ç°
- `StrmFileGenerator`ï¼šSTRMæ–‡ä»¶ç”Ÿæˆå™¨
- `CloudStorageStrmManager`ï¼šäº‘å­˜å‚¨STRMç®¡ç†å™¨
- `StrmFileConfig`ï¼šSTRMæ–‡ä»¶é…ç½®
- è¦†ç›–æ¨¡å¼ï¼šæ”¯æŒneverã€alwaysã€smart

## âœ… å®Œæˆæ ‡å‡†

1. âœ… STRMç³»ç»Ÿåªä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼ˆç”ŸæˆSTRMæ–‡ä»¶ï¼‰
2. âœ… æ•´åˆVabHub-1ä¸­çš„å®Œæ•´STRMå®ç°
3. âœ… å®ç°è¦†ç›–æ¨¡å¼ï¼ˆneverã€alwaysã€sizeï¼‰
4. âœ… å®ç°åˆ®å‰ŠåŠŸèƒ½é›†æˆï¼ˆ115ç½‘ç›˜å’Œæœ¬åœ°ï¼‰
5. âœ… å®ç°æœåŠ¡å¼€å…³
6. âœ… ç§»é™¤éæ ¸å¿ƒåŠŸèƒ½ï¼ˆä¸Šä¼ ã€é‡å‘½åã€åˆ†ç±»ç­‰ï¼‰

