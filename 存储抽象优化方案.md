# 存储抽象优化方案

## 📋 目标

统一存储接口，支持多种存储后端（115、RClone、OpenList），参考MoviePilot的最佳实践。

## 🔍 当前状态分析

### 现有实现
- ✅ `CloudStorageProvider` 基类已存在
- ✅ `Cloud115Provider` 已实现（使用开发者密钥）
- ✅ `RCloneProvider` 已实现
- ⚠️ `OpenListProvider` 已存在但可能不完整

### 与MoviePilot的差异
1. **接口设计**：
   - 当前：`CloudStorageProvider` - 简单的抽象接口
   - MoviePilot：`StorageBase` - 更丰富的功能（transtype、snapshot等）

2. **数据模型**：
   - 当前：`CloudFileInfo` - 基础文件信息
   - MoviePilot：`FileItem` - 更完整的文件项模型

3. **配置管理**：
   - 当前：通过credentials字典传递
   - MoviePilot：通过StorageHelper统一管理

## 🎯 优化方案

### 1. 增强存储基类接口

#### 添加功能
- ✅ 支持传输类型（transtype）
- ✅ 支持快照检查（snapshot）
- ✅ 统一的配置管理
- ✅ 二维码登录支持
- ✅ 登录状态检查

#### 接口方法扩展
```python
class StorageBase(ABC):
    # 基础方法（已有）
    - initialize()
    - is_authenticated()
    - list_files()
    - get_file_info()
    - create_folder()
    - delete_file()
    - upload_file()
    - download_file()
    - get_storage_usage()
    
    # 新增方法
    - check() -> bool  # 检查存储是否可用
    - get_config() -> StorageConfig  # 获取配置
    - set_config(conf: dict)  # 设置配置
    - generate_qrcode() -> Tuple[dict, str]  # 生成二维码
    - check_login() -> Dict[str, str]  # 检查登录状态
    - support_transtype() -> dict  # 支持的传输类型
    - is_support_transtype(transtype: str) -> bool  # 是否支持特定传输类型
```

### 2. 统一数据模型

#### FileItem模型
```python
@dataclass
class FileItem:
    """文件项（统一模型）"""
    path: Path  # 文件路径
    name: str  # 文件名
    type: str  # 类型（file/dir）
    size: int  # 大小（字节）
    modify_time: Optional[datetime]  # 修改时间
    is_dir: bool  # 是否为目录
    parent: Optional[Path]  # 父目录
    children: List['FileItem']  # 子项（目录时）
    metadata: Dict[str, Any]  # 元数据
```

#### StorageUsage模型
```python
@dataclass
class StorageUsage:
    """存储使用情况"""
    total: int  # 总容量
    used: int  # 已使用
    available: int  # 可用容量
    percentage: float  # 使用率
```

### 3. 配置管理优化

#### StorageConfig模型
```python
@dataclass
class StorageConfig:
    """存储配置"""
    provider: str  # 提供商类型
    name: str  # 配置名称
    enabled: bool  # 是否启用
    config: Dict[str, Any]  # 具体配置
    created_at: datetime
    updated_at: datetime
```

### 4. Provider实现优化

#### 115网盘Provider
- ✅ 保持现有实现
- ✅ 优化PKCE认证流程
- ✅ 添加OSS上传支持（阶段3）
- ✅ 完善错误处理

#### RClone Provider
- ✅ 保持现有实现
- ✅ 优化命令执行
- ✅ 完善文件操作
- ✅ 添加进度回调支持

#### OpenList Provider
- ⚠️ 检查并完善实现
- ⚠️ 添加OAuth Token获取
- ⚠️ 实现文件操作接口

## 📝 实施步骤

### 步骤1: 增强基类接口 ✅
- [x] 分析MoviePilot的StorageBase
- [ ] 扩展CloudStorageProvider接口
- [ ] 添加配置管理方法
- [ ] 添加传输类型支持

### 步骤2: 统一数据模型 ✅
- [ ] 创建FileItem模型
- [ ] 创建StorageConfig模型
- [ ] 更新现有Provider使用新模型
- [ ] 添加模型转换工具

### 步骤3: 完善Provider实现
- [ ] 优化115Provider
- [ ] 优化RCloneProvider
- [ ] 完善OpenListProvider
- [ ] 添加统一错误处理

### 步骤4: 创建Provider管理器
- [ ] 创建StorageProviderManager
- [ ] 实现Provider注册机制
- [ ] 实现Provider选择逻辑
- [ ] 添加Provider测试

## 🔧 技术细节

### 接口兼容性
- 保持向后兼容
- 现有代码可以继续使用
- 新功能通过扩展接口提供

### 数据模型转换
- 提供转换工具函数
- 自动转换旧模型到新模型
- 支持双向转换

### 错误处理
- 统一的异常类型
- 详细的错误信息
- 错误恢复机制

## 📊 预期效果

### 功能增强
- ✅ 统一的存储接口
- ✅ 更好的配置管理
- ✅ 支持更多存储后端
- ✅ 更完善的错误处理

### 代码质量
- ✅ 更清晰的代码结构
- ✅ 更好的可维护性
- ✅ 更容易扩展新Provider

### 用户体验
- ✅ 更统一的API
- ✅ 更好的错误提示
- ✅ 更稳定的功能

---

**状态**: 规划中  
**优先级**: 高  
**预计时间**: 1周

