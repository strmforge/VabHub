# STRM代理模式工作原理说明

**更新时间**: 2025-01-XX  
**用户需求**: 外出时通过Emby播放，直接连接115网盘流式传输，无需先下载到NAS

---

## 📋 一、用户需求

### 1.1 核心诉求

**场景**: 外出时通过映射的端口登录Emby（网页端或app端）

**需求**:
- ✅ **直接连接115网盘** - 播放时直接从115网盘流式传输
- ❌ **不需要先下载到NAS** - 不需要先下载再上传
- ✅ **流式传输** - 实时从115网盘获取视频数据

### 1.2 工作流程

```
用户外出
  ↓
通过映射端口访问Emby（网页端/App端）
  ↓
Emby播放STRM文件
  ↓
STRM文件包含VabHub代理URL
  ↓
Emby请求VabHub代理服务器
  ↓
VabHub代理服务器从115网盘获取下载地址
  ↓
VabHub代理服务器流式转发115网盘数据给Emby
  ↓
用户观看视频（实时流式传输，无需下载到NAS）
```

---

## 📋 二、实现原理

### 2.1 STRM文件格式

**STRM文件内容**:
```
http://your-vabhub-server:port/api/strm/stream/115/TOKEN
```

**说明**:
- `your-vabhub-server`: VabHub服务器地址（可以是公网IP或域名）
- `port`: VabHub服务端口
- `115`: 存储类型
- `TOKEN`: JWT token（包含pick_code等信息）

### 2.2 代理模式工作流程

```
1. Emby读取STRM文件
   ↓
2. Emby发起播放请求（包含Range头）
   GET /api/strm/stream/115/TOKEN
   Headers: Range: bytes=0-1023, Accept: video/mp4
   ↓
3. VabHub验证TOKEN，获取pick_code
   ↓
4. VabHub从115网盘获取下载地址
   ↓
5. VabHub代理转发请求到115网盘
   GET 115下载地址
   Headers: Range: bytes=0-1023, Accept: video/mp4
   ↓
6. 115网盘返回视频数据（流式）
   ↓
7. VabHub实时转发数据给Emby（流式传输）
   ↓
8. Emby播放视频（实时流式传输，无需下载到NAS）
```

### 2.3 关键特性

**✅ 流式传输**:
- 数据实时从115网盘获取
- 不存储到本地NAS
- 直接转发给Emby

**✅ 支持Range请求**:
- 支持断点续传
- 支持快进/快退
- 支持多段请求

**✅ 完全透明**:
- Emby认为在播放本地文件
- 实际上是流式传输
- 用户体验无差异

---

## 📋 三、代码实现

### 3.1 代理模式实现

```python
async def _proxy_stream_request(download_url: str, request: Request) -> StreamingResponse:
    """
    代理流媒体请求（支持Range请求和所有HTTP头）
    
    关键特性：
    1. 流式传输 - 实时从115网盘获取数据，不存储到本地
    2. 支持Range请求 - 支持断点续传、快进/快退
    3. 完全透明 - Emby认为在播放本地文件
    """
    # 1. 构建请求头（传递原始请求的关键头信息）
    headers = {}
    if "range" in request.headers:
        headers["range"] = request.headers["range"]
    if "accept" in request.headers:
        headers["accept"] = request.headers["accept"]
    
    # 2. 代理请求到115网盘（流式传输）
    async with httpx.AsyncClient(timeout=300.0) as client:
        response = await client.get(
            download_url,
            headers=headers
        )
        
        # 3. 实时转发数据给Emby（流式传输，不存储到本地）
        return StreamingResponse(
            response.iter_bytes(),  # 流式迭代器，实时传输
            status_code=response.status_code,
            headers=response_headers,
            media_type=response.headers.get("content-type", "video/mp4")
        )
```

### 3.2 关键点说明

**`response.iter_bytes()`**:
- ✅ 流式迭代器，实时传输数据
- ✅ 不等待完整文件下载
- ✅ 内存占用小
- ✅ 延迟低

**不存储到本地**:
- ✅ 数据直接从115网盘流式传输
- ✅ 不写入本地文件系统
- ✅ 不占用NAS存储空间
- ✅ 完全流式传输

---

## 📋 四、部署配置

### 4.1 网络配置

**内网访问**:
```
Emby -> VabHub (内网IP:端口) -> 115网盘
```

**外网访问（通过端口映射）**:
```
用户外出 -> 公网IP:映射端口 -> Emby -> VabHub -> 115网盘
```

### 4.2 STRM文件生成

**Local Redirect模式**:
```python
# STRM文件内容（内网）
http://192.168.1.100:8096/api/strm/stream/115/TOKEN

# STRM文件内容（外网，使用默认端口映射）
http://vabhub.example.com:8096/api/strm/stream/115/TOKEN
```

**外网访问时**:
- 使用域名带端口号（推荐）：`vabhub.example.com:8096`
- 如果使用默认端口映射（内网8096->外网8096），Emby客户端只需填写域名即可连接
- 地址栏下方已预制8096端口，自动使用

**推荐配置**:
```python
# 使用域名（自动适配内网/外网）
http://vabhub.example.com/api/strm/stream/115/TOKEN
```

### 4.3 端口映射

**路由器配置**:
- 内网端口: 8096 (VabHub服务端口，Emby默认端口)
- 公网端口: 8096 (或自定义，建议与内网端口一致)
- 协议: TCP

**防火墙配置**:
- 确保VabHub服务端口开放
- 确保Emby服务端口开放

---

## 📋 五、优势对比

### 5.1 代理模式 vs 302跳转

| 特性 | 代理模式 | 302跳转 |
|------|---------|---------|
| **流式传输** | ✅ 完全支持 | ⚠️ 可能有问题 |
| **Range请求** | ✅ 完全支持 | ❌ 可能丢失 |
| **字幕支持** | ✅ 完全支持 | ⚠️ 可能有问题 |
| **音频支持** | ✅ 完全支持 | ⚠️ 可能有问题 |
| **存储占用** | ✅ 不占用本地 | ✅ 不占用本地 |
| **服务器负载** | ⚠️ 需要代理流量 | ✅ 负载低 |

### 5.2 代理模式 vs 先下载再上传

| 特性 | 代理模式 | 先下载再上传 |
|------|---------|-------------|
| **存储占用** | ✅ 不占用NAS | ❌ 占用NAS |
| **播放延迟** | ✅ 即时播放 | ❌ 需要等待下载 |
| **带宽占用** | ✅ 按需传输 | ❌ 完整下载 |
| **适用场景** | ✅ 外出观看 | ❌ 本地观看 |

---

## 📋 六、使用场景

### 6.1 外出观看（主要场景）

**场景**: 用户外出，通过手机/平板访问Emby

**流程**:
1. 用户打开Emby App
2. 选择要观看的影片
3. Emby读取STRM文件
4. 发起播放请求到VabHub代理
5. VabHub从115网盘流式传输
6. 用户实时观看（无需等待下载）

**优势**:
- ✅ 即时播放，无需等待
- ✅ 不占用NAS存储
- ✅ 节省带宽（按需传输）

### 6.2 本地观看（可选场景）

**场景**: 用户在家，通过内网访问Emby

**流程**:
1. 用户打开Emby
2. 选择要观看的影片
3. Emby读取STRM文件
4. 发起播放请求到VabHub代理
5. VabHub从115网盘流式传输
6. 用户实时观看

**优势**:
- ✅ 不占用NAS存储
- ✅ 支持所有影片（无需下载）

---

## 📋 七、性能优化

### 7.1 缓存策略

**下载地址缓存**:
- 115网盘下载地址有时效性
- 可以缓存一段时间（如1小时）
- 减少API调用

**实现**:
```python
# 缓存下载地址
@cache(ttl=3600)  # 缓存1小时
async def get_download_url(pick_code: str):
    # 获取下载地址
    pass
```

### 7.2 连接池

**HTTP连接复用**:
- 使用httpx连接池
- 复用TCP连接
- 减少连接开销

### 7.3 超时设置

**合理的超时**:
- 连接超时: 30秒
- 读取超时: 300秒（视频流需要长时间）
- 避免长时间等待

---

## 📋 八、注意事项

### 8.1 网络要求

**带宽要求**:
- 视频流需要稳定的网络
- 建议至少10Mbps带宽
- 4K视频需要更高带宽

**延迟要求**:
- 代理会增加少量延迟
- 通常可以接受（<100ms）
- 不影响观看体验

### 8.2 服务器要求

**VabHub服务器**:
- 需要稳定的网络连接
- 需要足够的带宽
- 建议使用公网IP或域名

**资源占用**:
- 代理模式会增加服务器负载
- 主要是网络I/O
- CPU和内存占用较低

### 8.3 安全性

**TOKEN安全**:
- JWT token包含pick_code
- 建议设置合理的过期时间
- 使用HTTPS（推荐）

**访问控制**:
- 可以添加IP白名单
- 可以添加认证
- 可以添加限流

---

## 📋 九、总结

### 9.1 实现确认

**✅ 完全满足用户需求**:
- ✅ 外出时通过映射端口访问Emby
- ✅ 播放时直接连接115网盘
- ✅ 流式传输，无需先下载到NAS
- ✅ 支持网页端和App端

### 9.2 工作流程

```
用户外出
  ↓
通过映射端口访问Emby
  ↓
Emby播放STRM文件
  ↓
VabHub代理服务器
  ↓
从115网盘流式传输
  ↓
实时播放（不占用NAS存储）
```

### 9.3 关键优势

- ✅ **即时播放** - 无需等待下载
- ✅ **不占存储** - 不占用NAS空间
- ✅ **节省带宽** - 按需传输
- ✅ **完全透明** - Emby认为在播放本地文件

---

**文档生成时间**: 2025-01-XX  
**确认**: ✅ 代理模式完全满足用户需求，可以实现外出时直接连接115网盘流式传输

